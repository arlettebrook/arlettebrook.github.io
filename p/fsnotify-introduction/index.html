<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="Go跨平台文件系统通知之第三方库fsnotify介绍。"><title>Fsnotify Introduction</title>
<link rel=canonical href=https://arlettebrook.github.io/p/fsnotify-introduction/><link rel=stylesheet href=/scss/style.min.59d76563977ef6a76d0c7df16aa86c7ac37ed8942ba1442046cb6cf3b07439d7.css><meta property='og:title' content="Fsnotify Introduction"><meta property='og:description' content="Go跨平台文件系统通知之第三方库fsnotify介绍。"><meta property='og:url' content='https://arlettebrook.github.io/p/fsnotify-introduction/'><meta property='og:site_name' content="Arlettebrook's blog"><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='Go第三方库'><meta property='article:published_time' content='2024-05-08T15:49:50+08:00'><meta property='article:modified_time' content='2024-05-08T15:49:50+08:00'><meta name=twitter:site content="@arlettebrook"><meta name=twitter:creator content="@arlettebrook"><meta name=twitter:title content="Fsnotify Introduction"><meta name=twitter:description content="Go跨平台文件系统通知之第三方库fsnotify介绍。"><link rel="shortcut icon" href=/img/favicon.ico><script async src="https://www.googletagmanager.com/gtag/js?id=G-9MKLLVPEER"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-9MKLLVPEER")}</script></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><div id=article-toolbar style=position:sticky;top:5px;z-index:1000><a href=/ class=back-home><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-chevron-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="15 6 9 12 15 18"/></svg>
<span>返回</span></a></div><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">目录</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#快速使用>快速使用</a></li><li><a href=#事件>事件</a></li><li><a href=#应用>应用</a></li><li><a href=#总结>总结</a></li><li><a href=#参考>参考</a></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/go/ style=background-color:#f97300;color:#fff>Go
</a><a href=/categories/%E7%BC%96%E7%A8%8B/ style=background-color:#41b06e;color:#fff>编程</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/fsnotify-introduction/>Fsnotify Introduction</a></h2><h3 class=article-subtitle>Go跨平台文件系统通知之第三方库fsnotify介绍。</h3></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>May 08, 2024</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>阅读时长: 6 分钟</time></div></footer></div></header><section class=article-content><blockquote><p>Viper 可以监听文件修改进而自动重新加载。 其内部使用的就是<code>fsnotify</code>这个库，它是跨平台的。<code>fs</code>是filesystem的缩写，翻译过来就是文件系统通知。能够监听文件的修改，进而发送通知。今天我们就来介绍一下<a class=link href=https://github.com/fsnotify/fsnotify target=_blank rel=noopener>fsnotify</a>。</p></blockquote><hr><h2 id=快速使用><a href=#%e5%bf%ab%e9%80%9f%e4%bd%bf%e7%94%a8 class=header-anchor>#</a>
快速使用</h2><p>先安装：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ go get -u github.com/fsnotify/fsnotify
</span></span></code></pre></td></tr></table></div></div><p>后使用：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;log&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=s>&#34;github.com/fsnotify/fsnotify&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// Create new watcher.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>watcher</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>fsnotify</span><span class=p>.</span><span class=nf>NewWatcher</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=kd>func</span><span class=p>(</span><span class=nx>watcher</span> <span class=o>*</span><span class=nx>fsnotify</span><span class=p>.</span><span class=nx>Watcher</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>err</span> <span class=o>:=</span> <span class=nx>watcher</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}(</span><span class=nx>watcher</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>done</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=kt>bool</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Start listening for events.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>go</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>defer</span> <span class=nb>close</span><span class=p>(</span><span class=nx>done</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>for</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>select</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>case</span> <span class=nx>event</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=o>&lt;-</span><span class=nx>watcher</span><span class=p>.</span><span class=nx>Events</span><span class=p>:</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=p>!</span><span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=k>return</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;%s %s\n&#34;</span><span class=p>,</span> <span class=nx>event</span><span class=p>.</span><span class=nx>Name</span><span class=p>,</span> <span class=nx>event</span><span class=p>.</span><span class=nx>Op</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=cm>/*if event.Has(fsnotify.Write) {
</span></span></span><span class=line><span class=cl><span class=cm>					log.Println(&#34;modified file:&#34;, event.Name)
</span></span></span><span class=line><span class=cl><span class=cm>				}*/</span>
</span></span><span class=line><span class=cl>			<span class=k>case</span> <span class=nx>err</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=o>&lt;-</span><span class=nx>watcher</span><span class=p>.</span><span class=nx>Errors</span><span class=p>:</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=p>!</span><span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=k>return</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=nx>log</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;error:&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Add a path.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>err</span> <span class=p>=</span> <span class=nx>watcher</span><span class=p>.</span><span class=nf>Add</span><span class=p>(</span><span class=s>&#34;.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=o>&lt;-</span><span class=nx>done</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p><code>fsnotify</code>的使用比较简单：</p><ul><li>先调用<code>NewWatcher</code>创建一个监听器；</li><li>然后调用监听器的<code>Add</code>增加监听的文件或目录；</li><li>如果目录或文件有事件产生，监听器中的通道<code>Events</code>可以取出事件。如果出现错误，监听器中的通道<code>Errors</code>可以取出错误信息。</li></ul><p>上面示例中，我们在另一个 goroutine 中循环读取发生的事件及错误，然后输出它们。</p><p>编译、运行程序。在当前目录创建一个<code>新建文本文档.txt</code>，然后重命名为<code>abc.txt</code>文件，输入内容<code>some test text</code>，然后删除它。观察控制台输出：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ go run main.go
</span></span><span class=line><span class=cl>2024/05/08 16:29:52 新建文本文档.txt CREATE
</span></span><span class=line><span class=cl>2024/05/08 16:30:03 新建文本文档.txt RENAME
</span></span><span class=line><span class=cl>2024/05/08 16:30:03 abc.txt CREATE
</span></span><span class=line><span class=cl>2024/05/08 16:30:15 abc.txt WRITE
</span></span><span class=line><span class=cl>2024/05/08 16:30:26 abc.txt REMOVE
</span></span></code></pre></td></tr></table></div></div><p><strong>其实，重命名时会产生两个事件，一个是原文件的<code>RENAME</code>事件，一个是新文件的<code>CREATE</code>事件。</strong></p><p>注意：</p><ol><li><code>fsnotify</code>使用了操作系统接口，监听器中保存了系统资源的句柄，所以使用后需要关闭。</li><li>修改文件操作建议不要在IDE中操作，如GlLand。IDE的缓存和自动保存会响应输出结果。建议直接在系统文件管理器中操作，才会出现上面结果。</li></ol><hr><h2 id=事件><a href=#%e4%ba%8b%e4%bb%b6 class=header-anchor>#</a>
事件</h2><p>上面示例中的事件是<code>fsnotify.Event</code>类型：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-golang data-lang=golang><span class=line><span class=cl><span class=c1>// fsnotify/fsnotify.go
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>type</span> <span class=nx>Event</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>Name</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>  <span class=nx>Op</span>   <span class=nx>Op</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>事件只有两个字段，<code>Name</code>表示发生变化的文件或目录名，<code>Op</code>表示具体的变化。<code>Op</code>有 5 种取值：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-golang data-lang=golang><span class=line><span class=cl><span class=c1>// fsnotify/fsnotify.go
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>type</span> <span class=nx>Op</span> <span class=kt>uint32</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>const</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=nx>Create</span> <span class=nx>Op</span> <span class=p>=</span> <span class=mi>1</span> <span class=o>&lt;&lt;</span> <span class=kc>iota</span>
</span></span><span class=line><span class=cl>  <span class=nx>Write</span>
</span></span><span class=line><span class=cl>  <span class=nx>Remove</span>
</span></span><span class=line><span class=cl>  <span class=nx>Rename</span>
</span></span><span class=line><span class=cl>  <span class=nx>Chmod</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>在<a class=link href=#%e5%bf%ab%e9%80%9f%e4%bd%bf%e7%94%a8>快速使用</a>中，我们已经演示了前 4 种事件。<code>Chmod</code>事件在文件或目录的属性发生变化时触发，在 Linux 系统中可以通过<code>chmod</code>命令改变文件或目录属性。</p><p>事件中的<code>Op</code>是按照左移位运算来存储的，可以存储多个，可以通过<code>&</code>操作判断对应事件是不是发生了。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=k>if</span> <span class=nx>event</span><span class=p>.</span><span class=nx>Op</span> <span class=o>&amp;</span> <span class=nx>fsnotify</span><span class=p>.</span><span class=nx>Write</span> <span class=o>!=</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;Op has Write&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><blockquote><p>补充：</p><p>​ 与运算&：同为1为1。</p><p>​ 左移运算&#171;：向做做移动指定位，低位用0补齐</p><p>​ 或运算：有1就为1。用在组合<code>Op</code>——><code>|</code></p><p>​ 事件中的<code>Op</code>是通过左移运算之后，结果为1,2,4,6,8十进制来存储的，它们的二进制位都只有一个1，当进行与运算时，就就能判断是否包含指定<code>Op</code>。</p></blockquote><p>判断事件中是否存在某个<code>Op</code>，封装到了事件对象的<code>Has</code>方法下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// fsnotify/fsnotify.go
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>e</span> <span class=nx>Event</span><span class=p>)</span> <span class=nf>Has</span><span class=p>(</span><span class=nx>op</span> <span class=nx>Op</span><span class=p>)</span> <span class=kt>bool</span> <span class=p>{</span> <span class=k>return</span> <span class=nx>e</span><span class=p>.</span><span class=nx>Op</span><span class=p>.</span><span class=nf>Has</span><span class=p>(</span><span class=nx>op</span><span class=p>)</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>o</span> <span class=nx>Op</span><span class=p>)</span> <span class=nf>Has</span><span class=p>(</span><span class=nx>h</span> <span class=nx>Op</span><span class=p>)</span> <span class=kt>bool</span> <span class=p>{</span> <span class=k>return</span> <span class=nx>o</span><span class=o>&amp;</span><span class=nx>h</span> <span class=o>!=</span> <span class=mi>0</span> <span class=p>}</span>  <span class=c1>// event.Op &amp; fsnotify.Write != 0同理
</span></span></span></code></pre></td></tr></table></div></div><p>当我们直接输出<code>Op</code>时，会自动调用<code>String()</code>方法，这个方法帮我们将对应的<code>Op</code>（uint类型）转换成定义的具体操作，代码如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>o</span> <span class=nx>Op</span><span class=p>)</span> <span class=nf>String</span><span class=p>()</span> <span class=kt>string</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>b</span> <span class=nx>strings</span><span class=p>.</span><span class=nx>Builder</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>o</span><span class=p>.</span><span class=nf>Has</span><span class=p>(</span><span class=nx>Create</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>       <span class=nx>b</span><span class=p>.</span><span class=nf>WriteString</span><span class=p>(</span><span class=s>&#34;|CREATE&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>o</span><span class=p>.</span><span class=nf>Has</span><span class=p>(</span><span class=nx>Remove</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>       <span class=nx>b</span><span class=p>.</span><span class=nf>WriteString</span><span class=p>(</span><span class=s>&#34;|REMOVE&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>o</span><span class=p>.</span><span class=nf>Has</span><span class=p>(</span><span class=nx>Write</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>       <span class=nx>b</span><span class=p>.</span><span class=nf>WriteString</span><span class=p>(</span><span class=s>&#34;|WRITE&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>o</span><span class=p>.</span><span class=nf>Has</span><span class=p>(</span><span class=nx>Rename</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>       <span class=nx>b</span><span class=p>.</span><span class=nf>WriteString</span><span class=p>(</span><span class=s>&#34;|RENAME&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>o</span><span class=p>.</span><span class=nf>Has</span><span class=p>(</span><span class=nx>Chmod</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>       <span class=nx>b</span><span class=p>.</span><span class=nf>WriteString</span><span class=p>(</span><span class=s>&#34;|CHMOD&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>b</span><span class=p>.</span><span class=nf>Len</span><span class=p>()</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>       <span class=k>return</span> <span class=s>&#34;[no events]&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>b</span><span class=p>.</span><span class=nf>String</span><span class=p>()[</span><span class=mi>1</span><span class=p>:]</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><hr><h2 id=应用><a href=#%e5%ba%94%e7%94%a8 class=header-anchor>#</a>
应用</h2><p><code>fsnotify</code>的应用非常广泛，在 godoc 上，我们可以看到哪些库导入了<code>fsnotify</code>。只需进入<a class=link href=https://pkg.go.dev/github.com/fsnotify/fsnotify target=_blank rel=noopener>fsnotify godoc</a>点击<a class=link href="https://pkg.go.dev/github.com/fsnotify/fsnotify?tab=importedby" target=_blank rel=noopener>Imported by 9,171</a>，就能查看。有兴趣的可以打开看看。</p><p>在<a class=link href=https://blog.trojan123.top/p/go%e9%85%8d%e7%bd%ae%e7%ae%a1%e7%90%86%e4%b9%8b%e7%ac%ac%e4%b8%89%e6%96%b9%e5%ba%93viper/ target=_blank rel=noopener>《Go配置管理之第三方库viper》</a>文章中，我们介绍了调用<code>viper.WatchConfig</code>就可以监听配置修改，自动重新加载。下面我们就来看看<code>WatchConfig</code>是怎么实现的：</p><p>首先演示viper自动更新配置</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl><span class=c1>// mian.go
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;log&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;time&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=s>&#34;github.com/fsnotify/fsnotify&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;github.com/spf13/viper&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>viper</span><span class=p>.</span><span class=nf>SetConfigFile</span><span class=p>(</span><span class=s>&#34;./cfg.yaml&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>err</span> <span class=o>:=</span> <span class=nx>viper</span><span class=p>.</span><span class=nf>ReadInConfig</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>       <span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=s>&#34;ReadInConfig error:&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>viper</span><span class=p>.</span><span class=nf>OnConfigChange</span><span class=p>(</span><span class=kd>func</span><span class=p>(</span><span class=nx>in</span> <span class=nx>fsnotify</span><span class=p>.</span><span class=nx>Event</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>       <span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;%s %s username：%s\n&#34;</span><span class=p>,</span> <span class=nx>in</span><span class=p>.</span><span class=nx>Name</span><span class=p>,</span> <span class=nx>in</span><span class=p>.</span><span class=nx>Op</span><span class=p>,</span> <span class=nx>viper</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=s>&#34;username&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;修改前的username：&#34;</span><span class=p>,</span> <span class=nx>viper</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=s>&#34;username&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=nx>viper</span><span class=p>.</span><span class=nf>WatchConfig</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nx>time</span><span class=p>.</span><span class=nf>Sleep</span><span class=p>(</span><span class=mi>10</span> <span class=o>*</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>)</span> <span class=c1>// 修改文件
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;修改后的username：&#34;</span><span class=p>,</span> <span class=nx>viper</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=s>&#34;username&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># ./cfg.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>username</span><span class=p>:</span><span class=w> </span><span class=l>arlettebrook</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>运行之后，手动修改<code>cfg.yaml</code>username（注意不要在IDE中修改，会影响输出效果）,在后面分别追加1/2/3,并别保存，输出：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ go run main.go 
</span></span><span class=line><span class=cl>修改前的username： arlettebrook
</span></span><span class=line><span class=cl>2024/05/08 18:01:32 cfg.yaml WRITE username：arlettebrook1
</span></span><span class=line><span class=cl>2024/05/08 18:01:36 cfg.yaml WRITE username：arlettebrook12
</span></span><span class=line><span class=cl>2024/05/08 18:01:39 cfg.yaml WRITE username：arlettebrook123
</span></span><span class=line><span class=cl>修改后的username： arlettebrook123
</span></span></code></pre></td></tr></table></div></div><p>具体实现：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-golang data-lang=golang><span class=line><span class=cl><span class=c1>// viper/viper.go
</span></span></span><span class=line><span class=cl><span class=c1>// WatchConfig starts watching a config file for changes.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>WatchConfig</span><span class=p>()</span> <span class=p>{</span> <span class=nx>v</span><span class=p>.</span><span class=nf>WatchConfig</span><span class=p>()</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// WatchConfig starts watching a config file for changes.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>v</span> <span class=o>*</span><span class=nx>Viper</span><span class=p>)</span> <span class=nf>WatchConfig</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>initWG</span> <span class=o>:=</span> <span class=nx>sync</span><span class=p>.</span><span class=nx>WaitGroup</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>	<span class=nx>initWG</span><span class=p>.</span><span class=nf>Add</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>go</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>watcher</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>fsnotify</span><span class=p>.</span><span class=nf>NewWatcher</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>v</span><span class=p>.</span><span class=nx>logger</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;failed to create watcher: %s&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>))</span>
</span></span><span class=line><span class=cl>			<span class=nx>os</span><span class=p>.</span><span class=nf>Exit</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>defer</span> <span class=nx>watcher</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=c1>// we have to watch the entire directory to pick up renames/atomic saves in a cross-platform way
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>filename</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>v</span><span class=p>.</span><span class=nf>getConfigFile</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>v</span><span class=p>.</span><span class=nx>logger</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;get config file: %s&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>))</span>
</span></span><span class=line><span class=cl>			<span class=nx>initWG</span><span class=p>.</span><span class=nf>Done</span><span class=p>()</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=nx>configFile</span> <span class=o>:=</span> <span class=nx>filepath</span><span class=p>.</span><span class=nf>Clean</span><span class=p>(</span><span class=nx>filename</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>configDir</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>filepath</span><span class=p>.</span><span class=nf>Split</span><span class=p>(</span><span class=nx>configFile</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>realConfigFile</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>filepath</span><span class=p>.</span><span class=nf>EvalSymlinks</span><span class=p>(</span><span class=nx>filename</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=nx>eventsWG</span> <span class=o>:=</span> <span class=nx>sync</span><span class=p>.</span><span class=nx>WaitGroup</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>		<span class=nx>eventsWG</span><span class=p>.</span><span class=nf>Add</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>go</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>for</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>select</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>case</span> <span class=nx>event</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=o>&lt;-</span><span class=nx>watcher</span><span class=p>.</span><span class=nx>Events</span><span class=p>:</span>
</span></span><span class=line><span class=cl>					<span class=k>if</span> <span class=p>!</span><span class=nx>ok</span> <span class=p>{</span> <span class=c1>// &#39;Events&#39; channel is closed
</span></span></span><span class=line><span class=cl><span class=c1></span>						<span class=nx>eventsWG</span><span class=p>.</span><span class=nf>Done</span><span class=p>()</span>
</span></span><span class=line><span class=cl>						<span class=k>return</span>
</span></span><span class=line><span class=cl>					<span class=p>}</span>
</span></span><span class=line><span class=cl>					<span class=nx>currentConfigFile</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>filepath</span><span class=p>.</span><span class=nf>EvalSymlinks</span><span class=p>(</span><span class=nx>filename</span><span class=p>)</span>
</span></span><span class=line><span class=cl>					<span class=c1>// we only care about the config file with the following cases:
</span></span></span><span class=line><span class=cl><span class=c1></span>					<span class=c1>// 1 - if the config file was modified or created
</span></span></span><span class=line><span class=cl><span class=c1></span>					<span class=c1>// 2 - if the real path to the config file changed (eg: k8s ConfigMap replacement)
</span></span></span><span class=line><span class=cl><span class=c1></span>					<span class=k>if</span> <span class=p>(</span><span class=nx>filepath</span><span class=p>.</span><span class=nf>Clean</span><span class=p>(</span><span class=nx>event</span><span class=p>.</span><span class=nx>Name</span><span class=p>)</span> <span class=o>==</span> <span class=nx>configFile</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>						<span class=p>(</span><span class=nx>event</span><span class=p>.</span><span class=nf>Has</span><span class=p>(</span><span class=nx>fsnotify</span><span class=p>.</span><span class=nx>Write</span><span class=p>)</span> <span class=o>||</span> <span class=nx>event</span><span class=p>.</span><span class=nf>Has</span><span class=p>(</span><span class=nx>fsnotify</span><span class=p>.</span><span class=nx>Create</span><span class=p>)))</span> <span class=o>||</span>
</span></span><span class=line><span class=cl>						<span class=p>(</span><span class=nx>currentConfigFile</span> <span class=o>!=</span> <span class=s>&#34;&#34;</span> <span class=o>&amp;&amp;</span> <span class=nx>currentConfigFile</span> <span class=o>!=</span> <span class=nx>realConfigFile</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>						<span class=nx>realConfigFile</span> <span class=p>=</span> <span class=nx>currentConfigFile</span>
</span></span><span class=line><span class=cl>						<span class=nx>err</span> <span class=o>:=</span> <span class=nx>v</span><span class=p>.</span><span class=nf>ReadInConfig</span><span class=p>()</span>
</span></span><span class=line><span class=cl>						<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>							<span class=nx>v</span><span class=p>.</span><span class=nx>logger</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;read config file: %s&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>))</span>
</span></span><span class=line><span class=cl>						<span class=p>}</span>
</span></span><span class=line><span class=cl>						<span class=k>if</span> <span class=nx>v</span><span class=p>.</span><span class=nx>onConfigChange</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>							<span class=nx>v</span><span class=p>.</span><span class=nf>onConfigChange</span><span class=p>(</span><span class=nx>event</span><span class=p>)</span>
</span></span><span class=line><span class=cl>						<span class=p>}</span>
</span></span><span class=line><span class=cl>					<span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=nx>filepath</span><span class=p>.</span><span class=nf>Clean</span><span class=p>(</span><span class=nx>event</span><span class=p>.</span><span class=nx>Name</span><span class=p>)</span> <span class=o>==</span> <span class=nx>configFile</span> <span class=o>&amp;&amp;</span> <span class=nx>event</span><span class=p>.</span><span class=nf>Has</span><span class=p>(</span><span class=nx>fsnotify</span><span class=p>.</span><span class=nx>Remove</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>						<span class=nx>eventsWG</span><span class=p>.</span><span class=nf>Done</span><span class=p>()</span>
</span></span><span class=line><span class=cl>						<span class=k>return</span>
</span></span><span class=line><span class=cl>					<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>				<span class=k>case</span> <span class=nx>err</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=o>&lt;-</span><span class=nx>watcher</span><span class=p>.</span><span class=nx>Errors</span><span class=p>:</span>
</span></span><span class=line><span class=cl>					<span class=k>if</span> <span class=nx>ok</span> <span class=p>{</span> <span class=c1>// &#39;Errors&#39; channel is not closed
</span></span></span><span class=line><span class=cl><span class=c1></span>						<span class=nx>v</span><span class=p>.</span><span class=nx>logger</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;watcher error: %s&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>))</span>
</span></span><span class=line><span class=cl>					<span class=p>}</span>
</span></span><span class=line><span class=cl>					<span class=nx>eventsWG</span><span class=p>.</span><span class=nf>Done</span><span class=p>()</span>
</span></span><span class=line><span class=cl>					<span class=k>return</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}()</span>
</span></span><span class=line><span class=cl>		<span class=nx>watcher</span><span class=p>.</span><span class=nf>Add</span><span class=p>(</span><span class=nx>configDir</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>initWG</span><span class=p>.</span><span class=nf>Done</span><span class=p>()</span>   <span class=c1>// done initializing the watch in this go routine, so the parent routine can move on...
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>eventsWG</span><span class=p>.</span><span class=nf>Wait</span><span class=p>()</span> <span class=c1>// now, wait for event loop to end in this go-routine...
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=p>}()</span>
</span></span><span class=line><span class=cl>	<span class=nx>initWG</span><span class=p>.</span><span class=nf>Wait</span><span class=p>()</span> <span class=c1>// make sure that the go routine above fully ended before returning
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>其实流程是相似的：</p><ul><li>首先，调用<code>NewWatcher</code>创建一个监听器；</li><li>调用<code>v.getConfigFile()</code>获取配置文件路径，抽出文件名、目录，配置文件如果是一个符号链接，获得链接指向的路径；</li><li>调用<code>watcher.Add(configDir)</code>监听配置文件所在目录，另起一个 goroutine 处理事件。</li></ul><p><code>WatchConfig</code>不能阻塞主 goroutine，所以创建监听器也是新起 goroutine 进行的。代码中有两个<code>sync.WaitGroup</code>变量，<code>initWG</code>是为了保证监听器初始化， <code>eventsWG</code>是在事件通道关闭，或配置被删除了，或遇到错误时退出事件处理循环。</p><p>然后就是核心事件循环：</p><ul><li>有事件发生时，判断变化的文件是否是在 viper 中设置的配置文件，发生的是否是创建或修改事件（只处理这两个事件）；</li><li>如果配置文件为符号链接，若符合链接的指向修改了，也需要重新加载配置；</li><li>如果需要重新加载配置，调用<code>v.ReadInConfig()</code>读取新的配置；</li><li>如果注册了事件回调，以发生的事件为参数执行回调。</li></ul><hr><h2 id=总结><a href=#%e6%80%bb%e7%bb%93 class=header-anchor>#</a>
总结</h2><p><code>fsnotify</code>的接口非常简单直接，所有系统相关的复杂性都被封装起来了。这也是我们平时设计模块和接口时可以参考的案例。</p><hr><h2 id=参考><a href=#%e5%8f%82%e8%80%83 class=header-anchor>#</a>
参考</h2><blockquote><ol><li><a class=link href=https://docs.google.com/document/d/1-GQrFdDVrA57-ce0kbzSth4lQqfOMMRKpih3hPJmvoU/edit target=_blank rel=noopener>fsnotify API 设计</a></li><li><a class=link href=https://github.com/fsnotify/fsnotify target=_blank rel=noopener>fsnotify GitHub 仓库</a></li><li>原文：<a class=link href=https://darjun.github.io/2020/01/19/godailylib/fsnotify/ target=_blank rel=noopener>Go 每日一库之 fsnotify</a></li></ol></blockquote></section><footer class=article-footer><section class=article-tags><a href=/tags/go%E7%AC%AC%E4%B8%89%E6%96%B9%E5%BA%93/>Go第三方库</a></section><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>相关文章</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/p/gin-introduction/><div class=article-details><h2 class=article-title>Gin Introduction</h2></div></a></article><article><a href=/p/go-ini-introduction/><div class=article-details><h2 class=article-title>Go-ini Introduction</h2></div></a></article><article><a href=/p/carbon-introduction/><div class=article-details><h2 class=article-title>Carbon Introduction</h2></div></a></article><article><a href=/p/godotenv-introduction/><div class=article-details><h2 class=article-title>Godotenv Introduction</h2></div></a></article><article><a href=/p/cast-introduction/><div class=article-details><h2 class=article-title>Cast Introduction</h2></div></a></article></div></div></aside><script src=//unpkg.com/@waline/client@v2/dist/waline.js></script><link href=//unpkg.com/@waline/client@v2/dist/waline.css rel=stylesheet><div id=waline class=waline-container></div><style>.waline-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding);--waline-font-size:var(--article-font-size)}.waline-container .wl-count{color:var(--card-text-color-main)}</style><script>Waline.init({copyright:!1,dark:'html[data-scheme="dark"]',el:"#waline",emoji:["https://unpkg.com/@waline/emojis@1.0.1/weibo"],lang:"zh-cn",locale:{admin:"👻Hi!",placeholder:"🎉留下你的脚印..."},pageview:!0,requiredMeta:["name","email"],serverURL:"https://waline.trojan123.top/"})</script><footer class=site-footer><section class=copyright>Copyright &copy;
2020 -
2024 <b><a href=https://github.com/arlettebrook target=_blank rel=noopener>@Arlettebrook</a></b></section><section class=powerby>博客内容遵循<b><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/legalcode.zh-hans target=_blank rel=noopener> 知识共享 署名-非商业性-相同方式共享4.0国际协议</a></b><br>使用 <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> 构建<br>主题 <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.25.0>Stack</a></b> 由 <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> 设计</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>