<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="Go第三方库之web框架gin。"><title>Gin Introduction</title>
<link rel=canonical href=https://arlettebrook.github.io/p/gin-introduction/><link rel=stylesheet href=/scss/style.min.505938c6c688784167a9f82747dd1fc8c9c6c9e2137f29599d0e43e8740344b5.css><meta property='og:title' content="Gin Introduction"><meta property='og:description' content="Go第三方库之web框架gin。"><meta property='og:url' content='https://arlettebrook.github.io/p/gin-introduction/'><meta property='og:site_name' content="Arlettebrook's blog"><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='Go第三方库'><meta property='article:published_time' content='2024-05-21T17:58:00+08:00'><meta property='article:modified_time' content='2024-05-21T17:58:00+08:00'><meta name=twitter:site content="@arlettebrook"><meta name=twitter:creator content="@arlettebrook"><meta name=twitter:title content="Gin Introduction"><meta name=twitter:description content="Go第三方库之web框架gin。"><link rel="shortcut icon" href=/img/favicon.ico><script async src="https://www.googletagmanager.com/gtag/js?id=G-9MKLLVPEER"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-9MKLLVPEER")}</script></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><div id=article-toolbar style=position:sticky;top:5px;z-index:1000><a href=/ class=back-home><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-chevron-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="15 6 9 12 15 18"/></svg>
<span>返回</span></a></div><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">目录</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#gin介绍>Gin介绍</a></li><li><a href=#快速使用>快速使用</a><ol><li><a href=#gin框架热重载>Gin框架热重载</a><ol><li><a href=#air基本使用>air基本使用</a></li></ol></li><li><a href=#项目结构>项目结构</a></li><li><a href=#gin框架运行模式>Gin框架运行模式</a></li></ol></li><li><a href=#路由与控制器>路由与控制器</a><ol><li><a href=#路由规则>路由规则</a><ol><li><a href=#http请求方法>http请求方法</a></li><li><a href=#url路径>url路径</a></li><li><a href=#控制器函数>控制器函数</a></li></ol></li><li><a href=#配置路由示例>配置路由示例</a></li><li><a href=#路由分组><strong>路由分组</strong></a></li><li><a href=#控制器函数分组>控制器函数分组</a><ol><li><a href=#控制器继承>控制器继承</a></li></ol></li></ol></li><li><a href=#获取请求参数>获取请求参数</a><ol><li><a href=#获取查询参数>获取查询参数</a></li><li><a href=#获取路径参数>获取路径参数</a></li><li><a href=#获取表单参数>获取表单参数</a></li><li><a href=#将请求参数绑定到结构体对象>将请求参数绑定到结构体对象</a></li><li><a href=#gin如何获取客户ip>Gin如何获取客户ip</a></li><li><a href=#获取文件上传参数>获取文件上传参数</a></li></ol></li><li><a href=#响应请求参数>响应请求参数</a><ol><li><a href=#以字符串格式响应请求>以字符串格式响应请求</a></li><li><a href=#以json格式响应请求>以json格式响应请求</a><ol><li><a href=#以带填充的json格式响应请求了解>以带填充的json格式响应请求（了解）</a></li></ol></li><li><a href=#以xml格式响应请求>以xml格式响应请求</a></li><li><a href=#以文件格式响应请求>以文件格式响应请求</a></li><li><a href=#设置http响应头设置header>设置http响应头（设置Header）</a></li></ol></li><li><a href=#html模板渲染>HTML模板渲染</a></li><li><a href=#静态文件服务>静态文件服务</a></li><li><a href=#gin中间件>Gin中间件</a><ol><li><a href=#使用中间件>使用中间件</a></li><li><a href=#中间件之间共享数据>中间件之间共享数据</a></li><li><a href=#内置中间件>内置中间件</a></li><li><a href=#中间件的执行顺序>中间件的执行顺序</a></li><li><a href=#中间件中使用goroutine>中间件中使用goroutine</a></li><li><a href=#小结>小结</a></li></ol></li><li><a href=#gin文件上传>Gin文件上传</a><ol><li><a href=#基本文件上传>基本文件上传</a></li><li><a href=#处理多个文件上传>处理多个文件上传</a></li><li><a href=#设置处理多部分表单请求的最大内存大小>设置处理多部分表单请求的最大内存大小</a></li><li><a href=#使用中间件处理文件上传>使用中间件处理文件上传</a></li></ol></li><li><a href=#使用cookie>使用Cookie</a><ol><li><a href=#cookie介绍>Cookie介绍</a><ol><li><a href=#cookie的属性>Cookie的属性</a></li><li><a href=#补充>补充</a></li></ol></li><li><a href=#在gin中使用cookie>在Gin中使用Cookie</a></li></ol></li><li><a href=#使用session>使用Session</a><ol><li><a href=#session介绍>Session介绍</a></li><li><a href=#在gin中使用session>在Gin中使用Session</a><ol><li><a href=#基于cookie存储session>基于Cookie存储Session</a></li><li><a href=#基于redis存储session>基于Redis存储Session</a></li><li><a href=#sessions加密秘钥介绍>Sessions加密<strong>秘钥介绍</strong></a></li></ol></li></ol></li><li><a href=#总结>总结</a></li><li><a href=#参考>参考</a></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/go/ style=background-color:#f97300;color:#fff>Go
</a><a href=/categories/%E7%BC%96%E7%A8%8B/ style=background-color:#41b06e;color:#fff>编程</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/gin-introduction/>Gin Introduction</a></h2><h3 class=article-subtitle>Go第三方库之web框架gin。</h3></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>May 21, 2024</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>阅读时长: 49 分钟</time></div></footer></div></header><section class=article-content><hr><h2 id=gin介绍>Gin介绍</h2><p>Gin 是一个用 Golang编写的高性能的web 框架, 由于<a class=link href=https://github.com/julienschmidt/httprouter target=_blank rel=noopener>http路由</a>的优化，运行速度非常快，速度提高了近 40 倍。 Gin的特点就是封装优雅、API友好。</p><p>Gin 最擅长的就是API接口的高并发，如果项目的规模不大，业务相对简单，这个时候我们也推荐您使用 Gin。</p><p>当某个接口的性能遭到较大挑战的时候，这个还是可以考虑使用 Gin 重写接口。</p><p>Gin 也是一个流行的 golang Web 框架，Github Strat 量已经超过了 75k[2024/05/21]。</p><p>Gin的一些特性：</p><ul><li>快速
基于 Radix 树的路由，小内存占用。没有反射。可预测的 API 性能。</li><li>支持中间件
传入的 HTTP 请求可以由一系列中间件和最终操作来处理。 例如：Logger，Authorization，GZIP，最终操作 DB。</li><li>Crash 处理
Gin 可以 catch 一个发生在 HTTP 请求中的 panic 并 recover 它。这样，你的服务器将始终可用。例如，你可以向 Sentry 报告这个 panic！</li><li>JSON 验证
Gin 可以解析并验证请求的 JSON，例如检查所需值的存在。</li><li>路由组
更好地组织路由。是否需要授权，不同的 API 版本…… 此外，这些组可以无限制地嵌套而不会降低性能。</li><li>错误管理
Gin 提供了一种方便的方法来收集 HTTP 请求期间发生的所有错误。最终，中间件可以将它们写入日志文件，数据库并通过网络发送。</li><li>内置渲染
Gin 为 JSON，XML 和 HTML 渲染提供了易于使用的 API。</li><li>可扩展性
新建一个中间件非常简单。</li></ul><p>Gin 的官网： <a class=link href=https://gin-gonic.com/zh-cn/ target=_blank rel=noopener>https://gin-gonic.com/zh-cn/</a></p><p>Gin Github 地址： <a class=link href=https://github.com/gin-gonic/gin target=_blank rel=noopener>https://github.com/gin-gonic/gin</a></p><hr><h2 id=快速使用>快速使用</h2><p>下载并安装 gin：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=err>$</span> <span class=k>go</span> <span class=nx>get</span> <span class=o>-</span><span class=nx>u</span> <span class=nx>github</span><span class=p>.</span><span class=nx>com</span><span class=o>/</span><span class=nx>gin</span><span class=o>-</span><span class=nx>gonic</span><span class=o>/</span><span class=nx>gin</span>
</span></span></code></pre></td></tr></table></div></div><p>注意：go版本要 1.6 及以上。</p><p>快速使用示例：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 导入gin包
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kn>import</span> <span class=s>&#34;github.com/gin-gonic/gin&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 入口函数
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 初始化一个http服务对象，创建一个默认的路由引擎对象
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>r</span> <span class=o>:=</span> <span class=nx>gin</span><span class=p>.</span><span class=nf>Default</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 配置路由
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 设置一个get请求的路由，url为/ping, 处理函数（或者叫控制器函数、回调函数）是一个闭包函数。
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>r</span><span class=p>.</span><span class=nf>GET</span><span class=p>(</span><span class=s>&#34;/ping&#34;</span><span class=p>,</span> <span class=kd>func</span><span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>gin</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>       <span class=c1>// 通过请求上下文对象Context, 直接往客户端返回一个json
</span></span></span><span class=line><span class=cl><span class=c1></span>       <span class=nx>c</span><span class=p>.</span><span class=nf>JSON</span><span class=p>(</span><span class=mi>200</span><span class=p>,</span> <span class=nx>gin</span><span class=p>.</span><span class=nx>H</span><span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=s>&#34;message&#34;</span><span class=p>:</span> <span class=s>&#34;pong&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>       <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>err</span> <span class=o>:=</span> <span class=nx>r</span><span class=p>.</span><span class=nf>Run</span><span class=p>()</span> <span class=c1>// 启动 HTTP 服务，默认在 0.0.0.0:8080 启动服务
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>       <span class=nb>panic</span><span class=p>(</span><span class=s>&#34;Http serve start error:&#34;</span> <span class=o>+</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>运行命令<code>go run main.go</code>，即可启动http服务。然后就可以通过localhost:8080/ping 访问了。会返回如下内容：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl><span class=nt>&#34;message&#34;</span><span class=p>:</span> <span class=s2>&#34;pong&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>注意：如果不期望在测试的时候，每次都弹出防火墙警告，可将监听地址、端口改为<code>localhost:8080</code>。生产环境应该为<code>:port</code>，省略地址，默认为<code>0.0.0.0</code>。</p><h3 id=gin框架热重载>Gin框架热重载</h3><p>所谓热重载就是当我们对代码进行修改时，程序能够自动重新加载并执行，这在我们开发中是非常便利的，可以快速进行代码测试，省去了每次手动重新编译。</p><p>Gin框架并没有提供热重载的功能，这个时候我们要实现热重载就要借助第三方的工具。</p><p>这里推荐一个使用最多的gin框架热重载工具：<strong><a class=link href=https://github.com/cosmtrek/air/ target=_blank rel=noopener>air</a></strong>。它是在 <a class=link href=https://github.com/pilu/fresh target=_blank rel=noopener>fresh</a> 的基础上诞生的。</p><p>特性：</p><ul><li>彩色的日志输出</li><li>自定义构建或必要的命令</li><li>支持外部子目录</li><li>在 Air 启动之后，允许监听新创建的路径</li><li><strong>更棒的构建过程</strong></li></ul><p>原理大致是：监听到文件系统修改通知后，重新构建应用程序。</p><h4 id=air基本使用>air基本使用</h4><p>安装：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>go install github.com/cosmtrek/air@latest
</span></span></code></pre></td></tr></table></div></div><p>注意：go版本要1.22 或更高。</p><p>安装成功之后，就可以在gin项目根目录下直接运行<code>air</code>命令，就可以启动gin项目，实现热重载。</p><p>air默认情况下使用默认配置启动服务。如果要修改默认配置，可以运行<code>air init</code>生成默认的配置文件<code>.air.toml</code>，修改之后，运行<code>air</code>即可使用修改的配置启动服务，注意：如果修改了配置文件名，需要用<code>-c</code>选项指定新的配置文件。否则将使用默认的<code>.air.toml</code>启动服务。</p><p>一般使用默认配置就够用了。可修改的内容如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-toml data-lang=toml><span class=line><span class=cl><span class=nx>root</span> <span class=p>=</span> <span class=s2>&#34;.&#34;</span>
</span></span><span class=line><span class=cl><span class=nx>testdata_dir</span> <span class=p>=</span> <span class=s2>&#34;testdata&#34;</span>
</span></span><span class=line><span class=cl><span class=nx>tmp_dir</span> <span class=p>=</span> <span class=s2>&#34;tmp&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=nx>build</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=nx>args_bin</span> <span class=p>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>  <span class=nx>bin</span> <span class=p>=</span> <span class=s2>&#34;tmp\\main.exe&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nx>cmd</span> <span class=p>=</span> <span class=s2>&#34;go build -o ./tmp/main.exe .&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nx>delay</span> <span class=p>=</span> <span class=mi>1000</span>
</span></span><span class=line><span class=cl>  <span class=nx>exclude_dir</span> <span class=p>=</span> <span class=p>[</span><span class=s2>&#34;assets&#34;</span><span class=p>,</span> <span class=s2>&#34;tmp&#34;</span><span class=p>,</span> <span class=s2>&#34;vendor&#34;</span><span class=p>,</span> <span class=s2>&#34;testdata&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=nx>exclude_file</span> <span class=p>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>  <span class=nx>exclude_regex</span> <span class=p>=</span> <span class=p>[</span><span class=s2>&#34;_test.go&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=nx>exclude_unchanged</span> <span class=p>=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>  <span class=nx>follow_symlink</span> <span class=p>=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>  <span class=nx>full_bin</span> <span class=p>=</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nx>include_dir</span> <span class=p>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>  <span class=nx>include_ext</span> <span class=p>=</span> <span class=p>[</span><span class=s2>&#34;go&#34;</span><span class=p>,</span> <span class=s2>&#34;tpl&#34;</span><span class=p>,</span> <span class=s2>&#34;tmpl&#34;</span><span class=p>,</span> <span class=s2>&#34;html&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=nx>include_file</span> <span class=p>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>  <span class=nx>kill_delay</span> <span class=p>=</span> <span class=s2>&#34;0s&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nx>log</span> <span class=p>=</span> <span class=s2>&#34;build-errors.log&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nx>poll</span> <span class=p>=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>  <span class=nx>poll_interval</span> <span class=p>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>  <span class=nx>post_cmd</span> <span class=p>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>  <span class=nx>pre_cmd</span> <span class=p>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>  <span class=nx>rerun</span> <span class=p>=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>  <span class=nx>rerun_delay</span> <span class=p>=</span> <span class=mi>500</span>
</span></span><span class=line><span class=cl>  <span class=nx>send_interrupt</span> <span class=p>=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>  <span class=nx>stop_on_error</span> <span class=p>=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=nx>color</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=nx>app</span> <span class=p>=</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nx>build</span> <span class=p>=</span> <span class=s2>&#34;yellow&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nx>main</span> <span class=p>=</span> <span class=s2>&#34;magenta&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nx>runner</span> <span class=p>=</span> <span class=s2>&#34;green&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nx>watcher</span> <span class=p>=</span> <span class=s2>&#34;cyan&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=nx>log</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=nx>main_only</span> <span class=p>=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>  <span class=nx>time</span> <span class=p>=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=nx>misc</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=nx>clean_on_exit</span> <span class=p>=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=nx>proxy</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=nx>app_port</span> <span class=p>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>  <span class=nx>enabled</span> <span class=p>=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>  <span class=nx>proxy_port</span> <span class=p>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=nx>screen</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=nx>clear_on_rebuild</span> <span class=p>=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>  <span class=nx>keep_scroll</span> <span class=p>=</span> <span class=kc>true</span>
</span></span></code></pre></td></tr></table></div></div><p>基本使用如上，更多内容参考<a class=link href=https://github.com/cosmtrek/air/ target=_blank rel=noopener>air官方</a>。</p><h3 id=项目结构>项目结构</h3><p>实际项目业务功能和模块会很多，我们不可能把所有代码都写在一个go文件里面或者写在一个main入口函数里面；我们需要对项目结构做一些规划，方便维护代码以及扩展。</p><blockquote><p>Gin框没有对项目结构做出限制，我们可以根据自己项目需要自行设计。</p></blockquote><p>这里给出一个典型的MVC框架大致的项目结构的例子，大家可以<strong>参考</strong>下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>├── conf                    <span class=c1>#项目配置文件目录</span>
</span></span><span class=line><span class=cl>│   └── config.toml         <span class=c1>#大家可以选择自己熟悉的配置文件管理工具包例如：toml、xml等等</span>
</span></span><span class=line><span class=cl>├── controllers             <span class=c1>#控制器目录，按模块存放控制器（或者叫控制器函数），必要的时候可以继续划分子目录。</span>
</span></span><span class=line><span class=cl>│   ├── food.go
</span></span><span class=line><span class=cl>│   └── user.go
</span></span><span class=line><span class=cl>├── main.go                 <span class=c1>#项目入口，这里负责Gin框架的初始化，注册路由信息，关联控制器函数等。</span>
</span></span><span class=line><span class=cl>├── models                  <span class=c1>#模型目录，负责项目的数据存储部分，例如各个模块的Mysql表的读写模型。</span>
</span></span><span class=line><span class=cl>│   ├── food.go
</span></span><span class=line><span class=cl>│   └── user.go
</span></span><span class=line><span class=cl>├── static assets             <span class=c1>#静态资源目录，包括Js，css，jpg等等，可以通过Gin框架配置，直接让用户访问。</span>
</span></span><span class=line><span class=cl>│   ├── css
</span></span><span class=line><span class=cl>│   ├── images
</span></span><span class=line><span class=cl>│   └── js
</span></span><span class=line><span class=cl>├── logs                    <span class=c1>#日志文件目录，主要保存项目运行过程中产生的日志。</span>
</span></span><span class=line><span class=cl>└── views templates                   <span class=c1>#视图模板目录，存放各个模块的视图模板，当然有些项目只有api，是不需要视图部分，可以忽略这个目录</span>
</span></span><span class=line><span class=cl>    └── index.html
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    routers
</span></span></code></pre></td></tr></table></div></div><h3 id=gin框架运行模式>Gin框架运行模式</h3><p>为方便调试，Gin 框架在运行的时候默认是debug模式，在控制台默认会打印出很多调试日志，上线的时候我们需要关闭<code>debug</code>模式，改为<code>release</code>模式。</p><p>设置Gin框架运行模式：</p><ol><li><p>通过环境变量设置<code>GIN_MODE</code>，如：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=nb>export</span> <span class=nv>GIN_MODE</span><span class=o>=</span>release
</span></span></code></pre></td></tr></table></div></div><p>GIN_MODE环境变量，可以设置为debug或者release，默认为debug。</p></li><li><p>通过代码设置:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// 在main函数，初始化gin框架的时候执行下面代码
</span></span></span><span class=line><span class=cl><span class=c1>// 设置 release模式
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>gin</span><span class=p>.</span><span class=nf>SetMode</span><span class=p>(</span><span class=nx>gin</span><span class=p>.</span><span class=nx>ReleaseMode</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// 或者 设置debug模式
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>gin</span><span class=p>.</span><span class=nf>SetMode</span><span class=p>(</span><span class=nx>gin</span><span class=p>.</span><span class=nx>DebugMode</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div></li></ol><h2 id=路由与控制器>路由与控制器</h2><p>Gin框架中的<strong>路由</strong>是指通过HTTP请求的路径找到对应的控制器函数（也可以叫处理器函数）。Gin框架的路由是基于<a class=link href=https://github.com/julienschmidt/httprouter target=_blank rel=noopener>httprouter</a>包实现的。</p><p><strong>控制器函数</strong>主要负责处理http请求和响应请求。</p><p>一个简单的例子：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>r</span> <span class=o>:=</span> <span class=nx>gin</span><span class=p>.</span><span class=nf>Default</span><span class=p>()</span> <span class=c1>// 创建默认的路由引擎对象
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// 配置路由：post请求, uri路径为：/user/login, 绑定doLogin控制器函数
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>r</span><span class=p>.</span><span class=nf>POST</span><span class=p>(</span><span class=s>&#34;/user/login&#34;</span><span class=p>,</span> <span class=nx>doLogin</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 控制器函数
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>doLogin</span><span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>gin</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 获取post请求参数
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>username</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>PostForm</span><span class=p>(</span><span class=s>&#34;username&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>password</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>PostForm</span><span class=p>(</span><span class=s>&#34;password&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 通过请求上下文对象Context, 直接往客户端返回一个字符串
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>c</span><span class=p>.</span><span class=nf>String</span><span class=p>(</span><span class=mi>200</span><span class=p>,</span> <span class=s>&#34;username=%s,password=%s&#34;</span><span class=p>,</span> <span class=nx>username</span><span class=p>,</span> <span class=nx>password</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=路由规则>路由规则</h3><p>一条路由规则由三部分组成：</p><ul><li>http请求方法</li><li>url路径</li><li>控制器函数</li></ul><h4 id=http请求方法>http请求方法</h4><p>常用的http请求方法有下面4种:</p><ul><li>GET：查Read-select</li><li>POST：增Create-insert</li><li>PUT：改Update-update</li><li>DELETE: 删Delete-delete</li></ul><p>目前常用的API风格是RESTful风格。</p><p>在RESTful风格中，每个路径表示不同的资源，通过不同的请求方式访问相同的路径表示执行不同的操作（CRUD)。</p><p>RESTful CRUD示例：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>POST /users      <span class=c1># 创建一个新用户</span>
</span></span><span class=line><span class=cl>GET /users/1     <span class=c1># 获取ID为1的用户</span>
</span></span><span class=line><span class=cl>PUT /users/1     <span class=c1># 更新ID为1的用户</span>
</span></span><span class=line><span class=cl>DELETE /users/1  <span class=c1># 删除ID为1的用户</span>
</span></span><span class=line><span class=cl>				 <span class=c1># 注意：1是路径参数</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=url路径>url路径</h4><p>Gin框架中，url路径有三种写法：</p><ul><li>静态url路径</li><li>带路径参数的url路径</li><li>带星号（*）模糊匹配参数的url路径</li></ul><p>下面看下各种url路由的例子</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>// 例子1， 静态Url路径, 即不带任何参数的url路径
</span></span><span class=line><span class=cl>/users/center
</span></span><span class=line><span class=cl>/user/111
</span></span><span class=line><span class=cl>/food/12
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>// 例子2，带路径参数的url路径，url路径上面带有参数,参数由冒号（:）跟着一个字符串定义。
</span></span><span class=line><span class=cl>// 路径参数值可以是数值，也可以是字符串
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>//定义参数:id， 可以匹配/user/1, /user/899 /user/xiaoli 这类Url路径
</span></span><span class=line><span class=cl>/user/:id
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>//定义参数:id， 可以匹配/food/2, /food/100 /food/apple 这类Url路径
</span></span><span class=line><span class=cl>/food/:id
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>//定义参数:type和:page， 可以匹配/foods/2/1, /food/100/25 /food/apple/30 这类Url路径
</span></span><span class=line><span class=cl>/foods/:type/:page
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>// 例子3. 带星号（*）模糊匹配参数的url路径
</span></span><span class=line><span class=cl>// 星号代表匹配任意路径的意思, 必须在*号后面指定一个参数名，后面可以通过这个参数获取*号匹配的内容。
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>//以/foods/ 开头的所有路径都匹配
</span></span><span class=line><span class=cl>//匹配：/foods/1， /foods/200, /foods/1/20, /foods/apple/1 
</span></span><span class=line><span class=cl>/foods/*path
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>//可以通过path参数获取*号匹配的内容。
</span></span></code></pre></td></tr></table></div></div><h4 id=控制器函数>控制器函数</h4><p>控制器函数定义：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>type HandlerFunc func(*Context)
</span></span></code></pre></td></tr></table></div></div><p>控制器函数接受一个上下文参数。
可以通过上下文参数，获取http请求参数，响应http请求。</p><h3 id=配置路由示例>配置路由示例</h3><p>配置路由就是利用路由规则定义路由：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>//实例化gin实例对象。创建默认的路由引擎对象。
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>r</span> <span class=o>:=</span> <span class=nx>gin</span><span class=p>.</span><span class=nf>Default</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl><span class=c1>// 配置路由
</span></span></span><span class=line><span class=cl><span class=c1>//定义post请求, url路径为：/users, 绑定saveUser控制器函数
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>r</span><span class=p>.</span><span class=nf>POST</span><span class=p>(</span><span class=s>&#34;/users&#34;</span><span class=p>,</span> <span class=nx>saveUser</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>//定义get请求，url路径为：/users/:id  （:id是参数，例如: /users/10, 会匹配这个url模式），绑定getUser控制器函数
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>r</span><span class=p>.</span><span class=nf>GET</span><span class=p>(</span><span class=s>&#34;/users/:id&#34;</span><span class=p>,</span> <span class=nx>getUser</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>//定义put请求
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>r</span><span class=p>.</span><span class=nf>PUT</span><span class=p>(</span><span class=s>&#34;/users/:id&#34;</span><span class=p>,</span> <span class=nx>updateUser</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>//定义delete请求
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>r</span><span class=p>.</span><span class=nf>DELETE</span><span class=p>(</span><span class=s>&#34;/users/:id&#34;</span><span class=p>,</span> <span class=nx>deleteUser</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>//控制器函数实现
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>saveUser</span><span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>gin</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span><span class=nx>忽略实现</span><span class=o>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>getUser</span><span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>gin</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span><span class=nx>忽略实现</span><span class=o>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>updateUser</span><span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>gin</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span><span class=nx>忽略实现</span><span class=o>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>deleteUser</span><span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>gin</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span><span class=nx>忽略实现</span><span class=o>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><blockquote><p>提示：实际项目开发中不要把路由定义和控制器函数都写在一个go文件，不方便维护，可以参考第一章的项目结构，规划自己的业务模块。</p></blockquote><h3 id=路由分组><strong>路由分组</strong></h3><p>在做api开发的时候，如果要支持多个api版本，我们可以通过分组路由来实现api版本处理。</p><p>示例：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>router</span> <span class=o>:=</span> <span class=nx>gin</span><span class=p>.</span><span class=nf>Default</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 创建v1组
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>v1</span> <span class=o>:=</span> <span class=nx>router</span><span class=p>.</span><span class=nf>Group</span><span class=p>(</span><span class=s>&#34;/v1&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// 在v1这个分组下，注册路由
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>v1</span><span class=p>.</span><span class=nf>POST</span><span class=p>(</span><span class=s>&#34;/login&#34;</span><span class=p>,</span> <span class=nx>loginEndpoint</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>v1</span><span class=p>.</span><span class=nf>POST</span><span class=p>(</span><span class=s>&#34;/submit&#34;</span><span class=p>,</span> <span class=nx>submitEndpoint</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>v1</span><span class=p>.</span><span class=nf>POST</span><span class=p>(</span><span class=s>&#34;/read&#34;</span><span class=p>,</span> <span class=nx>readEndpoint</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 创建v2组
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>v2</span> <span class=o>:=</span> <span class=nx>router</span><span class=p>.</span><span class=nf>Group</span><span class=p>(</span><span class=s>&#34;/v2&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// 在v2这个分组下，注册路由
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>v2</span><span class=p>.</span><span class=nf>POST</span><span class=p>(</span><span class=s>&#34;/login&#34;</span><span class=p>,</span> <span class=nx>loginEndpoint</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>v2</span><span class=p>.</span><span class=nf>POST</span><span class=p>(</span><span class=s>&#34;/submit&#34;</span><span class=p>,</span> <span class=nx>submitEndpoint</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>v2</span><span class=p>.</span><span class=nf>POST</span><span class=p>(</span><span class=s>&#34;/read&#34;</span><span class=p>,</span> <span class=nx>readEndpoint</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>router</span><span class=p>.</span><span class=nf>Run</span><span class=p>(</span><span class=s>&#34;:8080&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>上面的例子将会注册下面的路由信息：</p><ul><li>/v1/login</li><li>/v1/submit</li><li>/v1/read</li><li>/v2/login</li><li>/v2/submit</li><li>/v2/read</li></ul><p>路由分组，其实就是设置了同一类<strong>路由的url前缀</strong>。</p><p>利用路由分组，我们可以实现将需要授权和不需要授权的API进行分组管理(后面介绍）。同时也能够将他们<strong>分文件保存</strong>。</p><p>示例如下：</p><p><code>routers/router.go</code>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>routers</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;log&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=s>&#34;github.com/gin-gonic/gin&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// registerRouterGroupFunc 定义类型别名，用于注册路由组的函数
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>type</span> <span class=nx>registerRouterGroupFunc</span> <span class=p>=</span> <span class=kd>func</span><span class=p>(</span><span class=nx>r</span> <span class=o>*</span><span class=nx>gin</span><span class=p>.</span><span class=nx>Engine</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 存储所有需要注册的路由组函数
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>var</span> <span class=nx>routerGroups</span> <span class=p>[]</span><span class=nx>registerRouterGroupFunc</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 添加路由组函数到路由组列表中
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>addRouterGroup</span><span class=p>(</span><span class=nx>r</span> <span class=nx>registerRouterGroupFunc</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>r</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>routerGroups</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>routerGroups</span><span class=p>,</span> <span class=nx>r</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 注册所有路由组到主路由组中
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>registerRoutes</span><span class=p>(</span><span class=nx>r</span> <span class=o>*</span><span class=nx>gin</span><span class=p>.</span><span class=nx>Engine</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>register</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>routerGroups</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nf>register</span><span class=p>(</span><span class=nx>r</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 加载所有路由组
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>loadRouterGroups</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nf>loadDefaultRouter</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nf>loadManageRouter</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// InitRouter 初始化主路由器
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>InitRouter</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 创建默认的 Gin 路由器
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>r</span> <span class=o>:=</span> <span class=nx>gin</span><span class=p>.</span><span class=nf>Default</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 加载并注册所有路由组
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>loadRouterGroups</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nf>registerRoutes</span><span class=p>(</span><span class=nx>r</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 启动服务器
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>err</span> <span class=o>:=</span> <span class=nx>r</span><span class=p>.</span><span class=nf>Run</span><span class=p>(</span><span class=s>&#34;localhost:8080&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>log</span><span class=p>.</span><span class=nf>Panic</span><span class=p>(</span><span class=s>&#34;Start http serve error:&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p><code>routers/defaultRouter.go</code>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>routers</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;github.com/arlettebrook/learn/controllers&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;github.com/gin-gonic/gin&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 加载所有默认的路由组
</span></span></span><span class=line><span class=cl><span class=c1>// 这里控制器函数没有分组保存
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>loadDefaultRouter</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nf>addRouterGroup</span><span class=p>(</span><span class=kd>func</span><span class=p>(</span><span class=nx>r</span> <span class=o>*</span><span class=nx>gin</span><span class=p>.</span><span class=nx>Engine</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// defaultRouter := r.group(&#34;/&#34;) 可以省略
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// defaultRouter.Get(...) 与下面等效
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>r</span><span class=p>.</span><span class=nf>GET</span><span class=p>(</span><span class=s>&#34;/&#34;</span><span class=p>,</span> <span class=kd>func</span><span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>gin</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>c</span><span class=p>.</span><span class=nf>JSON</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nx>StatusOK</span><span class=p>,</span> <span class=nx>gin</span><span class=p>.</span><span class=nx>H</span><span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=s>&#34;msg&#34;</span><span class=p>:</span> <span class=s>&#34;Hello, world!&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=p>})</span>
</span></span><span class=line><span class=cl>		<span class=p>})</span>
</span></span><span class=line><span class=cl>	<span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p><code>routers/manageRouter.go</code>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>routers</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;github.com/arlettebrook/learn/controllers&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;github.com/gin-gonic/gin&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 加载所有管理路由组
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>loadManageRouter</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nf>addRouterGroup</span><span class=p>(</span><span class=kd>func</span><span class=p>(</span><span class=nx>r</span> <span class=o>*</span><span class=nx>gin</span><span class=p>.</span><span class=nx>Engine</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>manageRouter</span> <span class=o>:=</span> <span class=nx>r</span><span class=p>.</span><span class=nf>Group</span><span class=p>(</span><span class=s>&#34;/manage&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>manageRouter</span><span class=p>.</span><span class=nf>GET</span><span class=p>(</span><span class=s>&#34;/addUser&#34;</span><span class=p>,</span> <span class=kd>func</span><span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>gin</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>c</span><span class=p>.</span><span class=nf>JSON</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nx>StatusOK</span><span class=p>,</span> <span class=nx>gin</span><span class=p>.</span><span class=nx>H</span><span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=s>&#34;msg&#34;</span><span class=p>:</span> <span class=s>&#34;Add user&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=p>})</span>
</span></span><span class=line><span class=cl>			<span class=p>})</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>在main.go中调用<code>routers.InitRouter()</code>即可启动gin框架。浏览器中访问<a class=link href=http://localhost:8080/manage/addUser target=_blank rel=noopener>http://localhost:8080/manage/addUser</a>、 <a class=link href=http://localhost:8080/ target=_blank rel=noopener>http://localhost:8080/</a>就可以访问注册的两条路由。</p><p>注意：默认路由组,在<code>/</code>,意思就是：<code>r.Group("/")</code>与<code>r.Get("/",...)</code>属于同一组。</p><h3 id=控制器函数分组>控制器函数分组</h3><p>当我们的项目比较大的时候有必要对我们的控制器进行分组。</p><p>参考<a class=link href=#%e8%b7%af%e7%94%b1%e5%88%86%e7%bb%84>路由分组</a>示例，使用控制器函数分组可修改为：</p><p><code>routers/defaultRouter.go</code>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>routers</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;github.com/arlettebrook/learn/controllers&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=s>&#34;github.com/gin-gonic/gin&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>loadDefaultRouter</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>addRouterGroup</span><span class=p>(</span><span class=kd>func</span><span class=p>(</span><span class=nx>r</span> <span class=o>*</span><span class=nx>gin</span><span class=p>.</span><span class=nx>Engine</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>       <span class=nx>defaultController</span> <span class=o>:=</span> <span class=nx>controllers</span><span class=p>.</span><span class=nx>DefaultController</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>       <span class=nx>r</span><span class=p>.</span><span class=nf>GET</span><span class=p>(</span><span class=s>&#34;/&#34;</span><span class=p>,</span> <span class=nx>defaultController</span><span class=p>.</span><span class=nx>Index</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p><code>routers/manageRouter.go</code>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>routers</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;github.com/arlettebrook/learn/controllers&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;github.com/gin-gonic/gin&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>loadManageRouter</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>addRouterGroup</span><span class=p>(</span><span class=kd>func</span><span class=p>(</span><span class=nx>r</span> <span class=o>*</span><span class=nx>gin</span><span class=p>.</span><span class=nx>Engine</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>       <span class=nx>manageRouter</span> <span class=o>:=</span> <span class=nx>r</span><span class=p>.</span><span class=nf>Group</span><span class=p>(</span><span class=s>&#34;/manage&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>       <span class=nx>manageController</span> <span class=o>:=</span> <span class=nx>controllers</span><span class=p>.</span><span class=nx>ManageController</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>       <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>manageRouter</span><span class=p>.</span><span class=nf>GET</span><span class=p>(</span><span class=s>&#34;/addUser&#34;</span><span class=p>,</span> <span class=nx>manageController</span><span class=p>.</span><span class=nx>AddUser</span><span class=p>)</span>
</span></span><span class=line><span class=cl>       <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>添加的控制器分组：</p><p><code>controllers/defaultController.go</code>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>controllers</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;net/http&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=s>&#34;github.com/gin-gonic/gin&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>DefaultController</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>d</span> <span class=nx>DefaultController</span><span class=p>)</span> <span class=nf>Index</span><span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>gin</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>c</span><span class=p>.</span><span class=nf>JSON</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nx>StatusOK</span><span class=p>,</span> <span class=nx>gin</span><span class=p>.</span><span class=nx>H</span><span class=p>{</span>
</span></span><span class=line><span class=cl>       <span class=s>&#34;msg&#34;</span><span class=p>:</span> <span class=s>&#34;Hello, world!&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p><code>controllers/manageController.go</code>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>controllers</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;net/http&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=s>&#34;github.com/gin-gonic/gin&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>ManageController</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>m</span> <span class=nx>ManageController</span><span class=p>)</span> <span class=nf>AddUser</span><span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>gin</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>c</span><span class=p>.</span><span class=nf>JSON</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nx>StatusOK</span><span class=p>,</span> <span class=nx>gin</span><span class=p>.</span><span class=nx>H</span><span class=p>{</span>
</span></span><span class=line><span class=cl>       <span class=s>&#34;msg&#34;</span><span class=p>:</span> <span class=s>&#34;Add user&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><blockquote><p>注意：为什么要在控制器里面定义对应的结构体对象呢？</p><ul><li>防止在同一个包下出现同名方法。</li><li>更加语义化，方便调用。</li><li>可以实现<strong>控制器继承</strong>。</li></ul></blockquote><h4 id=控制器继承>控制器继承</h4><p>控制器继承，可以将一些共用的控制器函数封装出来，实现代码优化。</p><p>示例：</p><p><code>controllers/baseController.go</code>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>controllers</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;net/http&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=s>&#34;github.com/gin-gonic/gin&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>BaseController</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>b</span> <span class=o>*</span><span class=nx>BaseController</span><span class=p>)</span> <span class=nf>Ok</span><span class=p>(</span><span class=nx>ctx</span> <span class=o>*</span><span class=nx>gin</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>ctx</span><span class=p>.</span><span class=nf>JSON</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nx>StatusOK</span><span class=p>,</span> <span class=nx>gin</span><span class=p>.</span><span class=nx>H</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=s>&#34;msg&#34;</span><span class=p>:</span> <span class=s>&#34;Success!&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>b</span> <span class=o>*</span><span class=nx>BaseController</span><span class=p>)</span> <span class=nf>Fail</span><span class=p>(</span><span class=nx>ctx</span> <span class=o>*</span><span class=nx>gin</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>ctx</span><span class=p>.</span><span class=nf>JSON</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nx>StatusOK</span><span class=p>,</span> <span class=nx>gin</span><span class=p>.</span><span class=nx>H</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=s>&#34;msg&#34;</span><span class=p>:</span> <span class=s>&#34;Fail!&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p><code>controllers/defaultController.go</code>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>controllers</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;net/http&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=s>&#34;github.com/gin-gonic/gin&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>DefaultController</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>BaseController</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>d</span> <span class=nx>DefaultController</span><span class=p>)</span> <span class=nf>Index</span><span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>gin</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>c</span><span class=p>.</span><span class=nf>JSON</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nx>StatusOK</span><span class=p>,</span> <span class=nx>gin</span><span class=p>.</span><span class=nx>H</span><span class=p>{</span>
</span></span><span class=line><span class=cl>       <span class=s>&#34;msg&#34;</span><span class=p>:</span> <span class=s>&#34;Hello, world!&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p><code>routers/defaultRouter.go</code>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>routers</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;github.com/arlettebrook/learn/controllers&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=s>&#34;github.com/gin-gonic/gin&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>loadDefaultRouter</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>addRouterGroup</span><span class=p>(</span><span class=kd>func</span><span class=p>(</span><span class=nx>r</span> <span class=o>*</span><span class=nx>gin</span><span class=p>.</span><span class=nx>Engine</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>       <span class=nx>defaultController</span> <span class=o>:=</span> <span class=nx>controllers</span><span class=p>.</span><span class=nx>DefaultController</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>       <span class=nx>r</span><span class=p>.</span><span class=nf>GET</span><span class=p>(</span><span class=s>&#34;/&#34;</span><span class=p>,</span> <span class=nx>defaultController</span><span class=p>.</span><span class=nx>Index</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>       <span class=nx>r</span><span class=p>.</span><span class=nf>GET</span><span class=p>(</span><span class=s>&#34;/extend/s&#34;</span><span class=p>,</span> <span class=nx>defaultController</span><span class=p>.</span><span class=nx>Ok</span><span class=p>)</span>
</span></span><span class=line><span class=cl>       <span class=nx>r</span><span class=p>.</span><span class=nf>GET</span><span class=p>(</span><span class=s>&#34;/extend/f&#34;</span><span class=p>,</span> <span class=nx>defaultController</span><span class=p>.</span><span class=nx>Fail</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>所以，我们只需要对应的控制器继承<code>BaseController</code>，那么该控制器就有对应的公有控制器函数。</p><p>TODO: 利用控制器，还能实现更多的操作，<strong>未完待续&mldr;</strong></p><p><strong>补充</strong>：上面的示例中<code>DefaultController</code> 是无状态的（stateless），即它不在成员变量中保存与特定请求相关的数据，那么是线程安全的，不会发生数据冲突。然而，如果 <code>DefaultController</code> 有状态（stateful），即它在成员变量中保存与请求相关的数据，那么多个用户请求同时访问时可能会发生数据冲突。</p><p>以下是一些确保线程安全的方法：</p><ol><li><p><strong>无状态控制器</strong>: 确保控制器不保存任何与请求相关的状态信息。所有的状态信息应保存在请求的上下文中或传递给方法中的局部变量。</p><ul><li><strong>使用中间件或局部变量</strong>: 如果需要保存请求相关的数据，将这些数据保存在请求的上下文中或方法的局部变量中，而不是控制器的成员变量中。</li></ul></li><li><p><strong>每次请求创建新的控制器实例</strong>: 在路由器中为每个请求创建一个新的控制器实例。这样每个请求都有自己的控制器实例，不会发生数据冲突。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>r</span><span class=p>.</span><span class=nf>GET</span><span class=p>(</span><span class=s>&#34;/&#34;</span><span class=p>,</span> <span class=kd>func</span><span class=p>(</span><span class=nx>ctx</span> <span class=o>*</span><span class=nx>gin</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>defaultController</span> <span class=o>:=</span> <span class=nx>controllers</span><span class=p>.</span><span class=nx>DefaultController</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>            <span class=nx>defaultController</span><span class=p>.</span><span class=nf>Index</span><span class=p>(</span><span class=nx>ctx</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>})</span>
</span></span></code></pre></td></tr></table></div></div></li></ol><hr><h2 id=获取请求参数>获取请求参数</h2><p>本章介绍Gin框架获取请求参数的方式。</p><h3 id=获取查询参数>获取查询参数</h3><p>查询（query）参数是url路径中<code>?</code>后面的所有键值对，他们用<code>&</code>符合连接。url例子：/query?id=1234&amp;name=Manu&amp;value=111</p><p>Gin框架获取查询参数的<strong>常用函数</strong>：</p><ul><li><strong>func</strong> (c *Context) <strong>Query</strong>(key string) string<ul><li>键不存在返回空字符串。</li></ul></li><li><strong>func</strong> (c *Context) <strong>DefaultQuery</strong>(key, defaultValue string) string<ul><li>键不存在，使用默认值。</li></ul></li><li><strong>func</strong> (c *Context) <strong>GetQuery</strong>(key string) (string, bool)<ul><li>键存在返回值和true。键不存在返回空字符串和false。键的值为空字符串也返回空字符串和false。</li></ul></li></ul><p>注意：</p><ul><li><p>获取的查询参数类型都为string。</p></li><li><p>通常情况下查询参数出现在GET请求当中，因为GET请求参数会出现在url路径中。当然在POST请求中也能够获取查询参数。</p></li></ul><p>示例：/user?uid=20&amp;page=1</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>router</span><span class=p>.</span><span class=nf>GET</span><span class=p>(</span><span class=s>&#34;/user&#34;</span><span class=p>,</span> <span class=kd>func</span><span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>gin</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span> 
</span></span><span class=line><span class=cl>    <span class=nx>uid</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>Query</span><span class=p>(</span><span class=s>&#34;uid&#34;</span><span class=p>)</span> 
</span></span><span class=line><span class=cl>    <span class=nx>page</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>DefaultQuery</span><span class=p>(</span><span class=s>&#34;page&#34;</span><span class=p>,</span> <span class=s>&#34;0&#34;</span><span class=p>)</span> 
</span></span><span class=line><span class=cl>    <span class=nx>c</span><span class=p>.</span><span class=nf>String</span><span class=p>(</span><span class=mi>200</span><span class=p>,</span> <span class=s>&#34;uid=%v page=%v&#34;</span><span class=p>,</span> <span class=nx>uid</span><span class=p>,</span> <span class=nx>page</span><span class=p>)</span> 
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=获取路径参数>获取路径参数</h3><p>路径（param）参数是包含在url路径中的参数，通常在url中不容易区分，只有在绑定路径参数的地方才能正确判断。</p><p>绑定路径参数的语法是<code>/:+参数名</code>，如<code>/user/:id</code>，就是在user路径下绑定一个id参数，那么/user/1, /user/2&mldr;, user后面的一级都是路径参数。</p><p>当然路径参数也支持嵌套，如：/user/:id/:name/:age, /user/001/jack/18</p><p>获取路径参数常用函数：</p><ul><li><strong>func</strong> (c *Context) <strong>Param</strong>(key string) string<ul><li>获取路径中指定位置的参数，键不存在，返回空字符串。</li><li>注意：键名要与绑定的路径参数名一直，没有冒号。位置要一一对应，否则请求会404.</li><li>通常获取GET请求中的路径参数，但也能获取POST请求中的路径参数。</li></ul></li><li>获取路径参数只有这一个方法。</li></ul><p>示例：域名/user/20</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>r</span><span class=p>.</span><span class=nf>POST</span><span class=p>(</span><span class=s>&#34;/user/:uid&#34;</span><span class=p>,</span> <span class=kd>func</span><span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>gin</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span> 
</span></span><span class=line><span class=cl>    <span class=nx>uid</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>Param</span><span class=p>(</span><span class=s>&#34;uid&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>c</span><span class=p>.</span><span class=nf>String</span><span class=p>(</span><span class=mi>200</span><span class=p>,</span> <span class=s>&#34;userID=%s&#34;</span><span class=p>,</span> <span class=nx>uid</span><span class=p>)</span> 
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=获取表单参数>获取表单参数</h3><p>表单参数是位于请求体中的，所以只适用于POST请求。</p><p>所以一般说获取表单参数就是获取POST请求参数。</p><p>获取Post请求参数的常用函数：</p><ul><li><strong>func</strong> (c *Context) <strong>PostForm</strong>(key string) string<ul><li>从请求体（表单）中获取指定键的值，不存在返回空字符串。</li></ul></li><li><strong>func</strong> (c *Context) <strong>DefaultPostForm</strong>(key, defaultValue string) string<ul><li>键不存在，指定默认值。</li></ul></li><li><strong>func</strong> (c *Context) <strong>GetPostForm</strong>(key string) (string, bool)<ul><li>键不存在返回空字符串和false，存在返回值和true。</li></ul></li><li>注意：<ul><li>获取的参数类型但是string。</li><li>以上方法不能获取请求体中的json、xml等原始数据。只能获取表单数据。<ul><li>获取原始数据，可以通过<a class=link href=#%e5%b0%86%e8%af%b7%e6%b1%82%e5%8f%82%e6%95%b0%e7%bb%91%e5%ae%9a%e5%88%b0%e7%bb%93%e6%9e%84%e4%bd%93%e5%af%b9%e8%b1%a1>参数与结构体对象绑定</a>获取。</li></ul></li></ul></li></ul><p>示例：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>r</span><span class=p>.</span><span class=nf>POST</span><span class=p>(</span><span class=s>&#34;/doAddUser&#34;</span><span class=p>,</span> <span class=kd>func</span><span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>gin</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span> 
</span></span><span class=line><span class=cl>    <span class=nx>username</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>PostForm</span><span class=p>(</span><span class=s>&#34;username&#34;</span><span class=p>)</span> 
</span></span><span class=line><span class=cl>    <span class=nx>password</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>PostForm</span><span class=p>(</span><span class=s>&#34;password&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>age</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>DefaultPostForm</span><span class=p>(</span><span class=s>&#34;age&#34;</span><span class=p>,</span> <span class=s>&#34;20&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>	<span class=nx>c</span><span class=p>.</span><span class=nf>JSON</span><span class=p>(</span><span class=mi>200</span><span class=p>,</span> <span class=nx>gin</span><span class=p>.</span><span class=nx>H</span><span class=p>{</span> 
</span></span><span class=line><span class=cl>        <span class=s>&#34;usernmae&#34;</span><span class=p>:</span> <span class=nx>username</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>        <span class=s>&#34;password&#34;</span><span class=p>:</span> <span class=nx>password</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>        <span class=s>&#34;age&#34;</span><span class=p>:</span> <span class=nx>age</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>    <span class=p>})</span> 
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=将请求参数绑定到结构体对象>将请求参数绑定到结构体对象</h3><p>前面获取参数的方式都是一个个参数的读取，比较麻烦，Gin框架支持根据请求参数类型自动绑定到一个struct对象。</p><p>用到的方法是<code>Bind</code>和<code>ShouldBind</code>：</p><ul><li><p>二者会根据请求参数的类型自动选择对应的<strong>绑定引擎</strong>进行绑定</p><ul><li>根据请求头的MIME类型判断。</li></ul></li><li><p>支持查询、表单、请求体原始数据（常用：xml、json）参数，<strong>不支持路径参数</strong>。</p><ul><li>如果需要将路径参数绑定到结构体，需要指定绑定引擎为<code>XxxUri</code>，并且用<code>uri</code>标签指定字段。</li></ul></li><li><p>也可指定对应的绑定引擎就行绑定，如：</p><ul><li><p><code>BindQuery</code>、<code>ShouldBindQuery</code>。</p></li><li><p><code>BindJSON</code>、<code>ShouldBindJSON</code>。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl>	<span class=nx>c</span><span class=p>.</span><span class=nf>ShouldBindBodyWithJSON</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>c</span><span class=p>.</span><span class=nf>ShouldBindJSON</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><p>二者都是将请求体中的json数据绑定到结构体对象</p><p><strong>区别是</strong>：使用<code>ShouldBindBodyWithJSON</code>绑定后，请求体内容不会被消耗，请求体的内容还能用<code>ShouldBindBodyWithJSON</code><strong>重复使用</strong>，而<strong>其他的绑定方法只能绑定一次</strong>，<strong>会消耗请求体内容</strong>，读取后请求体内容<strong>不可再用</strong>。</p><p>如果<strong>请求体</strong>只读取一次，使用<code>ShouldBindJSON</code>性能更好。读取多次只能用<code>ShouldBindBodyWithJSON</code>。如在中间件中进行验证后再处理业务逻辑。</p><p>一句话带<code>Body</code>的可以使用<strong>相同</strong>方法<strong>重复绑定</strong>。<strong>没有的只能绑定一次</strong>。再次绑定会报<strong>EOF错误</strong>。</p></li><li><p><code>BindUri</code>、<code>ShouldBindUri</code>。</p><ul><li>绑定路径参数，注意需要用<code>uri</code>标签指定字段。</li></ul></li><li><p>&mldr;</p></li></ul></li><li><p>绑定的结构体字段需要与参数的键一直，才能绑定成功。如果不一致需要用结构体标签指明。格式为<code>参数类型:键名</code>，常用的绑定标签：</p><ul><li><code>form</code>: 指定<strong>表单参数</strong>和<strong>查询参数</strong>的键。</li><li><code>json</code>：指定json参数的键。</li><li><code>xml</code>：指定xml参数的键。</li><li><code>uri</code>：指定<strong>路径参数</strong>的键。</li><li><code>binding</code>：指定<strong>绑定验证</strong>，如果验证失败，绑定会失败。多个属性用<code>,</code>分隔。常用属性：<ul><li>必填字段（<code>required</code>）：确保字段在请求中必须存在且不能为空。</li><li>最小长度（<code>min</code>）: 确保字符串或数组的长度不小于指定值。</li><li>最大长度（<code>max</code>）: 确保字符串或数组的长度不大于指定值。</li><li>正则表达式（<code>regexp</code>）: 确保字符串符合指定的正则表达式。</li></ul></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>User</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>Id</span>   <span class=kt>int</span>    <span class=s>`form:&#34;id&#34; json:&#34;id&#34; xml:&#34;id&#34; uri:&#34;id&#34; binding:&#34;required&#34;`</span>
</span></span><span class=line><span class=cl>    <span class=nx>Name</span> <span class=kt>string</span> <span class=s>`form:&#34;name&#34; json:&#34;name&#34; xml:&#34;name&#34; uri:&#34;name&#34;`</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Id字段在表单和查询参数中的键是id，json数据中的键是id，xml数据中的键是id，路径参数中的键是id，并且该字段在请求参数中必须存在且不为空，才能绑定成功。Name字段同理。</p><ul><li><code>binding</code> 标签通常与其他标签（如 <code>json</code>、<code>form</code> 等）结合使用，以指定键名和绑定验证。</li></ul></li><li><p>二者区别：</p><ul><li><code>Bind</code>绑定结构体失败，会自动响应400错误：Bad Request</li><li><code>ShouldBind</code>绑定失败不会自动响应错误，需要手动处理响应错误。</li><li>一般推荐使用<code>ShouldBind</code>，更容易定制化。</li></ul></li></ul><p>示例：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;github.com/gin-gonic/gin&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;net/http&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>User</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>Username</span> <span class=kt>string</span> <span class=s>`json:&#34;username&#34; binding:&#34;required,min=3,max=20&#34;`</span>
</span></span><span class=line><span class=cl>    <span class=nx>Password</span> <span class=kt>string</span> <span class=s>`json:&#34;password&#34; binding:&#34;required,min=8&#34;`</span>
</span></span><span class=line><span class=cl>    <span class=nx>Email</span>    <span class=kt>string</span> <span class=s>`json:&#34;email&#34; binding:&#34;required,email&#34;`</span>
</span></span><span class=line><span class=cl>    <span class=nx>Age</span>      <span class=kt>int</span>    <span class=s>`json:&#34;age&#34; binding:&#34;required,min=18,max=65&#34;`</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>r</span> <span class=o>:=</span> <span class=nx>gin</span><span class=p>.</span><span class=nf>Default</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>r</span><span class=p>.</span><span class=nf>POST</span><span class=p>(</span><span class=s>&#34;/register&#34;</span><span class=p>,</span> <span class=kd>func</span><span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>gin</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>var</span> <span class=nx>user</span> <span class=nx>User</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>ShouldBindJSON</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>c</span><span class=p>.</span><span class=nf>JSON</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nx>StatusBadRequest</span><span class=p>,</span> <span class=nx>gin</span><span class=p>.</span><span class=nx>H</span><span class=p>{</span><span class=s>&#34;error&#34;</span><span class=p>:</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>()})</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nx>c</span><span class=p>.</span><span class=nf>JSON</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nx>StatusOK</span><span class=p>,</span> <span class=nx>gin</span><span class=p>.</span><span class=nx>H</span><span class=p>{</span><span class=s>&#34;status&#34;</span><span class=p>:</span> <span class=s>&#34;registration successful&#34;</span><span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>r</span><span class=p>.</span><span class=nf>Run</span><span class=p>(</span><span class=s>&#34;:8080&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>在这个示例中：</p><ul><li><code>Username</code> 字段必须存在且长度在 3 到 20 之间。</li><li><code>Password</code> 字段必须存在且长度至少为 8。</li><li><code>Email</code> 字段必须存在且符合 email 格式。</li><li><code>Age</code> 字段必须存在且值在 18 到 65 之间。</li></ul><h3 id=gin如何获取客户ip>Gin如何获取客户ip</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>r</span><span class=p>.</span><span class=nf>GET</span><span class=p>(</span><span class=s>&#34;/ip&#34;</span><span class=p>,</span> <span class=kd>func</span><span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>gin</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 获取用户IP
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>ip</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>ClientIP</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nx>remoteIP</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>RemoteIP</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span></code></pre></td></tr></table></div></div><ul><li><p><code>ClientIP</code>方法会<strong>尽力</strong>返回客户端真实ip。会考虑代理的情况。</p></li><li><p><code>RemoteIP</code>方法返回与服务器直接连接的ip，不考虑代理的情况。</p></li></ul><p>区别（了解）：</p><ol><li><strong>数据来源</strong>：<ul><li><code>RemoteIP()</code> 直接从 <code>c.Request.RemoteAddr</code> 获取 IP 地址。</li><li><code>ClientIP()</code> 优先从请求头（如 <code>X-Forwarded-For</code>、<code>X-Real-IP</code> 等）中获取 IP 地址，如果请求头中没有这些字段，则退回到 <code>RemoteAddr</code>。</li></ul></li><li><strong>使用场景</strong>：<ul><li><code>RemoteIP()</code> 更适用于需要获取直接连接到服务器的客户端 IP 地址的场景。</li><li><code>ClientIP()</code> 更适用于需要获取经过代理服务器后的客户端真实 IP 地址的场景，适用于有反向代理或负载均衡器的环境。</li></ul></li><li><strong>处理代理</strong>：<ul><li><code>RemoteIP()</code> 不考虑代理的情况，只返回直接连接的客户端 IP。</li><li><code>ClientIP()</code> 考虑代理的情况，优先从请求头获取客户端的真实 IP，适用于处理经过多个代理的请求。</li></ul></li></ol><h3 id=获取文件上传参数>获取文件上传参数</h3><p>参考<a class=link href=#Gin%e6%96%87%e4%bb%b6%e4%b8%8a%e4%bc%a0>Gin文件上传</a>。</p><hr><h2 id=响应请求参数>响应请求参数</h2><p>本章介绍处理完http请求后如何响应请求，Gin框架支持以字符串、json、xml、文件等格式响应请求。</p><p>gin.Context上下文对象支持多种返回处理结果，下面分别介绍不同的响应方式。</p><h3 id=以字符串格式响应请求>以字符串格式响应请求</h3><p>通过String方法返回字符串。</p><p>方法定义：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>Context</span><span class=p>)</span> <span class=nf>String</span><span class=p>(</span><span class=nx>code</span> <span class=kt>int</span><span class=p>,</span> <span class=nx>format</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>values</span> <span class=o>...</span><span class=kd>interface</span><span class=p>{})</span>
</span></span></code></pre></td></tr></table></div></div><p>参数说明：</p><div class=table-wrapper><table><thead><tr><th style=text-align:left>参数</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:left>code</td><td style=text-align:left>http状态码</td></tr><tr><td style=text-align:left>format</td><td style=text-align:left>返回结果，支持类似Sprintf函数一样的字符串格式定义，例如,%d 代表插入整数，%s代表插入字符串</td></tr><tr><td style=text-align:left>values</td><td style=text-align:left>任意个format参数定义的字符串格式参数</td></tr></tbody></table></div><p>示例：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>r</span><span class=p>.</span><span class=nf>GET</span><span class=p>(</span><span class=s>&#34;/news&#34;</span><span class=p>,</span> <span class=kd>func</span><span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>gin</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span> 
</span></span><span class=line><span class=cl>    <span class=nx>aid</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>Query</span><span class=p>(</span><span class=s>&#34;aid&#34;</span><span class=p>)</span> 
</span></span><span class=line><span class=cl>    <span class=nx>c</span><span class=p>.</span><span class=nf>String</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nx>StatusOK</span><span class=p>,</span> <span class=s>&#34;aid=%s&#34;</span><span class=p>,</span> <span class=nx>aid</span><span class=p>)</span> 
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span></code></pre></td></tr></table></div></div><blockquote><p>提示： net/http包定义了多种常用的状态码常量，例如：http.StatusOK == 200， http.StatusMovedPermanently == 301， http.StatusNotFound == 404, http.StatusBadRequest == 400等，具体可以参考net/http包</p></blockquote><h3 id=以json格式响应请求>以json格式响应请求</h3><p>我们开发api接口的时候常用的格式就是json。</p><p>通过<code>JSON</code>方法返回json数据。</p><p>方法定义：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-GO data-lang=GO><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>Context</span><span class=p>)</span> <span class=nf>JSON</span><span class=p>(</span><span class=nx>code</span> <span class=kt>int</span><span class=p>,</span> <span class=nx>obj</span> <span class=nx>any</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>参数说明：</p><ul><li>code：响应的http状态码。</li><li>obj：响应的json数据。类型是可以序列化为json类型的数据，如：结构体对象、map[string]any。Gin框架会自动将它们序列化为JSON数据，并将它们放在请求体当中。<ul><li>Gin框架为方便将map数据作为json响应，提供了一个快捷类型：<code>type H map[string]any</code>，<code>gin.H</code>是<code>map[string]any</code>类型。</li></ul></li></ul><p>示例：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>User</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>Id</span>   <span class=kt>int</span>    <span class=s>`form:&#34;id&#34; json:&#34;id&#34; xml:&#34;id&#34; uri:&#34;id&#34; binding:&#34;required&#34;`</span>
</span></span><span class=line><span class=cl>	<span class=nx>Name</span> <span class=kt>string</span> <span class=s>`form:&#34;name&#34; json:&#34;name&#34; xml:&#34;name&#34; uri:&#34;name&#34;`</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span> 
</span></span><span class=line><span class=cl>    <span class=nx>r</span> <span class=o>:=</span> <span class=nx>gin</span><span class=p>.</span><span class=nf>Default</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=c1>// gin.H 是 map[string]interface{}的缩写 
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>r</span><span class=p>.</span><span class=nf>GET</span><span class=p>(</span><span class=s>&#34;/someJSON&#34;</span><span class=p>,</span> <span class=kd>func</span><span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>gin</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=c1>// 方式一：自己拼接 JSON 
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>c</span><span class=p>.</span><span class=nf>JSON</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nx>StatusOK</span><span class=p>,</span> <span class=nx>gin</span><span class=p>.</span><span class=nx>H</span><span class=p>{</span><span class=s>&#34;message&#34;</span><span class=p>:</span> <span class=s>&#34;Hello world!&#34;</span><span class=p>})</span> <span class=c1>// {&#34;messgae&#34;:&#34;Hello world!&#34;}
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>})</span> 
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nx>r</span><span class=p>.</span><span class=nf>GET</span><span class=p>(</span><span class=s>&#34;/moreJSON&#34;</span><span class=p>,</span> <span class=kd>func</span><span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>gin</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=c1>// 方法二：使用结构体 
</span></span></span><span class=line><span class=cl><span class=c1></span>       <span class=nx>u</span> <span class=o>:=</span> <span class=nx>models</span><span class=p>.</span><span class=nx>User</span><span class=p>{</span><span class=nx>Id</span><span class=p>:</span> <span class=mi>123</span><span class=p>,</span> <span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;Marry&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>c</span><span class=p>.</span><span class=nf>JSON</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nx>StatusOK</span><span class=p>,</span> <span class=nx>u</span><span class=p>)</span>  <span class=c1>// {&#34;id&#34;:123,&#34;name&#34;:&#34;Marry&#34;}
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>})</span> 
</span></span><span class=line><span class=cl>    <span class=nx>r</span><span class=p>.</span><span class=nf>Run</span><span class=p>(</span><span class=s>&#34;localhost:8080&#34;</span><span class=p>)</span> 
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=以带填充的json格式响应请求了解>以带填充的json格式响应请求（了解）</h4><ul><li><p>用到的方法是<code>JSONP</code>，英文名为：JSON with Padding，中文大概：带填充的json。</p><ul><li>只有当请求中指定查询参数<code>callback</code>时，才会响应带填充的json，否则，只响应json。</li><li>示例：<ul><li>请求：<code>http://localhost:8080/get?callback=abc</code>，响应：<code>abc({json数据})</code>。<ul><li><code>Content-Type：application/javascript; charset=utf-8</code></li></ul></li><li>请求：<code>http://localhost:8080/get</code>，响应：<code>{json数据}</code>。<ul><li><code>Content-Type：application/json; charset=utf-8</code></li></ul></li></ul></li></ul></li><li><p>作用：</p><ul><li><strong>JSONP</strong> 是一种<strong>古老的跨域请求解决方案</strong>，通过 <code>&lt;script></code> 标签加载和执行 JavaScript 代码来实现数据传输，因此只适用于 <code>GET</code> 请求的简单跨域场景。<ul><li>因为要配合script标签的src属性使用，它只能发送GET请求。</li><li>带填充的json格式就是JavaScript代码。</li></ul></li></ul></li><li><p>具体使用：</p><ol><li><p>在前端定义好回调函数名。</p></li><li><p>通过<code>&lt;script></code> 标签的 src 属性指向跨域的服务器，并包含一个查询参数 callback，其值是一个回调函数的名字。</p></li><li><p>服务器收到请求后，将数据包装在回调函数中，生成一段 JavaScript 代码，并返回给客户端。</p></li><li><p><strong>浏览器加载并执行返回的 JavaScript 代码，从而调用回调函数，回调函数接收数据并处理。</strong></p><p>示例：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>r</span><span class=p>.</span><span class=nf>GET</span><span class=p>(</span><span class=s>&#34;/get&#34;</span><span class=p>,</span> <span class=kd>func</span><span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>gin</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>data</span> <span class=o>:=</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kd>interface</span><span class=p>{}{</span>
</span></span><span class=line><span class=cl>				<span class=s>&#34;message&#34;</span><span class=p>:</span> <span class=s>&#34;Hello, World!&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=s>&#34;status&#34;</span><span class=p>:</span>  <span class=s>&#34;success&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=nx>c</span><span class=p>.</span><span class=nf>JSONP</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nx>StatusOK</span><span class=p>,</span> <span class=nx>gin</span><span class=p>.</span><span class=nx>H</span><span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=s>&#34;data&#34;</span><span class=p>:</span> <span class=nx>data</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=p>})</span>
</span></span><span class=line><span class=cl>		<span class=p>})</span>
</span></span></code></pre></td></tr></table></div></div><p><code>http://localhost:8080/get?callback=abc</code>响应：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=nx>abc</span><span class=p>({</span>
</span></span><span class=line><span class=cl>	<span class=s2>&#34;data&#34;</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=s2>&#34;message&#34;</span><span class=o>:</span> <span class=s2>&#34;Hello, World!&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=s2>&#34;status&#34;</span><span class=o>:</span> <span class=s2>&#34;success&#34;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span></code></pre></td></tr></table></div></div><p><code>http://localhost:8080/get</code>响应：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nt>&#34;data&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nt>&#34;message&#34;</span><span class=p>:</span> <span class=s2>&#34;Hello, World!&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nt>&#34;status&#34;</span><span class=p>:</span> <span class=s2>&#34;success&#34;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></li></ol></li><li><p>注意事项：</p><ol><li><p><strong>存在数据安全问题</strong>：由于 JSONP 是通过执行返回的 JavaScript 代码来实现数据传输的，如果不对返回的数据进行验证，可能会执行恶意代码。</p></li><li><p><strong>支持有限</strong>：JSONP 只支持 <code>GET</code> 请求，不支持其他 HTTP 方法（如 <code>POST</code>、<code>PUT</code>、<code>DELETE</code> 等）。因此，它只适用于获取数据的场景。</p></li><li><p>推荐使用<strong>现代跨域解决方案</strong>：CORS（Cross-Origin Resource Sharing）跨域资源共享，允许浏览器向跨域服务器发送请求并接受响应。<strong>通过设置适当的 HTTP 头，服务器可以指示浏览器允许跨域请求，不受同源策略控制，报错。</strong></p><ol><li><p><strong>就是设置对应的响应头（跨域资源共享头cors头），告诉浏览器允许跨域请求</strong>。</p></li><li><p>主要的 CORS 头部：</p><ol><li><p><strong>Access-Control-Allow-Origin</strong>：指定允许的源。 <code>*</code> 表示允许所有源。</p></li><li><p><strong>Access-Control-Allow-Methods</strong>：指定允许的 HTTP 方法。</p></li><li><p><strong>Access-Control-Allow-Headers</strong>：指定允许的请求头。</p></li><li><p><strong>Access-Control-Allow-Credentials</strong>：指示是否允许发送凭证。</p></li><li><p><strong>Access-Control-Expose-Headers</strong>：指定可以暴露的响应头。</p></li><li><p><strong>Access-Control-Max-Age</strong>：指定预检请求结果的缓存时间。</p></li><li><p>注意：以上头都只有在跨域请求中才会进行校验。</p><p>示例：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;github.com/gin-gonic/gin&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;net/http&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>CORSMiddleware</span><span class=p>()</span> <span class=nx>gin</span><span class=p>.</span><span class=nx>HandlerFunc</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kd>func</span><span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>gin</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>c</span><span class=p>.</span><span class=nx>Writer</span><span class=p>.</span><span class=nf>Header</span><span class=p>().</span><span class=nf>Set</span><span class=p>(</span><span class=s>&#34;Access-Control-Allow-Origin&#34;</span><span class=p>,</span> <span class=s>&#34;*&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>c</span><span class=p>.</span><span class=nx>Writer</span><span class=p>.</span><span class=nf>Header</span><span class=p>().</span><span class=nf>Set</span><span class=p>(</span><span class=s>&#34;Access-Control-Allow-Methods&#34;</span><span class=p>,</span> <span class=s>&#34;GET, POST, OPTIONS&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>c</span><span class=p>.</span><span class=nx>Writer</span><span class=p>.</span><span class=nf>Header</span><span class=p>().</span><span class=nf>Set</span><span class=p>(</span><span class=s>&#34;Access-Control-Allow-Headers&#34;</span><span class=p>,</span> <span class=s>&#34;Origin, Content-Type, Accept&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>c</span><span class=p>.</span><span class=nx>Request</span><span class=p>.</span><span class=nx>Method</span> <span class=o>==</span> <span class=s>&#34;OPTIONS&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>c</span><span class=p>.</span><span class=nf>AbortWithStatus</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nx>StatusNoContent</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nx>c</span><span class=p>.</span><span class=nf>Next</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>r</span> <span class=o>:=</span> <span class=nx>gin</span><span class=p>.</span><span class=nf>Default</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nx>r</span><span class=p>.</span><span class=nf>Use</span><span class=p>(</span><span class=nf>CORSMiddleware</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>r</span><span class=p>.</span><span class=nf>GET</span><span class=p>(</span><span class=s>&#34;/data&#34;</span><span class=p>,</span> <span class=kd>func</span><span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>gin</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>data</span> <span class=o>:=</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kd>interface</span><span class=p>{}{</span>
</span></span><span class=line><span class=cl>            <span class=s>&#34;message&#34;</span><span class=p>:</span> <span class=s>&#34;Hello, World!&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s>&#34;status&#34;</span><span class=p>:</span>  <span class=s>&#34;success&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=nx>c</span><span class=p>.</span><span class=nf>JSON</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nx>StatusOK</span><span class=p>,</span> <span class=nx>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>r</span><span class=p>.</span><span class=nf>Run</span><span class=p>(</span><span class=s>&#34;:8080&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>本文后面会介绍<a class=link href=#%e4%b8%ad%e9%97%b4%e4%bb%b6>Gin中间件</a>。</p></li></ol></li><li><p>在Gin框架中，Gin 官方推荐使用 <code>gin-contrib/cors</code> 中间件来设置 CORS 头部。</p><ul><li>不出意外的话，后面会出一篇关于cors详细介绍以及<a class=link href=https://github.com/gin-contrib/cors target=_blank rel=noopener>gin-contrib/cors</a>使用的文章：<a class=link href=https://arlettebrook.github.io/p/cors-introduction target=_blank rel=noopener>Cors Introduction</a>。</li></ul></li></ol></li></ol></li></ul><h3 id=以xml格式响应请求>以xml格式响应请求</h3><p>通过<code>XML</code>方法返回xml数据</p><p>方法定义：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-GO data-lang=GO><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>Context</span><span class=p>)</span> <span class=nf>XML</span><span class=p>(</span><span class=nx>code</span> <span class=kt>int</span><span class=p>,</span> <span class=nx>obj</span> <span class=nx>any</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>该方法与<code>JSON</code>方法类似。</p><p>参数说明：</p><ul><li>code：响应的http状态码。</li><li>obj：响应的xml数据。类型是能够序列化成xml数据的类型，如map[string]any、结构体对象。</li></ul><p>示例：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>User</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>Id</span>   <span class=kt>int</span>    <span class=s>`form:&#34;id&#34; json:&#34;id&#34; xml:&#34;id&#34; uri:&#34;id&#34; binding:&#34;required&#34;`</span>
</span></span><span class=line><span class=cl>	<span class=nx>Name</span> <span class=kt>string</span> <span class=s>`form:&#34;name&#34; json:&#34;name&#34; xml:&#34;name&#34; uri:&#34;name&#34;`</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span> 
</span></span><span class=line><span class=cl>    <span class=nx>r</span> <span class=o>:=</span> <span class=nx>gin</span><span class=p>.</span><span class=nf>Default</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=c1>// gin.H 是 map[string]interface{}的缩写 
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>r</span><span class=p>.</span><span class=nf>GET</span><span class=p>(</span><span class=s>&#34;/someXML&#34;</span><span class=p>,</span> <span class=kd>func</span><span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>gin</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>c</span><span class=p>.</span><span class=nf>XML</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nx>StatusOK</span><span class=p>,</span> <span class=nx>gin</span><span class=p>.</span><span class=nx>H</span><span class=p>{</span><span class=s>&#34;message&#34;</span><span class=p>:</span> <span class=s>&#34;Hello world!&#34;</span><span class=p>})</span> <span class=c1>// &lt;map&gt;&lt;message&gt;Hello world!&lt;/message&gt;&lt;/map&gt;
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>})</span> 
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nx>r</span><span class=p>.</span><span class=nf>GET</span><span class=p>(</span><span class=s>&#34;/moreXML&#34;</span><span class=p>,</span> <span class=kd>func</span><span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>gin</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=c1>// 方法二：使用结构体 
</span></span></span><span class=line><span class=cl><span class=c1></span>       <span class=nx>u</span> <span class=o>:=</span> <span class=nx>models</span><span class=p>.</span><span class=nx>User</span><span class=p>{</span><span class=nx>Id</span><span class=p>:</span> <span class=mi>123</span><span class=p>,</span> <span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;Marry&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>c</span><span class=p>.</span><span class=nf>XML</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nx>StatusOK</span><span class=p>,</span> <span class=nx>u</span><span class=p>)</span>  <span class=c1>// &lt;User&gt;&lt;id&gt;123&lt;/id&gt;&lt;name&gt;Marry&lt;/name&gt;&lt;/User&gt;
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>})</span> 
</span></span><span class=line><span class=cl>    <span class=nx>r</span><span class=p>.</span><span class=nf>Run</span><span class=p>(</span><span class=s>&#34;localhost:8080&#34;</span><span class=p>)</span> 
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=以文件格式响应请求>以文件格式响应请求</h3><p>下面介绍gin框架如何响应一个文件，可以用来做文件下载。</p><p>响应文件用<code>File</code>或<code>FileAttachment</code>方法：</p><ul><li><code>File</code>方法：<ul><li>直接响应文件，Gin框架会自动根据文件类型设置MIME类型，浏览器会自动根据MEM类型I处理文件（显示文件）。</li><li>只接收一个参数：为响应文件的本地系统路径。</li></ul></li><li><code>FileAttachment</code>方法：<ul><li>直接下载文件，会弹出下载框。文件名为给定的第二个参数。</li><li>有两个参数：第一个参数与<code>File</code>的参数一直，第二个参数：指定文件下载的名称。</li></ul></li></ul><p>原理：<code>FileAttachment</code>会比<code>File</code>多设置一个响应头<code>Content-Disposition:attachment; filename="filename"</code>，告诉浏览器将文件作为附加下载。</p><h3 id=设置http响应头设置header>设置http响应头（设置Header）</h3><p>在Gin框架中：</p><ul><li><p>获取请求头的方法是<code>func (c *Context) GetHeader(key string)</code>。</p></li><li><p>将请求头与结构体绑定的方法是<code>BindHeader</code>或<code>ShouldBindHeader</code>。</p><ul><li>二者区别是：<code>BindHeader</code>绑定失败，会自动响应400错误，而<code>ShouldBind</code>不会，需要手动响应错误。</li></ul></li><li><p>设置响应头的方法是<code>func (c *Context) Header(key, value string)</code>：</p><ul><li><p>支持反复设置响应头。</p></li><li><p>若键的值为空，将删除该响应头。</p></li><li><p>设置响应头应该在响应前设置，响应后设置无效。</p></li><li><p>源码：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>Context</span><span class=p>)</span> <span class=nf>Header</span><span class=p>(</span><span class=nx>key</span><span class=p>,</span> <span class=nx>value</span> <span class=kt>string</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>value</span> <span class=o>==</span> <span class=s>&#34;&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>c</span><span class=p>.</span><span class=nx>Writer</span><span class=p>.</span><span class=nf>Header</span><span class=p>().</span><span class=nf>Del</span><span class=p>(</span><span class=nx>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>c</span><span class=p>.</span><span class=nx>Writer</span><span class=p>.</span><span class=nf>Header</span><span class=p>().</span><span class=nf>Set</span><span class=p>(</span><span class=nx>key</span><span class=p>,</span> <span class=nx>value</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></li></ul></li></ul><hr><h2 id=html模板渲染>HTML模板渲染</h2><p>前面详细介绍了gin框架响应不同类型的参数，其实还漏掉了响应html模板渲染。因为涉及到go模板渲染，就单独拿出来介绍。</p><p>Gin框架默认封装了golang内置的html/template包用于处理html模版，如果你开发的是接口服务，不提供html页面可以跳过本章内容。</p><p><strong>作用</strong>：Gin框架内置的模板渲染功能，可以通过http请求，就可以生成安全的HTML内容，如动态网页、邮件内容、HTML报告等。同时简化了动态HTML页面的生成过程，通过设置模板目录和在路由处理函数中渲染模板，可以轻松地生成包含动态数据的网页。此功能有助于分离业务逻辑和表示层，提高代码的可维护性，并且通过自动HTML转义，提高了Web应用的安全性。</p><p>go模板渲染参考文章：<a class=link href=https://arlettebrook.github.io/p/template-introduction/ target=_blank rel=noopener>《Template Introduction》</a></p><p>下面主要介绍Gin框架封装的<code>html/template</code>模板渲染与内置的<code>html/template</code>模板渲染的区别。</p><ol><li><p><strong>解析模板并创建模板对象</strong>：</p><div class=table-wrapper><table><thead><tr><th>作用</th><th style=text-align:left>Go内置</th><th style=text-align:left>Gin封装</th></tr></thead><tbody><tr><td>指定解析的模板文件</td><td style=text-align:left><code>func (t *Template) ParseFiles(filenames ...string) (*Template, error)</code></td><td style=text-align:left><code>func (engine *Engine) LoadHTMLFiles(files ...string)</code></td></tr><tr><td>根据匹配模式解析模板文件（<strong>推荐</strong>）</td><td style=text-align:left><code>func (t *Template) ParseGlob(pattern string) (*Template, error)</code></td><td style=text-align:left><code>func (engine *Engine) LoadHTMLGlob(pattern string)</code></td></tr></tbody></table></div></li><li><p><strong>渲染模板对象</strong>，改成：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>Context</span><span class=p>)</span> <span class=nf>HTML</span><span class=p>(</span><span class=nx>code</span> <span class=kt>int</span><span class=p>,</span> <span class=nx>name</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>obj</span> <span class=nx>any</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>code：状态码。</p><p>name：模板名称。</p><p>obj：渲染的数据。</p></li><li><p>其他主要区别：</p><ul><li><p>将语法分隔符<code>Delims</code>、自定义模板函数映射<code>FuncMap</code>等方法的对象改成了模板引擎对象<code>engine *Engine</code>，<strong>不需要我们在手动创建模板对象</strong>。</p></li><li><p>自定义模板函数也不需要我们手动添加（<code>Funcs</code>）自定义模板函数<strong>映射</strong><code>FuncMap</code>。</p></li></ul></li><li><p>其余的模板语法，模板嵌套，模板函数，自动HTML内容转义，重写模板等使用都与内置的<code>html/template</code>一模一样。</p></li><li><p>示例：</p><p>templates/default/hello.tmpl：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl>{[ define &#34;default/hello.tmpl&#34; -]}
</span></span><span class=line><span class=cl><span class=cp>&lt;!DOCTYPE html&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>html</span> <span class=na>lang</span><span class=o>=</span><span class=s>&#34;en&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>head</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>	<span class=p>&lt;</span><span class=nt>meta</span> <span class=na>charset</span><span class=o>=</span><span class=s>&#34;UTF-8&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>	<span class=p>&lt;</span><span class=nt>meta</span> <span class=na>http-equiv</span><span class=o>=</span><span class=s>&#34;X-UA-Compatible&#34;</span> <span class=na>content</span><span class=o>=</span><span class=s>&#34;IE=edge&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>	<span class=p>&lt;</span><span class=nt>meta</span> <span class=na>name</span><span class=o>=</span><span class=s>&#34;viewport&#34;</span> <span class=na>content</span><span class=o>=</span><span class=s>&#34;width=device-width, initial-scale=1.0&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>	<span class=p>&lt;</span><span class=nt>title</span><span class=p>&gt;</span>Document<span class=p>&lt;/</span><span class=nt>title</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>head</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>body</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>	<span class=p>&lt;</span><span class=nt>h1</span><span class=p>&gt;</span>模板渲染<span class=p>&lt;/</span><span class=nt>h1</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>	<span class=p>&lt;</span><span class=nt>h3</span><span class=p>&gt;</span>Your message is: {[ ToUpper . ]}
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>h3</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>body</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>html</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>{[- end ]}
</span></span></code></pre></td></tr></table></div></div><p>main.go:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl>	<span class=nx>r</span> <span class=o>:=</span> <span class=nx>gin</span><span class=p>.</span><span class=nf>Default</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>r</span><span class=p>.</span><span class=nf>Delims</span><span class=p>(</span><span class=s>&#34;{[&#34;</span><span class=p>,</span> <span class=s>&#34;]}&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>r</span><span class=p>.</span><span class=nx>FuncMap</span> <span class=p>=</span> <span class=nx>template</span><span class=p>.</span><span class=nx>FuncMap</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=s>&#34;ToUpper&#34;</span><span class=p>:</span> <span class=nx>strings</span><span class=p>.</span><span class=nx>ToUpper</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>r</span><span class=p>.</span><span class=nf>LoadHTMLGlob</span><span class=p>(</span><span class=s>&#34;templates/**/*.tmpl&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>r</span><span class=p>.</span><span class=nf>GET</span><span class=p>(</span><span class=s>&#34;/html&#34;</span><span class=p>,</span> <span class=kd>func</span><span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>gin</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>msg</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>Query</span><span class=p>(</span><span class=s>&#34;msg&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=nx>c</span><span class=p>.</span><span class=nf>HTML</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nx>StatusOK</span><span class=p>,</span> <span class=s>&#34;default/hello.tmpl&#34;</span><span class=p>,</span> <span class=nx>msg</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>})</span>
</span></span></code></pre></td></tr></table></div></div><p>启动http服务访问[http://localhost:8181/html?msg=Hello, worrld!](http://localhost:8181/html?msg=Hello, worrld!)<strong>将响应渲染之后的HTML内容</strong>。</p><p>浏览器呈现为：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>模板渲染
</span></span><span class=line><span class=cl>Your message is: HELLO, WORRLD!
</span></span></code></pre></td></tr></table></div></div><p>响应的html源码为：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=cp>&lt;!DOCTYPE html&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>html</span> <span class=na>lang</span><span class=o>=</span><span class=s>&#34;en&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>head</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>	<span class=p>&lt;</span><span class=nt>meta</span> <span class=na>charset</span><span class=o>=</span><span class=s>&#34;UTF-8&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>	<span class=p>&lt;</span><span class=nt>meta</span> <span class=na>http-equiv</span><span class=o>=</span><span class=s>&#34;X-UA-Compatible&#34;</span> <span class=na>content</span><span class=o>=</span><span class=s>&#34;IE=edge&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>	<span class=p>&lt;</span><span class=nt>meta</span> <span class=na>name</span><span class=o>=</span><span class=s>&#34;viewport&#34;</span> <span class=na>content</span><span class=o>=</span><span class=s>&#34;width=device-width, initial-scale=1.0&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>	<span class=p>&lt;</span><span class=nt>title</span><span class=p>&gt;</span>Document<span class=p>&lt;/</span><span class=nt>title</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>head</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>body</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>	<span class=p>&lt;</span><span class=nt>h1</span><span class=p>&gt;</span>模板渲染<span class=p>&lt;/</span><span class=nt>h1</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>	<span class=p>&lt;</span><span class=nt>h3</span><span class=p>&gt;</span>Your message is: HELLO, WORRLD!
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>h3</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>body</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>html</span><span class=p>&gt;</span>
</span></span></code></pre></td></tr></table></div></div></li></ol><hr><h2 id=静态文件服务>静态文件服务</h2><p>当我们渲染的HTML文件中引用了静态文件时，就需要配置静态文件服务。以便js、css、jpg之类的静态文件能够正常响应。</p><p>在Gin框架中访问静态资源文件通常是通过设置一个<strong>静态文件服务</strong>来实现的。Gin提供了一个非常方便的方法来处理这一任务。</p><p>配置静态文件服务常用的两个方法：</p><ol><li><p>映射静态资源目录：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// 设置静态文件夹，URL路径 /static 映射到文件系统中的 assets 文件夹
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>router</span><span class=p>.</span><span class=nf>Static</span><span class=p>(</span><span class=s>&#34;/static&#34;</span><span class=p>,</span> <span class=s>&#34;./assets&#34;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p><code>router.Static("/static", "./static")</code>方法的第一个参数是URL路径前缀，第二个参数是文件系统中的路径。当访问<code>http://localhost:8080/static/css/styles.css</code>时，Gin会在文件系统的<code>./assets/css/styles.css</code>路径查找文件并返回给客户端。</p><p><strong>注意事项</strong>：URL路径前缀建议为一个静态资源路径<code>/static</code>，要<strong>避免路由重复</strong>。底层是通过<code>/static/*filepath</code>匹配的，如果为<code>/</code>将匹配所有的路径，后续配置的路径将失效，Gin服务启动也会失败。</p></li><li><p>映射单个静态资源文件：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl> <span class=c1>// 可以使用 router.StaticFile 来设置单个文件的静态路径
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>router</span><span class=p>.</span><span class=nf>StaticFile</span><span class=p>(</span><span class=s>&#34;/favicon.ico&#34;</span><span class=p>,</span> <span class=s>&#34;./assets/favicon.ico&#34;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>第一个参数：访问路径。第二个参数：文件系统中的路径。</p><p>对于<code>/favicon.ico</code>URL路径，是一个特殊的路径，用于<strong>请求浏览器标签页的图标</strong>。</p><p>当我们使用浏览器访问任何网站时，浏览器会<strong>自动请求</strong><code>/favicon.ico</code>路径，以便正常显示标签页图标。失败会显示一个地球。</p><p>为了提升用户体验和网站的识别度，通常都会配置网站图标的静态资源映射。</p><p>因此会用到映射单个静态资源文件<code>StaticFile</code>，注意不能使用映射静态资源目录，因为浏览器<strong>自动请求</strong>网站图标的路径是在根目录。</p><p><strong>提示</strong>：</p><ul><li><p>网站图标（标签页图标）很小，格式为ico(x-icon)，名为favicon，可以通过图标生成器生成。如：<a class=link href=https://www.logosc.cn/logo/favicon target=_blank rel=noopener>Favicon.ico图标在线生成器</a>。</p></li><li><p>默认的网页图标路径是<code>域名/favicon</code>，当然也可以自定义，通过<code>link</code>标签：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl> <span class=c>&lt;!-- 定义网页的favicon 下面的href属性默认为/favicon.ico --&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>link</span> <span class=na>rel</span><span class=o>=</span><span class=s>&#34;icon&#34;</span> <span class=na>type</span><span class=o>=</span><span class=s>&#34;image/x-icon&#34;</span> <span class=na>href</span><span class=o>=</span><span class=s>&#34;//www.example.com/static/favicon.ico&#34;</span> <span class=p>&gt;</span>
</span></span></code></pre></td></tr></table></div></div></li></ul></li></ol><hr><h2 id=gin中间件>Gin中间件</h2><p>在Gin框架中，<strong>中间件</strong>（Middleware）指的是可以拦截<strong>http请求-响应</strong>生命周期的<strong>特殊函数</strong>，在请求-响应生命周期中可以注册多个中间件，每个中间件执行不同的功能，一个中间执行完再轮到下一个中间件执行。</p><p>通俗的讲：中间件就是匹配路由前和匹配路由后执行的一系列操作。</p><p><strong>中间件的常见应用场景如下：</strong></p><ol><li><strong>日志记录</strong>：记录每个请求的详细信息，例如请求方法、路径、状态码和处理时间。</li><li><strong>认证和授权</strong>：检查请求是否包含有效的认证信息，决定是否允许访问资源。</li><li><strong>错误处理</strong>：捕获和处理请求过程中发生的错误，返回统一的错误响应。</li><li><strong>数据验证</strong>：在请求到达处理器之前对请求数据进行验证。</li><li><strong>CORS处理</strong>：处理跨域资源共享（CORS）的相关设置，允许或拒绝跨域请求。、</li><li><strong>限流</strong>：限制客户端在一定时间内的请求数量，防止过载。</li></ol><h3 id=使用中间件>使用中间件</h3><ol><li><p><strong>定义中间件</strong>：</p><p>中间件本质上是一个 Gin 处理函数（控制器函数：<code>gin.HandlerFunc</code>），接受 <code>*gin.Context</code> 作为参数。</p><p>所以定义中间件可以定义一个函数，返回值是<code>gin.HandlerFunc</code>类型，即返回将<code>*gin.Context</code> 作为参数的函数即可。</p><p>或者直接定义<code>gin.HandlerFunc</code>函数，跟定义控制器函数类似。</p><p>例如，定义一个简单的日志中间件：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>LoggerMiddleware</span><span class=p>()</span> <span class=nx>gin</span><span class=p>.</span><span class=nx>HandlerFunc</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=kd>func</span><span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>gin</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// 记录请求开始时间
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>startTime</span> <span class=o>:=</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=c1>// 处理请求
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>c</span><span class=p>.</span><span class=nf>Next</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=c1>// 记录处理时间
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>duration</span> <span class=o>:=</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Since</span><span class=p>(</span><span class=nx>startTime</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Request %s %s took %v&#34;</span><span class=p>,</span> <span class=nx>c</span><span class=p>.</span><span class=nx>Request</span><span class=p>.</span><span class=nx>Method</span><span class=p>,</span> <span class=nx>c</span><span class=p>.</span><span class=nx>Request</span><span class=p>.</span><span class=nx>URL</span><span class=p>.</span><span class=nx>Path</span><span class=p>,</span> <span class=nx>duration</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p><code>Next</code>方法是<strong>调用该路由剩余的控制器函数</strong>，当剩余的控制器函数执行完毕之后，继续执行后面的代码，起到放行的作用。</p><p>​ 当存在多个中间件时，执行顺序依此类推。</p><p>​ 与之相反的方法<code>Abort</code>，<strong>终止调用剩余的控制器函数</strong>，起到不放行的作用。</p><p>​ <strong>如果没有调用以上两个方法，会依次按照注册顺序执行控制器函数。</strong></p><p>所有控制器函数执行完毕之后，意味着本次请求处理完毕。因此上面演示了记录处理一次请求所花费的时间。（注意：要将其注册为第一个中间件。）</p></li><li><p><strong>使用中间件</strong>：</p><ul><li><p><strong>全局中间件</strong></p><p>可以在创建路由器时使用 <code>Use</code> 方法注册<strong>全局中间件</strong>，这样<strong>所有请求都会经过该中间件</strong>。</p><p>​ 注意：<code>Use</code>方法可以一次性注册一个或多个中间件。</p><p>示例：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>r</span> <span class=o>:=</span> <span class=nx>gin</span><span class=p>.</span><span class=nf>Default</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 注册全局中间件
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>r</span><span class=p>.</span><span class=nf>Use</span><span class=p>(</span><span class=nf>LoggerMiddleware</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 定义路由
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>r</span><span class=p>.</span><span class=nf>GET</span><span class=p>(</span><span class=s>&#34;/ping&#34;</span><span class=p>,</span> <span class=kd>func</span><span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>gin</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>c</span><span class=p>.</span><span class=nf>JSON</span><span class=p>(</span><span class=mi>200</span><span class=p>,</span> <span class=nx>gin</span><span class=p>.</span><span class=nx>H</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s>&#34;message&#34;</span><span class=p>:</span> <span class=s>&#34;pong&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>r</span><span class=p>.</span><span class=nf>Run</span><span class=p>()</span> <span class=c1>// 启动服务器
</span></span></span></code></pre></td></tr></table></div></div></li><li><p><strong>路由组中间件</strong></p><p>也可以在特定的路由组中使用中间件，这样只有指定组经过该中间件。例如：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>r</span> <span class=o>:=</span> <span class=nx>gin</span><span class=p>.</span><span class=nf>Default</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 定义一个需要认证的路由组
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>authGroup</span> <span class=o>:=</span> <span class=nx>r</span><span class=p>.</span><span class=nf>Group</span><span class=p>(</span><span class=s>&#34;/auth&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>authGroup</span><span class=p>.</span><span class=nf>Use</span><span class=p>(</span><span class=nf>AuthMiddleware</span><span class=p>())</span> <span class=c1>// 注册中间件
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>authGroup</span><span class=p>.</span><span class=nf>GET</span><span class=p>(</span><span class=s>&#34;/profile&#34;</span><span class=p>,</span> <span class=kd>func</span><span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>gin</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>c</span><span class=p>.</span><span class=nf>JSON</span><span class=p>(</span><span class=mi>200</span><span class=p>,</span> <span class=nx>gin</span><span class=p>.</span><span class=nx>H</span><span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s>&#34;user&#34;</span><span class=p>:</span> <span class=s>&#34;John Doe&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>r</span><span class=p>.</span><span class=nf>Run</span><span class=p>()</span> <span class=c1>// 启动服务器
</span></span></span></code></pre></td></tr></table></div></div></li><li><p><strong>单独使用中间件</strong></p><p>如果只希望在某个特定路由上使用中间件，可以直接在定义路由时使用，这样只有该路由经过中间件。例如：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>r</span> <span class=o>:=</span> <span class=nx>gin</span><span class=p>.</span><span class=nf>Default</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 单独为某个路由使用中间件
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>r</span><span class=p>.</span><span class=nf>GET</span><span class=p>(</span><span class=s>&#34;/secure&#34;</span><span class=p>,</span> <span class=nf>AuthMiddleware</span><span class=p>(),</span> <span class=kd>func</span><span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>gin</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>c</span><span class=p>.</span><span class=nf>JSON</span><span class=p>(</span><span class=mi>200</span><span class=p>,</span> <span class=nx>gin</span><span class=p>.</span><span class=nx>H</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s>&#34;message&#34;</span><span class=p>:</span> <span class=s>&#34;secure&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>r</span><span class=p>.</span><span class=nf>Run</span><span class=p>()</span> <span class=c1>// 启动服务器
</span></span></span></code></pre></td></tr></table></div></div><p>前面介绍了Gin中间件的本质就是控制器函数，因此配置路由时，最后一个控制器函数前面的控制器函数都是中间件。</p><p>因此路由组中间件还可以写成：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>r</span> <span class=o>:=</span> <span class=nx>gin</span><span class=p>.</span><span class=nf>Default</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 定义一个需要认证的路由组并注册中间件
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>authGroup</span> <span class=o>:=</span> <span class=nx>r</span><span class=p>.</span><span class=nf>Group</span><span class=p>(</span><span class=s>&#34;/auth&#34;</span><span class=p>,</span> <span class=nf>AuthMiddleware</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=c1>// authGroup.Use(AuthMiddleware()) // 注册中间件
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>authGroup</span><span class=p>.</span><span class=nf>GET</span><span class=p>(</span><span class=s>&#34;/profile&#34;</span><span class=p>,</span> <span class=kd>func</span><span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>gin</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>c</span><span class=p>.</span><span class=nf>JSON</span><span class=p>(</span><span class=mi>200</span><span class=p>,</span> <span class=nx>gin</span><span class=p>.</span><span class=nx>H</span><span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s>&#34;user&#34;</span><span class=p>:</span> <span class=s>&#34;John Doe&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>r</span><span class=p>.</span><span class=nf>Run</span><span class=p>()</span> <span class=c1>// 启动服务器
</span></span></span></code></pre></td></tr></table></div></div></li></ul></li></ol><h3 id=中间件之间共享数据>中间件之间共享数据</h3><p>中间件间与对应控制器之间<strong>共享数据</strong>是通过上下文的<code>Set</code>方法和<code>Get</code>方法实现的，存储的是键值对，key是string类型，value是any类型。共享范围仅在本次请求中。生命周期是本次请求结束，自动销毁。Gin框架没有提供主动删除共享数据的方法，可以在请求中将共享数据的值设为nil，起到删除的效果。</p><p>示例：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>AuthMiddleware</span><span class=p>()</span> <span class=nx>gin</span><span class=p>.</span><span class=nx>HandlerFunc</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=kd>func</span><span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>gin</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// 模拟鉴权：获取username成功表示通过
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>username</span><span class=p>,</span> <span class=nx>f</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>GetPostForm</span><span class=p>(</span><span class=s>&#34;username&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>!</span><span class=nx>f</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>c</span><span class=p>.</span><span class=nf>Abort</span><span class=p>()</span>
</span></span><span class=line><span class=cl>			<span class=nx>c</span><span class=p>.</span><span class=nf>String</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nx>StatusUnauthorized</span><span class=p>,</span> <span class=s>&#34;未授权!&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>c</span><span class=p>.</span><span class=nf>Set</span><span class=p>(</span><span class=s>&#34;username&#34;</span><span class=p>,</span> <span class=nx>username</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>c</span><span class=p>.</span><span class=nf>Next</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>manageRouter</span> <span class=o>:=</span> <span class=nx>r</span><span class=p>.</span><span class=nf>Group</span><span class=p>(</span><span class=s>&#34;/manage&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>manageRouter</span><span class=p>.</span><span class=nf>Use</span><span class=p>(</span><span class=nf>AuthMiddleware</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>manageRouter</span><span class=p>.</span><span class=nf>POST</span><span class=p>(</span><span class=s>&#34;/addUser&#34;</span><span class=p>,</span> <span class=kd>func</span><span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>gin</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>username</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=s>&#34;username&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>c</span><span class=p>.</span><span class=nf>JSON</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nx>StatusOK</span><span class=p>,</span> <span class=nx>gin</span><span class=p>.</span><span class=nx>H</span><span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s>&#34;msg&#34;</span><span class=p>:</span>      <span class=s>&#34;Add user&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s>&#34;username&#34;</span><span class=p>:</span> <span class=nx>username</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=内置中间件>内置中间件</h3><p>Gin 提供了一些内置中间件，常用的有：</p><ul><li><code>Logger()</code>: 日志中间件，记录请求日志。<ul><li>注意：无论Gin是debug或者release模式，都会记录请求日志。</li></ul></li><li><code>Recovery()</code>: 恢复中间件，捕获任何恐慌（panic），并返回 500 错误。</li><li><code>gin.BasicAuth()</code>: 基本认证中间件。</li></ul><p>使用 <code>gin.Default()</code> 创建的默认路由引擎，默认使用了Logger和Recovery中间件。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>Default</span><span class=p>(</span><span class=nx>opts</span> <span class=o>...</span><span class=nx>OptionFunc</span><span class=p>)</span> <span class=o>*</span><span class=nx>Engine</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nf>debugPrintWARNINGDefault</span><span class=p>()</span> <span class=c1>// 打印日志：记录使用的中间件以及go版本要求
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>engine</span> <span class=o>:=</span> <span class=nf>New</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>engine</span><span class=p>.</span><span class=nf>Use</span><span class=p>(</span><span class=nf>Logger</span><span class=p>(),</span> <span class=nf>Recovery</span><span class=p>())</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>engine</span><span class=p>.</span><span class=nf>With</span><span class=p>(</span><span class=nx>opts</span><span class=o>...</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>如果不想使用上面两个默认的中间件，可以使用 <code>gin.New()</code> 新建一个没有任何默认中间件的路由引擎。</p><p>使用方式与自定义中间件类似。例如：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>r</span> <span class=o>:=</span> <span class=nx>gin</span><span class=p>.</span><span class=nf>New</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 使用内置的日志和恢复中间件
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>r</span><span class=p>.</span><span class=nf>Use</span><span class=p>(</span><span class=nx>gin</span><span class=p>.</span><span class=nf>Logger</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=nx>r</span><span class=p>.</span><span class=nf>Use</span><span class=p>(</span><span class=nx>gin</span><span class=p>.</span><span class=nf>Recovery</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>r</span><span class=p>.</span><span class=nf>GET</span><span class=p>(</span><span class=s>&#34;/ping&#34;</span><span class=p>,</span> <span class=kd>func</span><span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>gin</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>c</span><span class=p>.</span><span class=nf>JSON</span><span class=p>(</span><span class=mi>200</span><span class=p>,</span> <span class=nx>gin</span><span class=p>.</span><span class=nx>H</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s>&#34;message&#34;</span><span class=p>:</span> <span class=s>&#34;pong&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>r</span><span class=p>.</span><span class=nf>Run</span><span class=p>()</span> <span class=c1>// 启动服务器
</span></span></span></code></pre></td></tr></table></div></div><p>上面示例与使用<code>gin.Default()</code>创建的路由引擎唯一区别是没有记录使用的中间件以及go版本要求。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>debugPrintWARNINGDefault</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>v</span><span class=p>,</span> <span class=nx>e</span> <span class=o>:=</span> <span class=nf>getMinVer</span><span class=p>(</span><span class=nx>runtime</span><span class=p>.</span><span class=nf>Version</span><span class=p>());</span> <span class=nx>e</span> <span class=o>==</span> <span class=kc>nil</span> <span class=o>&amp;&amp;</span> <span class=nx>v</span> <span class=p>&lt;</span> <span class=nx>ginSupportMinGoVer</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nf>debugPrint</span><span class=p>(</span><span class=s>`[WARNING] Now Gin requires Go 1.18+.
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>`</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nf>debugPrint</span><span class=p>(</span><span class=s>`[WARNING] Creating an Engine instance with the Logger and Recovery middleware already attached.
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>`</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=中间件的执行顺序>中间件的执行顺序</h3><p>Gin 中间件按照注册顺序执行。对于每个请求，所有中间件会按照注册的顺序依次执行 <code>c.Next()</code> 之前的代码，当一个中间件调用 <code>c.Next()</code> 时，控制权传递给下一个中间件，所有中间件执行完之后再按逆序执行 <code>c.Next()</code> 之后的代码。</p><h3 id=中间件中使用goroutine>中间件中使用goroutine</h3><p>当在中间件或控制器函数中启动新的goroutine时，不能使用原始的上下文（<code>c *gin.Context</code>），因为 <code>gin.Context</code> <strong>不是线程安全的</strong>。在 goroutine 中直接访问 <code>gin.Context</code> 的字段可能会导致竞态条件（race condition）和不可预测的行为。</p><p><strong>中间件中使用 goroutine 的场景</strong></p><ol><li><strong>日志记录</strong>：异步记录日志以减少对请求处理时间的影响。</li><li><strong>异步处理</strong>：在响应请求后执行耗时的任务，例如发送通知邮件、清理资源等。</li><li><strong>并发处理</strong>：在请求处理中并发执行多个任务。</li></ol><p><strong>在中间件中使用 goroutine 的正确方式</strong></p><ol><li><p>安全地传递上下文数据</p><p>为了避免直接在 goroutine 中使用 <code>gin.Context</code>，我们可以在启动 goroutine 之前提取需要的数据，然后将这些数据传递给 goroutine。例如：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>AsyncLoggerMiddleware</span><span class=p>()</span> <span class=nx>gin</span><span class=p>.</span><span class=nx>HandlerFunc</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kd>func</span><span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>gin</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 提取需要的数据
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>method</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nx>Request</span><span class=p>.</span><span class=nx>Method</span>
</span></span><span class=line><span class=cl>        <span class=nx>path</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nx>Request</span><span class=p>.</span><span class=nx>URL</span><span class=p>.</span><span class=nx>Path</span>
</span></span><span class=line><span class=cl>        <span class=nx>clientIP</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>ClientIP</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// 启动一个 goroutine 进行异步日志记录
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>go</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Request %s %s from %s&#34;</span><span class=p>,</span> <span class=nx>method</span><span class=p>,</span> <span class=nx>path</span><span class=p>,</span> <span class=nx>clientIP</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// 继续处理请求
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>c</span><span class=p>.</span><span class=nf>Next</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></li><li><p>请求响应之后启动协程处理任务</p><p>可以在响应客户端后启动 goroutine 执行耗时操作，例如发送邮件通知：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>AsyncTaskMiddleware</span><span class=p>()</span> <span class=nx>gin</span><span class=p>.</span><span class=nx>HandlerFunc</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kd>func</span><span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>gin</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 提取需要的数据
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>userEmail</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nx>Request</span><span class=p>.</span><span class=nx>Header</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=s>&#34;User-Email&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// 继续处理请求
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>c</span><span class=p>.</span><span class=nf>Next</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// 在响应客户端后启动一个 goroutine 执行异步任务
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>go</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 模拟耗时任务，例如发送邮件
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=nx>time</span><span class=p>.</span><span class=nf>Sleep</span><span class=p>(</span><span class=mi>5</span> <span class=o>*</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Email sent to %s&#34;</span><span class=p>,</span> <span class=nx>userEmail</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}()</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></li><li><p>创建上下文副本</p><p>在 Gin 中使用 <code>c.Copy()</code> 方法可以在 goroutine 中安全地访问 <code>gin.Context</code> 的数据。<code>c.Copy()</code> 会创建并返回 <code>gin.Context</code> 的一个深拷贝，这样就可以避免竞态条件的问题。</p><p>以下是一个使用 <code>c.Copy()</code> 的示例，演示如何在 Gin 中间件中使用 goroutine 进行异步处理。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;log&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;time&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=s>&#34;github.com/gin-gonic/gin&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>AsyncLoggerMiddleware</span><span class=p>()</span> <span class=nx>gin</span><span class=p>.</span><span class=nx>HandlerFunc</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kd>func</span><span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>gin</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 复制上下文
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>cCp</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>Copy</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// 启动一个 goroutine 进行异步日志记录
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>go</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 模拟日志记录的耗时操作
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=nx>time</span><span class=p>.</span><span class=nf>Sleep</span><span class=p>(</span><span class=mi>2</span> <span class=o>*</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Request %s %s from %s&#34;</span><span class=p>,</span> <span class=nx>cCp</span><span class=p>.</span><span class=nx>Request</span><span class=p>.</span><span class=nx>Method</span><span class=p>,</span> <span class=nx>cCp</span><span class=p>.</span><span class=nx>Request</span><span class=p>.</span><span class=nx>URL</span><span class=p>.</span><span class=nx>Path</span><span class=p>,</span> <span class=nx>cCp</span><span class=p>.</span><span class=nf>ClientIP</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=p>}()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// 继续处理请求
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>c</span><span class=p>.</span><span class=nf>Next</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>AsyncTaskMiddleware</span><span class=p>()</span> <span class=nx>gin</span><span class=p>.</span><span class=nx>HandlerFunc</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kd>func</span><span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>gin</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 复制上下文
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>cCp</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>Copy</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// 继续处理请求
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>c</span><span class=p>.</span><span class=nf>Next</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// 在响应客户端后启动一个 goroutine 执行异步任务
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>go</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 模拟耗时任务，例如发送邮件
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=nx>time</span><span class=p>.</span><span class=nf>Sleep</span><span class=p>(</span><span class=mi>5</span> <span class=o>*</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nx>userEmail</span> <span class=o>:=</span> <span class=nx>cCp</span><span class=p>.</span><span class=nx>Request</span><span class=p>.</span><span class=nx>Header</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=s>&#34;User-Email&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Email sent to %s&#34;</span><span class=p>,</span> <span class=nx>userEmail</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}()</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>r</span> <span class=o>:=</span> <span class=nx>gin</span><span class=p>.</span><span class=nf>Default</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 注册中间件
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>r</span><span class=p>.</span><span class=nf>Use</span><span class=p>(</span><span class=nf>AsyncLoggerMiddleware</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=nx>r</span><span class=p>.</span><span class=nf>Use</span><span class=p>(</span><span class=nf>AsyncTaskMiddleware</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 定义路由
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>r</span><span class=p>.</span><span class=nf>GET</span><span class=p>(</span><span class=s>&#34;/ping&#34;</span><span class=p>,</span> <span class=kd>func</span><span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>gin</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>c</span><span class=p>.</span><span class=nf>JSON</span><span class=p>(</span><span class=mi>200</span><span class=p>,</span> <span class=nx>gin</span><span class=p>.</span><span class=nx>H</span><span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s>&#34;message&#34;</span><span class=p>:</span> <span class=s>&#34;pong&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 启动服务器
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>r</span><span class=p>.</span><span class=nf>Run</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>通过使用 <code>c.Copy()</code>，可以安全地在 Gin 中间件中使用 goroutine，提升应用的并发处理能力和响应效率。</p></li></ol><p>​</p><p><strong>注意事项</strong></p><ol><li><strong>线程安全</strong>：避免在 goroutine 中直接访问 <code>gin.Context</code> 的字段，应该在启动 goroutine 之前提取所需数据。</li><li><strong>资源泄漏</strong>：确保 goroutine 中的任务能够正常完成，避免因意外情况导致 goroutine 泄漏。</li><li><strong>错误处理</strong>：在 goroutine 中处理可能发生的错误，以免影响主请求的处理流程。</li><li><strong>使用深拷贝</strong>：确保在启动 goroutine 之前调用 <code>c.Copy()</code>，并在 goroutine 中使用返回的副本，而不是直接使用原始的 <code>gin.Context</code>。</li></ol><p>通过合理使用 goroutine，可以显著提升应用的并发处理能力，同时保持请求的快速响应。</p><h3 id=小结>小结</h3><p>中间件在 Gin 框架中起着至关重要的作用，可以帮助开发者实现日志记录、认证授权、错误处理等常见功能。Gin 提供了灵活的中间件使用方式，可以全局、路由组或者单独路由使用中间件，满足不同的需求。通过合理使用中间件，可以大大提升应用的结构和代码复用性。</p><hr><h2 id=gin文件上传>Gin文件上传</h2><p>在Gin框架中，处理文件上传是一项常见的任务。</p><p>Gin是一个高效的Go语言Web框架，提供了简洁而强大的API来处理HTTP请求，包括文件上传。下面是关于如何在Gin框架中处理文件上传的相关知识和示例代码。</p><h3 id=基本文件上传>基本文件上传</h3><p>Gin提供了方便的方法来处理单个文件的上传。以下是一个示例代码：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>form</span> <span class=na>action</span><span class=o>=</span><span class=s>&#34;/admin/user/doAdd&#34;</span> <span class=na>method</span><span class=o>=</span><span class=s>&#34;post&#34;</span> <span class=na>enctype</span><span class=o>=</span><span class=s>&#34;multipart/form-data&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>	用户名： <span class=p>&lt;</span><span class=nt>input</span> <span class=na>type</span><span class=o>=</span><span class=s>&#34;text&#34;</span> <span class=na>name</span><span class=o>=</span><span class=s>&#34;username&#34;</span> <span class=na>placeholder</span><span class=o>=</span><span class=s>&#34;用户名&#34;</span><span class=p>&gt;</span> <span class=p>&lt;</span><span class=nt>br</span><span class=p>&gt;</span> <span class=p>&lt;</span><span class=nt>br</span><span class=p>&gt;</span> 
</span></span><span class=line><span class=cl>    头 像1：<span class=p>&lt;</span><span class=nt>input</span> <span class=na>type</span><span class=o>=</span><span class=s>&#34;file&#34;</span> <span class=na>name</span><span class=o>=</span><span class=s>&#34;file1&#34;</span><span class=p>&gt;&lt;</span><span class=nt>br</span><span class=p>&gt;</span> <span class=p>&lt;</span><span class=nt>br</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    头 像2：<span class=p>&lt;</span><span class=nt>input</span> <span class=na>type</span><span class=o>=</span><span class=s>&#34;file&#34;</span> <span class=na>name</span><span class=o>=</span><span class=s>&#34;file2&#34;</span><span class=p>&gt;&lt;</span><span class=nt>br</span><span class=p>&gt;</span> <span class=p>&lt;</span><span class=nt>br</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>input</span> <span class=na>type</span><span class=o>=</span><span class=s>&#34;submit&#34;</span> <span class=na>value</span><span class=o>=</span><span class=s>&#34;提交&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>form</span><span class=p>&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>注意：需要在上传文件的 form 表单上面需要加入 enctype=&ldquo;multipart/form-data&rdquo;</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;net/http&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=s>&#34;github.com/gin-gonic/gin&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>r</span> <span class=o>:=</span> <span class=nx>gin</span><span class=p>.</span><span class=nf>Default</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nx>r</span><span class=p>.</span><span class=nf>POST</span><span class=p>(</span><span class=s>&#34;/upload&#34;</span><span class=p>,</span> <span class=kd>func</span><span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>gin</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>file1</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>FormFile</span><span class=p>(</span><span class=s>&#34;file1&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>file2</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>FormFile</span><span class=p>(</span><span class=s>&#34;file2&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>c</span><span class=p>.</span><span class=nf>String</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nx>StatusBadRequest</span><span class=p>,</span> <span class=s>&#34;Bad request: %s&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>err</span> <span class=p>=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>SaveUploadedFile</span><span class=p>(</span><span class=nx>file1</span><span class=p>,</span> <span class=nx>path</span><span class=p>.</span><span class=nf>Join</span><span class=p>(</span><span class=s>&#34;./uploads&#34;</span><span class=p>,</span> <span class=nx>file1</span><span class=p>.</span><span class=nx>Filename</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=nx>err</span> <span class=p>=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>SaveUploadedFile</span><span class=p>(</span><span class=nx>file2</span><span class=p>,</span> <span class=nx>path</span><span class=p>.</span><span class=nf>Join</span><span class=p>(</span><span class=s>&#34;./uploads&#34;</span><span class=p>,</span> <span class=nx>file2</span><span class=p>.</span><span class=nx>Filename</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>c</span><span class=p>.</span><span class=nf>String</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nx>StatusInternalServerError</span><span class=p>,</span> <span class=s>&#34;Could not save file: %s&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>c</span><span class=p>.</span><span class=nf>String</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nx>StatusOK</span><span class=p>,</span> <span class=s>&#34;File %s and %s uploaded successfully.&#34;</span><span class=p>,</span> <span class=nx>file1</span><span class=p>.</span><span class=nx>Filename</span><span class=p>,</span> <span class=nx>file2</span><span class=p>.</span><span class=nx>Filename</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>r</span><span class=p>.</span><span class=nf>Run</span><span class=p>(</span><span class=s>&#34;:8080&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>在这个例子中，Gin通过<code>c.FormFile("file")</code>方法获取上传的文件。</p><p>​ <code>FormFile</code>方法返回指定<strong>表单键</strong>（只能返回第一个）的<strong>描述多部分表单请求的文件部分</strong>对象。</p><p>​ 意思就是：根据多部分表单请求的文件部分的name属性获取文件部分对象<code>multipart.FileHeader</code>。</p><p>然后使用<code>c.SaveUploadedFile</code>方法将文件保存到服务器的指定目录。</p><p>​ <code>SaveUploadedFile</code>方法接收两个参数：第一个：要保存的描述多部分表单请求的文件部分对象，第二个：本地系统路径（string类型）。</p><p>上面演示了如何根据不同的表单键将上传的文件保存到服务器（即处理一个或多个文件上传，name属性不同），是根据表单的name属性保存的。<strong>适用于不同的name属性</strong>。</p><p>注意，上面这种情况如果存在多个相同的name属性，只能获取第一个文件。</p><p>下面介绍如何保存相同name属性的文件。<strong>适用于相同的name属性</strong>。</p><h3 id=处理多个文件上传>处理多个文件上传</h3><p>如果需要处理多个文件上传，name属性相同，可以使用<code>c.MultipartForm</code>方法。以下是示例代码：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>form</span> <span class=na>action</span><span class=o>=</span><span class=s>&#34;/admin/user/doAdd&#34;</span> <span class=na>method</span><span class=o>=</span><span class=s>&#34;post&#34;</span> <span class=na>enctype</span><span class=o>=</span><span class=s>&#34;multipart/form-data&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>	用户名： <span class=p>&lt;</span><span class=nt>input</span> <span class=na>type</span><span class=o>=</span><span class=s>&#34;text&#34;</span> <span class=na>name</span><span class=o>=</span><span class=s>&#34;username&#34;</span> <span class=na>placeholder</span><span class=o>=</span><span class=s>&#34;用户名&#34;</span><span class=p>&gt;</span> <span class=p>&lt;</span><span class=nt>br</span><span class=p>&gt;</span> <span class=p>&lt;</span><span class=nt>br</span><span class=p>&gt;</span> 
</span></span><span class=line><span class=cl>    头 像1：<span class=p>&lt;</span><span class=nt>input</span> <span class=na>type</span><span class=o>=</span><span class=s>&#34;file&#34;</span> <span class=na>name</span><span class=o>=</span><span class=s>&#34;files&#34;</span><span class=p>&gt;&lt;</span><span class=nt>br</span><span class=p>&gt;</span> <span class=p>&lt;</span><span class=nt>br</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    头 像2：<span class=p>&lt;</span><span class=nt>input</span> <span class=na>type</span><span class=o>=</span><span class=s>&#34;file&#34;</span> <span class=na>name</span><span class=o>=</span><span class=s>&#34;files&#34;</span><span class=p>&gt;&lt;</span><span class=nt>br</span><span class=p>&gt;</span> <span class=p>&lt;</span><span class=nt>br</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>input</span> <span class=na>type</span><span class=o>=</span><span class=s>&#34;submit&#34;</span> <span class=na>value</span><span class=o>=</span><span class=s>&#34;提交&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>form</span><span class=p>&gt;</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;net/http&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=s>&#34;github.com/gin-gonic/gin&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>r</span> <span class=o>:=</span> <span class=nx>gin</span><span class=p>.</span><span class=nf>Default</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nx>r</span><span class=p>.</span><span class=nf>POST</span><span class=p>(</span><span class=s>&#34;/uploads&#34;</span><span class=p>,</span> <span class=kd>func</span><span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>gin</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 从请求中解析多个文件
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>form</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>MultipartForm</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>c</span><span class=p>.</span><span class=nf>String</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nx>StatusBadRequest</span><span class=p>,</span> <span class=s>&#34;Bad request&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nx>files</span> <span class=o>:=</span> <span class=nx>form</span><span class=p>.</span><span class=nx>File</span><span class=p>[</span><span class=s>&#34;files&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>files</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>file</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>files</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>SaveUploadedFile</span><span class=p>(</span><span class=nx>file</span><span class=p>,</span> <span class=nx>path</span><span class=p>.</span><span class=nf>Join</span><span class=p>(</span><span class=s>&#34;./uploads&#34;</span><span class=p>,</span> <span class=nx>file</span><span class=p>.</span><span class=nx>Filename</span><span class=p>));</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=nx>c</span><span class=p>.</span><span class=nf>String</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nx>StatusInternalServerError</span><span class=p>,</span> <span class=s>&#34;Could not save file: %s&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=k>return</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>c</span><span class=p>.</span><span class=nf>String</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nx>StatusBadRequest</span><span class=p>,</span> <span class=s>&#34;Bad Request: 请上传指定文件！&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nx>c</span><span class=p>.</span><span class=nf>String</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nx>StatusOK</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;%d files uploaded successfully.&#34;</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=nx>files</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>r</span><span class=p>.</span><span class=nf>Run</span><span class=p>(</span><span class=s>&#34;:8080&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>在这个例子中，首先使用<code>c.MultipartForm</code>方法获<strong>多部分表单</strong>数据，文件部分就在其<code>File</code>字段下，是<code>map[string][]*FileHeader</code>类型。通过表单键（name属性的值）就能获取该键下的所有文件对象，是切片类型。</p><p>最后遍历所有文件进行保存处理即可。</p><p>注意：该方法同样适用于不同的表单键，不过需要进行遍历保存。</p><h3 id=设置处理多部分表单请求的最大内存大小>设置处理多部分表单请求的最大内存大小</h3><p><code>MaxMultipartMemory</code> 是 <code>*gin.Engine</code> 对象的一个字段，表示Gin框架处理multipart/form-data类型请求时，可以在内存中存储的最大数据大小。</p><p>当一个multipart/form-data请求中的数据大小超过了<code>MaxMultipartMemory</code>限制时，Gin框架将会自动将超出部分的数据写入到磁盘的临时文件中，而不是全部存储在内存中。这是为了防止占用过多内存导致内存溢出的问题。例如，在文件上传的情况下，较大的文件将不会全部加载到内存中，而是部分写入临时文件，从而<strong>减少内存消耗</strong>。</p><p>Gin默认处理多部分表单请求的最大内存是32MiB。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;net/http&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=s>&#34;github.com/gin-gonic/gin&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>r</span> <span class=o>:=</span> <span class=nx>gin</span><span class=p>.</span><span class=nf>Default</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 设置最大上传文件大小为8MB
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>r</span><span class=p>.</span><span class=nx>MaxMultipartMemory</span> <span class=p>=</span> <span class=mi>8</span> <span class=o>&lt;&lt;</span> <span class=mi>20</span> <span class=c1>// 8 MiB
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=nx>r</span><span class=p>.</span><span class=nf>POST</span><span class=p>(</span><span class=s>&#34;/upload&#34;</span><span class=p>,</span> <span class=kd>func</span><span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>gin</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>file</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>FormFile</span><span class=p>(</span><span class=s>&#34;file&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>c</span><span class=p>.</span><span class=nf>String</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nx>StatusBadRequest</span><span class=p>,</span> <span class=s>&#34;Bad request&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nx>err</span> <span class=p>=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>SaveUploadedFile</span><span class=p>(</span><span class=nx>file</span><span class=p>,</span> <span class=s>&#34;./uploads/&#34;</span> <span class=o>+</span> <span class=nx>file</span><span class=p>.</span><span class=nx>Filename</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>c</span><span class=p>.</span><span class=nf>String</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nx>StatusInternalServerError</span><span class=p>,</span> <span class=s>&#34;Could not save file&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nx>c</span><span class=p>.</span><span class=nf>String</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nx>StatusOK</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;File %s uploaded successfully.&#34;</span><span class=p>,</span> <span class=nx>file</span><span class=p>.</span><span class=nx>Filename</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>r</span><span class=p>.</span><span class=nf>Run</span><span class=p>(</span><span class=s>&#34;:8080&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>在这个例子中，<code>r.MaxMultipartMemory = 8 &lt;&lt; 20</code> 将Gin框架处理multipart/form-data类型请求的最大内存大小设置为8MiB。</p><p><code>8 &lt;&lt; 20</code>：这个表达式利用左移运算符将8左移20位，等价于<code>8 * 2^20</code>，即8 MiB（兆字节）。这种写法简洁明了，容易理解和记忆。</p><p>Gin会将超过部分的数据写入到磁盘的临时文件中，而不是全部存储在内存中。<strong>这样可以有效防止大文件上传时内存占用过多的问题</strong>。</p><blockquote><p><strong>单位扩展</strong></p><ul><li>MiB和MB都读兆字节。</li><li>二中的区别是使用的计数法不同。<ul><li>MiB使用二进制计数法。1MiB = 1024KiB = 1,048,576 字节 = 2^20 字节</li><li>MB使用十进制计数法。1MB = 1000KB = 1000000 字节 = 10^6 字节</li></ul></li><li>通常现实生活中使用的是MB，计算机中使用的是MiB。相同数值下，MiB表示的空间更大。<ul><li>如购买的一块机械硬盘为2T，在计算机中显示通常小于2T。因为操作系统使用的是二进制计算方法。</li></ul></li></ul></blockquote><h3 id=使用中间件处理文件上传>使用中间件处理文件上传</h3><p>通常我们会使用中间件来处理文件上传，比如<strong>验证文件类型</strong>、<strong>限制文件大小</strong>等。</p><p>限制文件大小中间件：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>MaxSizeAllowedMiddleware</span><span class=p>(</span><span class=nx>n</span> <span class=kt>int64</span><span class=p>)</span> <span class=nx>gin</span><span class=p>.</span><span class=nx>HandlerFunc</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=kd>func</span><span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>gin</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>c</span><span class=p>.</span><span class=nx>Request</span><span class=p>.</span><span class=nx>Body</span> <span class=p>=</span> <span class=nx>http</span><span class=p>.</span><span class=nf>MaxBytesReader</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>Writer</span><span class=p>,</span> <span class=nx>c</span><span class=p>.</span><span class=nx>Request</span><span class=p>.</span><span class=nx>Body</span><span class=p>,</span> <span class=nx>n</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nx>Request</span><span class=p>.</span><span class=nf>ParseMultipartForm</span><span class=p>(</span><span class=nx>n</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>c</span><span class=p>.</span><span class=nf>String</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nx>StatusRequestEntityTooLarge</span><span class=p>,</span> <span class=s>&#34;文件太大了, 不能超过%d兆字节: %s&#34;</span><span class=p>,</span> <span class=nx>n</span><span class=o>&gt;&gt;</span><span class=mi>20</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=nx>c</span><span class=p>.</span><span class=nf>Abort</span><span class=p>()</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>c</span><span class=p>.</span><span class=nf>Next</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>验证文件类型中间件：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>ValidateFileTypeMiddleware</span><span class=p>(</span><span class=nx>allowExtMap</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kt>bool</span><span class=p>)</span> <span class=nx>gin</span><span class=p>.</span><span class=nx>HandlerFunc</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=kd>func</span><span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>gin</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>file</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>FormFile</span><span class=p>(</span><span class=s>&#34;file&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>c</span><span class=p>.</span><span class=nf>String</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nx>StatusBadRequest</span><span class=p>,</span> <span class=s>&#34;Bad Request: %s&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=nx>c</span><span class=p>.</span><span class=nf>Abort</span><span class=p>()</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>ext</span> <span class=o>:=</span> <span class=nx>path</span><span class=p>.</span><span class=nf>Ext</span><span class=p>(</span><span class=nx>file</span><span class=p>.</span><span class=nx>Filename</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>f</span> <span class=o>:=</span> <span class=nx>allowExtMap</span><span class=p>[</span><span class=nx>ext</span><span class=p>];</span> <span class=p>!</span><span class=nx>f</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>c</span><span class=p>.</span><span class=nf>String</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nx>StatusBadRequest</span><span class=p>,</span> <span class=s>&#34;%q file type is not allowed&#34;</span><span class=p>,</span> <span class=nx>ext</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=nx>c</span><span class=p>.</span><span class=nf>Abort</span><span class=p>()</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=nx>c</span><span class=p>.</span><span class=nf>Next</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl>	<span class=nx>r</span><span class=p>.</span><span class=nf>POST</span><span class=p>(</span><span class=s>&#34;/upload&#34;</span><span class=p>,</span> <span class=nf>MaxSizeAllowedMiddleware</span><span class=p>(</span><span class=mi>3</span><span class=o>&lt;&lt;</span><span class=mi>20</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nf>ValidateFileTypeMiddleware</span><span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kt>bool</span><span class=p>{</span><span class=s>&#34;.jpg&#34;</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span> <span class=s>&#34;.png&#34;</span><span class=p>:</span> <span class=kc>true</span><span class=p>}),</span> 
</span></span><span class=line><span class=cl>        <span class=kd>func</span><span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>gin</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        	<span class=nx>file</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>FormFile</span><span class=p>(</span><span class=s>&#34;file&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nx>c</span><span class=p>.</span><span class=nf>String</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nx>StatusBadRequest</span><span class=p>,</span> <span class=s>&#34;Bad request: %s&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=nx>err</span> <span class=p>=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>SaveUploadedFile</span><span class=p>(</span><span class=nx>file</span><span class=p>,</span> <span class=nx>path</span><span class=p>.</span><span class=nf>Join</span><span class=p>(</span><span class=s>&#34;./uploads&#34;</span><span class=p>,</span> <span class=nx>file</span><span class=p>.</span><span class=nx>Filename</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nx>c</span><span class=p>.</span><span class=nf>String</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nx>StatusInternalServerError</span><span class=p>,</span> <span class=s>&#34;Could not save file: %s&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=nx>c</span><span class=p>.</span><span class=nf>String</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nx>StatusOK</span><span class=p>,</span> <span class=s>&#34;File %s uploaded successfully.&#34;</span><span class=p>,</span> <span class=nx>file</span><span class=p>.</span><span class=nx>Filename</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span></code></pre></td></tr></table></div></div><p>注意事项：</p><ul><li>上面简单演示了<strong>单文件上传</strong>时，使用中间件限制上传文件的大小，以及类型。<ul><li>如果是多文件上传，文件大小中间件可以适用，但文件类型中间件不适用，需要使用<code>MultipartForm</code>获取多部分表单请求对象，然后通过<code>File</code>字段遍历，判断文件类型。</li></ul></li><li>他们的注册顺序：<ol><li><strong>限制文件大小的中间件</strong>： 这个中间件应该先执行，因为它可以尽早地检查请求体的大小，避免浪费资源去处理超过限制的请求。</li><li><strong>验证文件类型的中间件</strong>： 在文件大小被验证通过之后，再进行文件类型的验证。这是因为文件类型的验证通常需要解析文件内容或元数据，属于较重的操作。</li><li>通过这种顺序设置，可以确保请求被有效地过滤，并避免不必要的资源消耗。</li></ol></li><li>最后需要注意：如果先验证了文件类型，那么会消耗请求体内容大小，造成限制文件大小中间件失效。所以要先注册限制文件大小中间件。</li><li>接口访问推荐在接口测试工具中访问，如apipost。</li></ul><hr><h2 id=使用cookie>使用Cookie</h2><h3 id=cookie介绍>Cookie介绍</h3><p>Cookie 是在 HTTP 协议中用来<strong>存储少量数据</strong>的技术，由服务器发送到浏览器并<strong>存储在客户端</strong>。其主要作用包括：</p><ol><li><p>会话管理（Session Management）</p><p>Cookie 常用于会话管理，即在用户浏览网页期间保持用户的登录状态。常见的应用场景有：</p><ul><li><strong>用户认证：</strong> 记录用户的登录信息，使得用户在浏览网站的不同页面时无需重新登录。</li><li><strong>购物车：</strong> 在线商店使用 Cookie 来记录用户的购物车内容。</li></ul></li><li><p>个性化（Personalization）</p><p>Cookie 可以用来记录用户的偏好设置，以便在用户访问网站时提供个性化的内容和体验。例如：</p><ul><li><strong>用户界面设置：</strong> 保存用户选择的主题、语言等偏好设置。</li><li><strong>个性化广告：</strong> 根据用户的浏览历史记录和偏好，展示相关的广告内容。</li></ul></li><li><p>跟踪和分析（Tracking and Analytics）</p><p>Cookie 被广泛用于用户行为跟踪和数据分析，以帮助网站管理员了解用户如何使用他们的网站，并进行相应的优化。例如：</p><ul><li><strong>流量分析：</strong> 记录用户访问的页面、停留时间等信息，用于流量统计和分析。</li><li><strong>广告跟踪：</strong> 跟踪用户点击广告的情况，以评估广告效果。</li></ul></li><li><p>安全性（Security）</p><p>虽然 Cookie 本身不是安全机制，但它们可以与安全机制结合使用。例如：</p><ul><li><strong>防止跨站请求伪造（CSRF）：</strong> 通过设置 HttpOnly 和 Secure 属性，增强 Cookie 的安全性，防止攻击者利用 JavaScript 窃取 Cookie 内容。</li><li><strong>令牌存储：</strong> 将安全令牌存储在 Cookie 中，以便在每次请求时进行验证。</li></ul><p>需要注意的是别使用cookie保存<strong>隐私数据</strong>。</p></li><li><p>状态管理（State Management）</p><p>HTTP 是无状态协议，服务器无法记录每次请求的状态。Cookie 可以帮助服务器存储和管理一些状态信息，例如：</p><ul><li><strong>上次访问时间：</strong> 记录用户上次访问的时间，以便在用户再次访问时提供相关信息。</li><li><strong>表单数据：</strong> 存储用户在表单中输入的数据，方便在用户返回时自动填充。</li></ul></li></ol><h4 id=cookie的属性>Cookie的属性</h4><p>Cookie 的属性决定了它的行为和存储方式，常见的属性包括：</p><p><strong>Name 和 Value：</strong> Cookie 的名称和值。</p><p><strong>Domain：</strong> 指定 Cookie 所属的域，只有该域及其子域可以访问 Cookie。</p><p><strong>Path：</strong> 指定 Cookie 所属的路径，只有该路径及其子路径可以访问 Cookie。</p><p><strong>Max-Age/Expires：</strong> 指定 Cookie 的有效期，超过这个时间后，Cookie 将被删除。</p><p><strong>Secure：</strong> 指定 Cookie 仅在 HTTPS 连接中发送。</p><p><strong>HttpOnly：</strong> 指定 Cookie 不能通过 JavaScript 访问，增强安全性。</p><p><strong>SameSite：</strong> 防止跨站请求伪造（CSRF）攻击，有三个值可以选择：Strict、Lax 和 None。</p><h4 id=补充>补充</h4><ul><li>Cookie本质就是一个请求头，可以在请求头中查看Cookie。</li><li>浏览器设置Cookie是通过响应头Set-Cookie设置的。</li><li>查看Cookie还可以再浏览器的开发者工具的Application&ndash;>Storage中查看对应域名下的Cookie。<ul><li>不同浏览器可能有所不同。</li></ul></li></ul><h3 id=在gin中使用cookie>在Gin中使用Cookie</h3><ol><li><p>设置Cookie</p><p>在Gin中，使用<code>SetCookie</code>方法可以在响应中设置一个cookie：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>Context</span><span class=p>)</span> <span class=nf>SetCookie</span><span class=p>(</span><span class=nx>name</span><span class=p>,</span> <span class=nx>value</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>maxAge</span> <span class=kt>int</span><span class=p>,</span> <span class=nx>path</span><span class=p>,</span> <span class=nx>domain</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>secure</span><span class=p>,</span> <span class=nx>httpOnly</span> <span class=kt>bool</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>参数说明：</p><ul><li><p><code>name</code>: cookie的名称。</p></li><li><p><code>value</code>: cookie的值。</p></li><li><p><code>maxAge</code>: cookie的最大存活时间（以秒为单位）。</p><ul><li>有效时间，单位是秒。</li><li>MaxAge=0，忽略MaxAge属性，就是忽略存活时间，有效期在<strong>浏览器会话结束时删除</strong>。</li><li>MaxAge&lt;0 相当于删除cookie, 通常可以设置-1代表删除。</li><li>MaxAge>0 多少秒后cookie失效。</li></ul></li><li><p><code>path</code>: cookie的路径。通常设置为"/&ldquo;表示整个站点。</p></li><li><p><code>domain</code>: cookie的域。本地调试配置成 localhost , 正式上线配置成域名。</p><ul><li><p><strong>子域共享Cookie</strong>：</p><p>在域名前面加点表示：该域名及其子域共享Cookie。没有只能该域访问设置的Cookie。子域无法访问。如：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// 设置 Cookie，域为 .example.com，子域名可以共享
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>c</span><span class=p>.</span><span class=nf>SetCookie</span><span class=p>(</span><span class=s>&#34;username&#34;</span><span class=p>,</span> <span class=s>&#34;gin_user&#34;</span><span class=p>,</span> <span class=mi>3600</span><span class=p>,</span> <span class=s>&#34;/&#34;</span><span class=p>,</span> <span class=s>&#34;.example.com&#34;</span><span class=p>,</span> <span class=kc>false</span><span class=p>,</span> <span class=kc>true</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>在 <code>SetCookie</code> 方法中，将域设置为 <code>.example.com</code>。这使得所有 <code>example.com</code> 及其子域（如 <code>sub1.example.com</code> 和 <code>sub2.example.com</code>）都可以访问该 Cookie。</p><p><strong>注意</strong>：<strong>跨不同的顶级域名、二级域名</strong>无法共享Cookie。（如 <code>example.com</code> 和 <code>anotherexample.com</code>）</p><p><strong>浏览器支持</strong>：确保浏览器支持跨子域名的 Cookie 设置，现代浏览器一般都支持。</p></li></ul></li><li><p><code>secure</code>: 是否仅在HTTPS请求中发送cookie。设置为<code>false</code>表示在HTTP和HTTPS请求中都发送。</p><ul><li>在生产环境中，建议将 <code>Secure</code> 设置为 <code>true</code>，以确保 Cookie 仅在 HTTPS 请求中发送。</li></ul></li><li><p><code>httpOnly</code>: 是否将cookie标记为HttpOnly。设置为<code>true</code>表示客户端JavaScript无法访问cookie。</p></li></ul></li><li><p>获取Cookie</p><p>使用<code>Cookie</code>方法可以从请求中获取cookie：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>Context</span><span class=p>)</span> <span class=nf>Cookie</span><span class=p>(</span><span class=nx>name</span> <span class=kt>string</span><span class=p>)</span> <span class=p>(</span><span class=kt>string</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p><code>Cookie</code>方法用于获取指定Cookie键的值，如果获取成功，将返回cookie的值，否则返回错误。</p></li><li><p>删除Cookie</p><p>在Gin中，删除cookie实际上是通过设置一个过期的cookie来实现的。</p><p>只需要将要删除的cookie的存活时间<code>maxAge</code>参数设置为<code>-1</code>，这表示将cookie立即过期，从而达到删除cookie的效果。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>Context</span><span class=p>)</span> <span class=nf>SetCookie</span><span class=p>(</span><span class=nx>name</span><span class=p>,</span> <span class=nx>value</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>maxAge</span> <span class=kt>int</span><span class=p>,</span> <span class=nx>path</span><span class=p>,</span> <span class=nx>domain</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>secure</span><span class=p>,</span> <span class=nx>httpOnly</span> <span class=kt>bool</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div></li><li><p>示例：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;github.com/gin-gonic/gin&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;net/http&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>r</span> <span class=o>:=</span> <span class=nx>gin</span><span class=p>.</span><span class=nf>Default</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>r</span><span class=p>.</span><span class=nf>GET</span><span class=p>(</span><span class=s>&#34;/set_cookie&#34;</span><span class=p>,</span> <span class=kd>func</span><span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>gin</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>c</span><span class=p>.</span><span class=nf>SetCookie</span><span class=p>(</span><span class=s>&#34;username&#34;</span><span class=p>,</span> <span class=s>&#34;gin_user&#34;</span><span class=p>,</span> <span class=mi>3600</span><span class=p>,</span> <span class=s>&#34;/&#34;</span><span class=p>,</span> <span class=s>&#34;localhost&#34;</span><span class=p>,</span> <span class=kc>false</span><span class=p>,</span> <span class=kc>true</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>c</span><span class=p>.</span><span class=nf>JSON</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nx>StatusOK</span><span class=p>,</span> <span class=nx>gin</span><span class=p>.</span><span class=nx>H</span><span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s>&#34;message&#34;</span><span class=p>:</span> <span class=s>&#34;Cookie set successfully!&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>r</span><span class=p>.</span><span class=nf>GET</span><span class=p>(</span><span class=s>&#34;/get_cookie&#34;</span><span class=p>,</span> <span class=kd>func</span><span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>gin</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>cookie</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>Cookie</span><span class=p>(</span><span class=s>&#34;username&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>c</span><span class=p>.</span><span class=nf>JSON</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nx>StatusBadRequest</span><span class=p>,</span> <span class=nx>gin</span><span class=p>.</span><span class=nx>H</span><span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s>&#34;message&#34;</span><span class=p>:</span> <span class=s>&#34;Cookie not found! &#34;</span> <span class=o>+</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>            <span class=p>})</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nx>c</span><span class=p>.</span><span class=nf>JSON</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nx>StatusOK</span><span class=p>,</span> <span class=nx>gin</span><span class=p>.</span><span class=nx>H</span><span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s>&#34;username&#34;</span><span class=p>:</span> <span class=nx>cookie</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>r</span><span class=p>.</span><span class=nf>GET</span><span class=p>(</span><span class=s>&#34;/delete_cookie&#34;</span><span class=p>,</span> <span class=kd>func</span><span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>gin</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>c</span><span class=p>.</span><span class=nf>SetCookie</span><span class=p>(</span><span class=s>&#34;username&#34;</span><span class=p>,</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=s>&#34;/&#34;</span><span class=p>,</span> <span class=s>&#34;localhost&#34;</span><span class=p>,</span> <span class=kc>false</span><span class=p>,</span> <span class=kc>true</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>c</span><span class=p>.</span><span class=nf>JSON</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nx>StatusOK</span><span class=p>,</span> <span class=nx>gin</span><span class=p>.</span><span class=nx>H</span><span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s>&#34;message&#34;</span><span class=p>:</span> <span class=s>&#34;Cookie deleted successfully!&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>r</span><span class=p>.</span><span class=nf>Run</span><span class=p>(</span><span class=s>&#34;:8080&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></li></ol><hr><h2 id=使用session>使用Session</h2><h3 id=session介绍>Session介绍</h3><ul><li><p><strong>简单介绍</strong></p><p>Session是另一种<strong>存储少量数据</strong>的技术，不同的是Cookie保存在客户端浏览器中，而session保存在服务器上。</p></li><li><p><strong>作用</strong></p><p>Session是一种在客户端和服务器之间维持用户会话状态的机制。Session用于在多个请求之间保持用户的状态和信息，这在需要用户认证和个性化服务时非常有用。它可以存储用户的登录状态、购物车信息、用户偏好等。</p></li><li><p><strong>属性</strong></p><p>Session的属性跟Cookie的属性类似。参考<a class=link href=#Cookie%e7%9a%84%e5%b1%9e%e6%80%a7>Cookie的属性</a>。</p><p>Session常用属性的默认值（Cookie需要没有）：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl>	<span class=nx>Path</span><span class=p>:</span>     <span class=s>&#34;/&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>Domain</span><span class=p>:</span>   <span class=s>&#34;localhost&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>MaxAge</span><span class=p>:</span>   <span class=nx>一个月</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>HttpOnly</span><span class=p>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>Secure</span><span class=p>:</span>   <span class=kc>true</span><span class=p>,</span>
</span></span></code></pre></td></tr></table></div></div><p>键跟值通过内置方法管理。</p></li><li><p><strong>工作流程</strong></p><p>当客户端（浏览器）第一次访问需要Session的页面时，服务器端会创建一个session对象，拥有唯一的一个Session ID，数据就保存在类似于key,value的键值对，然后将Session对象保存到服务器设置的存储引擎中，最后将Session ID返回到浏览器(客户)端。浏览器下次访问时会携带Session ID(cookie)，找到对应的Session对象。</p><p>在后续的请求中，客户端会携带之前收到的Session Cookie，包含唯一的Session ID。</p><p>服务器接收到请求时，通过Session ID从存储引擎中查找对应的Session数据（键值对）。</p><p>服务器负责Session的创建、更新和销毁。Session通常有一个生命周期，在一段时间不活动后会自动过期。</p></li></ul><p>因为Gin本身没有内置的Session管理功能，所以在Gin中使用Session需要配合第三方库（中间件）实现，比较受欢迎的是<a class=link href=https://github.com/gin-contrib/sessions target=_blank rel=noopener>gin-contrib/sessions</a>。</p><h3 id=在gin中使用session>在Gin中使用Session</h3><p>要在Gin框架中使用Session，需要借助一些中间件库实现，例如<code>github.com/gin-contrib/sessions</code>。</p><p><a class=link href=https://github.com/gin-contrib/sessions target=_blank rel=noopener>gin-contrib/sessions</a>中间件支持的存储引擎：</p><ul><li><a class=link href="https://github.com/gin-contrib/sessions?tab=readme-ov-file#cookie-based" target=_blank rel=noopener>cookie-based</a></li><li><a class=link href="https://github.com/gin-contrib/sessions?tab=readme-ov-file#redis" target=_blank rel=noopener>Redis</a></li><li><a class=link href="https://github.com/gin-contrib/sessions?tab=readme-ov-file#memcached" target=_blank rel=noopener>memcached</a></li><li><a class=link href="https://github.com/gin-contrib/sessions?tab=readme-ov-file#mongodb" target=_blank rel=noopener>MongoDB</a></li><li><a class=link href="https://github.com/gin-contrib/sessions?tab=readme-ov-file#gorm" target=_blank rel=noopener>GORM</a></li><li><a class=link href="https://github.com/gin-contrib/sessions?tab=readme-ov-file#memstore" target=_blank rel=noopener>memstore</a></li><li><a class=link href="https://github.com/gin-contrib/sessions?tab=readme-ov-file#postgresql" target=_blank rel=noopener>PostgreSQL</a></li></ul><p><strong>安装依赖</strong>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>go get -u github.com/gin-contrib/sessions
</span></span></code></pre></td></tr></table></div></div><p>下面介绍常用的存储引擎。</p><h4 id=基于cookie存储session>基于Cookie存储Session</h4><p>基于Cookie存储Session是将Session中的数据存储在Cookie当中（与Session ID一同存放）。使用示例如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;github.com/gin-contrib/sessions&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;github.com/gin-contrib/sessions/cookie&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;github.com/gin-gonic/gin&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>r</span> <span class=o>:=</span> <span class=nx>gin</span><span class=p>.</span><span class=nf>Default</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 使用cookie-based存储
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>store</span> <span class=o>:=</span> <span class=nx>cookie</span><span class=p>.</span><span class=nf>NewStore</span><span class=p>([]</span><span class=nb>byte</span><span class=p>(</span><span class=s>&#34;secret&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=nx>r</span><span class=p>.</span><span class=nf>Use</span><span class=p>(</span><span class=nx>sessions</span><span class=p>.</span><span class=nf>Sessions</span><span class=p>(</span><span class=s>&#34;mysession&#34;</span><span class=p>,</span> <span class=nx>store</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>r</span><span class=p>.</span><span class=nf>GET</span><span class=p>(</span><span class=s>&#34;/login&#34;</span><span class=p>,</span> <span class=nx>loginHandler</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>r</span><span class=p>.</span><span class=nf>GET</span><span class=p>(</span><span class=s>&#34;/logout&#34;</span><span class=p>,</span> <span class=nx>logoutHandler</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>r</span><span class=p>.</span><span class=nf>GET</span><span class=p>(</span><span class=s>&#34;/profile&#34;</span><span class=p>,</span> <span class=nf>authRequired</span><span class=p>(),</span> <span class=nx>profileHandler</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>r</span><span class=p>.</span><span class=nf>Run</span><span class=p>(</span><span class=s>&#34;:8080&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 登录处理
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>loginHandler</span><span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>gin</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    	<span class=nx>session</span> <span class=o>:=</span> <span class=nx>sessions</span><span class=p>.</span><span class=nf>Default</span><span class=p>(</span><span class=nx>c</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>uId</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>Query</span><span class=p>(</span><span class=s>&#34;id&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>password</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>Query</span><span class=p>(</span><span class=s>&#34;password&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 模拟登录认证
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>password</span> <span class=o>==</span> <span class=s>&#34;123456&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>session</span><span class=p>.</span><span class=nf>Set</span><span class=p>(</span><span class=s>&#34;user&#34;</span><span class=p>,</span> <span class=nx>uId</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>session</span><span class=p>.</span><span class=nf>Options</span><span class=p>(</span><span class=nx>sessions</span><span class=p>.</span><span class=nx>Options</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>MaxAge</span><span class=p>:</span>   <span class=mi>3600</span><span class=p>,</span> <span class=c1>// 一小时过期
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>HttpOnly</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=p>})</span>
</span></span><span class=line><span class=cl>		<span class=nx>_</span> <span class=p>=</span> <span class=nx>session</span><span class=p>.</span><span class=nf>Save</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=nx>c</span><span class=p>.</span><span class=nf>JSON</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nx>StatusOK</span><span class=p>,</span> <span class=nx>gin</span><span class=p>.</span><span class=nx>H</span><span class=p>{</span><span class=s>&#34;message&#34;</span><span class=p>:</span> <span class=s>&#34;logged in&#34;</span><span class=p>})</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>c</span><span class=p>.</span><span class=nf>JSON</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nx>StatusUnauthorized</span><span class=p>,</span> <span class=nx>gin</span><span class=p>.</span><span class=nx>H</span><span class=p>{</span><span class=s>&#34;message&#34;</span><span class=p>:</span> <span class=s>&#34;login failed&#34;</span><span class=p>})</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 注销处理
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>logoutHandler</span><span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>gin</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>session</span> <span class=o>:=</span> <span class=nx>sessions</span><span class=p>.</span><span class=nf>Default</span><span class=p>(</span><span class=nx>c</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>session</span><span class=p>.</span><span class=nf>Delete</span><span class=p>(</span><span class=s>&#34;user&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>session</span><span class=p>.</span><span class=nf>Save</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nx>c</span><span class=p>.</span><span class=nf>JSON</span><span class=p>(</span><span class=mi>200</span><span class=p>,</span> <span class=nx>gin</span><span class=p>.</span><span class=nx>H</span><span class=p>{</span><span class=s>&#34;message&#34;</span><span class=p>:</span> <span class=s>&#34;logged out&#34;</span><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 需要认证的处理
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>authRequired</span><span class=p>()</span> <span class=nx>gin</span><span class=p>.</span><span class=nx>HandlerFunc</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kd>func</span><span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>gin</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>session</span> <span class=o>:=</span> <span class=nx>sessions</span><span class=p>.</span><span class=nf>Default</span><span class=p>(</span><span class=nx>c</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>uId</span> <span class=o>:=</span> <span class=nx>session</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=s>&#34;user&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>uId</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>c</span><span class=p>.</span><span class=nf>JSON</span><span class=p>(</span><span class=mi>401</span><span class=p>,</span> <span class=nx>gin</span><span class=p>.</span><span class=nx>H</span><span class=p>{</span><span class=s>&#34;message&#34;</span><span class=p>:</span> <span class=s>&#34;unauthorized&#34;</span><span class=p>})</span>
</span></span><span class=line><span class=cl>            <span class=nx>c</span><span class=p>.</span><span class=nf>Abort</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=nx>c</span><span class=p>.</span><span class=nf>Next</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 用户信息处理
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>profileHandler</span><span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>gin</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>session</span> <span class=o>:=</span> <span class=nx>sessions</span><span class=p>.</span><span class=nf>Default</span><span class=p>(</span><span class=nx>c</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>uId</span> <span class=o>:=</span> <span class=nx>session</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=s>&#34;user&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>c</span><span class=p>.</span><span class=nf>JSON</span><span class=p>(</span><span class=mi>200</span><span class=p>,</span> <span class=nx>gin</span><span class=p>.</span><span class=nx>H</span><span class=p>{</span><span class=s>&#34;user&#34;</span><span class=p>:</span> <span class=nx>uId</span><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>解释各部分功能</strong>：</p><ul><li><p><strong>创建Session存储引擎</strong>：使用<code>cookie.NewStore</code>创建一个基于Cookie的Session存储引擎。参数是一个字节切片，是Session的加密秘钥。</p></li><li><p><strong>注册Session中间件</strong>：使用<code>sessions.Sessions("mysession", store)</code>注册<strong>一个</strong>Session中间件，它接收两个参数，第一个是Session ID的键（string类型），第二个是存储引擎。</p><ul><li>如果要注册多个Session中间件，使用<code>sessions.SessionsMany(sessionNames, store)</code>，它接收两个参数，第一个不同Session ID的键（string切片类型），第二个是存储引擎。一个存储引擎可以存储多个Session。</li></ul></li><li><p><strong>获取Session对象</strong>：使用<code>sessions.Default(c)</code>获取Session对象，这个方法是获取只注册一个Session中间件的快捷方式。参数是Gin上下文对象。</p><ul><li>如果注册的是多个Session中间件，获取不同的Session对象，使用<code>sessions.DefaultMany(c, "a")</code>，这个方法是获取注册多个Session中间件的快捷方式，第一个参数是Gin上下文对象，第二个是要获取Session对象的Session ID的键。</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl>  <span class=nx>store</span> <span class=o>:=</span> <span class=nx>cookie</span><span class=p>.</span><span class=nf>NewStore</span><span class=p>([]</span><span class=nb>byte</span><span class=p>(</span><span class=s>&#34;secret&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>  <span class=nx>sessionNames</span> <span class=o>:=</span> <span class=p>[]</span><span class=kt>string</span><span class=p>{</span><span class=s>&#34;a&#34;</span><span class=p>,</span> <span class=s>&#34;b&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nx>r</span><span class=p>.</span><span class=nf>Use</span><span class=p>(</span><span class=nx>sessions</span><span class=p>.</span><span class=nf>SessionsMany</span><span class=p>(</span><span class=nx>sessionNames</span><span class=p>,</span> <span class=nx>store</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>r</span><span class=p>.</span><span class=nf>GET</span><span class=p>(</span><span class=s>&#34;/hello&#34;</span><span class=p>,</span> <span class=kd>func</span><span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>gin</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>sessionA</span> <span class=o>:=</span> <span class=nx>sessions</span><span class=p>.</span><span class=nf>DefaultMany</span><span class=p>(</span><span class=nx>c</span><span class=p>,</span> <span class=s>&#34;a&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>sessionB</span> <span class=o>:=</span> <span class=nx>sessions</span><span class=p>.</span><span class=nf>DefaultMany</span><span class=p>(</span><span class=nx>c</span><span class=p>,</span> <span class=s>&#34;b&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></li><li><p><strong>修改Session对象属性</strong>：使用<code>Options(sessions.Options{})</code>方法可以修改Session的默认属性。</p></li><li><p><strong>设置Session数据</strong>：使用<code>Set</code>方法设置Session数据（key，value键值对）。可以重复添加数据。</p></li><li><p><strong>删除Session数据</strong>：使用<code>Delete</code>方法删除Session数据。参数是数据的键。</p><ul><li>理解：服务器接收到请求之后会从Cookie中自动获取Session ID，调用<code>Default</code>方法会根据Session ID获取对应的Session对象。数据就保存在Session对象中。因为Session ID是唯一的，所以获取的数据就是本次请求中的，可以通过数据的键进行删除。（不同用户的Session是独立的，相互之间不会干扰。）</li></ul></li><li><p><strong>保存Session数据</strong>：使用<code>Save</code>方法保存Session数据。注意每次修改过Session数据之后，都需要调用此方法，数据才能生效。</p></li><li><p><strong>删除当前Session ID所有的Session数据</strong>：使用<code>Clear</code>方法即可删除当前Session对象所有的Session数据。</p></li></ul><h4 id=基于redis存储session>基于Redis存储Session</h4><p>基于Redis存储Session就是将Session数据保存在Redis中，当浏览器发送请求时，服务器会根据Cookie中的Session ID，获取对应的Session对象。</p><p>学会了基于Cookie存储Session，那么基于Redis存储Session就很简单。我们只需要将存储引擎修改为Redis即可。其他使用方法一模一样。</p><p>创建Cookie存储引擎使用的是<code>cookie.NewStore([]byte("secret"))</code>方法。</p><p>创建Reds存储引擎使用的是<code>redis.NewStore(10, "tcp", "localhost:6379", "", []byte("secret"))</code>方法，参数介绍：</p><ul><li>第一个：Redis最大的空闲连接数。</li><li>第二个：数通信协议tcp或者udp。连接类型。</li><li>第三个：Redis服务器地址，格式：<code>host:port</code>。</li><li>第四个：Redis密码。</li><li>最后一个：Session加密秘钥。</li></ul><p>默认连接0号库。需要指定几号Redis数据库，使用<code>redis.NewStoreWithDB(10, "tcp", "192.168.245.130:6379", "123456", "1", []byte("secret"))</code>方法。</p><h4 id=sessions加密秘钥介绍>Sessions加密<strong>秘钥介绍</strong></h4><p><strong>加密密钥的作用</strong></p><ol><li><strong>数据加密</strong>：<ul><li>因为Session的部分数据（Session ID），会保存在Cookie中响应给客户端，加密密钥用于加密这些数据，以防止客户端篡改。</li><li>加密后的数据是不可读的，只有持有加密密钥的服务器才能解密和读取这些数据。</li></ul></li><li><strong>数据签名</strong>：<ul><li>除了加密，加密密钥也用于对数据进行签名，以确保数据的完整性和真实性。</li><li>签名确保数据在传输过程中未被篡改，如果数据被篡改，签名验证将失败。</li></ul></li></ol><p><strong>使用加密秘钥</strong></p><ul><li><p>在创建存储引擎的时候传入加密密钥。</p></li><li><p>加密密钥是一个字节切片，可以通过一个字符串转换而来。</p></li><li><p>加密秘钥是可选参数，但是必须要有一个身份验证秘钥，Sessions中间件才能起作用。</p></li><li><p>当<strong>只有一个</strong>加密秘钥时，用于身份验证和加密。</p></li><li><p>当存在多加密秘钥时，第一个秘钥用于<strong>身份验证</strong>，后续秘钥用于<strong>加密</strong>。</p></li><li><p><strong>建议</strong>使用 32 或 64 字节的<strong>身份验证密钥</strong>。</p></li><li><p>如果设置了<strong>加密密钥</strong>，则<strong>必须</strong>为 <strong>16、24 或 32 字节</strong>，以选择 AES-128、AES-192 或 AES-256 模式。否则Sessions中间件不起作用。</p></li><li><p>常见的情况是设置单个身份验证密钥和可选的加密密钥。</p></li><li><p>示例：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>redis</span><span class=p>.</span><span class=nf>NewStoreWithDB</span><span class=p>(</span><span class=mi>10</span><span class=p>,</span> <span class=s>&#34;tcp&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=s>&#34;192.168.245.130:6379&#34;</span><span class=p>,</span> <span class=s>&#34;123456&#34;</span><span class=p>,</span> <span class=s>&#34;1&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=p>[]</span><span class=nb>byte</span><span class=p>(</span><span class=s>&#34;secret&#34;</span><span class=p>),</span> <span class=p>[]</span><span class=nb>byte</span><span class=p>(</span><span class=s>&#34;1234567890123456&#34;</span><span class=p>))</span>
</span></span></code></pre></td></tr></table></div></div></li><li><p>至此：</p><ul><li>设置 Session 数据时，数据会使用加密密钥加密后存储在 Cookie 中。</li><li>获取 Session 数据时，数据会使用加密密钥解密。</li></ul></li><li><p>注意事项</p><ol><li><strong>密钥长度</strong>：使用足够长和随机的密钥来增强安全性，避免使用过短或容易猜测的密钥。</li><li><strong>密钥管理</strong>：妥善管理加密密钥，避免泄露。可以使用环境变量或专门的密钥管理服务来存储和读取密钥。</li><li><strong>HTTPS</strong>：在生产环境中，确保使用 HTTPS 来加密传输中的数据，防止中间人攻击。</li></ol></li></ul><hr><h2 id=总结>总结</h2><p>本文简单介绍了Gin框架的基本使用。</p><hr><h2 id=参考>参考</h2><blockquote><ol><li><a class=link href=https://www.tizi365.com/archives/244.html target=_blank rel=noopener>Go gin框架入门教程</a></li></ol></blockquote></section><footer class=article-footer><section class=article-tags><a href=/tags/go%E7%AC%AC%E4%B8%89%E6%96%B9%E5%BA%93/>Go第三方库</a></section><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>相关文章</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/p/go-figure-introduction/><div class=article-details><h2 class=article-title>Go-figure Introduction</h2></div></a></article><article><a href=/p/go-ini-introduction/><div class=article-details><h2 class=article-title>Go-ini Introduction</h2></div></a></article><article><a href=/p/carbon-introduction/><div class=article-details><h2 class=article-title>Carbon Introduction</h2></div></a></article><article><a href=/p/godotenv-introduction/><div class=article-details><h2 class=article-title>Godotenv Introduction</h2></div></a></article><article><a href=/p/cast-introduction/><div class=article-details><h2 class=article-title>Cast Introduction</h2></div></a></article></div></div></aside><script src=//unpkg.com/@waline/client@v2/dist/waline.js></script><link href=//unpkg.com/@waline/client@v2/dist/waline.css rel=stylesheet><div id=waline class=waline-container></div><style>.waline-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding);--waline-font-size:var(--article-font-size)}.waline-container .wl-count{color:var(--card-text-color-main)}</style><script>Waline.init({comment:!0,copyright:!1,dark:'html[data-scheme="dark"]',el:"#waline",emoji:["https://unpkg.com/@waline/emojis@1.0.1/weibo"],lang:"zh-cn",locale:{admin:"👻Hi",placeholder:"🎉留下你的脚印..."},pageview:!0,reaction:!0,requiredMeta:["nick"],serverURL:"https://waline.nek.us.kg/"})</script><footer class=site-footer><section class=copyright>Copyright &copy;
2020 -
2024 <b><a href=https://github.com/arlettebrook target=_blank rel=noopener>@Arlettebrook</a></b></section><section class=powerby>博客内容遵循<b><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/legalcode.zh-hans target=_blank rel=noopener> 知识共享 署名-非商业性-相同方式共享4.0国际协议</a></b><br>使用 <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> 构建<br>主题 <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.25.0>Stack</a></b> 由 <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> 设计</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>