<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="Go第三方log库之zap使用。"><title>Go第三方log库之zap</title>
<link rel=canonical href=https://arlettebrook.github.io/p/go%E7%AC%AC%E4%B8%89%E6%96%B9log%E5%BA%93%E4%B9%8Bzap/><link rel=stylesheet href=/scss/style.min.59d76563977ef6a76d0c7df16aa86c7ac37ed8942ba1442046cb6cf3b07439d7.css><meta property='og:title' content="Go第三方log库之zap"><meta property='og:description' content="Go第三方log库之zap使用。"><meta property='og:url' content='https://arlettebrook.github.io/p/go%E7%AC%AC%E4%B8%89%E6%96%B9log%E5%BA%93%E4%B9%8Bzap/'><meta property='og:site_name' content="Arlettebrook's blog"><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='Go第三方库'><meta property='article:published_time' content='2024-04-29T12:12:52+08:00'><meta property='article:modified_time' content='2024-04-29T12:12:52+08:00'><meta name=twitter:site content="@arlettebrook"><meta name=twitter:creator content="@arlettebrook"><meta name=twitter:title content="Go第三方log库之zap"><meta name=twitter:description content="Go第三方log库之zap使用。"><link rel="shortcut icon" href=/img/favicon.ico></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><div id=article-toolbar style=position:sticky;top:5px;z-index:1000><a href=/ class=back-home><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-chevron-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="15 6 9 12 15 18"/></svg>
<span>返回</span></a></div><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">目录</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#特点>特点</a></li><li><a href=#使用>使用</a><ol><li><a href=#基本使用>基本使用</a></li><li><a href=#记录层级关系>记录层级关系</a></li><li><a href=#预设日志字段>预设日志字段</a></li><li><a href=#给语法加点糖>给语法加点糖</a></li><li><a href=#定制-logger>定制 Logger</a><ol><li><a href=#选项>选项</a></li></ol></li><li><a href=#全局logger>全局<code>Logger</code></a></li><li><a href=#与标准日志库搭配使用>与标准日志库搭配使用</a></li></ol></li><li><a href=#参考>参考</a></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/go/ style=background-color:#2a9d8f;color:#fff>Go
</a><a href=/categories/%E7%BC%96%E7%A8%8B/ style=background-color:#2a9d8f;color:#fff>编程</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/go%E7%AC%AC%E4%B8%89%E6%96%B9log%E5%BA%93%E4%B9%8Bzap/>Go第三方log库之zap</a></h2><h3 class=article-subtitle>Go第三方log库之zap使用。</h3></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Apr 29, 2024</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>阅读时长: 14 分钟</time></div></footer></div></header><section class=article-content><hr><blockquote><p>zap 是由 Uber 公司开源的一款 Go 日志库，就像它的命名一样，zap 以快著称。官方 GitHub 仓库中只用一句话来概括 zap：「在 Go 中进行快速、结构化、分级的日志记录」。这句话简单明了的概括了 zap 的核心特性，今天我们就来介绍下 zap 日志库的基本使用和高级特性，以及如何在实际应用程序中使用，来提高应用程序的可靠性。</p></blockquote><hr><h2 id=特点><a href=#%e7%89%b9%e7%82%b9 class=header-anchor>#</a>
特点</h2><p>zap 具有如下特点：</p><ul><li>快，非常快，这也是 zap 最显著的特点。速度快的原因是 zap 避免使用 <code>interface{}</code> 和反射，并且使用 <code>sync.Pool</code> 减少堆内存分配。在 zap 面前 Logrus 的执行速度只有被吊打的份，你可以在官方 <a class=link href=https://github.com/uber-go/zap#performance target=_blank rel=noopener>GitHub 仓库</a>中看到 zap 与不同日志库的速度对比。</li><li>支持结构化日志记录。这是一个优秀的日志库必备功能。</li><li>支持七种日志级别：<code>Debug</code>、<code>Info</code>、<code>Warn</code>、<code>Error</code>、<code>DPanic</code>、<code>Panic</code>、<code>Fatal</code>，其中 <code>DPanic</code> 是指在开发环境下（<code>development</code>）记录日志后会进行 <code>panic</code>。</li><li>支持输出调用堆栈。</li><li>支持 Hooks 机制。</li></ul><hr><h2 id=使用><a href=#%e4%bd%bf%e7%94%a8 class=header-anchor>#</a>
使用</h2><h3 id=基本使用><a href=#%e5%9f%ba%e6%9c%ac%e4%bd%bf%e7%94%a8 class=header-anchor>#</a>
基本使用</h3><ul><li><p>先安装<code>go get -u go.uber.org/zap</code></p></li><li><p>基本使用如下：</p><p><code>zap</code>库的使用与其他的日志库非常相似。先创建一个<code>logger</code>，然后调用各个级别的方法记录日志（<code>Debug/Info/Warn/Error/</code>）。<code>zap</code>提供了几个快速创建<code>logger</code>的方法，<code>zap.NewExample()</code>、<code>zap.NewDevelopment()</code>、<code>zap.NewProduction()</code>，还有高度定制化的创建方法<code>zap.New()</code>。创建前 3 个<code>logger</code>时，<code>zap</code>会使用一些预定义的设置，它们的使用场景也有所不同。<code>Example</code>适合用在测试代码中，<code>Development</code>在开发环境中使用，<code>Production</code>用在生成环境。</p><p><code>zap</code>底层 API 可以设置缓存，所以一般使用<code>defer logger.Sync()</code>将缓存同步到文件中。刷新缓存，确保日志输出。</p><p>由于<code>fmt.Printf</code>之类的方法大量使用<code>interface{}</code>和反射，会有不少性能损失，并且增加了内存分配的频次。<code>zap</code>为了提高性能、减少内存分配次数，没有使用反射，而且默认的<code>Logger</code>只支持<strong>强类型</strong>的、结构化的日志。必须使用<code>zap</code>提供的方法记录字段。<code>zap</code>为 Go 语言中所有的基本类型和其他常见类型都提供了方法。这些方法的名称也比较好记忆，<code>zap.Type</code>（<code>Type</code>为<code>bool/int/uint/float64/complex64/time.Time/time.Duration/error</code>等）就表示该类型的字段，<code>zap.Typep</code>以<code>p</code>结尾表示该类型指针的字段，<code>zap.Types</code>以<code>s</code>结尾表示该类型切片的字段。如：</p><ul><li><code>zap.Bool(key string, val bool) Field</code>：<code>bool</code>字段</li><li><code>zap.Boolp(key string, val *bool) Field</code>：<code>bool</code>指针字段；</li><li><code>zap.Bools(key string, val []bool) Field</code>：<code>bool</code>切片字段。</li></ul><p>当然也有一些特殊类型的字段：</p><ul><li><code>zap.Any(key string, value interface{}) Field</code>：任意类型的字段；</li><li><code>zap.Binary(key string, val []byte) Field</code>：二进制串的字段。</li></ul><p>当然，每个字段都用方法包一层用起来比较繁琐。<code>zap</code>也提供了便捷的方法<code>SugarLogger</code>，可以使用<code>printf</code>格式符的方式。调用<code>logger.Sugar()</code>即可创建<code>SugaredLogger</code>。<code>SugaredLogger</code>的使用比<code>Logger</code>简单，只是性能比<code>Logger</code>低 50% 左右，可以用在非热点函数中。调用<code>SugarLogger</code>以<code>f</code>结尾的方法与<code>fmt.Printf</code>没什么区别，如例子中的<code>Infof</code>。同时<code>SugarLogger</code>还支持以<code>w</code>结尾的方法，这种方式不需要先创建字段对象，直接将字段名和值依次放在参数中即可，如例子中的<code>Infow</code>。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;time&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=s>&#34;go.uber.org/zap&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 生产环境
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;------生产环境------&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>       <span class=nx>logger</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>zap</span><span class=p>.</span><span class=nf>NewProduction</span><span class=p>()</span>
</span></span><span class=line><span class=cl>       <span class=k>defer</span> <span class=nx>logger</span><span class=p>.</span><span class=nf>Sync</span><span class=p>()</span> <span class=c1>// 刷新 buffer，保证日志最终会被输出
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>       <span class=nx>url</span> <span class=o>:=</span> <span class=s>&#34;https://arlettebrook.github.io/&#34;</span>
</span></span><span class=line><span class=cl>       <span class=nx>logger</span><span class=p>.</span><span class=nf>Info</span><span class=p>(</span><span class=s>&#34;production failed to fetch URL&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>zap</span><span class=p>.</span><span class=nf>String</span><span class=p>(</span><span class=s>&#34;url&#34;</span><span class=p>,</span> <span class=nx>url</span><span class=p>),</span> <span class=c1>// 因为没有使用 interface{} 和反射机制，所以需要指定具体类型
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=nx>zap</span><span class=p>.</span><span class=nf>Int</span><span class=p>(</span><span class=s>&#34;attempt&#34;</span><span class=p>,</span> <span class=mi>3</span><span class=p>),</span>
</span></span><span class=line><span class=cl>          <span class=nx>zap</span><span class=p>.</span><span class=nf>Duration</span><span class=p>(</span><span class=s>&#34;backoff&#34;</span><span class=p>,</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>),</span>
</span></span><span class=line><span class=cl>       <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 开发环境
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;------开发环境------&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>       <span class=nx>logger</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>zap</span><span class=p>.</span><span class=nf>NewDevelopment</span><span class=p>()</span>
</span></span><span class=line><span class=cl>       <span class=k>defer</span> <span class=nx>logger</span><span class=p>.</span><span class=nf>Sync</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>       <span class=nx>url</span> <span class=o>:=</span> <span class=s>&#34;https://arlettebrook.github.io/&#34;</span>
</span></span><span class=line><span class=cl>       <span class=nx>logger</span><span class=p>.</span><span class=nf>Debug</span><span class=p>(</span><span class=s>&#34;development failed to fetch URL&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>zap</span><span class=p>.</span><span class=nf>String</span><span class=p>(</span><span class=s>&#34;url&#34;</span><span class=p>,</span> <span class=nx>url</span><span class=p>),</span>
</span></span><span class=line><span class=cl>          <span class=nx>zap</span><span class=p>.</span><span class=nf>Int</span><span class=p>(</span><span class=s>&#34;attempt&#34;</span><span class=p>,</span> <span class=mi>3</span><span class=p>),</span>
</span></span><span class=line><span class=cl>          <span class=nx>zap</span><span class=p>.</span><span class=nf>Duration</span><span class=p>(</span><span class=s>&#34;backoff&#34;</span><span class=p>,</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>),</span>
</span></span><span class=line><span class=cl>       <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 测试环境
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;------测试环境------&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>       <span class=nx>logger</span> <span class=o>:=</span> <span class=nx>zap</span><span class=p>.</span><span class=nf>NewExample</span><span class=p>()</span>
</span></span><span class=line><span class=cl>       <span class=k>defer</span> <span class=nx>logger</span><span class=p>.</span><span class=nf>Sync</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>       <span class=nx>url</span> <span class=o>:=</span> <span class=s>&#34;https://arlettebrook.github.io/&#34;</span>
</span></span><span class=line><span class=cl>       <span class=nx>logger</span><span class=p>.</span><span class=nf>Info</span><span class=p>(</span><span class=s>&#34;failed to fetch URL&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>zap</span><span class=p>.</span><span class=nf>String</span><span class=p>(</span><span class=s>&#34;url&#34;</span><span class=p>,</span> <span class=nx>url</span><span class=p>),</span>
</span></span><span class=line><span class=cl>          <span class=nx>zap</span><span class=p>.</span><span class=nf>Int</span><span class=p>(</span><span class=s>&#34;attempt&#34;</span><span class=p>,</span> <span class=mi>3</span><span class=p>),</span>
</span></span><span class=line><span class=cl>          <span class=nx>zap</span><span class=p>.</span><span class=nf>Duration</span><span class=p>(</span><span class=s>&#34;backoff&#34;</span><span class=p>,</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>),</span>
</span></span><span class=line><span class=cl>       <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>       <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;------sugaredLogger------&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>       <span class=nx>sugar</span> <span class=o>:=</span> <span class=nx>logger</span><span class=p>.</span><span class=nf>Sugar</span><span class=p>()</span>
</span></span><span class=line><span class=cl>       <span class=nx>sugar</span><span class=p>.</span><span class=nf>Infow</span><span class=p>(</span><span class=s>&#34;failed to fetch URL&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=s>&#34;url&#34;</span><span class=p>,</span> <span class=nx>url</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=s>&#34;attempt&#34;</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=s>&#34;backoff&#34;</span><span class=p>,</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>,</span>
</span></span><span class=line><span class=cl>       <span class=p>)</span>
</span></span><span class=line><span class=cl>       <span class=nx>sugar</span><span class=p>.</span><span class=nf>Infof</span><span class=p>(</span><span class=s>&#34;Failed to fetch URL: %s&#34;</span><span class=p>,</span> <span class=nx>url</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>zap 针对生产环境、开发环境以及测试环境提供了不同的函数来创建 <code>Logger</code> 对象。</p><p>如果想在日志后面追加 key-value，则需要根据 value 的数据类型使用 <code>zap.String</code>、<code>zap.Int</code> 等方法实现。这一点在使用上显然不如 Logrus 等其他日志库来的方便，但这也是 zap 速度快的原因之一，zap 内部尽量避免使用 <code>interface{}</code> 和反射来提高代码执行效率。</p><p>记录日志的 <code>logger.Xxx</code> 方法签名如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>log</span> <span class=o>*</span><span class=nx>Logger</span><span class=p>)</span> <span class=nf>Info</span><span class=p>(</span><span class=nx>msg</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>fields</span> <span class=o>...</span><span class=nx>Field</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>其中 <code>fields</code> 是 <code>zapcore.Field</code> 类型，用来存储 key-value，并记录 value 类型，不管是 <code>zap.String</code> 还是 <code>zap.Int</code> 底层都是 <code>zapcore.Field</code> 类型来记录的。zap 为每一种 Go 的内置类型都定义了对应的 <code>zap.Xxx</code> 方法，甚至还实现 <code>zap.Any()</code> 来支持 <code>interface{}</code>。</p><p>执行以上代码，控制台得到如下输出：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=o>------</span><span class=nx>生产环境</span><span class=o>------</span>
</span></span><span class=line><span class=cl><span class=p>{</span><span class=s>&#34;level&#34;</span><span class=p>:</span><span class=s>&#34;info&#34;</span><span class=p>,</span><span class=s>&#34;ts&#34;</span><span class=p>:</span><span class=mf>1714375211.8196504</span><span class=p>,</span><span class=s>&#34;caller&#34;</span><span class=p>:</span><span class=s>&#34;learn/main.go:18&#34;</span><span class=p>,</span><span class=s>&#34;msg&#34;</span><span class=p>:</span><span class=s>&#34;production failed to fe
</span></span></span><span class=line><span class=cl><span class=s>tch URL&#34;</span><span class=p>,</span><span class=s>&#34;url&#34;</span><span class=p>:</span><span class=s>&#34;https://arlettebrook.github.io/&#34;</span><span class=p>,</span><span class=s>&#34;attempt&#34;</span><span class=p>:</span><span class=mi>3</span><span class=p>,</span><span class=s>&#34;backoff&#34;</span><span class=p>:</span><span class=mi>1</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=o>------</span><span class=nx>开发环境</span><span class=o>------</span>
</span></span><span class=line><span class=cl><span class=mi>2024</span><span class=o>-</span><span class=mo>04</span><span class=o>-</span><span class=mi>29</span><span class=nx>T15</span><span class=p>:</span><span class=mi>20</span><span class=p>:</span><span class=mf>11.820</span><span class=o>+</span><span class=mi>0800</span>    <span class=nx>DEBUG</span>   <span class=nx>learn</span><span class=o>/</span><span class=nx>main</span><span class=p>.</span><span class=k>go</span><span class=p>:</span><span class=mi>32</span>        <span class=nx>development</span> <span class=nx>failed</span> <span class=nx>to</span> <span class=nx>fetch</span> <span class=nx>URL</span> <span class=p>{</span><span class=s>&#34;
</span></span></span><span class=line><span class=cl><span class=s>url&#34;</span><span class=p>:</span> <span class=s>&#34;https://arlettebrook.github.io/&#34;</span><span class=p>,</span> <span class=s>&#34;attempt&#34;</span><span class=p>:</span> <span class=mi>3</span><span class=p>,</span> <span class=s>&#34;backoff&#34;</span><span class=p>:</span> <span class=s>&#34;1s&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=o>------</span><span class=nx>测试环境</span><span class=o>------</span>
</span></span><span class=line><span class=cl><span class=p>{</span><span class=s>&#34;level&#34;</span><span class=p>:</span><span class=s>&#34;info&#34;</span><span class=p>,</span><span class=s>&#34;msg&#34;</span><span class=p>:</span><span class=s>&#34;failed to fetch URL&#34;</span><span class=p>,</span><span class=s>&#34;url&#34;</span><span class=p>:</span><span class=s>&#34;https://arlettebrook.github.io/&#34;</span><span class=p>,</span><span class=s>&#34;attempt&#34;</span><span class=p>:</span><span class=mi>3</span><span class=p>,</span><span class=s>&#34;b
</span></span></span><span class=line><span class=cl><span class=s>ackoff&#34;</span><span class=p>:</span><span class=s>&#34;1s&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=o>------</span><span class=nx>sugaredLogger</span><span class=o>------</span>
</span></span><span class=line><span class=cl><span class=p>{</span><span class=s>&#34;level&#34;</span><span class=p>:</span><span class=s>&#34;info&#34;</span><span class=p>,</span><span class=s>&#34;msg&#34;</span><span class=p>:</span><span class=s>&#34;failed to fetch URL&#34;</span><span class=p>,</span><span class=s>&#34;url&#34;</span><span class=p>:</span><span class=s>&#34;https://arlettebrook.github.io/&#34;</span><span class=p>,</span><span class=s>&#34;attempt&#34;</span><span class=p>:</span><span class=mi>3</span><span class=p>,</span><span class=s>&#34;b
</span></span></span><span class=line><span class=cl><span class=s>ackoff&#34;</span><span class=p>:</span><span class=s>&#34;1s&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>{</span><span class=s>&#34;level&#34;</span><span class=p>:</span><span class=s>&#34;info&#34;</span><span class=p>,</span><span class=s>&#34;msg&#34;</span><span class=p>:</span><span class=s>&#34;Failed to fetch URL: https://arlettebrook.github.io/&#34;</span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>可以发现，通过 <code>zap.NewProduction()</code> 创建的日志对象输出格式为 JSON，而通过 <code>zap.NewDevelopment()</code> 创建的日志对象输出格式为 Text，日志后面追加的 key-value 会被转换成 JSON。并且，两者输出的字段内容也略有差异，如生产环境日志输出的时间格式为 <code>Unix epoch</code> 利于程序解析，而开发环境日志输出的时间格式为 <code>ISO8601</code> 更利于人类阅读。测试环境没有文件行号、堆栈跟踪信息以及时间，格式为JSON。对应的sugar都是是一样的。</p><p>导致以上这些差异的原因是配置不同，我们来看下 <code>zap.NewProduction</code> 和 <code>zap.NewDevelopment</code> 的代码实现：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>NewProduction</span><span class=p>(</span><span class=nx>options</span> <span class=o>...</span><span class=nx>Option</span><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>Logger</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nf>NewProductionConfig</span><span class=p>().</span><span class=nf>Build</span><span class=p>(</span><span class=nx>options</span><span class=o>...</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>NewProductionConfig</span><span class=p>()</span> <span class=nx>Config</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>Config</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>Level</span><span class=p>:</span>       <span class=nf>NewAtomicLevelAt</span><span class=p>(</span><span class=nx>InfoLevel</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>Development</span><span class=p>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>Sampling</span><span class=p>:</span> <span class=o>&amp;</span><span class=nx>SamplingConfig</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>Initial</span><span class=p>:</span>    <span class=mi>100</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>Thereafter</span><span class=p>:</span> <span class=mi>100</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=p>},</span>
</span></span><span class=line><span class=cl>		<span class=nx>Encoding</span><span class=p>:</span>         <span class=s>&#34;json&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>EncoderConfig</span><span class=p>:</span>    <span class=nf>NewProductionEncoderConfig</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>		<span class=nx>OutputPaths</span><span class=p>:</span>      <span class=p>[]</span><span class=kt>string</span><span class=p>{</span><span class=s>&#34;stderr&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>		<span class=nx>ErrorOutputPaths</span><span class=p>:</span> <span class=p>[]</span><span class=kt>string</span><span class=p>{</span><span class=s>&#34;stderr&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>NewDevelopment</span><span class=p>(</span><span class=nx>options</span> <span class=o>...</span><span class=nx>Option</span><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>Logger</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nf>NewDevelopmentConfig</span><span class=p>().</span><span class=nf>Build</span><span class=p>(</span><span class=nx>options</span><span class=o>...</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>NewDevelopmentConfig</span><span class=p>()</span> <span class=nx>Config</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>Config</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>Level</span><span class=p>:</span>            <span class=nf>NewAtomicLevelAt</span><span class=p>(</span><span class=nx>DebugLevel</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>Development</span><span class=p>:</span>      <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>Encoding</span><span class=p>:</span>         <span class=s>&#34;console&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>EncoderConfig</span><span class=p>:</span>    <span class=nf>NewDevelopmentEncoderConfig</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>		<span class=nx>OutputPaths</span><span class=p>:</span>      <span class=p>[]</span><span class=kt>string</span><span class=p>{</span><span class=s>&#34;stderr&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>		<span class=nx>ErrorOutputPaths</span><span class=p>:</span> <span class=p>[]</span><span class=kt>string</span><span class=p>{</span><span class=s>&#34;stderr&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>可以看到，两者在实现思路上是一样的，都是先创建一个配置对象 <code>zap.Config</code>，然后再调用配置对象的 <code>Build</code> 方法来构建 <code>Logger</code>。</p><p><code>zap.Config</code> 定义如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Config</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>Level</span> <span class=nx>AtomicLevel</span> <span class=s>`json:&#34;level&#34; yaml:&#34;level&#34;`</span>
</span></span><span class=line><span class=cl>	<span class=nx>Development</span> <span class=kt>bool</span> <span class=s>`json:&#34;development&#34; yaml:&#34;development&#34;`</span>
</span></span><span class=line><span class=cl>	<span class=nx>DisableCaller</span> <span class=kt>bool</span> <span class=s>`json:&#34;disableCaller&#34; yaml:&#34;disableCaller&#34;`</span>
</span></span><span class=line><span class=cl>	<span class=nx>DisableStacktrace</span> <span class=kt>bool</span> <span class=s>`json:&#34;disableStacktrace&#34; yaml:&#34;disableStacktrace&#34;`</span>
</span></span><span class=line><span class=cl>	<span class=nx>Sampling</span> <span class=o>*</span><span class=nx>SamplingConfig</span> <span class=s>`json:&#34;sampling&#34; yaml:&#34;sampling&#34;`</span>
</span></span><span class=line><span class=cl>	<span class=nx>Encoding</span> <span class=kt>string</span> <span class=s>`json:&#34;encoding&#34; yaml:&#34;encoding&#34;`</span>
</span></span><span class=line><span class=cl>	<span class=nx>EncoderConfig</span> <span class=nx>zapcore</span><span class=p>.</span><span class=nx>EncoderConfig</span> <span class=s>`json:&#34;encoderConfig&#34; yaml:&#34;encoderConfig&#34;`</span>
</span></span><span class=line><span class=cl>	<span class=nx>OutputPaths</span> <span class=p>[]</span><span class=kt>string</span> <span class=s>`json:&#34;outputPaths&#34; yaml:&#34;outputPaths&#34;`</span>
</span></span><span class=line><span class=cl>	<span class=nx>ErrorOutputPaths</span> <span class=p>[]</span><span class=kt>string</span> <span class=s>`json:&#34;errorOutputPaths&#34; yaml:&#34;errorOutputPaths&#34;`</span>
</span></span><span class=line><span class=cl>	<span class=nx>InitialFields</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kd>interface</span><span class=p>{}</span> <span class=s>`json:&#34;initialFields&#34; yaml:&#34;initialFields&#34;`</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>每个配置项说明如下：</p><ul><li><code>Level</code>: 日志级别。</li><li><code>Development</code>: 是否为开发模式。</li><li><code>DisableCaller</code>: 禁用调用信息，值为 <code>true</code> 时，日志中将不再显示记录日志时所在的函数调用文件名和行号。</li><li><code>DisableStacktrace</code>: 禁用堆栈跟踪捕获。</li><li><code>Sampling</code>: 采样策略配置，单位为每秒，作用是限制日志在每秒内的输出数量，以此来防止全局的 CPU 和 I/O 负载过高。</li><li><code>Encoding</code>: 指定日志编码器，目前支持 <code>json</code> 和 <code>console</code>。</li><li><code>EncoderConfig</code>: 编码配置，决定了日志字段格式。</li><li><code>OutputPaths</code>: 配置日志输出位置，URLs 或文件路径，可配置多个。</li><li><code>ErrorOutputPaths</code>: zap 包内部出现错误的日志输出位置，URLs 或文件路径，可配置多个，默认 <code>os.Stderr</code>。</li><li><code>InitialFields</code>: 初始化字段配置，该配置的字段会以结构化的形式打印在每条日志输出中。</li></ul><p>我们再来对比下 <code>NewProductionEncoderConfig()</code> 和 <code>NewDevelopmentEncoderConfig()</code> 这两个配置的不同：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>NewProductionEncoderConfig</span><span class=p>()</span> <span class=nx>zapcore</span><span class=p>.</span><span class=nx>EncoderConfig</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>zapcore</span><span class=p>.</span><span class=nx>EncoderConfig</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>TimeKey</span><span class=p>:</span>        <span class=s>&#34;ts&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>LevelKey</span><span class=p>:</span>       <span class=s>&#34;level&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>NameKey</span><span class=p>:</span>        <span class=s>&#34;logger&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>CallerKey</span><span class=p>:</span>      <span class=s>&#34;caller&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>FunctionKey</span><span class=p>:</span>    <span class=nx>zapcore</span><span class=p>.</span><span class=nx>OmitKey</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>MessageKey</span><span class=p>:</span>     <span class=s>&#34;msg&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>StacktraceKey</span><span class=p>:</span>  <span class=s>&#34;stacktrace&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>LineEnding</span><span class=p>:</span>     <span class=nx>zapcore</span><span class=p>.</span><span class=nx>DefaultLineEnding</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>EncodeLevel</span><span class=p>:</span>    <span class=nx>zapcore</span><span class=p>.</span><span class=nx>LowercaseLevelEncoder</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>EncodeTime</span><span class=p>:</span>     <span class=nx>zapcore</span><span class=p>.</span><span class=nx>EpochTimeEncoder</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>EncodeDuration</span><span class=p>:</span> <span class=nx>zapcore</span><span class=p>.</span><span class=nx>SecondsDurationEncoder</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>EncodeCaller</span><span class=p>:</span>   <span class=nx>zapcore</span><span class=p>.</span><span class=nx>ShortCallerEncoder</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>NewDevelopmentEncoderConfig</span><span class=p>()</span> <span class=nx>zapcore</span><span class=p>.</span><span class=nx>EncoderConfig</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>zapcore</span><span class=p>.</span><span class=nx>EncoderConfig</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// Keys can be anything except the empty string.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>TimeKey</span><span class=p>:</span>        <span class=s>&#34;T&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>LevelKey</span><span class=p>:</span>       <span class=s>&#34;L&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>NameKey</span><span class=p>:</span>        <span class=s>&#34;N&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>CallerKey</span><span class=p>:</span>      <span class=s>&#34;C&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>FunctionKey</span><span class=p>:</span>    <span class=nx>zapcore</span><span class=p>.</span><span class=nx>OmitKey</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>MessageKey</span><span class=p>:</span>     <span class=s>&#34;M&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>StacktraceKey</span><span class=p>:</span>  <span class=s>&#34;S&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>LineEnding</span><span class=p>:</span>     <span class=nx>zapcore</span><span class=p>.</span><span class=nx>DefaultLineEnding</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>EncodeLevel</span><span class=p>:</span>    <span class=nx>zapcore</span><span class=p>.</span><span class=nx>CapitalLevelEncoder</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>EncodeTime</span><span class=p>:</span>     <span class=nx>zapcore</span><span class=p>.</span><span class=nx>ISO8601TimeEncoder</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>EncodeDuration</span><span class=p>:</span> <span class=nx>zapcore</span><span class=p>.</span><span class=nx>StringDurationEncoder</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>EncodeCaller</span><span class=p>:</span>   <span class=nx>zapcore</span><span class=p>.</span><span class=nx>ShortCallerEncoder</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>对比来看，两者有很多不同的配置，比如生产环境下 <code>EncodeTime</code> 值为 <code>zapcore.EpochTimeEncoder</code>，开发环境下 <code>EncodeTime</code> 值为 <code>zapcore.ISO8601TimeEncoder</code>。这就是生产环境日志输出的时间格式为 <code>Unix epoch</code> 而开发环境日志输出的时间格式为 <code>ISO8601</code> 的原因。</p><p><code>zapcore.EncoderConfig</code> 其他几个常用的配置项说明如下：</p><ul><li><code>MessageKey</code>: 日志信息的键名，默认 <code>msg</code>。</li><li><code>LevelKey</code>: 日志级别的键名，默认 <code>level</code>。</li><li><code>TimeKey</code>: 日志时间的键名。</li><li><code>EncodeLevel</code>: 日志级别的格式，默认为小写，如 <code>info</code>。</li></ul><p>除了提供 <code>zap.NewProduction()</code> 和 <code>zap.NewDevelopment()</code> 两个构造函数外，zap 还提供了 <code>zap.NewExample()</code> 来创建一个 <code>Logger</code> 对象，这个方法主要用于测试，这里就不多介绍了。</p></li></ul><h3 id=记录层级关系><a href=#%e8%ae%b0%e5%bd%95%e5%b1%82%e7%ba%a7%e5%85%b3%e7%b3%bb class=header-anchor>#</a>
记录层级关系</h3><p>前面我们记录的日志都是一层结构，没有嵌套的层级。我们可以使用<code>zap.Namespace(key string) Field</code>构建一个<strong>命名空间</strong>，后续的<code>Field</code>都记录在此命名空间中：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-golang data-lang=golang><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>logger</span> <span class=o>:=</span> <span class=nx>zap</span><span class=p>.</span><span class=nf>NewExample</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=k>defer</span> <span class=nx>logger</span><span class=p>.</span><span class=nf>Sync</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>logger</span><span class=p>.</span><span class=nf>Info</span><span class=p>(</span><span class=s>&#34;tracked some metrics&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>zap</span><span class=p>.</span><span class=nf>Namespace</span><span class=p>(</span><span class=s>&#34;metrics&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=nx>zap</span><span class=p>.</span><span class=nf>Int</span><span class=p>(</span><span class=s>&#34;counter&#34;</span><span class=p>,</span> <span class=mi>1</span><span class=p>),</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>logger2</span> <span class=o>:=</span> <span class=nx>logger</span><span class=p>.</span><span class=nf>With</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>zap</span><span class=p>.</span><span class=nf>Namespace</span><span class=p>(</span><span class=s>&#34;metrics&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=nx>zap</span><span class=p>.</span><span class=nf>Int</span><span class=p>(</span><span class=s>&#34;counter&#34;</span><span class=p>,</span> <span class=mi>1</span><span class=p>),</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=nx>logger2</span><span class=p>.</span><span class=nf>Info</span><span class=p>(</span><span class=s>&#34;tracked some metrics&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>输出：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-golang data-lang=golang><span class=line><span class=cl><span class=p>{</span><span class=s>&#34;level&#34;</span><span class=p>:</span><span class=s>&#34;info&#34;</span><span class=p>,</span><span class=s>&#34;msg&#34;</span><span class=p>:</span><span class=s>&#34;tracked some metrics&#34;</span><span class=p>,</span><span class=s>&#34;metrics&#34;</span><span class=p>:{</span><span class=s>&#34;counter&#34;</span><span class=p>:</span><span class=mi>1</span><span class=p>}}</span>
</span></span><span class=line><span class=cl><span class=p>{</span><span class=s>&#34;level&#34;</span><span class=p>:</span><span class=s>&#34;info&#34;</span><span class=p>,</span><span class=s>&#34;msg&#34;</span><span class=p>:</span><span class=s>&#34;tracked some metrices&#34;</span><span class=p>,</span><span class=s>&#34;metrics&#34;</span><span class=p>:{</span><span class=s>&#34;counter&#34;</span><span class=p>:</span><span class=mi>1</span><span class=p>}}</span>
</span></span></code></pre></td></tr></table></div></div><p>上面我们演示了两种<code>Namespace</code>的用法，一种是直接作为字段传入<code>Debug/Info</code>等方法，一种是调用<code>With()</code>创建一个新的<code>Logger</code>，新的<code>Logger</code>记录日志时总是带上预设的字段。<code>With()</code>方法实际上是创建了一个新的<code>Logger</code>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-golang data-lang=golang><span class=line><span class=cl><span class=c1>// src/go.uber.org/zap/logger.go
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>log</span> <span class=o>*</span><span class=nx>Logger</span><span class=p>)</span> <span class=nf>With</span><span class=p>(</span><span class=nx>fields</span> <span class=o>...</span><span class=nx>Field</span><span class=p>)</span> <span class=o>*</span><span class=nx>Logger</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>fields</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>log</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nx>l</span> <span class=o>:=</span> <span class=nx>log</span><span class=p>.</span><span class=nf>clone</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=nx>l</span><span class=p>.</span><span class=nx>core</span> <span class=p>=</span> <span class=nx>l</span><span class=p>.</span><span class=nx>core</span><span class=p>.</span><span class=nf>With</span><span class=p>(</span><span class=nx>fields</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>l</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=预设日志字段><a href=#%e9%a2%84%e8%ae%be%e6%97%a5%e5%bf%97%e5%ad%97%e6%ae%b5 class=header-anchor>#</a>
预设日志字段</h3><p>如果每条日志都要记录一些共用的字段，那么使用<code>zap.Fields(fs ...Field)</code>创建的选项。例如在服务器日志中记录可能都需要记录<code>serverId</code>和<code>serverName</code>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-golang data-lang=golang><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>logger</span> <span class=o>:=</span> <span class=nx>zap</span><span class=p>.</span><span class=nf>NewExample</span><span class=p>(</span><span class=nx>zap</span><span class=p>.</span><span class=nf>Fields</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>zap</span><span class=p>.</span><span class=nf>Int</span><span class=p>(</span><span class=s>&#34;serverId&#34;</span><span class=p>,</span> <span class=mi>90</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=nx>zap</span><span class=p>.</span><span class=nf>String</span><span class=p>(</span><span class=s>&#34;serverName&#34;</span><span class=p>,</span> <span class=s>&#34;awesome web&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>  <span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>logger</span><span class=p>.</span><span class=nf>Info</span><span class=p>(</span><span class=s>&#34;hello world&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>输出：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=p>{</span><span class=s>&#34;level&#34;</span><span class=p>:</span><span class=s>&#34;info&#34;</span><span class=p>,</span><span class=s>&#34;msg&#34;</span><span class=p>:</span><span class=s>&#34;hello world&#34;</span><span class=p>,</span><span class=s>&#34;serverId&#34;</span><span class=p>:</span><span class=mi>90</span><span class=p>,</span><span class=s>&#34;serverName&#34;</span><span class=p>:</span><span class=s>&#34;awesome web&#34;</span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>与<code>logger.with()</code>差不多</p><h3 id=给语法加点糖><a href=#%e7%bb%99%e8%af%ad%e6%b3%95%e5%8a%a0%e7%82%b9%e7%b3%96 class=header-anchor>#</a>
给语法加点糖</h3><p>zap 虽然速度足够快，但是多数情况下，我们并不需要极致的性能，而是想让代码写起来更爽一些。zap 为我们提供了解决方案 —— <code>SugaredLogger</code>。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;time&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=s>&#34;go.uber.org/zap&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>logger</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>zap</span><span class=p>.</span><span class=nf>NewProduction</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>logger</span><span class=p>.</span><span class=nf>Sync</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>url</span> <span class=o>:=</span> <span class=s>&#34;https://arlettebrook.github.io/&#34;</span>
</span></span><span class=line><span class=cl>	<span class=nx>sugar</span> <span class=o>:=</span> <span class=nx>logger</span><span class=p>.</span><span class=nf>Sugar</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>sugar</span><span class=p>.</span><span class=nf>Infow</span><span class=p>(</span><span class=s>&#34;production failed to fetch URL&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=s>&#34;url&#34;</span><span class=p>,</span> <span class=nx>url</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=s>&#34;attempt&#34;</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=s>&#34;backoff&#34;</span><span class=p>,</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>sugar</span><span class=p>.</span><span class=nf>Info</span><span class=p>(</span><span class=s>&#34;Info&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>sugar</span><span class=p>.</span><span class=nf>Infoln</span><span class=p>(</span><span class=s>&#34;Infoln&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>sugar</span><span class=p>.</span><span class=nf>Infof</span><span class=p>(</span><span class=s>&#34;Infof: %s&#34;</span><span class=p>,</span> <span class=nx>url</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>通过 <code>logger.Sugar()</code> 方法可以将一个 <code>Logger</code> 对象转换成一个 <code>SugaredLogger</code> 对象。</p><p><code>SugaredLogger</code> 提供了更人性化的接口，日志中追加 key-value 时不在需要 <code>zap.String("url", url)</code> 这种显式指明类型的写法，只需要保证 key 为 <code>string</code> 类型，value 则可以为任意类型，能够减少我们编写的代码量。</p><p>此外，为了满足不同需求，<code>SugaredLogger</code> 提供了四种方式输出日志：<code>sugar.Xxx</code>、<code>sugar.Xxxw</code>、<code>sugar.Xxxf</code>、<code>sugar.Xxxln</code>。</p><p>执行以上代码，控制台得到如下输出：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=p>{</span><span class=s>&#34;level&#34;</span><span class=p>:</span><span class=s>&#34;info&#34;</span><span class=p>,</span><span class=s>&#34;ts&#34;</span><span class=p>:</span><span class=mf>1714398451.8505704</span><span class=p>,</span><span class=s>&#34;caller&#34;</span><span class=p>:</span><span class=s>&#34;learn/main.go:15&#34;</span><span class=p>,</span><span class=s>&#34;msg&#34;</span><span class=p>:</span><span class=s>&#34;production failed to fe
</span></span></span><span class=line><span class=cl><span class=s>tch URL&#34;</span><span class=p>,</span><span class=s>&#34;url&#34;</span><span class=p>:</span><span class=s>&#34;https://arlettebrook.github.io/&#34;</span><span class=p>,</span><span class=s>&#34;attempt&#34;</span><span class=p>:</span><span class=mi>3</span><span class=p>,</span><span class=s>&#34;backoff&#34;</span><span class=p>:</span><span class=mi>1</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>{</span><span class=s>&#34;level&#34;</span><span class=p>:</span><span class=s>&#34;info&#34;</span><span class=p>,</span><span class=s>&#34;ts&#34;</span><span class=p>:</span><span class=mf>1714398451.8511178</span><span class=p>,</span><span class=s>&#34;caller&#34;</span><span class=p>:</span><span class=s>&#34;learn/main.go:20&#34;</span><span class=p>,</span><span class=s>&#34;msg&#34;</span><span class=p>:</span><span class=s>&#34;Info&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>{</span><span class=s>&#34;level&#34;</span><span class=p>:</span><span class=s>&#34;info&#34;</span><span class=p>,</span><span class=s>&#34;ts&#34;</span><span class=p>:</span><span class=mf>1714398451.851623</span><span class=p>,</span><span class=s>&#34;caller&#34;</span><span class=p>:</span><span class=s>&#34;learn/main.go:21&#34;</span><span class=p>,</span><span class=s>&#34;msg&#34;</span><span class=p>:</span><span class=s>&#34;Infoln&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>{</span><span class=s>&#34;level&#34;</span><span class=p>:</span><span class=s>&#34;info&#34;</span><span class=p>,</span><span class=s>&#34;ts&#34;</span><span class=p>:</span><span class=mf>1714398451.8516397</span><span class=p>,</span><span class=s>&#34;caller&#34;</span><span class=p>:</span><span class=s>&#34;learn/main.go:22&#34;</span><span class=p>,</span><span class=s>&#34;msg&#34;</span><span class=p>:</span><span class=s>&#34;Infof: https://arletteb
</span></span></span><span class=line><span class=cl><span class=s>rook.github.io/&#34;</span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>我们知道，这种方便的写法是有一定代价的，所以开发中是否需要使用 <code>SugaredLogger</code> 来记录日志，需要根据程序的特点来决定。<code>SugaredLogger</code> 与 <code>Logger</code> 的性能对比同样可以在官方 <a class=link href=https://github.com/uber-go/zap#performance target=_blank rel=noopener>GitHub 仓库</a>中看到。</p><h3 id=定制-logger><a href=#%e5%ae%9a%e5%88%b6-logger class=header-anchor>#</a>
定制 Logger</h3><p>通过查看 <code>zap.NewProduction()</code> 和 <code>zap.NewDevelopment()</code> 两个构造函数源码，我们知道可以使用 <code>zap.Config</code> 对象的 <code>Build</code> 方法创建 <code>Logger</code> 对象。那么我们很容易能够想到，如果要定制 <code>Logger</code>，只需要创建一个定制的 <code>zap.Config</code> 即可。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;go.uber.org/zap&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;go.uber.org/zap/zapcore&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>newCustomLogger</span><span class=p>()</span> <span class=p>(</span><span class=o>*</span><span class=nx>zap</span><span class=p>.</span><span class=nx>Logger</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>cfg</span> <span class=o>:=</span> <span class=nx>zap</span><span class=p>.</span><span class=nx>Config</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>Level</span><span class=p>:</span>       <span class=nx>zap</span><span class=p>.</span><span class=nf>NewAtomicLevelAt</span><span class=p>(</span><span class=nx>zap</span><span class=p>.</span><span class=nx>DebugLevel</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>Development</span><span class=p>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>Encoding</span><span class=p>:</span>    <span class=s>&#34;json&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>EncoderConfig</span><span class=p>:</span> <span class=nx>zapcore</span><span class=p>.</span><span class=nx>EncoderConfig</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>TimeKey</span><span class=p>:</span>        <span class=s>&#34;time&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>LevelKey</span><span class=p>:</span>       <span class=s>&#34;level&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>NameKey</span><span class=p>:</span>        <span class=s>&#34;logger&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>CallerKey</span><span class=p>:</span>      <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=c1>// 不记录日志调用位置
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>FunctionKey</span><span class=p>:</span>    <span class=nx>zapcore</span><span class=p>.</span><span class=nx>OmitKey</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>MessageKey</span><span class=p>:</span>     <span class=s>&#34;message&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>LineEnding</span><span class=p>:</span>     <span class=nx>zapcore</span><span class=p>.</span><span class=nx>DefaultLineEnding</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>EncodeLevel</span><span class=p>:</span>    <span class=nx>zapcore</span><span class=p>.</span><span class=nx>LowercaseLevelEncoder</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>EncodeTime</span><span class=p>:</span>     <span class=nx>zapcore</span><span class=p>.</span><span class=nx>RFC3339TimeEncoder</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>EncodeDuration</span><span class=p>:</span> <span class=nx>zapcore</span><span class=p>.</span><span class=nx>SecondsDurationEncoder</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>EncodeCaller</span><span class=p>:</span>   <span class=nx>zapcore</span><span class=p>.</span><span class=nx>ShortCallerEncoder</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=p>},</span>
</span></span><span class=line><span class=cl>		<span class=nx>OutputPaths</span><span class=p>:</span>      <span class=p>[]</span><span class=kt>string</span><span class=p>{</span><span class=s>&#34;stdout&#34;</span><span class=p>,</span> <span class=s>&#34;test.log&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>		<span class=nx>ErrorOutputPaths</span><span class=p>:</span> <span class=p>[]</span><span class=kt>string</span><span class=p>{</span><span class=s>&#34;error.log&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>cfg</span><span class=p>.</span><span class=nf>Build</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>logger</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nf>newCustomLogger</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>logger</span><span class=p>.</span><span class=nf>Sync</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 增加一个 skip 选项，触发 zap 内部 error，将错误输出到 error.log
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>logger</span> <span class=p>=</span> <span class=nx>logger</span><span class=p>.</span><span class=nf>WithOptions</span><span class=p>(</span><span class=nx>zap</span><span class=p>.</span><span class=nf>AddCallerSkip</span><span class=p>(</span><span class=mi>100</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>logger</span><span class=p>.</span><span class=nf>Info</span><span class=p>(</span><span class=s>&#34;Info msg&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>logger</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=s>&#34;Error msg&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>以上代码通过 <code>newCustomLogger</code> 函数创建了一个自定义的 <code>Logger</code>，同样通过先定义一个 <code>zap.Config</code> 然后再调用其 <code>Build</code> 方法来实现。</p><p>配置日志分别输出到标准输出和 <code>test.log</code> 文件，执行以上代码，控制台和 <code>test.log</code> 都会得到如下输出：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=p>{</span><span class=s>&#34;level&#34;</span><span class=p>:</span><span class=s>&#34;info&#34;</span><span class=p>,</span><span class=s>&#34;time&#34;</span><span class=p>:</span><span class=s>&#34;2023-03-19T19:19:18+08:00&#34;</span><span class=p>,</span><span class=s>&#34;message&#34;</span><span class=p>:</span><span class=s>&#34;Info msg&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>{</span><span class=s>&#34;level&#34;</span><span class=p>:</span><span class=s>&#34;error&#34;</span><span class=p>,</span><span class=s>&#34;time&#34;</span><span class=p>:</span><span class=s>&#34;2023-03-19T19:19:18+08:00&#34;</span><span class=p>,</span><span class=s>&#34;message&#34;</span><span class=p>:</span><span class=s>&#34;Error msg&#34;</span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>另外，我们还通过 <code>logger.WithOptions()</code> 为 <code>Logger</code> 对象增加了一个选项 <code>zap.AddCallerSkip(100)</code>，这个选项的作用是指定在通过调用栈获得行号时跳过的调用深度，因为我们的函数调用栈并不是 100 层，所以会触发 zap 内部错误，zap 会将错误日志输出到 <code>ErrorOutputPaths</code> 配置指定的位置中，即 <code>error.log</code>。</p><p><code>error.log</code> 得到的错误日志如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=mi>2023</span><span class=o>-</span><span class=mo>03</span><span class=o>-</span><span class=mi>19</span> <span class=mi>11</span><span class=p>:</span><span class=mi>19</span><span class=p>:</span><span class=mf>18.438824</span> <span class=o>+</span><span class=mo>0000</span> <span class=nx>UTC</span> <span class=nx>Logger</span><span class=p>.</span><span class=nx>check</span> <span class=kt>error</span><span class=p>:</span> <span class=nx>failed</span> <span class=nx>to</span> <span class=nx>get</span> <span class=nx>caller</span>
</span></span><span class=line><span class=cl><span class=mi>2023</span><span class=o>-</span><span class=mo>03</span><span class=o>-</span><span class=mi>19</span> <span class=mi>11</span><span class=p>:</span><span class=mi>19</span><span class=p>:</span><span class=mf>18.44921</span> <span class=o>+</span><span class=mo>0000</span> <span class=nx>UTC</span> <span class=nx>Logger</span><span class=p>.</span><span class=nx>check</span> <span class=kt>error</span><span class=p>:</span> <span class=nx>failed</span> <span class=nx>to</span> <span class=nx>get</span> <span class=nx>caller</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=选项><a href=#%e9%80%89%e9%a1%b9 class=header-anchor>#</a>
选项</h4><p><code>logger.WithOptions()</code> 支持的选项如下：</p><ul><li><code>WrapCore(f func(zapcore.Core) zapcore.Core)</code>: 使用一个新的 <code>zapcore.Core</code> 替换掉 <code>Logger</code> 内部原有的的 <code>zapcore.Core</code> 属性。</li><li><code>Hooks(hooks ...func(zapcore.Entry) error)</code>: 注册钩子函数，用来在日志打印时同时调用注册的钩子函数。</li><li><code>Fields(fs ...Field)</code>: 添加公共字段。</li><li><code>ErrorOutput(w zapcore.WriteSyncer)</code>: 指定日志组件内部出现异常时的输出位置。</li><li><code>Development()</code>: 将日志记录器设为开发模式，这将使 <code>DPanic</code> 级别日志记录错误后执行 <code>panic()</code>。</li><li><code>AddCaller()</code>: 与 <code>WithCaller(true)</code> 等价。</li><li><code>WithCaller(enabled bool)</code>: 指定是否在日志输出内容中增加调用信息，即文件名和行号。</li><li><code>AddCallerSkip(skip int)</code>: 指定在通过调用栈获取文件名和行号时跳过的调用深度。</li><li><code>AddStacktrace(lvl zapcore.LevelEnabler)</code>: 用来指定某个日志级别及以上级别输出调用堆栈。</li><li><code>IncreaseLevel(lvl zapcore.LevelEnabler)</code>: 提高日志级别，如果传入的 <code>lvl</code> 比现有级别低，则不会改变日志级别。</li><li><code>WithFatalHook(hook zapcore.CheckWriteHook)</code>: 当出现 <code>Fatal</code> 级别日志时调用的钩子函数。</li><li><code>WithClock(clock zapcore.Clock)</code>: 指定日志记录器用来确定当前时间的 <code>zapcore.Clock</code> 对象，默认为 <code>time.Now</code> 的系统时钟。</li></ul><p><code>NewExample()/NewDevelopment()/NewProduction()</code>这 3 个函数可以传入若干类型为<code>zap.Option</code>的选项，从而定制<code>Logger</code>的行为。又一次见到了<strong>选项模式</strong>！！</p><p><code>zap</code>提供了丰富的选项供我们选择。</p><ul><li><p>输出文件名和行号</p><p>调用<code>zap.AddCaller()</code>返回的选项设置输出文件名和行号。但是有一个前提，必须设置配置对象<code>Config</code>中的<code>CallerKey</code>字段。也因此<code>NewExample()</code>不能输出这个信息（它的<code>Config</code>没有设置<code>CallerKey</code>）。</p><p><code>AddCaller()</code>与<code>zap.WithCaller(true)</code>等价。一般不用</p><p>有时我们稍微封装了一下记录日志的方法，但是我们希望输出的文件名和行号是调用封装函数的位置。这时可以使用<code>zap.AddCallerSkip(skip int)</code>向上跳 1 层。可能会用到。</p></li><li><p>输出调用堆栈</p><p>有时候在某个函数处理中遇到了异常情况，因为这个函数可能在很多地方被调用。如果我们能输出此次调用的堆栈，那么分析起来就会很方便。我们可以使用<code>zap.AddStackTrace(lvl zapcore.LevelEnabler)</code>达成这个目的。该函数指定<code>lvl</code>和之上的级别都需要输出调用堆栈：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;go.uber.org/zap&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;go.uber.org/zap/zapcore&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>f1</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>f2</span><span class=p>(</span><span class=s>&#34;hello world&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>f2</span><span class=p>(</span><span class=nx>msg</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>fields</span> <span class=o>...</span><span class=nx>zap</span><span class=p>.</span><span class=nx>Field</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>zap</span><span class=p>.</span><span class=nf>L</span><span class=p>().</span><span class=nf>Warn</span><span class=p>(</span><span class=nx>msg</span><span class=p>,</span> <span class=nx>fields</span><span class=o>...</span><span class=p>)</span> <span class=c1>// zap.L()获取全局logger
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>logger</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>zap</span><span class=p>.</span><span class=nf>NewDevelopment</span><span class=p>(</span><span class=nx>zap</span><span class=p>.</span><span class=nf>AddStacktrace</span><span class=p>(</span><span class=nx>zapcore</span><span class=p>.</span><span class=nx>WarnLevel</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=k>defer</span> <span class=nx>logger</span><span class=p>.</span><span class=nf>Sync</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>zap</span><span class=p>.</span><span class=nf>ReplaceGlobals</span><span class=p>(</span><span class=nx>logger</span><span class=p>)</span> <span class=c1>// 替换全局logger
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=nf>f1</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>将<code>zapcore.WarnLevel</code>传入<code>AddStacktrace()</code>，之后<code>Warn()/Error()</code>等级别的日志会输出堆栈，<code>Debug()/Info()</code>这些级别不会。运行结果：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=mi>2024</span><span class=o>-</span><span class=mo>04</span><span class=o>-</span><span class=mi>30</span><span class=nx>T10</span><span class=p>:</span><span class=mi>32</span><span class=p>:</span><span class=mf>49.798</span><span class=o>+</span><span class=mi>0800</span>    <span class=nx>WARN</span>    <span class=nx>learn</span><span class=o>/</span><span class=nx>main</span><span class=p>.</span><span class=k>go</span><span class=p>:</span><span class=mi>13</span>        <span class=nx>hello</span> <span class=nx>world</span>
</span></span><span class=line><span class=cl><span class=nx>main</span><span class=p>.</span><span class=nx>f2</span>
</span></span><span class=line><span class=cl>        <span class=nx>F</span><span class=p>:</span><span class=o>/</span><span class=nx>GoProject</span><span class=o>/</span><span class=nx>learn</span><span class=o>/</span><span class=nx>main</span><span class=p>.</span><span class=k>go</span><span class=p>:</span><span class=mi>13</span>
</span></span><span class=line><span class=cl><span class=nx>main</span><span class=p>.</span><span class=nx>f1</span>
</span></span><span class=line><span class=cl>        <span class=nx>F</span><span class=p>:</span><span class=o>/</span><span class=nx>GoProject</span><span class=o>/</span><span class=nx>learn</span><span class=o>/</span><span class=nx>main</span><span class=p>.</span><span class=k>go</span><span class=p>:</span><span class=mi>9</span>
</span></span><span class=line><span class=cl><span class=nx>main</span><span class=p>.</span><span class=nx>main</span>
</span></span><span class=line><span class=cl>        <span class=nx>F</span><span class=p>:</span><span class=o>/</span><span class=nx>GoProject</span><span class=o>/</span><span class=nx>learn</span><span class=o>/</span><span class=nx>main</span><span class=p>.</span><span class=k>go</span><span class=p>:</span><span class=mi>22</span>
</span></span><span class=line><span class=cl><span class=nx>runtime</span><span class=p>.</span><span class=nx>main</span>
</span></span><span class=line><span class=cl>        <span class=nx>D</span><span class=p>:</span><span class=o>/</span><span class=nx>Go</span><span class=o>/</span><span class=nx>src</span><span class=o>/</span><span class=nx>runtime</span><span class=o>/</span><span class=nx>proc</span><span class=p>.</span><span class=k>go</span><span class=p>:</span><span class=mi>271</span>
</span></span></code></pre></td></tr></table></div></div><p>很清楚地看到调用路径。</p></li></ul><p>创建自定义的配置对象，除了在代码中指定配置参数，也可以将这些配置项写入到 JSON 文件中，然后通过 <code>json.Unmarshal</code> 的方式将配置绑定到 <code>zap.Config</code>，可以参考<a class=link href=https://pkg.go.dev/go.uber.org/zap#example-package-BasicConfiguration target=_blank rel=noopener>官方示例</a>。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-golang data-lang=golang><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>rawJSON</span> <span class=o>:=</span> <span class=p>[]</span><span class=nb>byte</span><span class=p>(</span><span class=s>`{
</span></span></span><span class=line><span class=cl><span class=s>    &#34;level&#34;:&#34;debug&#34;,
</span></span></span><span class=line><span class=cl><span class=s>    &#34;encoding&#34;:&#34;json&#34;,
</span></span></span><span class=line><span class=cl><span class=s>    &#34;outputPaths&#34;: [&#34;stdout&#34;, &#34;server.log&#34;],
</span></span></span><span class=line><span class=cl><span class=s>    &#34;errorOutputPaths&#34;: [&#34;stderr&#34;],
</span></span></span><span class=line><span class=cl><span class=s>    &#34;initialFields&#34;:{&#34;name&#34;:&#34;dj&#34;},
</span></span></span><span class=line><span class=cl><span class=s>    &#34;encoderConfig&#34;: {
</span></span></span><span class=line><span class=cl><span class=s>      &#34;messageKey&#34;: &#34;message&#34;,
</span></span></span><span class=line><span class=cl><span class=s>      &#34;levelKey&#34;: &#34;level&#34;,
</span></span></span><span class=line><span class=cl><span class=s>      &#34;levelEncoder&#34;: &#34;lowercase&#34;
</span></span></span><span class=line><span class=cl><span class=s>    }
</span></span></span><span class=line><span class=cl><span class=s>  }`</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>var</span> <span class=nx>cfg</span> <span class=nx>zap</span><span class=p>.</span><span class=nx>Config</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>json</span><span class=p>.</span><span class=nf>Unmarshal</span><span class=p>(</span><span class=nx>rawJSON</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>cfg</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nb>panic</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nx>logger</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>cfg</span><span class=p>.</span><span class=nf>Build</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nb>panic</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>defer</span> <span class=nx>logger</span><span class=p>.</span><span class=nf>Sync</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>logger</span><span class=p>.</span><span class=nf>Info</span><span class=p>(</span><span class=s>&#34;server start work successfully!&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>上面创建一个输出到标准输出<code>stdout</code>和文件<code>server.log</code>的<code>Logger</code>。观察输出：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=p>{</span><span class=s>&#34;level&#34;</span><span class=p>:</span><span class=s>&#34;info&#34;</span><span class=p>,</span><span class=s>&#34;message&#34;</span><span class=p>:</span><span class=s>&#34;server start work successfully!&#34;</span><span class=p>,</span><span class=s>&#34;name&#34;</span><span class=p>:</span><span class=s>&#34;dj&#34;</span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=全局logger><a href=#%e5%85%a8%e5%b1%80logger class=header-anchor>#</a>
全局<code>Logger</code></h3><p>为了方便使用，<code>zap</code>提供了两个全局的<code>Logger</code>，一个是<code>*zap.Logger</code>，可调用<code>zap.L()</code>获得；另一个是<code>*zap.SugaredLogger</code>，可调用<code>zap.S()</code>获得。需要注意的是，全局的<code>Logger</code>默认并不会记录日志！它是一个无实际效果的<code>Logger</code>。看源码:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-golang data-lang=golang><span class=line><span class=cl><span class=c1>// go.uber.org/zap/global.go
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>var</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=nx>_globalMu</span> <span class=nx>sync</span><span class=p>.</span><span class=nx>RWMutex</span>
</span></span><span class=line><span class=cl>  <span class=nx>_globalL</span>  <span class=p>=</span> <span class=nf>NewNop</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=nx>_globalS</span>  <span class=p>=</span> <span class=nx>_globalL</span><span class=p>.</span><span class=nf>Sugar</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>我们可以使用<code>ReplaceGlobals(logger *Logger) func()</code>将<code>logger</code>设置为全局的<code>Logger</code>，该函数返回一个无参函数，用于恢复全局<code>Logger</code>设置：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-golang data-lang=golang><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>zap</span><span class=p>.</span><span class=nf>L</span><span class=p>().</span><span class=nf>Info</span><span class=p>(</span><span class=s>&#34;global Logger before&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=nx>zap</span><span class=p>.</span><span class=nf>S</span><span class=p>().</span><span class=nf>Info</span><span class=p>(</span><span class=s>&#34;global SugaredLogger before&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>logger</span> <span class=o>:=</span> <span class=nx>zap</span><span class=p>.</span><span class=nf>NewExample</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=k>defer</span> <span class=nx>logger</span><span class=p>.</span><span class=nf>Sync</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>zap</span><span class=p>.</span><span class=nf>ReplaceGlobals</span><span class=p>(</span><span class=nx>logger</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=nx>zap</span><span class=p>.</span><span class=nf>L</span><span class=p>().</span><span class=nf>Info</span><span class=p>(</span><span class=s>&#34;global Logger after&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=nx>zap</span><span class=p>.</span><span class=nf>S</span><span class=p>().</span><span class=nf>Info</span><span class=p>(</span><span class=s>&#34;global SugaredLogger after&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>输出：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-golang data-lang=golang><span class=line><span class=cl><span class=p>{</span><span class=s>&#34;level&#34;</span><span class=p>:</span><span class=s>&#34;info&#34;</span><span class=p>,</span><span class=s>&#34;msg&#34;</span><span class=p>:</span><span class=s>&#34;global Logger after&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>{</span><span class=s>&#34;level&#34;</span><span class=p>:</span><span class=s>&#34;info&#34;</span><span class=p>,</span><span class=s>&#34;msg&#34;</span><span class=p>:</span><span class=s>&#34;global SugaredLogger after&#34;</span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>可以看到在调用<code>ReplaceGlobals</code>之前记录的日志并没有输出。</p><h3 id=与标准日志库搭配使用><a href=#%e4%b8%8e%e6%a0%87%e5%87%86%e6%97%a5%e5%bf%97%e5%ba%93%e6%90%ad%e9%85%8d%e4%bd%bf%e7%94%a8 class=header-anchor>#</a>
与标准日志库搭配使用</h3><p>如果项目一开始使用的是标准日志库<code>log</code>，后面想转为<code>zap</code>。这时不必修改每一个文件。我们可以调用<code>zap.NewStdLog(l *Logger) *log.Logger</code>返回一个标准的<code>log.Logger</code>，内部实际上写入的还是我们之前创建的<code>zap.Logger</code>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-golang data-lang=golang><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>logger</span> <span class=o>:=</span> <span class=nx>zap</span><span class=p>.</span><span class=nf>NewExample</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=k>defer</span> <span class=nx>logger</span><span class=p>.</span><span class=nf>Sync</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>std</span> <span class=o>:=</span> <span class=nx>zap</span><span class=p>.</span><span class=nf>NewStdLog</span><span class=p>(</span><span class=nx>logger</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=nx>std</span><span class=p>.</span><span class=nf>Print</span><span class=p>(</span><span class=s>&#34;standard logger wrapper&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>输出：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=p>{</span><span class=s>&#34;level&#34;</span><span class=p>:</span><span class=s>&#34;info&#34;</span><span class=p>,</span><span class=s>&#34;msg&#34;</span><span class=p>:</span><span class=s>&#34;standard logger wrapper&#34;</span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>很方便不是吗？我们还可以使用<code>NewStdLogAt(l *logger, level zapcore.Level) (*log.Logger, error)</code>让标准接口以<code>level</code>级别写入内部的<code>*zap.Logger</code>。</p><p>如果我们只是想在一段代码内使用标准日志库<code>log</code>，其它地方还是使用<code>zap.Logger</code>。可以调用<code>RedirectStdLog(l *Logger) func()</code>。它会返回一个无参函数恢复设置：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-golang data-lang=golang><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>logger</span> <span class=o>:=</span> <span class=nx>zap</span><span class=p>.</span><span class=nf>NewExample</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=k>defer</span> <span class=nx>logger</span><span class=p>.</span><span class=nf>Sync</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>undo</span> <span class=o>:=</span> <span class=nx>zap</span><span class=p>.</span><span class=nf>RedirectStdLog</span><span class=p>(</span><span class=nx>logger</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=nx>log</span><span class=p>.</span><span class=nf>Print</span><span class=p>(</span><span class=s>&#34;redirected standard library&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=nf>undo</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>log</span><span class=p>.</span><span class=nf>Print</span><span class=p>(</span><span class=s>&#34;restored standard library&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>看前后输出变化：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-golang data-lang=golang><span class=line><span class=cl><span class=p>{</span><span class=s>&#34;level&#34;</span><span class=p>:</span><span class=s>&#34;info&#34;</span><span class=p>,</span><span class=s>&#34;msg&#34;</span><span class=p>:</span><span class=s>&#34;redirected standard library&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=mi>2020</span><span class=o>/</span><span class=mo>04</span><span class=o>/</span><span class=mi>24</span> <span class=mi>22</span><span class=p>:</span><span class=mi>13</span><span class=p>:</span><span class=mi>58</span> <span class=nx>restored</span> <span class=nx>standard</span> <span class=nx>library</span>
</span></span></code></pre></td></tr></table></div></div><p>当然<code>RedirectStdLog</code>也有一个对应的<code>RedirectStdLogAt</code>以特定的级别调用内部的<code>*zap.Logger</code>方法。</p><h2 id=参考><a href=#%e5%8f%82%e8%80%83 class=header-anchor>#</a>
参考</h2><blockquote><ol><li><a class=link href=https://darjun.github.io/2020/04/23/godailylib/zap/ target=_blank rel=noopener>Go 每日一库之 zap</a></li><li>zap 源码: <a class=link href=https://github.com/uber-go/zap target=_blank rel=noopener>https://github.com/uber-go/zap</a></li><li>zap 文档: <a class=link href=https://pkg.go.dev/go.uber.org/zap target=_blank rel=noopener>https://pkg.go.dev/go.uber.org/zap</a></li><li><a class=link href=https://jianghushinian.cn/2023/03/19/use-of-zap-in-go-third-party-log-library/ target=_blank rel=noopener>Go 第三方 log 库之 zap 使用</a></li><li><a class=link href=https://jianghushinian.cn/2023/04/16/how-to-wrap-a-more-user-friendly-logging-package-based-on-zap/ target=_blank rel=noopener>如何基于 zap 封装一个更好用的日志库</a></li></ol></blockquote></section><footer class=article-footer><section class=article-tags><a href=/tags/go%E7%AC%AC%E4%B8%89%E6%96%B9%E5%BA%93/>Go第三方库</a></section><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>相关文章</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/p/go%E8%A7%A3%E6%9E%90%E5%91%BD%E4%BB%A4%E8%A1%8C%E9%80%89%E9%A1%B9%E4%B9%8B%E7%AC%AC%E4%B8%89%E6%96%B9%E5%BA%93go-flags/><div class=article-details><h2 class=article-title>Go解析命令行选项之第三方库go-flags</h2></div></a></article><article><a href=/p/go-homedir%E5%BA%93%E4%BB%8B%E7%BB%8D/><div class=article-details><h2 class=article-title>Go-homedir库介绍</h2></div></a></article><article><a href=/p/go%E5%B8%B8%E8%A7%81%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E9%80%89%E9%A1%B9%E6%A8%A1%E5%BC%8F/><div class=article-details><h2 class=article-title>Go常见设计模式：选项模式</h2></div></a></article><article><a href=/p/go%E5%B8%B8%E8%A7%81%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F/><div class=article-details><h2 class=article-title>Go常见设计模式：单例模式</h2></div></a></article><article><a href=/p/go%E8%B0%83%E7%94%A8%E5%A4%96%E9%83%A8%E5%91%BD%E4%BB%A4os/exec%E5%BA%93%E4%BB%8B%E7%BB%8D/><div class=article-details><h2 class=article-title>Go调用外部命令os/exec库介绍</h2></div></a></article></div></div></aside><script src=//unpkg.com/@waline/client@v2/dist/waline.js></script><link href=//unpkg.com/@waline/client@v2/dist/waline.css rel=stylesheet><div id=waline class=waline-container></div><style>.waline-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding);--waline-font-size:var(--article-font-size)}.waline-container .wl-count{color:var(--card-text-color-main)}</style><script>Waline.init({copyright:!1,dark:'html[data-scheme="dark"]',el:"#waline",emoji:["https://unpkg.com/@waline/emojis@1.0.1/weibo"],lang:"zh-cn",locale:{admin:"👻Hi!",placeholder:"🎉留下你的脚印..."},pageview:!0,requiredMeta:["name","email"],serverURL:"https://waline.trojan123.top/"})</script><footer class=site-footer><section class=copyright>&copy;
2020 -
2024 Arlettebrook</section><section class=powerby>使用 <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> 构建<br>主题 <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.25.0>Stack</a></b> 由 <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> 设计</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>