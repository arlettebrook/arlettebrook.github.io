<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="Go第三方日志库之logrus介绍"><title>Logrus Introduction</title>
<link rel=canonical href=https://arlettebrook.github.io/p/logrus-introduction/><link rel=stylesheet href=/scss/style.min.59d76563977ef6a76d0c7df16aa86c7ac37ed8942ba1442046cb6cf3b07439d7.css><meta property='og:title' content="Logrus Introduction"><meta property='og:description' content="Go第三方日志库之logrus介绍"><meta property='og:url' content='https://arlettebrook.github.io/p/logrus-introduction/'><meta property='og:site_name' content="Arlettebrook's blog"><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='Go第三方库'><meta property='article:published_time' content='2024-05-09T10:31:23+08:00'><meta property='article:modified_time' content='2024-05-09T10:31:23+08:00'><meta name=twitter:site content="@arlettebrook"><meta name=twitter:creator content="@arlettebrook"><meta name=twitter:title content="Logrus Introduction"><meta name=twitter:description content="Go第三方日志库之logrus介绍"><link rel="shortcut icon" href=/img/favicon.ico></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><div id=article-toolbar style=position:sticky;top:5px;z-index:1000><a href=/ class=back-home><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-chevron-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="15 6 9 12 15 18"/></svg>
<span>返回</span></a></div><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">目录</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#特点>特点</a></li><li><a href=#快速使用>快速使用</a></li><li><a href=#使用>使用</a><ol><li><a href=#替代-go-log-标准库>替代 Go log 标准库</a></li><li><a href=#基本使用>基本使用</a><ol><li><a href=#修改日志级别>修改日志级别</a></li><li><a href=#输出调用信息>输出调用信息</a></li><li><a href=#添加字段>添加字段</a></li><li><a href=#重定向输出>重定向输出</a></li></ol></li><li><a href=#处理不同环境>处理不同环境</a></li><li><a href=#测试>测试</a></li><li><a href=#自定义-logger>自定义 Logger</a><ol><li><a href=#修改日志格式>修改日志格式</a></li></ol></li></ol></li><li><a href=#hooks>Hooks</a><ol><li><a href=#自定义hook>自定义Hook</a><ol><li><a href=#利用hook添加字段>利用Hook添加字段</a></li><li><a href=#利用hook模拟邮件发送>利用Hook模拟邮件发送</a></li></ol></li><li><a href=#第三方hook>第三方Hook</a><ol><li><a href=#lumberjackrus>lumberjackrus</a></li><li><a href=#logrus-redis-hook>logrus-redis-hook</a></li></ol></li></ol></li><li><a href=#总结>总结</a></li><li><a href=#参考>参考</a></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/go/ style=background-color:#f97300;color:#fff>Go
</a><a href=/categories/%E7%BC%96%E7%A8%8B/ style=background-color:#41b06e;color:#fff>编程</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/logrus-introduction/>Logrus Introduction</a></h2><h3 class=article-subtitle>Go第三方日志库之logrus介绍</h3></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>May 09, 2024</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>阅读时长: 17 分钟</time></div></footer></div></header><section class=article-content><hr><blockquote><p><a class=link href=https://github.com/sirupsen/logrus target=_blank rel=noopener>Logrus</a> 是目前 GitHub 上 Star 数量最多的 Go 日志库。尽管目前 Logrus 处于维护模式，不再引入新功能，但这并不意味着它已经死了。Logrus 仍将继续维护，以确保安全性、错误修复和提高性能。作为 Go 社区中最受欢迎的日志库之一，Logrus 最大的贡献是推动了 Go 社区广泛使用结构化（如JSON格式)的日志记录。著名的 Docker 项目就在使用 Logrus 记录日志，这进一步证明了其在实际应用中的可靠性和实用性。</p></blockquote><hr><h2 id=特点><a href=#%e7%89%b9%e7%82%b9 class=header-anchor>#</a>
特点</h2><p>Logrus 具有如下特点：</p><ul><li>与 Go log 标准库 API 完全兼容，这意味着任何使用 log 标准库的代码都可以将日志库无缝切换到 Logrus。</li><li>支持七种日志级别：<code>Trace</code>、<code>Debug</code>、<code>Info</code>、<code>Warn</code>、<code>Error</code>、<code>Fatal</code>、<code>Panic</code>。</li><li>支持结构化日志记录（key-value 形式，容易被程序解析，如 JSON 格式），通过 Filed 机制进行结构化的日志记录。</li><li>支持自定义日志格式，内置两种格式 <code>JSONFormatter</code>（JSON 格式） 和 <code>TextFormatter</code>（文本格式），并允许用户通过实现 <code>Formatter</code> 接口来自定义日志格式。</li><li>支持可扩展的 Hooks 机制，可以为不同级别的日志添加 Hooks 将日志记录到不同位置，例如将 <code>Error</code>、<code>Fatal</code> 和 <code>Panic</code> 级别的错误日志发送到 logstash、kafka 等。</li><li>支持在控制台输出带有不同颜色的日志。</li><li>并发安全。</li></ul><hr><h2 id=快速使用><a href=#%e5%bf%ab%e9%80%9f%e4%bd%bf%e7%94%a8 class=header-anchor>#</a>
快速使用</h2><p>第三方库需要先安装：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ go get -u github.com/sirupsen/logrus
</span></span></code></pre></td></tr></table></div></div><p>后使用：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;github.com/sirupsen/logrus&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>logrus</span><span class=p>.</span><span class=nf>SetLevel</span><span class=p>(</span><span class=nx>logrus</span><span class=p>.</span><span class=nx>TraceLevel</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>logrus</span><span class=p>.</span><span class=nf>Trace</span><span class=p>(</span><span class=s>&#34;trace msg&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>logrus</span><span class=p>.</span><span class=nf>Debug</span><span class=p>(</span><span class=s>&#34;debug msg&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>logrus</span><span class=p>.</span><span class=nf>Info</span><span class=p>(</span><span class=s>&#34;info msg&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>logrus</span><span class=p>.</span><span class=nf>Warn</span><span class=p>(</span><span class=s>&#34;warn msg&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>logrus</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=s>&#34;error msg&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>logrus</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=s>&#34;fatal msg&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>logrus</span><span class=p>.</span><span class=nf>Panic</span><span class=p>(</span><span class=s>&#34;panic msg&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p><code>logrus</code>的使用非常简单，与标准库<code>log</code>类似。<code>logrus</code>支持更多的日志级别：</p><ul><li><code>Panic</code>：记录日志，然后<code>panic</code>。</li><li><code>Fatal</code>：致命错误，出现错误时程序无法正常运转。输出日志后，程序退出；</li><li><code>Error</code>：错误日志，需要查看原因；</li><li><code>Warn</code>：警告信息，提醒程序员注意；</li><li><code>Info</code>：关键操作，核心流程的日志；</li><li><code>Debug</code>：一般程序中输出的调试信息；</li><li><code>Trace</code>：很细粒度的信息，一般用不到；</li></ul><p>日志级别从上向下依次减小，<code>Trace</code>最小，<code>Panic</code>最大。<code>logrus</code>有一个日志级别，低于这个级别的日志不会输出。 默认的级别为<code>InfoLevel</code>。所以为了能看到<code>Trace</code>和<code>Debug</code>日志，我们在<code>main</code>函数第一行设置日志级别为<code>TraceLevel</code>。</p><p>运行程序，非标准TTY输出：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ go run main.go 
</span></span><span class=line><span class=cl><span class=nv>time</span><span class=o>=</span><span class=s2>&#34;2024-05-09T11:31:42+08:00&#34;</span> <span class=nv>level</span><span class=o>=</span>trace <span class=nv>msg</span><span class=o>=</span><span class=s2>&#34;trace msg&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>time</span><span class=o>=</span><span class=s2>&#34;2024-05-09T11:31:42+08:00&#34;</span> <span class=nv>level</span><span class=o>=</span>debug <span class=nv>msg</span><span class=o>=</span><span class=s2>&#34;debug msg&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>time</span><span class=o>=</span><span class=s2>&#34;2024-05-09T11:31:42+08:00&#34;</span> <span class=nv>level</span><span class=o>=</span>info <span class=nv>msg</span><span class=o>=</span><span class=s2>&#34;info msg&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>time</span><span class=o>=</span><span class=s2>&#34;2024-05-09T11:31:42+08:00&#34;</span> <span class=nv>level</span><span class=o>=</span>warning <span class=nv>msg</span><span class=o>=</span><span class=s2>&#34;warn msg&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>time</span><span class=o>=</span><span class=s2>&#34;2024-05-09T11:31:42+08:00&#34;</span> <span class=nv>level</span><span class=o>=</span>error <span class=nv>msg</span><span class=o>=</span><span class=s2>&#34;error msg&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>time</span><span class=o>=</span><span class=s2>&#34;2024-05-09T11:31:42+08:00&#34;</span> <span class=nv>level</span><span class=o>=</span>fatal <span class=nv>msg</span><span class=o>=</span><span class=s2>&#34;fatal msg&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>exit</span> status <span class=m>1</span>
</span></span></code></pre></td></tr></table></div></div><p>logrus默认输出到标准错误。格式是文本格式，即默认的Formatter是TextFormatter。</p><p>还有默认情况下，<code>log.SetFormatter(&amp;log.TextFormatter{})</code>（即默认的TextFormatter）未连接 TTY 时，输出与 <a class=link href=http://godoc.org/github.com/kr/logfmt target=_blank rel=noopener>logfmt</a>格式兼容（就是上面输出的格式）。当连接TTY时,会对输出的日志进行颜色编码，参考官方图片:<img src=https://camo.githubusercontent.com/3177c4e5657f79815e562c79c07469374a68b837e0e7fee919675adcd7f499e6/687474703a2f2f692e696d6775722e636f6d2f505937714d77642e706e67 loading=lazy alt=连接终端></p><p>为了确保即使连接了 TTY 也能实现不带颜色输出，请按如下方式设置格式化程序：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl>	<span class=nx>logrus</span><span class=p>.</span><span class=nf>SetFormatter</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>log</span><span class=p>.</span><span class=nx>TextFormatter</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>DisableColors</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>})</span>
</span></span></code></pre></td></tr></table></div></div><p>如果连接了TTY没有实现颜色输出（原因之一：非标准TTY、自定义的Formatter等)，需要颜色输出，请按如下方式设置格式化程序：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>logrus</span><span class=p>.</span><span class=nf>SetFormatter</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>logrus</span><span class=p>.</span><span class=nx>TextFormatter</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>ForceColors</span><span class=p>:</span>   <span class=kc>true</span><span class=p>,</span> <span class=c1>// 强制输出颜色，原理：绕过TTY检查。
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>FullTimestamp</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span> <span class=c1>// 显示完整的时间戳
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=p>})</span>
</span></span></code></pre></td></tr></table></div></div><p>当绕过TTY检查时会丢失日期时间，添加<code>FullTimestamp: true,</code>即可正常显示。</p><p>后面会介绍更多格式化器。</p><p>由于<code>logrus.Fatal</code>会导致程序退出，下面的<code>logrus.Panic</code>不会执行到。</p><p>另外，我们观察到输出中有三个关键信息，<code>time</code>、<code>level</code>和<code>msg</code>：</p><ul><li><code>time</code>：输出日志的时间；为本地区标准时间。<ul><li>补充：+08:00为北京标准时间，改为Z为UTC（世界标准时间，零时区时间）</li><li>T为日期与时间的分隔符。是ISO定制的一种标准日期时间的表示方式。</li></ul></li><li><code>level</code>：日志级别；</li><li><code>msg</code>：日志信息。</li></ul><hr><h2 id=使用><a href=#%e4%bd%bf%e7%94%a8 class=header-anchor>#</a>
使用</h2><h3 id=替代-go-log-标准库><a href=#%e6%9b%bf%e4%bb%a3-go-log-%e6%a0%87%e5%87%86%e5%ba%93 class=header-anchor>#</a>
替代 Go log 标准库</h3><p>在<a class=link href=https://arlettebrook.github.io/p/%e6%b7%b1%e5%85%a5%e6%8e%a2%e7%a9%b6-go-log-%e6%a0%87%e5%87%86%e5%ba%93/ target=_blank rel=noopener>深入探究 Go log 标准库</a>一文中举过一个使用 Go log 标准库的简单<a class=link href=https://arlettebrook.github.io/p/%e6%b7%b1%e5%85%a5%e6%8e%a2%e7%a9%b6-go-log-%e6%a0%87%e5%87%86%e5%ba%93/#%e4%bd%bf%e7%94%a8 target=_blank rel=noopener>示例</a>，现在可以将其无缝切换到 Logrus，只需要把 <code>import "log"</code> 改成 <code>import log "github.com/sirupsen/logrus"</code> 即可实现：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 替代 import &#34;log&#34;
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>log</span> <span class=s>&#34;github.com/sirupsen/logrus&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>log</span><span class=p>.</span><span class=nf>Print</span><span class=p>(</span><span class=s>&#34;Print&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Printf: %s&#34;</span><span class=p>,</span> <span class=s>&#34;print&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>log</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;Println&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=s>&#34;Fatal&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>log</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;Fatalf: %s&#34;</span><span class=p>,</span> <span class=s>&#34;fatal&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>log</span><span class=p>.</span><span class=nf>Fatalln</span><span class=p>(</span><span class=s>&#34;Fatalln&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>log</span><span class=p>.</span><span class=nf>Panic</span><span class=p>(</span><span class=s>&#34;Panic&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>log</span><span class=p>.</span><span class=nf>Panicf</span><span class=p>(</span><span class=s>&#34;Panicf: %s&#34;</span><span class=p>,</span> <span class=s>&#34;panic&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>log</span><span class=p>.</span><span class=nf>Panicln</span><span class=p>(</span><span class=s>&#34;Panicln&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>执行以上代码，得到如下输出：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ go run main.go
</span></span><span class=line><span class=cl><span class=nv>time</span><span class=o>=</span><span class=s2>&#34;2024-05-09T14:13:43+08:00&#34;</span> <span class=nv>level</span><span class=o>=</span>info <span class=nv>msg</span><span class=o>=</span>Print
</span></span><span class=line><span class=cl><span class=nv>time</span><span class=o>=</span><span class=s2>&#34;2024-05-09T14:13:43+08:00&#34;</span> <span class=nv>level</span><span class=o>=</span>info <span class=nv>msg</span><span class=o>=</span><span class=s2>&#34;Printf: print&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>time</span><span class=o>=</span><span class=s2>&#34;2024-05-09T14:13:43+08:00&#34;</span> <span class=nv>level</span><span class=o>=</span>info <span class=nv>msg</span><span class=o>=</span>Println
</span></span><span class=line><span class=cl><span class=nv>time</span><span class=o>=</span><span class=s2>&#34;2024-05-09T14:13:43+08:00&#34;</span> <span class=nv>level</span><span class=o>=</span>fatal <span class=nv>msg</span><span class=o>=</span>Fatal
</span></span><span class=line><span class=cl><span class=nb>exit</span> status <span class=m>1</span>
</span></span></code></pre></td></tr></table></div></div><p>虽然输出格式与使用 Go log 标准库表现略有不同，但程序执行并不会报错，说明二者完全兼容。</p><h3 id=基本使用><a href=#%e5%9f%ba%e6%9c%ac%e4%bd%bf%e7%94%a8 class=header-anchor>#</a>
基本使用</h3><h4 id=修改日志级别><a href=#%e4%bf%ae%e6%94%b9%e6%97%a5%e5%bf%97%e7%ba%a7%e5%88%ab class=header-anchor>#</a>
修改日志级别</h4><p>调用<code>logrus.SetLevel(level Level)</code>，就可以修改日志级别。</p><p>logrus默认的text记录器日志级别是InfoLevel。要想要输出info以下级别的日志，就必须修改。</p><p>如</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl> <span class=nx>logrus</span><span class=p>.</span><span class=nf>SetLevel</span><span class=p>(</span><span class=nx>logrus</span><span class=p>.</span><span class=nx>TraceLevel</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p><code>level</code>可选择类型：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// logrus/logrus.go
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>const</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=c1>// PanicLevel level, highest level of severity. Logs and then calls panic with the
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// message passed to Debug, Info, ...
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>PanicLevel</span> <span class=nx>Level</span> <span class=p>=</span> <span class=kc>iota</span>
</span></span><span class=line><span class=cl>    <span class=c1>// FatalLevel level. Logs and then calls `logger.Exit(1)`. It will exit even if the
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// logging level is set to Panic.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>FatalLevel</span>
</span></span><span class=line><span class=cl>    <span class=c1>// ErrorLevel level. Logs. Used for errors that should definitely be noted.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// Commonly used for hooks to send errors to an error tracking service.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>ErrorLevel</span>
</span></span><span class=line><span class=cl>    <span class=c1>// WarnLevel level. Non-critical entries that deserve eyes.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>WarnLevel</span>
</span></span><span class=line><span class=cl>    <span class=c1>// InfoLevel level. General operational entries about what&#39;s going on inside the
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// application.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>InfoLevel</span>
</span></span><span class=line><span class=cl>    <span class=c1>// DebugLevel level. Usually only enabled when debugging. Very verbose logging.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>DebugLevel</span>
</span></span><span class=line><span class=cl>    <span class=c1>// TraceLevel level. Designates finer-grained informational events than the Debug.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>TraceLevel</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=输出调用信息><a href=#%e8%be%93%e5%87%ba%e8%b0%83%e7%94%a8%e4%bf%a1%e6%81%af class=header-anchor>#</a>
输出调用信息</h4><p>调用<code>logrus.SetReportCaller(true)</code>，会在输出日志中添加方法、文件以及行号信息：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;github.com/sirupsen/logrus&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>logrus</span><span class=p>.</span><span class=nf>SetReportCaller</span><span class=p>(</span><span class=kc>true</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>logrus</span><span class=p>.</span><span class=nf>Info</span><span class=p>(</span><span class=s>&#34;info msg&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>输出多了两个字段：<code>func</code>为函数名，<code>file</code>为调用<code>logrus</code>相关方法的文件名以及行号：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ go run main.go 
</span></span><span class=line><span class=cl><span class=nv>time</span><span class=o>=</span><span class=s2>&#34;2024-05-09T14:26:00+08:00&#34;</span> <span class=nv>level</span><span class=o>=</span>info <span class=nv>msg</span><span class=o>=</span><span class=s2>&#34;info msg&#34;</span> <span class=nv>func</span><span class=o>=</span>main.main <span class=nv>file</span><span class=o>=</span><span class=s2>&#34;F:/GoProject/learn
</span></span></span><span class=line><span class=cl><span class=s2>/main.go:10&#34;</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=添加字段><a href=#%e6%b7%bb%e5%8a%a0%e5%ad%97%e6%ae%b5 class=header-anchor>#</a>
添加字段</h4><p>Logrus 鼓励用户通过日志字段记录结构化日志，可以使用 <code>WithFields</code> 和 <code>WithField</code> 两种形式，并且可以链式调用。</p><p>尽量别用<code>logrus.Fatalf("Failed to send event %s to topic %s with key %d")</code> 这种纯文本形式，因为结构化日志有利于工具提取并分析日志。</p><p>有时候需要在输出中添加一些字段，可以通过调用<code>logrus.WithField</code>（接收单个字段）和<code>logrus.WithFields</code>（接收多个字段）实现。 <code>logrus.WithFields</code>接受一个<code>logrus.Fields</code>类型的参数，其底层实际上为<code>map[string]interface{}</code>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// github.com/sirupsen/logrus/logrus.go
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>type</span> <span class=nx>Fields</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kd>interface</span><span class=p>{}</span>
</span></span></code></pre></td></tr></table></div></div><p>二者都可以链式调用，会返回一个指向Entry类型的结构体（日志条目logrus.Entry），该结构体绑定了各种级别的日志方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;github.com/sirupsen/logrus&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>logrus</span><span class=p>.</span>
</span></span><span class=line><span class=cl>       <span class=nf>WithField</span><span class=p>(</span><span class=s>&#34;name&#34;</span><span class=p>,</span> <span class=s>&#34;arlettebrook&#34;</span><span class=p>).</span>
</span></span><span class=line><span class=cl>       <span class=nf>WithField</span><span class=p>(</span><span class=s>&#34;age&#34;</span><span class=p>,</span> <span class=mi>18</span><span class=p>).</span>
</span></span><span class=line><span class=cl>       <span class=nf>Info</span><span class=p>(</span><span class=s>&#34;WithFiled&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nx>logrus</span><span class=p>.</span><span class=nf>WithFields</span><span class=p>(</span><span class=nx>logrus</span><span class=p>.</span><span class=nx>Fields</span><span class=p>{</span>
</span></span><span class=line><span class=cl>       <span class=s>&#34;name&#34;</span><span class=p>:</span> <span class=s>&#34;arlettebrook&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>       <span class=s>&#34;age&#34;</span><span class=p>:</span>  <span class=mi>18</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>}).</span><span class=nf>Info</span><span class=p>(</span><span class=s>&#34;WithFields&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>运行输出：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=err>$</span> <span class=k>go</span> <span class=nx>run</span> <span class=nx>main</span><span class=p>.</span><span class=k>go</span> 
</span></span><span class=line><span class=cl><span class=nx>time</span><span class=p>=</span><span class=s>&#34;2024-05-09T15:22:24+08:00&#34;</span> <span class=nx>level</span><span class=p>=</span><span class=nx>info</span> <span class=nx>msg</span><span class=p>=</span><span class=nx>WithFiled</span> <span class=nx>age</span><span class=p>=</span><span class=mi>18</span> <span class=nx>name</span><span class=p>=</span><span class=nx>arlettebrook</span>
</span></span><span class=line><span class=cl><span class=nx>time</span><span class=p>=</span><span class=s>&#34;2024-05-09T15:22:24+08:00&#34;</span> <span class=nx>level</span><span class=p>=</span><span class=nx>info</span> <span class=nx>msg</span><span class=p>=</span><span class=nx>WithFields</span> <span class=nx>age</span><span class=p>=</span><span class=mi>18</span> <span class=nx>name</span><span class=p>=</span><span class=nx>arlettebrook</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>默认字段</strong>：如果在一个函数中的所有日志都需要添加某些字段，可以使用<code>WithFields</code>的返回的*Entry替换logrus。这样后续输出都会包含指定字段：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=s>&#34;github.com/sirupsen/logrus&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>withFieldsLog</span> <span class=o>:=</span> <span class=nx>logrus</span><span class=p>.</span><span class=nf>WithFields</span><span class=p>(</span><span class=nx>logrus</span><span class=p>.</span><span class=nx>Fields</span><span class=p>{</span>
</span></span><span class=line><span class=cl>       <span class=s>&#34;name&#34;</span><span class=p>:</span> <span class=s>&#34;arlettebrook&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>       <span class=s>&#34;age&#34;</span><span class=p>:</span>  <span class=mi>18</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=nx>withFieldsLog</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=s>&#34;error msg&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>withFieldsLog</span><span class=p>.</span><span class=nf>Info</span><span class=p>(</span><span class=s>&#34;info msg&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>运行输出：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=err>$</span> <span class=k>go</span> <span class=nx>run</span> <span class=nx>main</span><span class=p>.</span><span class=k>go</span> 
</span></span><span class=line><span class=cl><span class=nx>time</span><span class=p>=</span><span class=s>&#34;2024-05-09T15:37:56+08:00&#34;</span> <span class=nx>level</span><span class=p>=</span><span class=kt>error</span> <span class=nx>msg</span><span class=p>=</span><span class=s>&#34;error msg&#34;</span> <span class=nx>age</span><span class=p>=</span><span class=mi>18</span> <span class=nx>name</span><span class=p>=</span><span class=nx>arlettebrook</span>
</span></span><span class=line><span class=cl><span class=nx>time</span><span class=p>=</span><span class=s>&#34;2024-05-09T15:37:56+08:00&#34;</span> <span class=nx>level</span><span class=p>=</span><span class=nx>info</span> <span class=nx>msg</span><span class=p>=</span><span class=s>&#34;info msg&#34;</span> <span class=nx>age</span><span class=p>=</span><span class=mi>18</span> <span class=nx>name</span><span class=p>=</span><span class=nx>arlettebrook</span>
</span></span></code></pre></td></tr></table></div></div><p>使用同一个<code>logrus.Entry</code>调不同级别的日志方法，即可实现携带相同的字段（<strong>默认字段</strong>）。</p><p>注意：默认字段也支持链式调用。</p><h4 id=重定向输出><a href=#%e9%87%8d%e5%ae%9a%e5%90%91%e8%be%93%e5%87%ba class=header-anchor>#</a>
重定向输出</h4><p>默认情况下，日志输出到<code>io.Stderr</code>。可以调用<code>logrus.SetOutput</code>传入一个<code>io.Writer</code>参数。后续调用相关方法日志将写到<code>io.Writer</code>中。 现在，我们就能像介绍<a class=link href=https://arlettebrook.github.io/p/%E6%B7%B1%E5%85%A5%E6%8E%A2%E7%A9%B6-go-log-%E6%A0%87%E5%87%86%E5%BA%93/ target=_blank rel=noopener>log</a>时一样，可以搞点事情了。传入一个<code>io.MultiWriter</code>， 同时将日志写到<code>bytes.Buffer</code>、标准输出和文件中：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;bytes&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;io&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;log&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;os&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=s>&#34;github.com/sirupsen/logrus&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>writer1</span> <span class=o>:=</span> <span class=nx>bytes</span><span class=p>.</span><span class=nf>NewBuffer</span><span class=p>(</span><span class=kc>nil</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>writer2</span> <span class=o>:=</span> <span class=nx>os</span><span class=p>.</span><span class=nx>Stdout</span>
</span></span><span class=line><span class=cl>	<span class=nx>writer3</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>os</span><span class=p>.</span><span class=nf>OpenFile</span><span class=p>(</span><span class=s>&#34;./log.txt&#34;</span><span class=p>,</span> <span class=nx>os</span><span class=p>.</span><span class=nx>O_WRONLY</span><span class=p>|</span><span class=nx>os</span><span class=p>.</span><span class=nx>O_CREATE</span><span class=p>,</span> <span class=mo>0755</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=kd>func</span><span class=p>(</span><span class=nx>writer3</span> <span class=o>*</span><span class=nx>os</span><span class=p>.</span><span class=nx>File</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>err</span> <span class=o>:=</span> <span class=nx>writer3</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}(</span><span class=nx>writer3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>log</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;create file log.txt failed: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>logrus</span><span class=p>.</span><span class=nf>SetOutput</span><span class=p>(</span><span class=nx>io</span><span class=p>.</span><span class=nf>MultiWriter</span><span class=p>(</span><span class=nx>writer1</span><span class=p>,</span> <span class=nx>writer2</span><span class=p>,</span> <span class=nx>writer3</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=nx>logrus</span><span class=p>.</span><span class=nf>Info</span><span class=p>(</span><span class=s>&#34;info msg&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;Buffer:&#34;</span><span class=p>,</span> <span class=nx>writer1</span><span class=p>.</span><span class=nf>String</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>运行，会在文件<code>log.txt</code>和控制台输出日志。</p><h3 id=处理不同环境><a href=#%e5%a4%84%e7%90%86%e4%b8%8d%e5%90%8c%e7%8e%af%e5%a2%83 class=header-anchor>#</a>
处理不同环境</h3><p>Logrus 并没有像 <a class=link href=https://github.com/uber-go/zap target=_blank rel=noopener>zap</a> 那样提供现成的 API 来支持在不同的环境下使用（Production 和 Development），如果你想在生产和测试环境使用不同的格式输出日志，则需要通过代码判断在不同环境设置不同的 <code>Formatter</code> 来实现。示例如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;os&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>nested</span> <span class=s>&#34;github.com/antonfisher/nested-logrus-formatter&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;github.com/sirupsen/logrus&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>init</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 假设环境变量APP_ENV已经被设置
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>env</span> <span class=o>:=</span> <span class=nx>os</span><span class=p>.</span><span class=nf>Getenv</span><span class=p>(</span><span class=s>&#34;APP_ENV&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 根据环境设置日志级别
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>switch</span> <span class=nx>env</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=s>&#34;development&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>       <span class=c1>// 在开发环境中显示所有日志
</span></span></span><span class=line><span class=cl><span class=c1></span>       <span class=nx>logrus</span><span class=p>.</span><span class=nf>SetLevel</span><span class=p>(</span><span class=nx>logrus</span><span class=p>.</span><span class=nx>DebugLevel</span><span class=p>)</span>
</span></span><span class=line><span class=cl>       <span class=nx>logrus</span><span class=p>.</span><span class=nf>SetFormatter</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>nested</span><span class=p>.</span><span class=nx>Formatter</span><span class=p>{})</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=s>&#34;testing&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>       <span class=c1>// 在测试环境中只显示警告和错误日志
</span></span></span><span class=line><span class=cl><span class=c1></span>       <span class=nx>logrus</span><span class=p>.</span><span class=nf>SetLevel</span><span class=p>(</span><span class=nx>logrus</span><span class=p>.</span><span class=nx>WarnLevel</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=s>&#34;production&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>       <span class=c1>// 在生产环境中只显示错误日志
</span></span></span><span class=line><span class=cl><span class=c1></span>       <span class=nx>logrus</span><span class=p>.</span><span class=nf>SetLevel</span><span class=p>(</span><span class=nx>logrus</span><span class=p>.</span><span class=nx>ErrorLevel</span><span class=p>)</span>
</span></span><span class=line><span class=cl>       <span class=nx>logrus</span><span class=p>.</span><span class=nf>SetFormatter</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>logrus</span><span class=p>.</span><span class=nx>JSONFormatter</span><span class=p>{})</span>
</span></span><span class=line><span class=cl>    <span class=k>default</span><span class=p>:</span>
</span></span><span class=line><span class=cl>       <span class=c1>// 默认情况下，显示所有日志
</span></span></span><span class=line><span class=cl><span class=c1></span>       <span class=nx>logrus</span><span class=p>.</span><span class=nf>SetLevel</span><span class=p>(</span><span class=nx>logrus</span><span class=p>.</span><span class=nx>DebugLevel</span><span class=p>)</span>
</span></span><span class=line><span class=cl>       <span class=nx>logrus</span><span class=p>.</span><span class=nf>SetFormatter</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>nested</span><span class=p>.</span><span class=nx>Formatter</span><span class=p>{})</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 你还可以设置日志格式、输出位置等
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>logrus</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=s>&#34;error log&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>logrus</span><span class=p>.</span><span class=nf>Warn</span><span class=p>(</span><span class=s>&#34;warn log&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>logrus</span><span class=p>.</span><span class=nf>Info</span><span class=p>(</span><span class=s>&#34;info log&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>logrus</span><span class=p>.</span><span class=nf>Debug</span><span class=p>(</span><span class=s>&#34;debug log&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>运行输出：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ go run main.go
</span></span><span class=line><span class=cl>May <span class=m>11</span> 15:31:46.122 <span class=o>[</span>ERRO<span class=o>]</span> error log
</span></span><span class=line><span class=cl>May <span class=m>11</span> 15:31:46.168 <span class=o>[</span>WARN<span class=o>]</span> warn log
</span></span><span class=line><span class=cl>May <span class=m>11</span> 15:31:46.168 <span class=o>[</span>INFO<span class=o>]</span> info log
</span></span><span class=line><span class=cl>May <span class=m>11</span> 15:31:46.169 <span class=o>[</span>DEBU<span class=o>]</span> debug log
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ <span class=nv>app_env</span><span class=o>=</span>production go run main.go
</span></span><span class=line><span class=cl><span class=o>{</span><span class=s2>&#34;level&#34;</span>:<span class=s2>&#34;error&#34;</span>,<span class=s2>&#34;msg&#34;</span>:<span class=s2>&#34;error log&#34;</span>,<span class=s2>&#34;time&#34;</span>:<span class=s2>&#34;2024-05-11T15:31:53+08:00&#34;</span><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ <span class=nv>app_env</span><span class=o>=</span>development go run main.go
</span></span><span class=line><span class=cl>May <span class=m>11</span> 15:32:05.563 <span class=o>[</span>ERRO<span class=o>]</span> error log
</span></span><span class=line><span class=cl>May <span class=m>11</span> 15:32:05.609 <span class=o>[</span>WARN<span class=o>]</span> warn log
</span></span><span class=line><span class=cl>May <span class=m>11</span> 15:32:05.609 <span class=o>[</span>INFO<span class=o>]</span> info log
</span></span><span class=line><span class=cl>May <span class=m>11</span> 15:32:05.609 <span class=o>[</span>DEBU<span class=o>]</span> debug log
</span></span></code></pre></td></tr></table></div></div><h3 id=测试><a href=#%e6%b5%8b%e8%af%95 class=header-anchor>#</a>
测试</h3><p>如果你的单元测试程序中需要测试日志内容，Logrus 提供了 <code>test.NewNullLogger</code> 日志记录器，它只会记录日志，不输出任何内容。使用示例如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;testing&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=s>&#34;github.com/sirupsen/logrus&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;github.com/sirupsen/logrus/hooks/test&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;github.com/stretchr/testify/assert&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>TestLogrus</span><span class=p>(</span><span class=nx>t</span> <span class=o>*</span><span class=nx>testing</span><span class=p>.</span><span class=nx>T</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>logger</span><span class=p>,</span> <span class=nx>hook</span> <span class=o>:=</span> <span class=nx>test</span><span class=p>.</span><span class=nf>NewNullLogger</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nx>logger</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=s>&#34;Hello error&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>assert</span><span class=p>.</span><span class=nf>Equal</span><span class=p>(</span><span class=nx>t</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=nx>hook</span><span class=p>.</span><span class=nx>Entries</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=nx>assert</span><span class=p>.</span><span class=nf>Equal</span><span class=p>(</span><span class=nx>t</span><span class=p>,</span> <span class=nx>logrus</span><span class=p>.</span><span class=nx>ErrorLevel</span><span class=p>,</span> <span class=nx>hook</span><span class=p>.</span><span class=nf>LastEntry</span><span class=p>().</span><span class=nx>Level</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>assert</span><span class=p>.</span><span class=nf>Equal</span><span class=p>(</span><span class=nx>t</span><span class=p>,</span> <span class=s>&#34;Hello error&#34;</span><span class=p>,</span> <span class=nx>hook</span><span class=p>.</span><span class=nf>LastEntry</span><span class=p>().</span><span class=nx>Message</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>hook</span><span class=p>.</span><span class=nf>Reset</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nx>assert</span><span class=p>.</span><span class=nf>Nil</span><span class=p>(</span><span class=nx>t</span><span class=p>,</span> <span class=nx>hook</span><span class=p>.</span><span class=nf>LastEntry</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>第二个返回值是一个结构体:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Hook</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// Entries is an array of all entries that have been received by this hook.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// For safe access, use the AllEntries() method, rather than reading this
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// value directly.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>Entries</span> <span class=p>[]</span><span class=nx>logrus</span><span class=p>.</span><span class=nx>Entry</span>  <span class=c1>// 条目切片
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>mu</span>      <span class=nx>sync</span><span class=p>.</span><span class=nx>RWMutex</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>方法<code>LastEntry()</code>返回<code>Entries</code>的最后一条日志条目对象。</p><p>运行输出：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ go <span class=nb>test</span> -run TestLogrus -v
</span></span><span class=line><span class=cl><span class=o>===</span> RUN   TestLogrus
</span></span><span class=line><span class=cl>--- PASS: TestLogrus <span class=o>(</span>0.07s<span class=o>)</span>
</span></span><span class=line><span class=cl>PASS
</span></span><span class=line><span class=cl>ok      github.com/arlettebrook/learn   0.643s
</span></span></code></pre></td></tr></table></div></div><h3 id=自定义-logger><a href=#%e8%87%aa%e5%ae%9a%e4%b9%89-logger class=header-anchor>#</a>
自定义 Logger</h3><p>除了通过 <code>logrus.Info("Info msg")</code> 这种开箱即用的方式使用 Logrus 默认的 <code>Logger</code>，我们还可以自定义 <code>Logger</code>。</p><p>**实际上，考虑到易用性，库一般会使用默认值创建一个对象，包最外层的方法一般都是操作这个默认对象。**用到的设计模式是<a class=link href=https://arlettebrook.github.io/p/go%E5%B8%B8%E8%A7%81%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F/ target=_blank rel=noopener>单例模式</a>。</p><p>我们之前好几篇文章都提到过这点：</p><ul><li><code>flag</code>标准库中的<code>CommandLine</code>对象；</li><li><code>log</code>标准库中的<code>std</code>对象。</li></ul><p>这个技巧应用在很多库的开发中，<code>logrus</code>也是如此：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// github.com/sirupsen/logrus/exported.go
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>var</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=c1>// std is the name of the standard logger in stdlib `log`
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>std</span> <span class=p>=</span> <span class=nf>New</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>New</span><span class=p>()</span> <span class=o>*</span><span class=nx>Logger</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=o>&amp;</span><span class=nx>Logger</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>Out</span><span class=p>:</span>          <span class=nx>os</span><span class=p>.</span><span class=nx>Stderr</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>Formatter</span><span class=p>:</span>    <span class=nb>new</span><span class=p>(</span><span class=nx>TextFormatter</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>Hooks</span><span class=p>:</span>        <span class=nb>make</span><span class=p>(</span><span class=nx>LevelHooks</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>Level</span><span class=p>:</span>        <span class=nx>InfoLevel</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>ExitFunc</span><span class=p>:</span>     <span class=nx>os</span><span class=p>.</span><span class=nx>Exit</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>ReportCaller</span><span class=p>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>StandardLogger</span><span class=p>()</span> <span class=o>*</span><span class=nx>Logger</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>std</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// SetOutput sets the standard logger output.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>SetOutput</span><span class=p>(</span><span class=nx>out</span> <span class=nx>io</span><span class=p>.</span><span class=nx>Writer</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>std</span><span class=p>.</span><span class=nf>SetOutput</span><span class=p>(</span><span class=nx>out</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// SetFormatter sets the standard logger formatter.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>SetFormatter</span><span class=p>(</span><span class=nx>formatter</span> <span class=nx>Formatter</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>std</span><span class=p>.</span><span class=nf>SetFormatter</span><span class=p>(</span><span class=nx>formatter</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// SetReportCaller sets whether the standard logger will include the calling
</span></span></span><span class=line><span class=cl><span class=c1>// method as a field.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>SetReportCaller</span><span class=p>(</span><span class=nx>include</span> <span class=kt>bool</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>std</span><span class=p>.</span><span class=nf>SetReportCaller</span><span class=p>(</span><span class=nx>include</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// SetLevel sets the standard logger level.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>SetLevel</span><span class=p>(</span><span class=nx>level</span> <span class=nx>Level</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>std</span><span class=p>.</span><span class=nf>SetLevel</span><span class=p>(</span><span class=nx>level</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>首先，使用默认配置定义一个<code>Logger</code>对象<code>std</code>，<code>SetOutput/SetFormatter/SetReportCaller/SetLevel</code>这些方法都是调用<code>std</code>对象的对应方法！</p><p>我们当然也可以创建自己的<code>Logger</code>对象，使用方式与直接调用<code>logrus</code>的方法类似：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=s>&#34;github.com/sirupsen/logrus&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>log</span> <span class=o>:=</span> <span class=nx>logrus</span><span class=p>.</span><span class=nf>New</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>log</span><span class=p>.</span><span class=nf>Info</span><span class=p>(</span><span class=s>&#34;info msg&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 用自定义logger
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>log</span><span class=p>.</span><span class=nf>SetLevel</span><span class=p>(</span><span class=nx>logrus</span><span class=p>.</span><span class=nx>DebugLevel</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>log</span><span class=p>.</span><span class=nf>SetFormatter</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>logrus</span><span class=p>.</span><span class=nx>JSONFormatter</span><span class=p>{})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>log</span><span class=p>.</span><span class=nf>Debug</span><span class=p>(</span><span class=s>&#34;debug msg&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p><code>New()</code>函数创建的logger与默认的logger相同。运行输出：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=err>$</span> <span class=k>go</span> <span class=nx>run</span> <span class=nx>main</span><span class=p>.</span><span class=k>go</span> 
</span></span><span class=line><span class=cl><span class=nx>time</span><span class=p>=</span><span class=s>&#34;2024-05-09T22:55:30+08:00&#34;</span> <span class=nx>level</span><span class=p>=</span><span class=nx>info</span> <span class=nx>msg</span><span class=p>=</span><span class=s>&#34;info msg&#34;</span>
</span></span><span class=line><span class=cl><span class=p>{</span><span class=s>&#34;level&#34;</span><span class=p>:</span><span class=s>&#34;debug&#34;</span><span class=p>,</span><span class=s>&#34;msg&#34;</span><span class=p>:</span><span class=s>&#34;debug msg&#34;</span><span class=p>,</span><span class=s>&#34;time&#34;</span><span class=p>:</span><span class=s>&#34;2024-05-09T22:55:30+08:00&#34;</span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>通过创建的logger对象可以直接赋值修改Level、Out、Formatter等，不用调对应的Set方法。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>New</span><span class=p>()</span> <span class=o>*</span><span class=nx>Logger</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=o>&amp;</span><span class=nx>Logger</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>Out</span><span class=p>:</span>          <span class=nx>os</span><span class=p>.</span><span class=nx>Stderr</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>Formatter</span><span class=p>:</span>    <span class=nb>new</span><span class=p>(</span><span class=nx>TextFormatter</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>Hooks</span><span class=p>:</span>        <span class=nb>make</span><span class=p>(</span><span class=nx>LevelHooks</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>Level</span><span class=p>:</span>        <span class=nx>InfoLevel</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>ExitFunc</span><span class=p>:</span>     <span class=nx>os</span><span class=p>.</span><span class=nx>Exit</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>ReportCaller</span><span class=p>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>示例修改如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl>	<span class=nx>log</span><span class=p>.</span><span class=nx>Out</span><span class=p>=</span><span class=nx>os</span><span class=p>.</span><span class=nx>Stdout</span>
</span></span><span class=line><span class=cl>	<span class=nx>log</span><span class=p>.</span><span class=nx>Level</span><span class=p>=</span><span class=nx>logrus</span><span class=p>.</span><span class=nx>DebugLevel</span>
</span></span><span class=line><span class=cl>	<span class=nx>log</span><span class=p>.</span><span class=nx>Formatter</span><span class=p>=</span><span class=o>&amp;</span><span class=nx>logrus</span><span class=p>.</span><span class=nx>JSONFormatter</span><span class=p>{}</span>
</span></span></code></pre></td></tr></table></div></div><p>我们还可以通过<code>FieldMap</code>属性修改默认字段的键名</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>FieldMap</span> <span class=kd>map</span><span class=p>[</span><span class=nx>fieldKey</span><span class=p>]</span><span class=kt>string</span>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>fieldKey</span> <span class=kt>string</span>
</span></span></code></pre></td></tr></table></div></div><p>支持重命名的默认字段<code>fieldKey</code>如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-GO data-lang=GO><span class=line><span class=cl><span class=kd>const</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=nx>defaultTimestampFormat</span> <span class=p>=</span> <span class=nx>time</span><span class=p>.</span><span class=nx>RFC3339</span>
</span></span><span class=line><span class=cl>	<span class=nx>FieldKeyMsg</span>            <span class=p>=</span> <span class=s>&#34;msg&#34;</span>
</span></span><span class=line><span class=cl>	<span class=nx>FieldKeyLevel</span>          <span class=p>=</span> <span class=s>&#34;level&#34;</span>
</span></span><span class=line><span class=cl>	<span class=nx>FieldKeyTime</span>           <span class=p>=</span> <span class=s>&#34;time&#34;</span>
</span></span><span class=line><span class=cl>	<span class=nx>FieldKeyLogrusError</span>    <span class=p>=</span> <span class=s>&#34;logrus_error&#34;</span>
</span></span><span class=line><span class=cl>	<span class=nx>FieldKeyFunc</span>           <span class=p>=</span> <span class=s>&#34;func&#34;</span>
</span></span><span class=line><span class=cl>	<span class=nx>FieldKeyFile</span>           <span class=p>=</span> <span class=s>&#34;file&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>实例如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;github.com/sirupsen/logrus&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>log</span> <span class=o>:=</span> <span class=nx>logrus</span><span class=p>.</span><span class=nf>New</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nx>log</span><span class=p>.</span><span class=nx>Formatter</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>logrus</span><span class=p>.</span><span class=nx>TextFormatter</span><span class=p>{</span>
</span></span><span class=line><span class=cl>       <span class=nx>DisableColors</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>       <span class=nx>FieldMap</span><span class=p>:</span> <span class=nx>logrus</span><span class=p>.</span><span class=nx>FieldMap</span><span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>logrus</span><span class=p>.</span><span class=nx>FieldKeyMsg</span><span class=p>:</span> <span class=s>&#34;message&#34;</span><span class=p>,</span> <span class=c1>// 将msg改成message
</span></span></span><span class=line><span class=cl><span class=c1></span>       <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>log</span><span class=p>.</span><span class=nf>Info</span><span class=p>(</span><span class=s>&#34;info msg&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>log</span><span class=p>.</span><span class=nx>Level</span> <span class=p>=</span> <span class=nx>logrus</span><span class=p>.</span><span class=nx>DebugLevel</span>
</span></span><span class=line><span class=cl>    <span class=nx>log</span><span class=p>.</span><span class=nx>Formatter</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>logrus</span><span class=p>.</span><span class=nx>JSONFormatter</span><span class=p>{</span> <span class=c1>// 会覆盖TextFormatter
</span></span></span><span class=line><span class=cl><span class=c1></span>       <span class=nx>FieldMap</span><span class=p>:</span> <span class=nx>logrus</span><span class=p>.</span><span class=nx>FieldMap</span><span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>logrus</span><span class=p>.</span><span class=nx>FieldKeyTime</span><span class=p>:</span> <span class=s>&#34;TIME&#34;</span><span class=p>,</span><span class=c1>// 将 time改成TIME
</span></span></span><span class=line><span class=cl><span class=c1></span>       <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>log</span><span class=p>.</span><span class=nf>Debug</span><span class=p>(</span><span class=s>&#34;debug msg&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>运行输出：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ go run main.go 
</span></span><span class=line><span class=cl><span class=nv>time</span><span class=o>=</span><span class=s2>&#34;2024-05-09T23:23:53+08:00&#34;</span> <span class=nv>level</span><span class=o>=</span>info <span class=nv>message</span><span class=o>=</span><span class=s2>&#34;info msg&#34;</span>
</span></span><span class=line><span class=cl><span class=o>{</span><span class=s2>&#34;TIME&#34;</span>:<span class=s2>&#34;2024-05-09T23:23:53+08:00&#34;</span>,<span class=s2>&#34;level&#34;</span>:<span class=s2>&#34;debug&#34;</span>,<span class=s2>&#34;msg&#34;</span>:<span class=s2>&#34;debug msg&#34;</span><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=修改日志格式><a href=#%e4%bf%ae%e6%94%b9%e6%97%a5%e5%bf%97%e6%a0%bc%e5%bc%8f class=header-anchor>#</a>
修改日志格式</h4><p>调用<code>logrus.SetFormatter(formatter Formatter)</code>，即可修改日志格式。</p><p><code>logrus</code>支持两种日志格式，文本和 JSON，默认为文本格式。可以通过<code>logrus.SetFormatter</code>设置日志格式：</p><p>Logrus 提供了 <code>JSONFormatter</code> 和 <code>TextFormatter</code> 来分别实现 JSON 和 Text 格式的日志输出，它们的<strong>指针类型</strong>都实现了 <code>Formatter</code> 接口。除此之外，这里还有一个第三方实现的 <code>Formatter</code> <a class=link href=https://github.com/sirupsen/logrus#formatters target=_blank rel=noopener>列表</a>可供选择，如果这些依然无法满足你的需求，则可以自己实现 <code>Formatter</code> 接口对象定制日志格式。</p><p>使用如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=s>&#34;github.com/sirupsen/logrus&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>logrus</span><span class=p>.</span><span class=nf>Info</span><span class=p>(</span><span class=s>&#34;default formatter:TextFormatter&#34;</span><span class=p>)</span> <span class=c1>//text
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>logrus</span><span class=p>.</span><span class=nf>SetFormatter</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>logrus</span><span class=p>.</span><span class=nx>JSONFormatter</span><span class=p>{})</span>
</span></span><span class=line><span class=cl>    <span class=nx>logrus</span><span class=p>.</span><span class=nf>Info</span><span class=p>(</span><span class=s>&#34;JSONFormatter&#34;</span><span class=p>)</span> <span class=c1>//json
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>logrus</span><span class=p>.</span><span class=nf>SetFormatter</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>logrus</span><span class=p>.</span><span class=nx>TextFormatter</span><span class=p>{})</span>
</span></span><span class=line><span class=cl>    <span class=nx>logrus</span><span class=p>.</span><span class=nf>Info</span><span class=p>(</span><span class=s>&#34;default formatter:TextFormatter&#34;</span><span class=p>)</span> <span class=c1>//text
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>logrus默认的Formatter是TextFormatter。在非标准TTY中运行输出结果（不带颜色输出）如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ go run main.go 
</span></span><span class=line><span class=cl><span class=nv>time</span><span class=o>=</span><span class=s2>&#34;2024-05-09T22:06:29+08:00&#34;</span> <span class=nv>level</span><span class=o>=</span>info <span class=nv>msg</span><span class=o>=</span><span class=s2>&#34;default formatter:TextFormatter&#34;</span>
</span></span><span class=line><span class=cl><span class=o>{</span><span class=s2>&#34;level&#34;</span>:<span class=s2>&#34;info&#34;</span>,<span class=s2>&#34;msg&#34;</span>:<span class=s2>&#34;JSONFormatter&#34;</span>,<span class=s2>&#34;time&#34;</span>:<span class=s2>&#34;2024-05-09T22:06:29+08:00&#34;</span><span class=o>}</span>
</span></span><span class=line><span class=cl><span class=nv>time</span><span class=o>=</span><span class=s2>&#34;2024-05-09T22:06:29+08:00&#34;</span> <span class=nv>level</span><span class=o>=</span>info <span class=nv>msg</span><span class=o>=</span><span class=s2>&#34;default formatter:TextFormatter&#34;</span>
</span></span></code></pre></td></tr></table></div></div><h5 id=使用第三方格式><a href=#%e4%bd%bf%e7%94%a8%e7%ac%ac%e4%b8%89%e6%96%b9%e6%a0%bc%e5%bc%8f class=header-anchor>#</a>
使用第三方格式</h5><p>除了内置的<code>TextFormatter</code>和<code>JSONFormatter</code>，还有不少第三方格式支持。我们这里介绍一个<a class=link href=https://github.com/antonfisher/nested-logrus-formatter target=_blank rel=noopener>nested-logrus-formatter</a>。</p><p>先安装：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ go get -u github.com/antonfisher/nested-logrus-formatter
</span></span></code></pre></td></tr></table></div></div><p>后使用：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;time&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>nested</span> <span class=s>&#34;github.com/antonfisher/nested-logrus-formatter&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;github.com/sirupsen/logrus&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 非标准TTY，强制输出颜色
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>logrus</span><span class=p>.</span><span class=nf>SetFormatter</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>logrus</span><span class=p>.</span><span class=nx>TextFormatter</span><span class=p>{</span>
</span></span><span class=line><span class=cl>       <span class=nx>ForceColors</span><span class=p>:</span>     <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>       <span class=nx>FullTimestamp</span><span class=p>:</span>   <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>       <span class=nx>TimestampFormat</span><span class=p>:</span> <span class=nx>time</span><span class=p>.</span><span class=nx>DateTime</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=nx>logrus</span><span class=p>.</span><span class=nf>Info</span><span class=p>(</span><span class=s>&#34;info msg&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>logrus</span><span class=p>.</span><span class=nf>WithFields</span><span class=p>(</span><span class=nx>logrus</span><span class=p>.</span><span class=nx>Fields</span><span class=p>{</span>
</span></span><span class=line><span class=cl>       <span class=s>&#34;username&#34;</span><span class=p>:</span> <span class=s>&#34;arlettebrook&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>       <span class=s>&#34;age&#34;</span><span class=p>:</span>      <span class=mi>18</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>}).</span><span class=nf>Warn</span><span class=p>(</span><span class=s>&#34;user info&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;----------------&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>logrus</span><span class=p>.</span><span class=nf>SetFormatter</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>nested</span><span class=p>.</span><span class=nx>Formatter</span><span class=p>{</span>
</span></span><span class=line><span class=cl>       <span class=nx>HideKeys</span><span class=p>:</span>        <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>       <span class=nx>TimestampFormat</span><span class=p>:</span> <span class=nx>time</span><span class=p>.</span><span class=nx>DateTime</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>logrus</span><span class=p>.</span><span class=nf>Info</span><span class=p>(</span><span class=s>&#34;info msg&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>logrus</span><span class=p>.</span><span class=nf>WithFields</span><span class=p>(</span><span class=nx>logrus</span><span class=p>.</span><span class=nx>Fields</span><span class=p>{</span>
</span></span><span class=line><span class=cl>       <span class=s>&#34;username&#34;</span><span class=p>:</span> <span class=s>&#34;arlettebrook&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>       <span class=s>&#34;age&#34;</span><span class=p>:</span>      <span class=mi>18</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>}).</span><span class=nf>Warn</span><span class=p>(</span><span class=s>&#34;user info&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>程序运行输出：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ go run main.go 
</span></span><span class=line><span class=cl>INFO<span class=o>[</span>2024-05-09 22:33:40<span class=o>]</span> info msg                                     
</span></span><span class=line><span class=cl>WARN<span class=o>[</span>2024-05-09 22:33:41<span class=o>]</span> user info                                     <span class=nv>age</span><span class=o>=</span><span class=m>18</span> <span class=nv>username</span><span class=o>=</span>arlettebro
</span></span><span class=line><span class=cl>ok
</span></span><span class=line><span class=cl>----------------
</span></span><span class=line><span class=cl>2024-05-09 22:33:41 <span class=o>[</span>INFO<span class=o>]</span> info msg
</span></span><span class=line><span class=cl>2024-05-09 22:33:41 <span class=o>[</span>WARN<span class=o>]</span> <span class=o>[</span>18<span class=o>]</span> <span class=o>[</span>arlettebrook<span class=o>]</span> user info
</span></span></code></pre></td></tr></table></div></div><p>没有截图，参考的是官方对比图片：<img src=https://raw.githubusercontent.com/antonfisher/nested-logrus-formatter/docs/images/demo.png loading=lazy></p><p><code>nested</code>格式提供了多个字段用来定制行为：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-golang data-lang=golang><span class=line><span class=cl><span class=c1>// github.com/antonfisher/nested-logrus-formatter/formatter.go
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>type</span> <span class=nx>Formatter</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>FieldsOrder</span>     <span class=p>[]</span><span class=kt>string</span>
</span></span><span class=line><span class=cl>  <span class=nx>TimestampFormat</span> <span class=kt>string</span>  
</span></span><span class=line><span class=cl>  <span class=nx>HideKeys</span>        <span class=kt>bool</span>    
</span></span><span class=line><span class=cl>  <span class=nx>NoColors</span>        <span class=kt>bool</span>    
</span></span><span class=line><span class=cl>  <span class=nx>NoFieldsColors</span>  <span class=kt>bool</span>    
</span></span><span class=line><span class=cl>  <span class=nx>ShowFullLevel</span>   <span class=kt>bool</span>    
</span></span><span class=line><span class=cl>  <span class=nx>TrimMessages</span>    <span class=kt>bool</span>    
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><ul><li><p>默认，<code>logrus</code>输出日志中字段是<code>key=value</code>这样的形式。使用<code>nested</code>格式，我们可以通过设置<code>HideKeys</code>为<code>true</code>隐藏键，只输出值；</p><ul><li><p>如果不隐藏键，程序输出：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>2024-05-09 22:40:09 <span class=o>[</span>WARN<span class=o>]</span> <span class=o>[</span>age:18<span class=o>]</span> <span class=o>[</span>username:arlettebrook<span class=o>]</span> user info
</span></span></code></pre></td></tr></table></div></div></li></ul></li><li><p>默认，<code>logrus</code>是按键的字母序输出字段，可以设置<code>FieldsOrder</code>定义输出字段顺序；string类型的切片指定顺序。</p></li><li><p>通过设置<code>TimestampFormat</code>设置日期格式。如<code>time.RFC3339</code>、<code>time.DateTime</code>。</p></li></ul><p><strong>通过实现接口<code>logrus.Formatter</code>可以实现自己的格式。</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-golang data-lang=golang><span class=line><span class=cl><span class=c1>// github.com/sirupsen/logrus/formatter.go
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>type</span> <span class=nx>Formatter</span> <span class=kd>interface</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nf>Format</span><span class=p>(</span><span class=o>*</span><span class=nx>Entry</span><span class=p>)</span> <span class=p>([]</span><span class=kt>byte</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><hr><h2 id=hooks><a href=#hooks class=header-anchor>#</a>
Hooks</h2><blockquote><p>Hooks本质是一些函数或方法，用于不修改原代码，<strong>扩展程序</strong>。</p></blockquote><p>Logrus 最令人心动的两个功能，一个是结构化日志，另一个就是 Hooks 了。</p><p>Hooks 为 Logrus 提供了极大的灵活性，通过 Hooks 可以实现各种扩展功能。比如可以通过 Hooks 实现：<code>Error</code> 以上级别日志<strong>发送邮件通知</strong>、<strong>重要日志告警</strong>、<strong>日志切割</strong>、<strong>程序优雅退出等</strong>，非常实用。</p><p>Logrus 提供了 <code>Hook</code> 接口，只要我们实现了这个接口，并将其注册到 Logrus 中，就可以使用 Hooks 的强大能力了。<code>Hook</code> 接口定义如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Hook</span> <span class=kd>interface</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nf>Levels</span><span class=p>()</span> <span class=p>[]</span><span class=nx>Level</span>
</span></span><span class=line><span class=cl>	<span class=nf>Fire</span><span class=p>(</span><span class=o>*</span><span class=nx>Entry</span><span class=p>)</span> <span class=kt>error</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p><code>Levels</code> 方法返回一个日志级别切片，Logrus 记录的日志级别如果存在于切片中，则会触发 Hooks，即调用 <code>Fire</code> 方法。</p><p>为<code>logrus</code>设置钩子（Hooks），符合<code>[]Level</code>的日志输出前都会执行钩子的特定方法（<code>Fire</code> 方法）。所以，我们可以实现添加输出字段、根据级别将日志输出到不同的目的地。</p><p>并且hook函数会在输出日志之前执行。</p><p>Entry是当前日志条目（当前输出日志对象）。是结构体类型，定义如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Entry</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>Logger</span> <span class=o>*</span><span class=nx>Logger</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Contains all the fields set by the user.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>Data</span> <span class=nx>Fields</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Time at which the log entry was created
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>Time</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Time</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Level the log entry was logged at: Trace, Debug, Info, Warn, Error, Fatal or Panic
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// This field will be set on entry firing and the value will be equal to the one in Logger struct field.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>Level</span> <span class=nx>Level</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Calling method, with package name
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>Caller</span> <span class=o>*</span><span class=nx>runtime</span><span class=p>.</span><span class=nx>Frame</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Message passed to Trace, Debug, Info, Warn, Error, Fatal or Panic
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>Message</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// When formatter is called in entry.log(), a Buffer may be set to entry
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>Buffer</span> <span class=o>*</span><span class=nx>bytes</span><span class=p>.</span><span class=nx>Buffer</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Contains the context set by the user. Useful for hook processing etc.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>Context</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// err may contain a field formatting error
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>err</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>常用的属性是：</p><ol><li><code>Data Fields</code>是日志条目中所有的字段，Fields类型是<code>type Fields map[string]interface{}</code>。</li><li><code>Logger *Logger</code>记录该日志条目的logger。</li><li>单条日志条目信息都保存在Entry结构体中。如，创建时间、日志级别、日志消息等。</li></ol><p><code>logrus</code>也内置了一个<code>syslog</code>的钩子，将日志输出到系统日志<code>syslog</code>中。它不适用用windows的系统日志。</p><p>Logrus 内置 Hooks 列表： <a class=link href=https://github.com/sirupsen/logrus/tree/master/hooks target=_blank rel=noopener>https://github.com/sirupsen/logrus/tree/master/hooks</a></p><h3 id=自定义hook><a href=#%e8%87%aa%e5%ae%9a%e4%b9%89hook class=header-anchor>#</a>
自定义Hook</h3><h4 id=利用hook添加字段><a href=#%e5%88%a9%e7%94%a8hook%e6%b7%bb%e5%8a%a0%e5%ad%97%e6%ae%b5 class=header-anchor>#</a>
利用Hook添加字段</h4><p>这里我们实现一个钩子，在输出的日志中增加一个<code>app=awesome-web</code>字段。</p><p>示例代码如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;github.com/sirupsen/logrus&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>AppHook</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>AppName</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>h</span> <span class=o>*</span><span class=nx>AppHook</span><span class=p>)</span> <span class=nf>Levels</span><span class=p>()</span> <span class=p>[]</span><span class=nx>logrus</span><span class=p>.</span><span class=nx>Level</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>logrus</span><span class=p>.</span><span class=nx>AllLevels</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>h</span> <span class=o>*</span><span class=nx>AppHook</span><span class=p>)</span> <span class=nf>Fire</span><span class=p>(</span><span class=nx>entry</span> <span class=o>*</span><span class=nx>logrus</span><span class=p>.</span><span class=nx>Entry</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>entry</span><span class=p>.</span><span class=nx>Data</span><span class=p>[</span><span class=s>&#34;app&#34;</span><span class=p>]</span> <span class=p>=</span> <span class=nx>h</span><span class=p>.</span><span class=nx>AppName</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>h</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>AppHook</span><span class=p>{</span><span class=nx>AppName</span><span class=p>:</span> <span class=s>&#34;awesome-web&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>logrus</span><span class=p>.</span><span class=nf>AddHook</span><span class=p>(</span><span class=nx>h</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>logrus</span><span class=p>.</span><span class=nf>Info</span><span class=p>(</span><span class=s>&#34;info msg&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>logrus</span><span class=p>.</span><span class=nf>WithField</span><span class=p>(</span><span class=s>&#34;username&#34;</span><span class=p>,</span> <span class=s>&#34;arlettebrook&#34;</span><span class=p>).</span>
</span></span><span class=line><span class=cl>       <span class=nf>Warn</span><span class=p>(</span><span class=s>&#34;user info&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>非标准TTY运行输出：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=err>$</span> <span class=k>go</span> <span class=nx>run</span> <span class=nx>main</span><span class=p>.</span><span class=k>go</span> 
</span></span><span class=line><span class=cl><span class=nx>time</span><span class=p>=</span><span class=s>&#34;2024-05-10T22:58:42+08:00&#34;</span> <span class=nx>level</span><span class=p>=</span><span class=nx>info</span> <span class=nx>msg</span><span class=p>=</span><span class=s>&#34;info msg&#34;</span> <span class=nx>app</span><span class=p>=</span><span class=nx>awesome</span><span class=o>-</span><span class=nx>web</span>
</span></span><span class=line><span class=cl><span class=nx>time</span><span class=p>=</span><span class=s>&#34;2024-05-10T22:58:42+08:00&#34;</span> <span class=nx>level</span><span class=p>=</span><span class=nx>warning</span> <span class=nx>msg</span><span class=p>=</span><span class=s>&#34;user info&#34;</span> <span class=nx>app</span><span class=p>=</span><span class=nx>awesome</span><span class=o>-</span><span class=nx>web</span> <span class=nx>username</span><span class=p>=</span><span class=nx>arlettebro</span>
</span></span><span class=line><span class=cl><span class=nx>ok</span>
</span></span></code></pre></td></tr></table></div></div><p>总结：添加钩子（hook），只需要创建一个结构体实现<code>Hook</code>接口，在Levels方法中设置触发hook函数的条件（日志级别），在Fire方法中定义hook函数行为。然后创建对象，利用<code>AddHook(hook Hook)</code>将hook注册到logger当中。</p><h4 id=利用hook模拟邮件发送><a href=#%e5%88%a9%e7%94%a8hook%e6%a8%a1%e6%8b%9f%e9%82%ae%e4%bb%b6%e5%8f%91%e9%80%81 class=header-anchor>#</a>
利用Hook模拟邮件发送</h4><p>代码如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=s>&#34;github.com/sirupsen/logrus&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>init</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>logrus</span><span class=p>.</span><span class=nf>SetFormatter</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>logrus</span><span class=p>.</span><span class=nx>JSONFormatter</span><span class=p>{})</span>
</span></span><span class=line><span class=cl>    <span class=nx>logrus</span><span class=p>.</span><span class=nf>AddHook</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>EmailHook</span><span class=p>{})</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>EmailHook</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>e</span> <span class=nx>EmailHook</span><span class=p>)</span> <span class=nf>Levels</span><span class=p>()</span> <span class=p>[]</span><span class=nx>logrus</span><span class=p>.</span><span class=nx>Level</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>logrus</span><span class=p>.</span><span class=nx>AllLevels</span> <span class=c1>// 所有日志都发送到邮件
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>e</span> <span class=nx>EmailHook</span><span class=p>)</span> <span class=nf>Fire</span><span class=p>(</span><span class=nx>entry</span> <span class=o>*</span><span class=nx>logrus</span><span class=p>.</span><span class=nx>Entry</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 添加一个邮箱字段标识
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>entry</span><span class=p>.</span><span class=nx>Data</span><span class=p>[</span><span class=s>&#34;app&#34;</span><span class=p>]</span> <span class=p>=</span> <span class=s>&#34;email&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 获取日志条目
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>msg</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>entry</span><span class=p>.</span><span class=nf>String</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 模拟发送邮件
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;fakeSendEmail: %s&#34;</span><span class=p>,</span> <span class=nx>msg</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>logrus</span><span class=p>.</span><span class=nf>Info</span><span class=p>(</span><span class=s>&#34;info msg&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>logrus</span><span class=p>.</span><span class=nf>WithField</span><span class=p>(</span><span class=s>&#34;username&#34;</span><span class=p>,</span> <span class=s>&#34;arlettebrook&#34;</span><span class=p>).</span>
</span></span><span class=line><span class=cl>       <span class=nf>Warn</span><span class=p>(</span><span class=s>&#34;user info&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>运行输出：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ go run main.go 
</span></span><span class=line><span class=cl>fakeSendEmail: <span class=o>{</span><span class=s2>&#34;app&#34;</span>:<span class=s2>&#34;email&#34;</span>,<span class=s2>&#34;level&#34;</span>:<span class=s2>&#34;info&#34;</span>,<span class=s2>&#34;msg&#34;</span>:<span class=s2>&#34;info msg&#34;</span>,<span class=s2>&#34;time&#34;</span>:<span class=s2>&#34;2024-05-10T23:22:13+08:00&#34;</span><span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>{</span><span class=s2>&#34;app&#34;</span>:<span class=s2>&#34;email&#34;</span>,<span class=s2>&#34;level&#34;</span>:<span class=s2>&#34;info&#34;</span>,<span class=s2>&#34;msg&#34;</span>:<span class=s2>&#34;info msg&#34;</span>,<span class=s2>&#34;time&#34;</span>:<span class=s2>&#34;2024-05-10T23:22:13+08:00&#34;</span><span class=o>}</span>
</span></span><span class=line><span class=cl>fakeSendEmail: <span class=o>{</span><span class=s2>&#34;app&#34;</span>:<span class=s2>&#34;email&#34;</span>,<span class=s2>&#34;level&#34;</span>:<span class=s2>&#34;warning&#34;</span>,<span class=s2>&#34;msg&#34;</span>:<span class=s2>&#34;user info&#34;</span>,<span class=s2>&#34;time&#34;</span>:<span class=s2>&#34;2024-05-10T23:22:13+08:0
</span></span></span><span class=line><span class=cl><span class=s2>0&#34;</span>,<span class=s2>&#34;username&#34;</span>:<span class=s2>&#34;arlettebrook&#34;</span><span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>{</span><span class=s2>&#34;app&#34;</span>:<span class=s2>&#34;email&#34;</span>,<span class=s2>&#34;level&#34;</span>:<span class=s2>&#34;warning&#34;</span>,<span class=s2>&#34;msg&#34;</span>:<span class=s2>&#34;user info&#34;</span>,<span class=s2>&#34;time&#34;</span>:<span class=s2>&#34;2024-05-10T23:22:13+08:00&#34;</span>,<span class=s2>&#34;username&#34;</span>:<span class=s2>&#34;
</span></span></span><span class=line><span class=cl><span class=s2>arlettebrook&#34;</span><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>可以发现，在打印每条日志之前，都会执行Hook函数，也就是实现了发送邮件。</p><h3 id=第三方hook><a href=#%e7%ac%ac%e4%b8%89%e6%96%b9hook class=header-anchor>#</a>
第三方Hook</h3><p><code>logrus</code>的第三方 Hook 有很多，我们可以使用一些现成的 Hook 。如：</p><ul><li><a class=link href=https://github.com/weekface/mgorus target=_blank rel=noopener>mgorus</a>：将日志发送到 mongodb；</li><li><a class=link href=https://github.com/rogierlommers/logrus-redis-hook target=_blank rel=noopener>logrus-redis-hook</a>：将日志发送到 redis；</li><li><a class=link href=https://github.com/vladoatanasov/logrus_amqp target=_blank rel=noopener>logrus-amqp</a>：将日志发送到 ActiveMQ。</li><li><a class=link href=https://github.com/orandin/lumberjackrus target=_blank rel=noopener>lumberjackrus</a> ：实现了日志切割和归档功能，并且能够将不同级别的日志输出到不同文件。<code>lumberjackrus</code> 是专门为 Logrus 而打造的文件日志 Hooks，其官方介绍为 <code>local filesystem hook for Logrus</code>。</li></ul><p>更多过内容请参考官方提供的<a class=link href=https://github.com/sirupsen/logrus/wiki/Hooks target=_blank rel=noopener>第三方开发的 Hooks 列表</a>。</p><h4 id=lumberjackrus><a href=#lumberjackrus class=header-anchor>#</a>
lumberjackrus</h4><p><a class=link href=https://github.com/orandin/lumberjackrus target=_blank rel=noopener>lumberjackrus</a> ：实现了日志切割和归档功能，并且能够将不同级别的日志输出到不同文件。<code>lumberjackrus</code> 是专门为 Logrus 而打造的文件日志 Hooks，其官方介绍为 <code>local filesystem hook for Logrus</code>。</p><p>用于记录到本地文件系统的钩子（使用 logrotate 和可以将不同的日志级保存到一个文件）</p><p>lumberjackrus是一个第三方包，使用要先安装：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=err>$</span> <span class=k>go</span> <span class=nx>get</span> <span class=o>-</span><span class=nx>u</span> <span class=nx>github</span><span class=p>.</span><span class=nx>com</span><span class=o>/</span><span class=nx>orandin</span><span class=o>/</span><span class=nx>lumberjackrus</span>
</span></span></code></pre></td></tr></table></div></div><p>示例如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;github.com/orandin/lumberjackrus&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;github.com/sirupsen/logrus&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>init</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>logrus</span><span class=p>.</span><span class=nf>SetFormatter</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>logrus</span><span class=p>.</span><span class=nx>TextFormatter</span><span class=p>{})</span>
</span></span><span class=line><span class=cl>    <span class=nx>logrus</span><span class=p>.</span><span class=nf>SetLevel</span><span class=p>(</span><span class=nx>logrus</span><span class=p>.</span><span class=nx>DebugLevel</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>hook</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>lumberjackrus</span><span class=p>.</span><span class=nf>NewHook</span><span class=p>(</span>
</span></span><span class=line><span class=cl>       <span class=o>&amp;</span><span class=nx>lumberjackrus</span><span class=p>.</span><span class=nx>LogFile</span><span class=p>{</span> <span class=c1>// 未指定级别的日志保存的文件，属性都是optional
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=nx>Filename</span><span class=p>:</span>   <span class=s>&#34;./tmp/general.log&#34;</span><span class=p>,</span> <span class=c1>// 路径+文件名，默认当前目录名字&lt;processName&gt;-lumberjack.log
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=nx>MaxSize</span><span class=p>:</span>    <span class=mi>3</span><span class=p>,</span>                   <span class=c1>// 文件最大占用，单位MB，默认100MB
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=nx>MaxBackups</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span>                   <span class=c1>// 文件最大备份数，默认不限制
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=nx>MaxAge</span><span class=p>:</span>     <span class=mi>1</span><span class=p>,</span>                   <span class=c1>// 备份文件保存的天数，默认永久
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=nx>Compress</span><span class=p>:</span>   <span class=kc>false</span><span class=p>,</span>               <span class=c1>// 是否压缩，默认false
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=nx>LocalTime</span><span class=p>:</span>  <span class=kc>false</span><span class=p>,</span>               <span class=c1>// 文件启用本地时间，默认utc，
</span></span></span><span class=line><span class=cl><span class=c1></span>       <span class=p>},</span>
</span></span><span class=line><span class=cl>       <span class=nx>logrus</span><span class=p>.</span><span class=nx>InfoLevel</span><span class=p>,</span>        <span class=c1>// 定义写入文件的日志级别
</span></span></span><span class=line><span class=cl><span class=c1></span>       <span class=o>&amp;</span><span class=nx>logrus</span><span class=p>.</span><span class=nx>JSONFormatter</span><span class=p>{},</span> <span class=c1>// 日志格式Formatter
</span></span></span><span class=line><span class=cl><span class=c1></span>       <span class=o>&amp;</span><span class=nx>lumberjackrus</span><span class=p>.</span><span class=nx>LogFileOpts</span><span class=p>{</span> <span class=c1>// 根据日志级别指定保存位置
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=nx>logrus</span><span class=p>.</span><span class=nx>InfoLevel</span><span class=p>:</span> <span class=o>&amp;</span><span class=nx>lumberjackrus</span><span class=p>.</span><span class=nx>LogFile</span><span class=p>{</span>
</span></span><span class=line><span class=cl>             <span class=nx>Filename</span><span class=p>:</span>   <span class=s>&#34;./tmp/info/info.log&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>             <span class=nx>MaxSize</span><span class=p>:</span>    <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>             <span class=nx>MaxBackups</span><span class=p>:</span> <span class=mi>2</span><span class=p>,</span>
</span></span><span class=line><span class=cl>             <span class=nx>MaxAge</span><span class=p>:</span>     <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>             <span class=nx>Compress</span><span class=p>:</span>   <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>             <span class=nx>LocalTime</span><span class=p>:</span>  <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=p>},</span>
</span></span><span class=line><span class=cl>          <span class=nx>logrus</span><span class=p>.</span><span class=nx>ErrorLevel</span><span class=p>:</span> <span class=o>&amp;</span><span class=nx>lumberjackrus</span><span class=p>.</span><span class=nx>LogFile</span><span class=p>{</span>
</span></span><span class=line><span class=cl>             <span class=nx>Filename</span><span class=p>:</span> <span class=s>&#34;./tmp/error/error.log&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=p>},</span>
</span></span><span class=line><span class=cl>       <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>       <span class=nb>panic</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>logrus</span><span class=p>.</span><span class=nf>AddHook</span><span class=p>(</span><span class=nx>hook</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>logrus</span><span class=p>.</span><span class=nf>Debug</span><span class=p>(</span><span class=s>&#34;Debug message&#34;</span><span class=p>)</span> <span class=c1>// It is not written to a file (because debug level &lt; minLevel)
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>logrus</span><span class=p>.</span><span class=nf>Info</span><span class=p>(</span><span class=s>&#34;Info message&#34;</span><span class=p>)</span>   <span class=c1>// Written in ./tmp/info.log
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>logrus</span><span class=p>.</span><span class=nf>Warn</span><span class=p>(</span><span class=s>&#34;Warn message&#34;</span><span class=p>)</span>   <span class=c1>// Written in ./tmp/general.log
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>logrus</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=s>&#34;Error message&#34;</span><span class=p>)</span> <span class=c1>// Written in ./tmp/error.log
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>运行，在非标准TTY中输出：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=err>$</span> <span class=k>go</span> <span class=nx>run</span> <span class=nx>main</span><span class=p>.</span><span class=k>go</span> 
</span></span><span class=line><span class=cl><span class=nx>time</span><span class=p>=</span><span class=s>&#34;2024-05-11T10:49:22+08:00&#34;</span> <span class=nx>level</span><span class=p>=</span><span class=nx>debug</span> <span class=nx>msg</span><span class=p>=</span><span class=s>&#34;Debug message&#34;</span>
</span></span><span class=line><span class=cl><span class=nx>time</span><span class=p>=</span><span class=s>&#34;2024-05-11T10:49:22+08:00&#34;</span> <span class=nx>level</span><span class=p>=</span><span class=nx>info</span> <span class=nx>msg</span><span class=p>=</span><span class=s>&#34;Info message&#34;</span>
</span></span><span class=line><span class=cl><span class=nx>time</span><span class=p>=</span><span class=s>&#34;2024-05-11T10:49:22+08:00&#34;</span> <span class=nx>level</span><span class=p>=</span><span class=nx>warning</span> <span class=nx>msg</span><span class=p>=</span><span class=s>&#34;Warn message&#34;</span>
</span></span><span class=line><span class=cl><span class=nx>time</span><span class=p>=</span><span class=s>&#34;2024-05-11T10:49:22+08:00&#34;</span> <span class=nx>level</span><span class=p>=</span><span class=kt>error</span> <span class=nx>msg</span><span class=p>=</span><span class=s>&#34;Error message&#34;</span>
</span></span></code></pre></td></tr></table></div></div><p>并且还会再当前目录下生成<code>tmp/general.log, tmp/info, tmp/error</code>,里面的格式为json。debug日志没有写入文件。<code>info.log</code>文件内容如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span><span class=nt>&#34;level&#34;</span><span class=p>:</span><span class=s2>&#34;info&#34;</span><span class=p>,</span><span class=nt>&#34;msg&#34;</span><span class=p>:</span><span class=s2>&#34;Info message&#34;</span><span class=p>,</span><span class=nt>&#34;time&#34;</span><span class=p>:</span><span class=s2>&#34;2024-05-11T10:49:22+08:00&#34;</span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>至此，我们使用<code>lumberjackrus</code>实现了<strong>日志轮询</strong>以及<strong>分级别保存</strong>。这个钩子，实现日志轮询是基于<code>lumberjack</code>库实现的。</p><p>使用这个钩子，我们只需要利用<code>NewHook(defaultLogger *LogFile, minLevel logrus.Level, formatter logrus.Formatter, opts *LogFileOpts) (*Hook, error)</code>创建对象，将对象添加logger中即可使用。代码中有对参数的介绍。最后一个参数（本质是map类型）如果为<code>nil</code>或者为空map，那么日志将不会分级别保存，都会保存到<code>defaultLogger</code>指定的文件中。</p><h4 id=logrus-redis-hook><a href=#logrus-redis-hook class=header-anchor>#</a>
logrus-redis-hook</h4><p>下面演示利用hook将日志发送到redis，我们用到的包是<a class=link href=https://github.com/rogierlommers/logrus-redis-hook target=_blank rel=noopener>logrus-redis-hook</a>, 先安装<code>logrus-redis-hook</code>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ go get -u github.com/rogierlommers/logrus-redis-hook
</span></span></code></pre></td></tr></table></div></div><p>默认你已经安装好了redis并且启动了它，如果你想了解redis，可以参考我的另一篇文章<a class=link href=https://arlettebrook.github.io/p/redis-introduction/ target=_blank rel=noopener>《Redis Introduction》</a>。</p><p>然后编写程序：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;io&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>logredis</span> <span class=s>&#34;github.com/rogierlommers/logrus-redis-hook&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;github.com/sirupsen/logrus&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>init</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>logrus</span><span class=p>.</span><span class=nf>SetFormatter</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>logrus</span><span class=p>.</span><span class=nx>JSONFormatter</span><span class=p>{})</span>
</span></span><span class=line><span class=cl>    <span class=nx>hookConfig</span> <span class=o>:=</span> <span class=nx>logredis</span><span class=p>.</span><span class=nx>HookConfig</span><span class=p>{</span>
</span></span><span class=line><span class=cl>       <span class=nx>Host</span><span class=p>:</span>     <span class=s>&#34;192.168.245.130&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>       <span class=nx>Password</span><span class=p>:</span> <span class=s>&#34;123456&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>       <span class=nx>Key</span><span class=p>:</span>      <span class=s>&#34;demo_log&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>       <span class=nx>Format</span><span class=p>:</span>   <span class=s>&#34;v0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>       <span class=nx>App</span><span class=p>:</span>      <span class=s>&#34;awesome_demo&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>       <span class=nx>Port</span><span class=p>:</span>     <span class=mi>6379</span><span class=p>,</span>
</span></span><span class=line><span class=cl>       <span class=nx>Hostname</span><span class=p>:</span> <span class=s>&#34;localhost&#34;</span><span class=p>,</span> <span class=c1>// will be sent to field @source_host
</span></span></span><span class=line><span class=cl><span class=c1></span>       <span class=nx>DB</span><span class=p>:</span>       <span class=mi>1</span><span class=p>,</span>           <span class=c1>// optional
</span></span></span><span class=line><span class=cl><span class=c1></span>       <span class=nx>TTL</span><span class=p>:</span>      <span class=mi>3600</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>hook</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>logredis</span><span class=p>.</span><span class=nf>NewHook</span><span class=p>(</span><span class=nx>hookConfig</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>       <span class=nx>logrus</span><span class=p>.</span><span class=nf>AddHook</span><span class=p>(</span><span class=nx>hook</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>       <span class=nx>logrus</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;logredis error: %q&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// when hook is injected successfully, logs will be sent to redis server
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>logrus</span><span class=p>.</span><span class=nf>Info</span><span class=p>(</span><span class=s>&#34;just some info logging...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// we also support log.WithFields()
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>logrus</span><span class=p>.</span><span class=nf>WithFields</span><span class=p>(</span><span class=nx>logrus</span><span class=p>.</span><span class=nx>Fields</span><span class=p>{</span>
</span></span><span class=line><span class=cl>       <span class=s>&#34;animal&#34;</span><span class=p>:</span> <span class=s>&#34;walrus&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>       <span class=s>&#34;foo&#34;</span><span class=p>:</span>    <span class=s>&#34;bar&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>       <span class=s>&#34;this&#34;</span><span class=p>:</span>   <span class=s>&#34;that&#34;</span><span class=p>}).</span>
</span></span><span class=line><span class=cl>       <span class=nf>Info</span><span class=p>(</span><span class=s>&#34;additional fields are being logged as well&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// If you want to disable writing to stdout, use setOutput
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>logrus</span><span class=p>.</span><span class=nf>SetOutput</span><span class=p>(</span><span class=nx>io</span><span class=p>.</span><span class=nx>Discard</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>logrus</span><span class=p>.</span><span class=nf>Info</span><span class=p>(</span><span class=s>&#34;This will only be sent to Redis&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>注意：请连接你自己的redis。</p><p>运行程序后，终端输出：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ go run main.go 
</span></span><span class=line><span class=cl><span class=o>{</span><span class=s2>&#34;level&#34;</span>:<span class=s2>&#34;info&#34;</span>,<span class=s2>&#34;msg&#34;</span>:<span class=s2>&#34;just some info logging...&#34;</span>,<span class=s2>&#34;time&#34;</span>:<span class=s2>&#34;2024-05-11T11:56:17+08:00&#34;</span><span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>{</span><span class=s2>&#34;animal&#34;</span>:<span class=s2>&#34;walrus&#34;</span>,<span class=s2>&#34;foo&#34;</span>:<span class=s2>&#34;bar&#34;</span>,<span class=s2>&#34;level&#34;</span>:<span class=s2>&#34;info&#34;</span>,<span class=s2>&#34;msg&#34;</span>:<span class=s2>&#34;additional fields are being logged as well&#34;</span>,<span class=s2>&#34;
</span></span></span><span class=line><span class=cl><span class=s2>this&#34;</span>:<span class=s2>&#34;that&#34;</span>,<span class=s2>&#34;time&#34;</span>:<span class=s2>&#34;2024-05-11T11:56:17+08:00&#34;</span><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>我们使用<code>redis-cli</code>查看：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>127.0.0.1:6379<span class=o>[</span>1<span class=o>]</span>&gt; lrange demo_log <span class=m>0</span> -1
</span></span><span class=line><span class=cl>1<span class=o>)</span> <span class=s2>&#34;{\&#34;@fields\&#34;:{\&#34;application\&#34;:\&#34;awesome_demo\&#34;,\&#34;level\&#34;:\&#34;info\&#34;},\&#34;@message\&#34;:\&#34;just some info logging...\&#34;,\&#34;@source_host\&#34;:\&#34;localhost\&#34;,\&#34;@timestamp\&#34;:\&#34;2024-05-11T03:56:17.867867Z\&#34;}&#34;</span>
</span></span><span class=line><span class=cl>2<span class=o>)</span> <span class=s2>&#34;{\&#34;@fields\&#34;:{\&#34;animal\&#34;:\&#34;walrus\&#34;,\&#34;application\&#34;:\&#34;awesome_demo\&#34;,\&#34;foo\&#34;:\&#34;bar\&#34;,\&#34;level\&#34;:\&#34;info\&#34;,\&#34;this\&#34;:\&#34;that\&#34;},\&#34;@message\&#34;:\&#34;additional fields are being logged as well\&#34;,\&#34;@source_host\&#34;:\&#34;localhost\&#34;,\&#34;@timestamp\&#34;:\&#34;2024-05-11T03:56:17.933777Z\&#34;}&#34;</span>
</span></span><span class=line><span class=cl>3<span class=o>)</span> <span class=s2>&#34;{\&#34;@fields\&#34;:{\&#34;application\&#34;:\&#34;awesome_demo\&#34;,\&#34;level\&#34;:\&#34;info\&#34;},\&#34;@message\&#34;:\&#34;This will only be sent to Redis\&#34;,\&#34;@source_host\&#34;:\&#34;localhost\&#34;,\&#34;@timestamp\&#34;:\&#34;2024-05-11T03:56:17.9351074Z\&#34;}&#34;</span>
</span></span></code></pre></td></tr></table></div></div><p>我们看到<code>demo_log</code>是一个<code>list</code>，每过来一条日志，就在<code>list</code>后新增一项。</p><p>默认的logger是输出到stderr，但修改为discard，将不会输出到任何地方，但是钩子依然执行。因为钩子里面指定发送到的是redis，不受影响。</p><hr><h2 id=总结><a href=#%e6%80%bb%e7%bb%93 class=header-anchor>#</a>
总结</h2><p>本文介绍了 Logrus 的基本特点，以及如何使用。</p><p>Logrus 完全兼容 log 标准库，所以可以实现无缝替换。其 API 设计思路跟 log 标准库的风格也有很多相似之处，都提供了一个默认的 <code>std</code> 日志对象达到开箱即用的效果。Logrus 最实用的两个功能，一个是支持结构化日志，一个是支持 Hooks 机制，这极大的提升了可用性和灵活性，也使得 Logrus 成为最受欢迎的 Go 日志库。</p><hr><h2 id=参考><a href=#%e5%8f%82%e8%80%83 class=header-anchor>#</a>
参考</h2><blockquote><ol><li><a class=link href=https://github.com/sirupsen/logrus target=_blank rel=noopener>logrus</a> GitHub 仓库</li><li><a class=link href=https://darjun.github.io/2020/02/07/godailylib/logrus/ target=_blank rel=noopener>Go 每日一库之 logrus</a></li><li><a class=link href=https://jianghushinian.cn/2023/03/15/use-of-logrus-in-go-third-party-log-library/ target=_blank rel=noopener>Go 第三方 log 库之 logrus 使用</a></li></ol></blockquote></section><footer class=article-footer><section class=article-tags><a href=/tags/go%E7%AC%AC%E4%B8%89%E6%96%B9%E5%BA%93/>Go第三方库</a></section><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>相关文章</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/p/carbon-introduction/><div class=article-details><h2 class=article-title>Carbon Introduction</h2></div></a></article><article><a href=/p/godotenv-introduction/><div class=article-details><h2 class=article-title>Godotenv Introduction</h2></div></a></article><article><a href=/p/cast-introduction/><div class=article-details><h2 class=article-title>Cast Introduction</h2></div></a></article><article><a href=/p/fsnotify-introduction/><div class=article-details><h2 class=article-title>Fsnotify Introduction</h2></div></a></article><article><a href=/p/go%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86%E4%B9%8B%E7%AC%AC%E4%B8%89%E6%96%B9%E5%BA%93viper/><div class=article-details><h2 class=article-title>Go配置管理之第三方库viper</h2></div></a></article></div></div></aside><script src=//unpkg.com/@waline/client@v2/dist/waline.js></script><link href=//unpkg.com/@waline/client@v2/dist/waline.css rel=stylesheet><div id=waline class=waline-container></div><style>.waline-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding);--waline-font-size:var(--article-font-size)}.waline-container .wl-count{color:var(--card-text-color-main)}</style><script>Waline.init({copyright:!1,dark:'html[data-scheme="dark"]',el:"#waline",emoji:["https://unpkg.com/@waline/emojis@1.0.1/weibo"],lang:"zh-cn",locale:{admin:"👻Hi!",placeholder:"🎉留下你的脚印..."},pageview:!0,requiredMeta:["name","email"],serverURL:"https://waline.trojan123.top/"})</script><footer class=site-footer><section class=copyright>&copy;
2020 -
2024 <a href=https://creativecommons.org/licenses/by-nc-sa/4.0/legalcode.zh-hans target=_blank rel=noopener>博客内容遵循 知识共享 署名 - 非商业性 - 相同方式共享 4.0 国际协议</a></section><section class=powerby>使用 <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> 构建<br>主题 <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.25.0>Stack</a></b> 由 <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> 设计</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>