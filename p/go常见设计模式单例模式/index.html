<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="Goå¸¸è§è®¾è®¡æ¨¡å¼ä¹‹å•ä¾‹æ¨¡å¼ã€‚"><title>Goå¸¸è§è®¾è®¡æ¨¡å¼ï¼šå•ä¾‹æ¨¡å¼</title>
<link rel=canonical href=https://arlettebrook.github.io/p/go%E5%B8%B8%E8%A7%81%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F/><link rel=stylesheet href=/scss/style.min.59d76563977ef6a76d0c7df16aa86c7ac37ed8942ba1442046cb6cf3b07439d7.css><meta property='og:title' content="Goå¸¸è§è®¾è®¡æ¨¡å¼ï¼šå•ä¾‹æ¨¡å¼"><meta property='og:description' content="Goå¸¸è§è®¾è®¡æ¨¡å¼ä¹‹å•ä¾‹æ¨¡å¼ã€‚"><meta property='og:url' content='https://arlettebrook.github.io/p/go%E5%B8%B8%E8%A7%81%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F/'><meta property='og:site_name' content="Arlettebrook's blog"><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='Goè®¾è®¡æ¨¡å¼'><meta property='article:published_time' content='2024-04-25T18:00:25+08:00'><meta property='article:modified_time' content='2024-04-25T18:00:25+08:00'><meta name=twitter:site content="@arlettebrook"><meta name=twitter:creator content="@arlettebrook"><meta name=twitter:title content="Goå¸¸è§è®¾è®¡æ¨¡å¼ï¼šå•ä¾‹æ¨¡å¼"><meta name=twitter:description content="Goå¸¸è§è®¾è®¡æ¨¡å¼ä¹‹å•ä¾‹æ¨¡å¼ã€‚"><link rel="shortcut icon" href=/img/favicon.ico><script async src="https://www.googletagmanager.com/gtag/js?id=G-9MKLLVPEER"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-9MKLLVPEER")}</script></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><div id=article-toolbar style=position:sticky;top:5px;z-index:1000><a href=/ class=back-home><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-chevron-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="15 6 9 12 15 18"/></svg>
<span>è¿”å›</span></a></div><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">ç›®å½•</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#é¥¿æ±‰å¼>é¥¿æ±‰å¼</a></li><li><a href=#æ‡’æ±‰å¼>æ‡’æ±‰å¼</a><ol><li><a href=#æ”¯æŒå¹¶å‘çš„å•ä¾‹>æ”¯æŒå¹¶å‘çš„å•ä¾‹</a></li><li><a href=#åŒé‡é”å®š>åŒé‡é”å®š</a></li></ol></li><li><a href=#gopher-æƒ¯ç”¨æ–¹æ¡ˆ>Gopher æƒ¯ç”¨æ–¹æ¡ˆ</a></li><li><a href=#æ€»ç»“>æ€»ç»“</a></li><li><a href=#å‚è€ƒ>å‚è€ƒ</a></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/go/ style=background-color:#f97300;color:#fff>Go
</a><a href=/categories/%E7%BC%96%E7%A8%8B/ style=background-color:#41b06e;color:#fff>ç¼–ç¨‹</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/go%E5%B8%B8%E8%A7%81%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F/>Goå¸¸è§è®¾è®¡æ¨¡å¼ï¼šå•ä¾‹æ¨¡å¼</a></h2><h3 class=article-subtitle>Goå¸¸è§è®¾è®¡æ¨¡å¼ä¹‹å•ä¾‹æ¨¡å¼ã€‚</h3></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Apr 25, 2024</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>é˜…è¯»æ—¶é•¿: 4 åˆ†é’Ÿ</time></div></footer></div></header><section class=article-content><hr><blockquote><p><strong>å•ä¾‹æ¨¡å¼</strong>æ˜¯è®¾è®¡æ¨¡å¼ä¸­æœ€ç®€å•çš„ä¸€ç§æ¨¡å¼ï¼Œå•ä¾‹æ¨¡å¼èƒ½å¤Ÿç¡®ä¿æ— è®ºå¯¹è±¡è¢«å®ä¾‹åŒ–å¤šå°‘æ¬¡ï¼Œå…¨å±€éƒ½<strong>åªæœ‰ä¸€ä¸ª</strong>å®ä¾‹å­˜åœ¨ã€‚æ ¹æ®å•ä¾‹æ¨¡å¼çš„ç‰¹æ€§ï¼Œæˆ‘ä»¬å¯ä»¥å°†å…¶åº”ç”¨åˆ°å…¨å±€å”¯ä¸€æ€§é…ç½®ã€æ•°æ®åº“è¿æ¥å¯¹è±¡ã€æ–‡ä»¶è®¿é—®å¯¹è±¡ç­‰ã€‚Go è¯­è¨€æœ‰å¤šç§æ–¹å¼å¯ä»¥å®ç°å•ä¾‹æ¨¡å¼ï¼Œæˆ‘ä»¬ä»Šå¤©å°±æ¥ä¸€èµ·å­¦ä¹ ä¸‹ã€‚</p></blockquote><hr><h2 id=é¥¿æ±‰å¼><a href=#%e9%a5%bf%e6%b1%89%e5%bc%8f class=header-anchor>#</a>
é¥¿æ±‰å¼</h2><p>é¥¿æ±‰å¼å®ç°å•ä¾‹æ¨¡å¼éå¸¸ç®€å•ï¼Œç›´æ¥çœ‹ä»£ç ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>singleton</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Singleton</span> <span class=kd>struct</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>instance</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>Singleton</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>GetSingleton</span><span class=p>()</span> <span class=o>*</span><span class=nx>Singleton</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>instance</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p><code>singleton</code> åŒ…åœ¨è¢«å¯¼å…¥æ—¶ä¼šè‡ªåŠ¨åˆå§‹åŒ– <code>instance</code> å®ä¾‹ï¼Œä½¿ç”¨æ—¶é€šè¿‡è°ƒç”¨ <code>singleton.GetSingleton()</code> å‡½æ•°å³å¯è·å¾— <code>Singleton</code> è¿™ä¸ªç»“æ„ä½“çš„å•ä¾‹å¯¹è±¡ã€‚</p><p>ç”±äºå•ä¾‹å¯¹è±¡æ˜¯åœ¨åŒ…åŠ è½½æ—¶ç«‹å³è¢«åˆ›å»ºå‡ºæ¥ï¼Œæ‰€ä»¥ä¹Ÿå°±æœ‰äº†è¿™ä¸ªå½¢è±¡çš„åç§°å«ä½œé¥¿æ±‰å¼ã€‚ä¸ä¹‹å¯¹åº”çš„å¦ä¸€ç§å®ç°æ–¹å¼å«ä½œæ‡’æ±‰å¼ï¼Œå½“å®ä¾‹è¢«ç¬¬ä¸€æ¬¡ä½¿ç”¨æ—¶æ‰ä¼šè¢«åˆ›å»ºã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå°½ç®¡é¥¿æ±‰å¼å®ç°å•ä¾‹æ¨¡å¼å¦‚æ­¤ç®€å•ï¼Œä½†å¤§å¤šæ•°æƒ…å†µä¸‹ä»ä¸è¢«æ¨èä½¿ç”¨ï¼Œå› ä¸ºå¦‚æœå•ä¾‹å®ä¾‹åŒ–æ—¶åˆå§‹åŒ–å†…å®¹è¿‡å¤šï¼Œå¯èƒ½é€ æˆç¨‹åºåŠ è½½ç”¨æ—¶è¾ƒé•¿ã€‚</p><hr><h2 id=æ‡’æ±‰å¼><a href=#%e6%87%92%e6%b1%89%e5%bc%8f class=header-anchor>#</a>
æ‡’æ±‰å¼</h2><p>æ¥ä¸‹æ¥æˆ‘ä»¬å†æ¥çœ‹ä¸‹å¦‚ä½•é€šè¿‡æ‡’æ±‰å¼å®ç°å•ä¾‹æ¨¡å¼ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>singleton</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Singleton</span> <span class=kd>struct</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>instance</span> <span class=o>*</span><span class=nx>Singleton</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>GetSingleton</span><span class=p>()</span> <span class=o>*</span><span class=nx>Singleton</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>instance</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>       <span class=nx>instance</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>Singleton</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>instance</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>ç›¸è¾ƒäºé¥¿æ±‰å¼çš„å®ç°ï¼Œæˆ‘ä»¬æŠŠå®ä¾‹åŒ– <code>Singleton</code> ç»“æ„ä½“éƒ¨åˆ†çš„ä»£ç ç§»åˆ°äº† <code>GetSingleton()</code> å‡½æ•°å†…éƒ¨ã€‚è¿™æ ·ä¸€æ¥ï¼Œå°±å°†å¯¹è±¡å®ä¾‹åŒ–çš„æ­¥éª¤å»¶è¿Ÿåˆ°äº† <code>GetSingleton()</code> è¢«ç¬¬ä¸€æ¬¡è°ƒç”¨æ—¶ã€‚</p><p>é€šè¿‡ <code>instance == nil</code> çš„åˆ¤æ–­æ¥å®ç°å•ä¾‹å¹¶ä¸ååˆ†å¯é ï¼Œå½“æœ‰å¤šä¸ª <code>goroutine</code> åŒæ—¶è°ƒç”¨ <code>GetSingleton()</code> æ—¶æ— æ³•ä¿è¯å¹¶å‘å®‰å…¨ã€‚</p><h3 id=æ”¯æŒå¹¶å‘çš„å•ä¾‹><a href=#%e6%94%af%e6%8c%81%e5%b9%b6%e5%8f%91%e7%9a%84%e5%8d%95%e4%be%8b class=header-anchor>#</a>
æ”¯æŒå¹¶å‘çš„å•ä¾‹</h3><p>å¦‚æœä½ ç”¨ Go è¯­è¨€å†™è¿‡å¹¶å‘ç¼–ç¨‹ï¼Œé‚£ä¹ˆåº”è¯¥å¯ä»¥å¾ˆå¿«æƒ³åˆ°è§£å†³æ‡’æ±‰å¼å•ä¾‹æ¨¡å¼å¹¶å‘å®‰å…¨é—®é¢˜çš„æ–¹æ¡ˆï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>singleton</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=s>&#34;sync&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Singleton</span> <span class=kd>struct</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>instance</span> <span class=o>*</span><span class=nx>Singleton</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>mu</span> <span class=nx>sync</span><span class=p>.</span><span class=nx>Mutex</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>GetSingleton</span><span class=p>()</span> <span class=o>*</span><span class=nx>Singleton</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>mu</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>defer</span> <span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>instance</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>       <span class=nx>instance</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>Singleton</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>instance</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>æˆ‘ä»¬å¯¹ä»£ç çš„ä¸»è¦ä¿®æ”¹å°±æ˜¯åœ¨ <code>GetSingleton()</code> å‡½æ•°æœ€å¼€å§‹åŠ äº†å¦‚ä¸‹ä¸¤è¡Œä»£ç ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>mu</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=k>defer</span> <span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><p>é€šè¿‡åŠ é”çš„æœºåˆ¶ï¼Œå°±å¯ä»¥ä¿è¯è¿™ä¸ªå®ç°å•ä¾‹æ¨¡å¼çš„å‡½æ•°æ˜¯å¹¶å‘å®‰å…¨çš„ã€‚</p><p>ä¸è¿‡è¿™æ ·ä¹Ÿæœ‰äº›é—®é¢˜ï¼Œå› ä¸ºç”¨äº†é”æœºåˆ¶ï¼Œæ¯æ¬¡è°ƒç”¨ <code>GetSingleton()</code> æ—¶ç¨‹åºéƒ½ä¼šè¿›è¡ŒåŠ é”ã€è§£é”çš„æ­¥éª¤ï¼Œè¿™æ ·ä¼šå¯¼è‡´ç¨‹åºæ€§èƒ½çš„ä¸‹é™ã€‚</p><h3 id=åŒé‡é”å®š><a href=#%e5%8f%8c%e9%87%8d%e9%94%81%e5%ae%9a class=header-anchor>#</a>
åŒé‡é”å®š</h3><p>åŠ é”å¯¼è‡´ç¨‹åºæ€§èƒ½ä¸‹é™ï¼Œä½†æˆ‘ä»¬åˆä¸å¾—ä¸ç”¨é”æ¥ä¿è¯ç¨‹åºçš„å¹¶å‘å®‰å…¨ï¼Œäºæ˜¯æœ‰äººæƒ³å‡ºäº†åŒé‡é”å®šï¼ˆ<code>Double-Check Locking</code>ï¼‰çš„æ–¹æ¡ˆï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>singleton</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=s>&#34;sync&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Singleton</span> <span class=kd>struct</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>instance</span> <span class=o>*</span><span class=nx>Singleton</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>mu</span> <span class=nx>sync</span><span class=p>.</span><span class=nx>Mutex</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>GetSingleton</span><span class=p>()</span> <span class=o>*</span><span class=nx>Singleton</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>instance</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>       <span class=nx>mu</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>       <span class=k>defer</span> <span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>       <span class=k>if</span> <span class=nx>instance</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>instance</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>Singleton</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>       <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>instance</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å¯ä»¥çœ‹åˆ°ï¼Œæ‰€è°“çš„åŒé‡é”å®šå®é™…ä¸Šå°±æ˜¯åœ¨ç¨‹åºåŠ é”å‰åˆåŠ äº†ä¸€å±‚ <code>instance == nil</code> åˆ¤æ–­ï¼Œè¿™æ ·å°±å…¼é¡¾äº†æ€§èƒ½å’Œå®‰å…¨ä¸¤ä¸ªæ–¹é¢ã€‚</p><p>ä¸è¿‡è¿™æ®µä»£ç çœ‹èµ·æ¥æœ‰äº›å¥‡æ€ªï¼Œæ—¢ç„¶å¤–å±‚å·²ç»åˆ¤æ–­äº† <code>instance == nil</code>ï¼ŒåŠ é”åå´åˆè¿›è¡Œäº†ç¬¬äºŒæ¬¡ <code>instance == nil</code> åˆ¤æ–­ã€‚å…¶å®å¤–å±‚çš„ <code>instance == nil</code> åˆ¤æ–­æ˜¯ä¸ºäº†æé«˜ç¨‹åºçš„æ‰§è¡Œæ•ˆç‡ï¼Œå› ä¸ºå¦‚æœ <code>instance</code> å·²ç»å­˜åœ¨ï¼Œåˆ™æ— éœ€è¿›å…¥ <code>if</code> é€»è¾‘ï¼Œç¨‹åºç›´æ¥è¿”å› <code>instance</code> å³å¯ã€‚è¿™æ ·å°±å…å»äº†åŸæ¥æ¯æ¬¡è°ƒç”¨ <code>GetSingleton()</code> éƒ½ä¸Šé”çš„æ“ä½œï¼Œå°†åŠ é”çš„ç²’åº¦æ›´åŠ ç²¾ç»†åŒ–ã€‚è€Œå†…å±‚çš„ <code>instance == nil</code> åˆ¤æ–­åˆ™æ˜¯è€ƒè™‘äº†å¹¶å‘å®‰å…¨ï¼Œåœ¨æç«¯æƒ…å†µä¸‹ï¼Œå¤šä¸ª <code>goroutine</code> åŒæ—¶èµ°åˆ°äº†åŠ é”è¿™ä¸€æ­¥ï¼Œå†…å±‚åˆ¤æ–­å°±èµ·åˆ°ä½œç”¨äº†ã€‚</p><hr><h2 id=gopher-æƒ¯ç”¨æ–¹æ¡ˆ><a href=#gopher-%e6%83%af%e7%94%a8%e6%96%b9%e6%a1%88 class=header-anchor>#</a>
Gopher æƒ¯ç”¨æ–¹æ¡ˆ</h2><blockquote><p>gopheråŸæ„åœ°é¼ ï¼Œåœ¨golang çš„ä¸–ç•Œé‡Œè§£é‡Šä¸º<strong>åœ°é“çš„goç¨‹åºå‘˜</strong>ã€‚åœ¨å…¶ä»–è¯­è¨€çš„ä¸–ç•Œé‡Œä¹Ÿæœ‰PHPerï¼ŒPythonicçš„è¯´æ³•ï¼Œåè€ŒJavaæ˜¯ä¸ªä¾‹å¤–ã€‚è™½ç„¶ä¹Ÿæœ‰Javaerä¹‹ç±»çš„è¯´æ³•ï¼Œä½†ä¼¼ä¹å¹¶ä¸è¢«è®¤å¯ã€‚è€Œ<strong>åœ°é“</strong>æˆ–è€…è¯´<strong>é“åœ°</strong>ï¼Œè¯´çš„æ˜¯gopherå†™çš„ä»£ç æ— ä¸é€éœ²å‡ºgoçš„ç‹¬ç‰¹æ°”æ¯ï¼Œæ¯”å¦‚é¡¹ç›®ç»“æ„ã€å‘½åæ–¹å¼ã€ä»£ç æ ¼å¼ã€ç¼–ç é£æ ¼ã€æ„å»ºæ–¹å¼ç­‰ç­‰ã€‚ç”¨gopherçš„è¯è¯´ï¼Œç”¨goç¼–å†™ä»£ç å°±åƒæ˜¯åœ¨ç”»ä¸€å¹…ä¸­å›½å±±æ°´ç”»ï¼Œæˆå“ç¾ä¸èƒœæ”¶ï¼Œå¿ƒæ—·ç¥æ€¡ã€‚</p></blockquote><p>è™½ç„¶æˆ‘ä»¬é€šè¿‡åŒé‡é”å®šæœºåˆ¶å…¼é¡¾å’Œæ€§èƒ½å’Œå¹¶å‘å®‰å…¨ï¼Œä½†ä»£ç æœ‰äº›ä¸‘é™‹ï¼Œä¸ç¬¦åˆå¹¿å¤§ Gopher çš„æœŸå¾…ã€‚å¥½åœ¨ Go è¯­è¨€åœ¨ <code>sync</code> åŒ…ä¸­æä¾›äº† <code>Once</code> æœºåˆ¶èƒ½å¤Ÿå¸®åŠ©æˆ‘ä»¬å†™å‡ºæ›´åŠ ä¼˜é›…çš„ä»£ç ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>singleton</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=s>&#34;sync&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Singleton</span> <span class=kd>struct</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>instance</span> <span class=o>*</span><span class=nx>Singleton</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>once</span> <span class=nx>sync</span><span class=p>.</span><span class=nx>Once</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>GetSingleton</span><span class=p>()</span> <span class=o>*</span><span class=nx>Singleton</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>once</span><span class=p>.</span><span class=nf>Do</span><span class=p>(</span><span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>       <span class=nx>instance</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>Singleton</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>instance</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p><code>Once</code> æ˜¯ä¸€ä¸ªç»“æ„ä½“ï¼Œåœ¨æ‰§è¡Œ <code>Do</code> æ–¹æ³•çš„å†…éƒ¨é€šè¿‡ <code>atomic</code> æ“ä½œå’ŒåŠ é”æœºåˆ¶æ¥ä¿è¯å¹¶å‘å®‰å…¨ï¼Œä¸” <code>once.Do</code> èƒ½å¤Ÿä¿è¯å¤šä¸ª <code>goroutine</code> åŒæ—¶æ‰§è¡Œæ—¶ <code>&amp;singleton{}</code> åªè¢«åˆ›å»ºä¸€æ¬¡ã€‚</p><p>å…¶å® <code>Once</code> å¹¶ä¸ç¥ç§˜ï¼Œå…¶å†…éƒ¨å®ç°è·Ÿä¸Šé¢ä½¿ç”¨çš„åŒé‡é”å®šæœºåˆ¶éå¸¸ç±»ä¼¼ï¼Œåªä¸è¿‡æŠŠ <code>instance == nil</code> æ¢æˆäº† <code>atomic</code> æ“ä½œï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥æŸ¥çœ‹ä¸‹å…¶å¯¹åº”æºç ã€‚</p><hr><h2 id=æ€»ç»“><a href=#%e6%80%bb%e7%bb%93 class=header-anchor>#</a>
æ€»ç»“</h2><p>ä»¥ä¸Šå°±æ˜¯ Go è¯­è¨€ä¸­å®ç°å•ä¾‹æ¨¡å¼çš„å‡ ç§å¸¸ç”¨å¥—è·¯ï¼Œç»è¿‡å¯¹æ¯”å¯ä»¥å¾—å‡ºç»“è®ºï¼Œæœ€æ¨èçš„æ–¹å¼æ˜¯ä½¿ç”¨ <code>once.Do</code> æ¥å®ç°ï¼Œ<code>sync.Once</code> åŒ…å¸®æˆ‘ä»¬éšè—äº†éƒ¨åˆ†ç»†èŠ‚ï¼Œå´å¯ä»¥è®©ä»£ç å¯è¯»æ€§å¾—åˆ°å¾ˆå¤§æå‡ã€‚</p><hr><h2 id=å‚è€ƒ><a href=#%e5%8f%82%e8%80%83 class=header-anchor>#</a>
å‚è€ƒ</h2><ol><li><a class=link href=https://www.cnblogs.com/laud/p/gopher.html target=_blank rel=noopener>ä¸ä¸€æ ·çš„goè¯­è¨€-gopher</a></li><li><a class=link href=https://jianghushinian.cn/2022/03/04/Golang-%E5%B8%B8%E8%A7%81%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E4%B9%8B%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F/ target=_blank rel=noopener>Go å¸¸è§è®¾è®¡æ¨¡å¼ä¹‹å•ä¾‹æ¨¡å¼</a></li></ol></section><footer class=article-footer><section class=article-tags><a href=/tags/go%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/>Goè®¾è®¡æ¨¡å¼</a></section><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>ç›¸å…³æ–‡ç« </h2><div class=related-content><div class="flex article-list--tile"><article><a href=/p/go%E5%B8%B8%E8%A7%81%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E9%80%89%E9%A1%B9%E6%A8%A1%E5%BC%8F/><div class=article-details><h2 class=article-title>Goå¸¸è§è®¾è®¡æ¨¡å¼ï¼šé€‰é¡¹æ¨¡å¼</h2></div></a></article><article><a href=/p/go-code-guide-introduction/><div class=article-details><h2 class=article-title>Go Code Guide Introduction</h2></div></a></article><article><a href=/p/go-ini-introduction/><div class=article-details><h2 class=article-title>Go-ini Introduction</h2></div></a></article><article><a href=/p/carbon-introduction/><div class=article-details><h2 class=article-title>Carbon Introduction</h2></div></a></article><article><a href=/p/godotenv-introduction/><div class=article-details><h2 class=article-title>Godotenv Introduction</h2></div></a></article></div></div></aside><script src=//unpkg.com/@waline/client@v2/dist/waline.js></script><link href=//unpkg.com/@waline/client@v2/dist/waline.css rel=stylesheet><div id=waline class=waline-container></div><style>.waline-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding);--waline-font-size:var(--article-font-size)}.waline-container .wl-count{color:var(--card-text-color-main)}</style><script>Waline.init({copyright:!1,dark:'html[data-scheme="dark"]',el:"#waline",emoji:["https://unpkg.com/@waline/emojis@1.0.1/weibo"],lang:"zh-cn",locale:{admin:"ğŸ‘»Hi!",placeholder:"ğŸ‰ç•™ä¸‹ä½ çš„è„šå°..."},pageview:!0,requiredMeta:["name","email"],serverURL:"https://waline.trojan123.top/"})</script><footer class=site-footer><section class=copyright>Copyright &copy;
2020 -
2024 <b><a href=https://github.com/arlettebrook target=_blank rel=noopener>@Arlettebrook</a></b></section><section class=powerby>åšå®¢å†…å®¹éµå¾ª<b><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/legalcode.zh-hans target=_blank rel=noopener> çŸ¥è¯†å…±äº« ç½²å-éå•†ä¸šæ€§-ç›¸åŒæ–¹å¼å…±äº«4.0å›½é™…åè®®</a></b><br>ä½¿ç”¨ <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> æ„å»º<br>ä¸»é¢˜ <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.25.0>Stack</a></b> ç”± <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> è®¾è®¡</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>