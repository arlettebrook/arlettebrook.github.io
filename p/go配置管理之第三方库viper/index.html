<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="Viper 是一个功能齐全的 Go 应用程序配置库，用来管理配置。"><title>Go配置管理之第三方库viper</title>
<link rel=canonical href=https://arlettebrook.github.io/p/go%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86%E4%B9%8B%E7%AC%AC%E4%B8%89%E6%96%B9%E5%BA%93viper/><link rel=stylesheet href=/scss/style.min.59d76563977ef6a76d0c7df16aa86c7ac37ed8942ba1442046cb6cf3b07439d7.css><meta property='og:title' content="Go配置管理之第三方库viper"><meta property='og:description' content="Viper 是一个功能齐全的 Go 应用程序配置库，用来管理配置。"><meta property='og:url' content='https://arlettebrook.github.io/p/go%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86%E4%B9%8B%E7%AC%AC%E4%B8%89%E6%96%B9%E5%BA%93viper/'><meta property='og:site_name' content="Arlettebrook's blog"><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='Go第三方库'><meta property='article:published_time' content='2024-05-03T18:24:28+08:00'><meta property='article:modified_time' content='2024-05-03T18:24:28+08:00'><meta name=twitter:site content="@arlettebrook"><meta name=twitter:creator content="@arlettebrook"><meta name=twitter:title content="Go配置管理之第三方库viper"><meta name=twitter:description content="Viper 是一个功能齐全的 Go 应用程序配置库，用来管理配置。"><link rel="shortcut icon" href=/img/favicon.ico><script async src="https://www.googletagmanager.com/gtag/js?id=G-9MKLLVPEER"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-9MKLLVPEER")}</script></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><div id=article-toolbar style=position:sticky;top:5px;z-index:1000><a href=/ class=back-home><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-chevron-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="15 6 9 12 15 18"/></svg>
<span>返回</span></a></div><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">目录</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#为什么选择-viper>为什么选择 Viper</a></li><li><a href=#快速使用>快速使用</a><ol><li><a href=#读取键>读取键</a></li><li><a href=#设置键值>设置键值</a></li></ol></li><li><a href=#把配置值读入viper>把配置值读入Viper</a><ol><li><a href=#设置默认配置值>设置默认配置值</a></li><li><a href=#从配置文件读取配置>从配置文件读取配置</a></li><li><a href=#监控并重新读取配置文件>监控并重新读取配置文件</a><ol><li><a href=#监听文件修改>监听文件修改</a></li></ol></li><li><a href=#从-ioreader-读取配置>从 <code>io.Reader</code> 读取配置</a><ol><li><a href=#从ioreader中读取>从<code>io.Reader</code>中读取</a></li></ol></li><li><a href=#从环境变量读取配置>从环境变量读取配置</a><ol><li><a href=#环境变量>环境变量</a></li></ol></li><li><a href=#从命令行参数读取配置>从命令行参数读取配置</a><ol><li><a href=#命令行选项>命令行选项</a></li></ol></li><li><a href=#从远程-keyvalue-存储读取配置>从远程 key/value 存储读取配置</a></li></ol></li><li><a href=#从-viper-中读取配置值>从 Viper 中读取配置值</a><ol><li><a href=#访问嵌套的键>访问嵌套的键</a></li><li><a href=#提取子树>提取子树</a></li><li><a href=#反序列化>反序列化</a><ol><li><a href=#unmarshal><code>Unmarshal</code></a></li></ol></li><li><a href=#序列化>序列化</a><ol><li><a href=#序列化成字符串>序列化成字符串</a></li><li><a href=#写入配置文件>写入配置文件</a></li></ol></li></ol></li><li><a href=#多实例对象>多实例对象</a></li><li><a href=#使用建议>使用建议</a></li><li><a href=#总结>总结</a></li><li><a href=#参考>参考</a></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/go/ style=background-color:#f97300;color:#fff>Go
</a><a href=/categories/%E7%BC%96%E7%A8%8B/ style=background-color:#41b06e;color:#fff>编程</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/go%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86%E4%B9%8B%E7%AC%AC%E4%B8%89%E6%96%B9%E5%BA%93viper/>Go配置管理之第三方库viper</a></h2><h3 class=article-subtitle>Viper 是一个功能齐全的 Go 应用程序配置库，用来管理配置。</h3></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>May 03, 2024</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>阅读时长: 24 分钟</time></div></footer></div></header><section class=article-content><hr><blockquote><p>Viper 是一个功能齐全的 Go 应用程序配置库，支持很多场景。它可以处理各种类型的配置需求和格式，包括设置默认值、从多种配置文件和环境变量中读取配置信息、实时监视配置文件等。无论是小型应用还是大型分布式系统，Viper 都可以提供灵活而可靠的配置管理解决方案。在本文中，我们将深入探讨 Viper 的各种用法和使用场景，以帮助读者更好地了解和使用 Viper 来管理应用程序配置。</p></blockquote><hr><h2 id=为什么选择-viper><a href=#%e4%b8%ba%e4%bb%80%e4%b9%88%e9%80%89%e6%8b%a9-viper class=header-anchor>#</a>
为什么选择 Viper</h2><p>当我们在做技术选型时，肯定要知道为什么选择某一项技术，而之所以选择使用 Viper 来管理应用程序的配置，Viper 官方给出了如下答案：</p><p>当构建应用程序时，你不想担心配置文件格式，只想专注于构建出色的软件。Viper 就是为了帮助我们解决这个问题而存在的。</p><p>Viper 可以完成以下工作：</p><ol><li>查找、加载和反序列化 JSON、TOML、YAML、HCL、INI、envfile 或 Java Properties 等多种格式的配置文件。</li><li>为不同的配置选项设置默认值。</li><li>为通过命令行标志指定的选项设置覆盖值。</li><li>提供别名系统，以便轻松重命名配置项而不破坏现有代码。</li><li>可以轻松区分用户提供的命令行参数或配置文件中的值是否与默认值相同。</li><li>可以设置监听配置文件的修改，修改时自动加载新的配置；</li><li>从环境变量、命令行选项和<code>io.Reader</code>中读取配置；</li><li>从远程配置系统中读取和监听修改，如 etcd/Consul；</li><li>代码逻辑中显示设置键值。</li><li>&mldr;&mldr;</li></ol><blockquote><p>注：关于上面第 5 点，我个人理解的使用场景是：</p><ol><li>先从命令行参数或配置文件中读取配置。</li><li>可以使用 <code>viper.IsSet(key)</code> 方法判断用户是否设置了 <code>key</code> 所对应的 <code>value</code>，如果设置了，可以通过 <code>viper.Get(key)</code> 获取值。</li><li>调用 <code>viper.SetDefault(key, default_value)</code> 来设置默认值（默认值不会覆盖上一步所获取到的值）。
在第 2 步中可以拿到用户设置的值 <code>value</code>，在第 3 步中可以知道默认值 <code>default_value</code>，这样其实就可以判断两者是否相同了。</li></ol></blockquote><p>Viper 采用以下优先级顺序来加载配置，按照优先级由高到低排序如下：</p><ul><li>显式调用 <code>viper.Set</code> 设置的配置值</li><li>命令行参数</li><li>环境变量</li><li>配置文件</li><li>key/value 存储</li><li>默认值</li></ul><blockquote><p>注意 ⚠️：Viper 配置中的键不区分大小写，如 <code>user/User/USER</code> 被视为是相等的 <code>key</code>，关于是否将其设为可选，目前还在讨论中。</p></blockquote><p>Viper 包中最核心的两个功能是：如何把配置值读入 Viper 和从 Viper 中读取配置值，接下来我将分别介绍这两个功能。</p><hr><h2 id=快速使用><a href=#%e5%bf%ab%e9%80%9f%e4%bd%bf%e7%94%a8 class=header-anchor>#</a>
快速使用</h2><p>安装：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>go get -u github.com/spf13/viper
</span></span></code></pre></td></tr></table></div></div><p>导入：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>import</span> <span class=s>&#34;github.com/spf13/viper&#34;</span>
</span></span></code></pre></td></tr></table></div></div><p>使用：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-golang data-lang=golang><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>  <span class=s>&#34;log&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=s>&#34;github.com/spf13/viper&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>viper</span><span class=p>.</span><span class=nf>SetConfigName</span><span class=p>(</span><span class=s>&#34;config&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=nx>viper</span><span class=p>.</span><span class=nf>SetConfigType</span><span class=p>(</span><span class=s>&#34;toml&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=nx>viper</span><span class=p>.</span><span class=nf>AddConfigPath</span><span class=p>(</span><span class=s>&#34;.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=nx>viper</span><span class=p>.</span><span class=nf>SetDefault</span><span class=p>(</span><span class=s>&#34;redis.port&#34;</span><span class=p>,</span> <span class=mi>6381</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=nx>err</span> <span class=o>:=</span> <span class=nx>viper</span><span class=p>.</span><span class=nf>ReadInConfig</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>log</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;read config failed: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>viper</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=s>&#34;app_name&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>  <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>viper</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=s>&#34;log_level&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;mysql ip: &#34;</span><span class=p>,</span> <span class=nx>viper</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=s>&#34;mysql.ip&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>  <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;mysql port: &#34;</span><span class=p>,</span> <span class=nx>viper</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=s>&#34;mysql.port&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>  <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;mysql user: &#34;</span><span class=p>,</span> <span class=nx>viper</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=s>&#34;mysql.user&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>  <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;mysql password: &#34;</span><span class=p>,</span> <span class=nx>viper</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=s>&#34;mysql.password&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>  <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;mysql database: &#34;</span><span class=p>,</span> <span class=nx>viper</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=s>&#34;mysql.database&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;redis ip: &#34;</span><span class=p>,</span> <span class=nx>viper</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=s>&#34;redis.ip&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>  <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;redis port: &#34;</span><span class=p>,</span> <span class=nx>viper</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=s>&#34;redis.port&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>这里的配置文件格式是toml。toml 的语法很简单，快速入门请看<a class=link href=https://toml.io/cn/v1.0.0 target=_blank rel=noopener>TOML:简体中文</a>。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-toml data-lang=toml><span class=line><span class=cl><span class=c># config.toml</span>
</span></span><span class=line><span class=cl><span class=nx>app_name</span> <span class=p>=</span> <span class=s2>&#34;awesome web&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># possible values: DEBUG, INFO, WARNING, ERROR, FATAL</span>
</span></span><span class=line><span class=cl><span class=nx>log_level</span> <span class=p>=</span> <span class=s2>&#34;DEBUG&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=nx>mysql</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nx>ip</span> <span class=p>=</span> <span class=s2>&#34;127.0.0.1&#34;</span>
</span></span><span class=line><span class=cl><span class=nx>port</span> <span class=p>=</span> <span class=mi>3306</span>
</span></span><span class=line><span class=cl><span class=nx>user</span> <span class=p>=</span> <span class=s2>&#34;dj&#34;</span>
</span></span><span class=line><span class=cl><span class=nx>password</span> <span class=p>=</span> <span class=mi>123456</span>
</span></span><span class=line><span class=cl><span class=nx>database</span> <span class=p>=</span> <span class=s2>&#34;awesome&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=nx>redis</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nx>ip</span> <span class=p>=</span> <span class=s2>&#34;127.0.0.1&#34;</span>
</span></span><span class=line><span class=cl><span class=nx>port</span> <span class=p>=</span> <span class=mi>7381</span>
</span></span></code></pre></td></tr></table></div></div><p>viper 的使用非常简单，它需要很少的设置。设置文件名（<code>SetConfigName</code>）、配置类型（<code>SetConfigType</code>）和搜索路径（<code>AddConfigPath</code>），然后调用<code>ReadInConfig</code>。 viper会自动根据类型来读取配置。使用时调用<code>viper.Get</code>方法获取键值。</p><p>编译、运行程序：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ go run main.go 
</span></span><span class=line><span class=cl>awesome web
</span></span><span class=line><span class=cl>DEBUG
</span></span><span class=line><span class=cl>mysql ip:  127.0.0.1
</span></span><span class=line><span class=cl>mysql port:  <span class=m>3306</span>
</span></span><span class=line><span class=cl>mysql user:  dj
</span></span><span class=line><span class=cl>mysql password:  <span class=m>123456</span>
</span></span><span class=line><span class=cl>mysql database:  awesome
</span></span><span class=line><span class=cl>redis ip:  127.0.0.1
</span></span><span class=line><span class=cl>redis port:  <span class=m>7381</span>
</span></span></code></pre></td></tr></table></div></div><p>有几点需要注意：</p><ul><li>设置文件名时不要带后缀；</li><li>搜索路径可以设置多个，viper 会根据设置顺序依次查找；</li><li>viper 获取值时使用<code>section.key</code>的形式，即传入嵌套的键名；</li><li>默认值可以调用<code>viper.SetDefault</code>设置。</li></ul><h3 id=读取键><a href=#%e8%af%bb%e5%8f%96%e9%94%ae class=header-anchor>#</a>
读取键</h3><p>viper 提供了多种形式的读取方法。在上面的例子中，我们看到了<code>Get</code>方法的用法。<code>Get</code>方法返回一个<code>interface{}</code>的值，使用有所不便。</p><p><code>GetType</code>系列方法可以返回指定类型的值。 其中，Type 可以为<code>Bool/Float64/Int/String/Time/Duration/IntSlice/StringSlice</code>。 但是请注意，<strong>如果指定的键不存在或类型不正确，<code>GetType</code>方法返回对应类型的零值</strong>。</p><p>如果要判断某个键是否存在，使用<code>IsSet</code>方法。 另外，<code>GetStringMap</code>和<code>GetStringMapString</code>直接以 map 返回某个键下面所有的键值对，前者返回<code>map[string]interface{}</code>，后者返回<code>map[string]string</code>。 <code>AllSettings</code>以<code>map[string]interface{}</code>返回所有设置。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-golang data-lang=golang><span class=line><span class=cl><span class=c1>// 省略包名和 import 部分
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>viper</span><span class=p>.</span><span class=nf>SetConfigName</span><span class=p>(</span><span class=s>&#34;config&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=nx>viper</span><span class=p>.</span><span class=nf>SetConfigType</span><span class=p>(</span><span class=s>&#34;toml&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=nx>viper</span><span class=p>.</span><span class=nf>AddConfigPath</span><span class=p>(</span><span class=s>&#34;.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=nx>err</span> <span class=o>:=</span> <span class=nx>viper</span><span class=p>.</span><span class=nf>ReadInConfig</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>log</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;read config failed: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;protocols: &#34;</span><span class=p>,</span> <span class=nx>viper</span><span class=p>.</span><span class=nf>GetStringSlice</span><span class=p>(</span><span class=s>&#34;server.protocols&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>  <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;ports: &#34;</span><span class=p>,</span> <span class=nx>viper</span><span class=p>.</span><span class=nf>GetIntSlice</span><span class=p>(</span><span class=s>&#34;server.ports&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>  <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;timeout: &#34;</span><span class=p>,</span> <span class=nx>viper</span><span class=p>.</span><span class=nf>GetDuration</span><span class=p>(</span><span class=s>&#34;server.timeout&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;mysql ip: &#34;</span><span class=p>,</span> <span class=nx>viper</span><span class=p>.</span><span class=nf>GetString</span><span class=p>(</span><span class=s>&#34;mysql.ip&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>  <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;mysql port: &#34;</span><span class=p>,</span> <span class=nx>viper</span><span class=p>.</span><span class=nf>GetInt</span><span class=p>(</span><span class=s>&#34;mysql.port&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=nx>viper</span><span class=p>.</span><span class=nf>IsSet</span><span class=p>(</span><span class=s>&#34;redis.port&#34;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;redis.port is set&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;redis.port is not set&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;mysql settings: &#34;</span><span class=p>,</span> <span class=nx>viper</span><span class=p>.</span><span class=nf>GetStringMap</span><span class=p>(</span><span class=s>&#34;mysql&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>  <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;redis settings: &#34;</span><span class=p>,</span> <span class=nx>viper</span><span class=p>.</span><span class=nf>GetStringMap</span><span class=p>(</span><span class=s>&#34;redis&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>  <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;all settings: &#34;</span><span class=p>,</span> <span class=nx>viper</span><span class=p>.</span><span class=nf>AllSettings</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>我们在配置文件 config.toml 中添加<code>protocols</code>和<code>ports</code>配置：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-toml data-lang=toml><span class=line><span class=cl><span class=p>[</span><span class=nx>server</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nx>protocols</span> <span class=p>=</span> <span class=p>[</span><span class=s2>&#34;http&#34;</span><span class=p>,</span> <span class=s2>&#34;https&#34;</span><span class=p>,</span> <span class=s2>&#34;port&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nx>ports</span> <span class=p>=</span> <span class=p>[</span><span class=mi>10000</span><span class=p>,</span> <span class=mi>10001</span><span class=p>,</span> <span class=mi>10002</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nx>timeout</span> <span class=p>=</span> <span class=s2>&#34;3s&#34;</span>
</span></span></code></pre></td></tr></table></div></div><p>编译、运行程序，输出：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ go run main.go 
</span></span><span class=line><span class=cl>protocols:  <span class=o>[</span>http https port<span class=o>]</span>
</span></span><span class=line><span class=cl>ports:  <span class=o>[</span><span class=m>10000</span> <span class=m>10001</span> 10002<span class=o>]</span>
</span></span><span class=line><span class=cl>timeout:  3s
</span></span><span class=line><span class=cl>mysql ip:  127.0.0.1
</span></span><span class=line><span class=cl>mysql port:  <span class=m>3306</span>
</span></span><span class=line><span class=cl>redis.port is <span class=nb>set</span>
</span></span><span class=line><span class=cl>mysql settings:  map<span class=o>[</span>database:awesome ip:127.0.0.1 password:123456 port:3306 user:dj<span class=o>]</span>
</span></span><span class=line><span class=cl>redis settings:  map<span class=o>[</span>ip:127.0.0.1 port:7381<span class=o>]</span>
</span></span><span class=line><span class=cl>all settings:  map<span class=o>[</span>app_name:awesome web log_level:DEBUG mysql:map<span class=o>[</span>database:awesome ip:127.0.0.1 pa
</span></span><span class=line><span class=cl>ssword:123456 port:3306 user:dj<span class=o>]</span> redis:map<span class=o>[</span>ip:127.0.0.1 port:7381<span class=o>]</span> server:map<span class=o>[</span>ports:<span class=o>[</span><span class=m>10000</span> <span class=m>10001</span> <span class=m>1</span>
</span></span><span class=line><span class=cl>0002<span class=o>]</span> protocols:<span class=o>[</span>http https port<span class=o>]</span> timeout:3s<span class=o>]]</span>
</span></span></code></pre></td></tr></table></div></div><p>如果将配置中的<code>redis.port</code>注释掉，将输出<code>redis.port is not set</code>。</p><p>上面的示例中还演示了如何使用<code>time.Duration</code>类型，只要是<code>time.ParseDuration</code>接受的格式都可以，例如<code>3s</code>、<code>2min</code>、<code>1min30s</code>等。</p><h3 id=设置键值><a href=#%e8%ae%be%e7%bd%ae%e9%94%ae%e5%80%bc class=header-anchor>#</a>
设置键值</h3><p>viper 支持在多个地方设置，使用下面的顺序依次读取：</p><ul><li>调用<code>Set</code>显示设置的；</li><li>命令行选项；</li><li>环境变量；</li><li>配置文件；</li><li>默认值。</li></ul><p><strong><code>viper.Set</code></strong></p><p>如果某个键通过<code>viper.Set</code>设置了值，那么这个值的优先级最高。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-golang data-lang=golang><span class=line><span class=cl><span class=nx>viper</span><span class=p>.</span><span class=nf>Set</span><span class=p>(</span><span class=s>&#34;redis.port&#34;</span><span class=p>,</span> <span class=mi>5381</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>如果将上面这行代码放到程序中，运行程序，输出的<code>redis.port</code>将是 5381。</p><p><strong><code>viper.SetDefault</code></strong></p><p>设置默认值，如果没有配置键，将使用默认值</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>viper.SetDefault<span class=o>(</span><span class=s2>&#34;log_level&#34;</span>, <span class=s2>&#34;INFO&#34;</span><span class=o>)</span>
</span></span></code></pre></td></tr></table></div></div><p>如果配置文件中没有配置<code>log_level</code>,那么将使用INFO</p><hr><h2 id=把配置值读入viper><a href=#%e6%8a%8a%e9%85%8d%e7%bd%ae%e5%80%bc%e8%af%bb%e5%85%a5viper class=header-anchor>#</a>
把配置值读入Viper</h2><p>Viper 支持多种方式读入配置：</p><ul><li>设置默认配置值</li><li>从配置文件读取配置</li><li>监控并重新读取配置文件</li><li>从 <code>io.Reader</code> 读取配置</li><li>从环境变量读取配置</li><li>从命令行参数读取配置</li><li>从远程 key/value 存储读取配置</li></ul><p>我们一个一个来看。</p><h3 id=设置默认配置值><a href=#%e8%ae%be%e7%bd%ae%e9%bb%98%e8%ae%a4%e9%85%8d%e7%bd%ae%e5%80%bc class=header-anchor>#</a>
设置默认配置值</h3><p>一个好的配置系统应该支持默认值。Viper 支持使用 <code>viper.SetDefault(key, value)</code> 为 <code>key</code> 设置默认值 <code>value</code>，在没有通过配置文件、环境变量、远程配置或命令行标志设置 <code>key</code> 所对应值的情况下，这很有用。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=s>&#34;github.com/spf13/viper&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 设置默认配置
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>viper</span><span class=p>.</span><span class=nf>SetDefault</span><span class=p>(</span><span class=s>&#34;username&#34;</span><span class=p>,</span> <span class=s>&#34;arlettebrook&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>viper</span><span class=p>.</span><span class=nf>SetDefault</span><span class=p>(</span><span class=s>&#34;server&#34;</span><span class=p>,</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kt>string</span><span class=p>{</span><span class=s>&#34;ip&#34;</span><span class=p>:</span> <span class=s>&#34;127.0.0.1&#34;</span><span class=p>,</span> <span class=s>&#34;port&#34;</span><span class=p>:</span> <span class=s>&#34;8080&#34;</span><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 读取配置值
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;username: %s\n&#34;</span><span class=p>,</span> <span class=nx>viper</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=s>&#34;Username&#34;</span><span class=p>))</span> <span class=c1>// key 不区分大小写
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;server: %+v\n&#34;</span><span class=p>,</span> <span class=nx>viper</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=s>&#34;server&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>执行以上示例代码得到如下输出：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ go run main.go 
</span></span><span class=line><span class=cl>username: arlettebrook
</span></span><span class=line><span class=cl>server: map<span class=o>[</span>ip:127.0.0.1 port:8080<span class=o>]</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=从配置文件读取配置><a href=#%e4%bb%8e%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6%e8%af%bb%e5%8f%96%e9%85%8d%e7%bd%ae class=header-anchor>#</a>
从配置文件读取配置</h3><p>Viper 支持从 JSON、TOML、YAML、HCL、INI、envfile 或 Java Properties 格式的配置文件中读取配置。Viper 可以搜索多个路径，但目前单个 Viper 实例只支持单个配置文件。<strong>Viper 不会默认配置任何搜索路径，将默认决定留给应用程序</strong>。</p><p>主要有两种方式来加载配置文件：</p><ul><li>通过 <code>viper.SetConfigFile()</code> 指定配置文件，显式定义配置文件的路径、名称和扩展名。 Viper将使用它并且不检查任何配置路径。</li><li>通过 <code>viper.SetConfigName()</code> 指定不带扩展名的配置文件，<code>viper.SetConfigType()</code>指定配置文件类型类型。然后通过 <code>viper.AddConfigPath()</code> 指定配置文件的搜索路径中，可以通过多次调用，来设置多个配置文件搜索路径。Viper 会根据所添加的路径顺序查找指定配置文件，如果找到就停止查找。</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;errors&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;flag&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;log&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=s>&#34;github.com/spf13/viper&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>cfg</span> <span class=p>=</span> <span class=nx>flag</span><span class=p>.</span><span class=nf>String</span><span class=p>(</span><span class=s>&#34;c&#34;</span><span class=p>,</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=s>&#34;config file.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>flag</span><span class=p>.</span><span class=nf>Parse</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>*</span><span class=nx>cfg</span> <span class=o>!=</span> <span class=s>&#34;&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>       <span class=nx>viper</span><span class=p>.</span><span class=nf>SetConfigFile</span><span class=p>(</span><span class=o>*</span><span class=nx>cfg</span><span class=p>)</span> <span class=c1>// 指定配置文件（路径 + 配置文件名）
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>       <span class=nx>viper</span><span class=p>.</span><span class=nf>AddConfigPath</span><span class=p>(</span><span class=s>&#34;.&#34;</span><span class=p>)</span>             <span class=c1>// 把当前目录加入到配置文件的搜索路径中
</span></span></span><span class=line><span class=cl><span class=c1></span>       <span class=nx>viper</span><span class=p>.</span><span class=nf>AddConfigPath</span><span class=p>(</span><span class=s>&#34;$HOME/.config&#34;</span><span class=p>)</span> <span class=c1>// 可以多次调用 AddConfigPath 来设置多个配置文件搜索路径
</span></span></span><span class=line><span class=cl><span class=c1></span>       <span class=nx>viper</span><span class=p>.</span><span class=nf>SetConfigName</span><span class=p>(</span><span class=s>&#34;config&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>       <span class=nx>viper</span><span class=p>.</span><span class=nf>SetConfigType</span><span class=p>(</span><span class=s>&#34;toml&#34;</span><span class=p>)</span> <span class=c1>// 如果配置文件名中没有扩展名，则需要显式指定配置文件的格式// 指定配置文件名（没有扩展名）
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 读取配置文件
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>viper</span><span class=p>.</span><span class=nf>ReadInConfig</span><span class=p>();</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>       <span class=kd>var</span> <span class=nx>configFileNotFoundError</span> <span class=nx>viper</span><span class=p>.</span><span class=nx>ConfigFileNotFoundError</span>
</span></span><span class=line><span class=cl>       <span class=k>if</span> <span class=nx>errors</span><span class=p>.</span><span class=nf>As</span><span class=p>(</span><span class=nx>err</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>configFileNotFoundError</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>log</span><span class=p>.</span><span class=nf>Fatalln</span><span class=p>(</span><span class=nx>configFileNotFoundError</span><span class=p>.</span><span class=nf>Error</span><span class=p>())</span>
</span></span><span class=line><span class=cl>       <span class=p>}</span>
</span></span><span class=line><span class=cl>       <span class=nx>log</span><span class=p>.</span><span class=nf>Fatalln</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;using config file: %s\n&#34;</span><span class=p>,</span> <span class=nx>viper</span><span class=p>.</span><span class=nf>ConfigFileUsed</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 读取配置值
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;username: %s\n&#34;</span><span class=p>,</span> <span class=nx>viper</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=s>&#34;username&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p><code>viper.ConfigFileUsed()</code>返回使用的配置文件的路径</p><p>假如有如下配置文件 <code>config.yaml</code> 与示例程序在同一目录中：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># config.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>username</span><span class=p>:</span><span class=w> </span><span class=l>arlettebrook</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>password</span><span class=p>:</span><span class=w> </span><span class=m>123456</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>server</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ip</span><span class=p>:</span><span class=w> </span><span class=m>127.0.0.1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>8080</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>执行以上示例代码得到如下输出：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ go run main.go -c ./config.yaml
</span></span><span class=line><span class=cl>using config file: ./config.yaml
</span></span><span class=line><span class=cl>username: arlettebrook
</span></span></code></pre></td></tr></table></div></div><h3 id=监控并重新读取配置文件><a href=#%e7%9b%91%e6%8e%a7%e5%b9%b6%e9%87%8d%e6%96%b0%e8%af%bb%e5%8f%96%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6 class=header-anchor>#</a>
监控并重新读取配置文件</h3><p>Viper 支持在应用程序运行过程中实时读取配置文件，即热加载配置。</p><p>只需要调用 <code>viper.WatchConfig()</code> 即可开启此功能。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;log&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;time&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=s>&#34;github.com/fsnotify/fsnotify&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=s>&#34;github.com/spf13/viper&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>viper</span><span class=p>.</span><span class=nf>SetConfigFile</span><span class=p>(</span><span class=s>&#34;./config.yaml&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 注册每次配置文件发生变更后都会调用的回调函数
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>viper</span><span class=p>.</span><span class=nf>OnConfigChange</span><span class=p>(</span><span class=kd>func</span><span class=p>(</span><span class=nx>e</span> <span class=nx>fsnotify</span><span class=p>.</span><span class=nx>Event</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;config file changed: %s username:%s\n&#34;</span><span class=p>,</span> <span class=nx>e</span><span class=p>.</span><span class=nx>Name</span><span class=p>,</span> <span class=nx>viper</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=s>&#34;username&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 监控并重新读取配置文件，需要确保在调用前添加了所有的配置路径
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>viper</span><span class=p>.</span><span class=nf>WatchConfig</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>err</span> <span class=o>:=</span> <span class=nx>viper</span><span class=p>.</span><span class=nf>ReadInConfig</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>log</span><span class=p>.</span><span class=nf>Fatalln</span><span class=p>(</span><span class=s>&#34;加载配置文件错误:&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 读取配置值
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;未修改的username: %s\n&#34;</span><span class=p>,</span> <span class=nx>viper</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=s>&#34;username&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 阻塞程序，这个过程中可以手动去修改配置文件内容，观察程序输出变化,注意要保存。
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>time</span><span class=p>.</span><span class=nf>Sleep</span><span class=p>(</span><span class=nx>time</span><span class=p>.</span><span class=nx>Second</span> <span class=o>*</span> <span class=mi>10</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 读取配置值
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;最终的username: %s\n&#34;</span><span class=p>,</span> <span class=nx>viper</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=s>&#34;username&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>值得注意的是，在调用 <code>viper.WatchConfig()</code> 监控并重新读取配置文件之前，需要确保添加了所有的配置搜索路径。</p><p>并且，我们还可以通过 <code>viper.OnConfigChange()</code> 函数注册一个每次配置文件发生变更后都会调用的回调函数。</p><p>我们依然使用上面的 <code>config.yaml</code> 配置文件：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>username</span><span class=p>:</span><span class=w> </span><span class=l>arlettebrook</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>password</span><span class=p>:</span><span class=w> </span><span class=m>123456</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>server</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ip</span><span class=p>:</span><span class=w> </span><span class=m>127.0.0.1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>8080</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>执行以上示例代码，并在程序阻塞的时候，手动修改配置文件中 <code>username</code> 后面分别追加1保存、2保存3保存，可以得到如下输出：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ go run main.go
</span></span><span class=line><span class=cl>未修改的username: arlettebrook
</span></span><span class=line><span class=cl>config file changed: config.yaml username:arlettebrook1
</span></span><span class=line><span class=cl>config file changed: config.yaml username:arlettebrook1
</span></span><span class=line><span class=cl>config file changed: config.yaml username:arlettebrook12
</span></span><span class=line><span class=cl>config file changed: config.yaml username:arlettebrook12
</span></span><span class=line><span class=cl>config file changed: config.yaml username:arlettebrook123
</span></span><span class=line><span class=cl>config file changed: config.yaml username:arlettebrook123
</span></span><span class=line><span class=cl>最终的username: arlettebrook123
</span></span></code></pre></td></tr></table></div></div><p>我这里修改一次回调函数不知道为什么执行了俩次，不过没有影响。</p><h4 id=监听文件修改><a href=#%e7%9b%91%e5%90%ac%e6%96%87%e4%bb%b6%e4%bf%ae%e6%94%b9 class=header-anchor>#</a>
监听文件修改</h4><p>viper 可以监听文件修改，热加载配置。因此不需要重启服务器，就能让配置生效。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;log&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;time&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=s>&#34;github.com/spf13/viper&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>viper</span><span class=p>.</span><span class=nf>SetConfigName</span><span class=p>(</span><span class=s>&#34;config&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>viper</span><span class=p>.</span><span class=nf>SetConfigType</span><span class=p>(</span><span class=s>&#34;toml&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>viper</span><span class=p>.</span><span class=nf>AddConfigPath</span><span class=p>(</span><span class=s>&#34;.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>err</span> <span class=o>:=</span> <span class=nx>viper</span><span class=p>.</span><span class=nf>ReadInConfig</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>       <span class=nx>log</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;read config failed: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>viper</span><span class=p>.</span><span class=nf>WatchConfig</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;redis port before sleep: &#34;</span><span class=p>,</span> <span class=nx>viper</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=s>&#34;redis.port&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=nx>time</span><span class=p>.</span><span class=nf>Sleep</span><span class=p>(</span><span class=nx>time</span><span class=p>.</span><span class=nx>Second</span> <span class=o>*</span> <span class=mi>10</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;redis port after sleep: &#34;</span><span class=p>,</span> <span class=nx>viper</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=s>&#34;redis.port&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>只需要调用<code>viper.WatchConfig</code>，viper 会自动监听配置修改。如果有修改，重新加载的配置。</p><p>上面程序中，我们先打印<code>redis.port</code>的值，然后<code>Sleep</code> 10s。在这期间修改配置中<code>redis.port</code>的值，<code>Sleep</code>结束后再次打印。 发现打印出修改后的值：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>redis port before sleep:  <span class=m>7381</span>
</span></span><span class=line><span class=cl>redis port after sleep:  <span class=m>73810</span>
</span></span></code></pre></td></tr></table></div></div><p>另外，还可以为配置修改增加一个回调：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-golang data-lang=golang><span class=line><span class=cl><span class=nx>viper</span><span class=p>.</span><span class=nf>OnConfigChange</span><span class=p>(</span><span class=kd>func</span><span class=p>(</span><span class=nx>e</span> <span class=nx>fsnotify</span><span class=p>.</span><span class=nx>Event</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Config file:%s Op:%s\n&#34;</span><span class=p>,</span> <span class=nx>e</span><span class=p>.</span><span class=nx>Name</span><span class=p>,</span> <span class=nx>e</span><span class=p>.</span><span class=nx>Op</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span></code></pre></td></tr></table></div></div><p>这样文件修改时会执行这个回调。</p><p>viper 使用<a class=link href=https://github.com/fsnotify/fsnotify target=_blank rel=noopener>fsnotify</a>这个库来实现监听文件修改的功能。</p><h3 id=从-ioreader-读取配置><a href=#%e4%bb%8e-ioreader-%e8%af%bb%e5%8f%96%e9%85%8d%e7%bd%ae class=header-anchor>#</a>
从 <code>io.Reader</code> 读取配置</h3><p>Viper 支持从任何实现了 <code>io.Reader</code> 接口的配置源中读取配置。注意需要指定配置文件的类型，才能识别<code>io.Reader</code>。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;bytes&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;log&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=s>&#34;github.com/spf13/viper&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>viper</span><span class=p>.</span><span class=nf>SetConfigType</span><span class=p>(</span><span class=s>&#34;yaml&#34;</span><span class=p>)</span> <span class=c1>// 或者使用 viper.SetConfigType(&#34;YAML&#34;)
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>yamlExample</span> <span class=p>=</span> <span class=p>[]</span><span class=nb>byte</span><span class=p>(</span><span class=s>`
</span></span></span><span class=line><span class=cl><span class=s>username: arlettebrook
</span></span></span><span class=line><span class=cl><span class=s>password: 123456
</span></span></span><span class=line><span class=cl><span class=s>server:
</span></span></span><span class=line><span class=cl><span class=s>  ip: 127.0.0.1
</span></span></span><span class=line><span class=cl><span class=s>  port: 8080
</span></span></span><span class=line><span class=cl><span class=s>`</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>err</span> <span class=o>:=</span> <span class=nx>viper</span><span class=p>.</span><span class=nf>ReadConfig</span><span class=p>(</span><span class=nx>bytes</span><span class=p>.</span><span class=nf>NewBuffer</span><span class=p>(</span><span class=nx>yamlExample</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>       <span class=nx>log</span><span class=p>.</span><span class=nf>Fatalln</span><span class=p>(</span><span class=s>&#34;读取配置文件错误：&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 读取配置值
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;username: %s\n&#34;</span><span class=p>,</span> <span class=nx>viper</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=s>&#34;username&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>这里我们通过 <code>bytes.NewBuffer()</code> 构造了一个 <code>bytes.Buffer</code> 对象，它实现了 <code>io.Reader</code> 接口，所以可以直接传递给 <code>viper.ReadConfig()</code> 来从中读取配置。</p><p>执行以上示例代码得到如下输出：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ go run main.go
</span></span><span class=line><span class=cl>username: arlettebrook
</span></span></code></pre></td></tr></table></div></div><h4 id=从ioreader中读取><a href=#%e4%bb%8eioreader%e4%b8%ad%e8%af%bb%e5%8f%96 class=header-anchor>#</a>
从<code>io.Reader</code>中读取</h4><p>viper 支持从<code>io.Reader</code>中读取配置。这种形式很灵活，来源可以是文件，也可以是程序中生成的字符串，甚至可以从网络连接中读取的字节流。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;bytes&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;log&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=s>&#34;github.com/spf13/viper&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>viper</span><span class=p>.</span><span class=nf>SetConfigType</span><span class=p>(</span><span class=s>&#34;toml&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>tomlConfig</span> <span class=o>:=</span> <span class=p>[]</span><span class=nb>byte</span><span class=p>(</span><span class=s>`
</span></span></span><span class=line><span class=cl><span class=s>app_name = &#34;awesome web&#34;
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># possible values: DEBUG, INFO, WARNING, ERROR, FATAL
</span></span></span><span class=line><span class=cl><span class=s>log_level = &#34;DEBUG&#34;
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>[mysql]
</span></span></span><span class=line><span class=cl><span class=s>ip = &#34;127.0.0.1&#34;
</span></span></span><span class=line><span class=cl><span class=s>port = 3306
</span></span></span><span class=line><span class=cl><span class=s>user = &#34;dj&#34;
</span></span></span><span class=line><span class=cl><span class=s>password = 123456
</span></span></span><span class=line><span class=cl><span class=s>database = &#34;awesome&#34;
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>[redis]
</span></span></span><span class=line><span class=cl><span class=s>ip = &#34;127.0.0.1&#34;
</span></span></span><span class=line><span class=cl><span class=s>port = 7381
</span></span></span><span class=line><span class=cl><span class=s>`</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>err</span> <span class=o>:=</span> <span class=nx>viper</span><span class=p>.</span><span class=nf>ReadConfig</span><span class=p>(</span><span class=nx>bytes</span><span class=p>.</span><span class=nf>NewBuffer</span><span class=p>(</span><span class=nx>tomlConfig</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>       <span class=nx>log</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;read config failed: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;redis port: &#34;</span><span class=p>,</span> <span class=nx>viper</span><span class=p>.</span><span class=nf>GetInt</span><span class=p>(</span><span class=s>&#34;redis.port&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=从环境变量读取配置><a href=#%e4%bb%8e%e7%8e%af%e5%a2%83%e5%8f%98%e9%87%8f%e8%af%bb%e5%8f%96%e9%85%8d%e7%bd%ae class=header-anchor>#</a>
从环境变量读取配置</h3><p>Viper 还支持从环境变量读取配置，有 5 个方法可以帮助我们使用环境变量:</p><ul><li><p><code>AutomaticEnv()</code>：使Viper检查环境变量是否与任何现有键（配置、默认值或标志）匹配。如果找到匹配的环境变量，它们将被加载到Viper中。</p><ul><li>开启自动匹配（根据前缀匹配）环境变量，加载到Viper中。如何没有前缀将加载所有环境变量。</li></ul></li><li><p><code>BindEnv(string...) : error</code>：绑定一个环境变量。需要一个或两个参数，第一个参数是配置项的键名（不区分大小写），第二个参数是环境变量的名称。如果未提供第二个参数，则 Viper 将假定环境变量名为：<code>环境变量前缀_键名</code>，且为全大写形式。例如环境变量前缀为 <code>ENV</code>，键名为 <code>username</code>，则环境变量名为 <code>ENV_USERNAME</code>。当显式提供第二个参数时，它不会自动添加前缀，也不会自动将其转换为大写。例如，使用 <code>viper.BindEnv("username", "username")</code> 绑定键名为 <code>username</code> 的环境变量，应该使用 <code>viper.Get("username")</code> 读取环境变量的值。</p><p>在使用环境变量时，需要注意，每次访问它的值时都会去环境变量中读取。当调用 <code>BindEnv</code> 时，Viper 不会固定它的值。</p></li><li><p><code>SetEnvPrefix(string)</code>：可以告诉 Viper 在读取环境变量时使用的前缀。<code>BindEnv</code> 和 <code>AutomaticEnv</code> 都将使用此前缀。例如，使用 <code>viper.SetEnvPrefix("ENV")</code> 设置了前缀为 <code>ENV</code>，并且使用 <code>viper.BindEnv("username")</code> 绑定了环境变量，在使用 <code>viper.Get("username")</code> 读取环境变量时，实际读取的 <code>key</code> 是 <code>ENV_USERNAME</code>。</p></li><li><p><code>SetEnvKeyReplacer(string...) *strings.Replacer</code>：允许使用 <code>strings.Replacer</code> 对象在一定程度上重写环境变量的键名。例如，存在 <code>SERVER_IP="127.0.0.1"</code> 环境变量，使用 <code>viper.SetEnvKeyReplacer(strings.NewReplacer(".", "_", "-", "_"))</code> 将键名中的 <code>.</code> 或 <code>-</code> 替换成 <code>_</code>，则通过 <code>viper.Get("server_ip")</code>、<code>viper.Get("server.ip")</code>、<code>viper.Get("server-ip")</code> 三种方式都可以读取环境变量对应的值。</p></li><li><p><code>AllowEmptyEnv(bool)</code>：当环境变量为空时（有键名而没有值的情况），默认会被认为是未设置的，并且程序将回退到下一个配置来源。要将空环境变量视为已设置，可以使用此方法。</p></li><li><p><code>viper.AllSettings()</code>读取全部配置，只能获取到通过 BindEnv 绑定的环境变量，无法获取到通过 AutomaticEnv 绑定的环境变量</p></li></ul><blockquote><p>注意 ⚠️：</p><ol><li>Viper 在读取环境变量时，是不区分大小写的。如果指定的环境变量与绑定的大小写不一致，viper会自动大小写转换。</li><li>以下代码是在windows下的bash终端中运行的。</li></ol></blockquote><p>使用示例：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;strings&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=s>&#34;github.com/spf13/viper&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>viper</span><span class=p>.</span><span class=nf>SetEnvPrefix</span><span class=p>(</span><span class=s>&#34;env&#34;</span><span class=p>)</span> <span class=c1>// 设置读取环境变量前缀，会自动转为大写 ENV
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>viper</span><span class=p>.</span><span class=nf>AllowEmptyEnv</span><span class=p>(</span><span class=kc>true</span><span class=p>)</span> <span class=c1>// 将空环境变量视为已设置
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=nx>viper</span><span class=p>.</span><span class=nf>AutomaticEnv</span><span class=p>()</span>          <span class=c1>// 开启自动匹配（根据前缀匹配）环境变量，加载到Viper中
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>_</span> <span class=p>=</span> <span class=nx>viper</span><span class=p>.</span><span class=nf>BindEnv</span><span class=p>(</span><span class=s>&#34;username&#34;</span><span class=p>)</span> <span class=c1>// 也可以单独绑定某一个环境变量
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>_</span> <span class=p>=</span> <span class=nx>viper</span><span class=p>.</span><span class=nf>BindEnv</span><span class=p>(</span><span class=s>&#34;password&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 将键名中的 . 或 - 替换成 _
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>viper</span><span class=p>.</span><span class=nf>SetEnvKeyReplacer</span><span class=p>(</span><span class=nx>strings</span><span class=p>.</span><span class=nf>NewReplacer</span><span class=p>(</span><span class=s>&#34;.&#34;</span><span class=p>,</span> <span class=s>&#34;_&#34;</span><span class=p>,</span> <span class=s>&#34;-&#34;</span><span class=p>,</span> <span class=s>&#34;_&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 读取配置
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;username: %v\n&#34;</span><span class=p>,</span> <span class=nx>viper</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=s>&#34;USERNAME&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;password: %v\n&#34;</span><span class=p>,</span> <span class=nx>viper</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=s>&#34;password&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;server.ip: %v\n&#34;</span><span class=p>,</span> <span class=nx>viper</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=s>&#34;server.ip&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=c1>// fmt.Printf(&#34;GOPATH:%v\n&#34;,viper.Get(&#34;gopath&#34;)) // 请注释到前缀在取消注释运行
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=c1>// 读取全部配置，只能获取到通过 BindEnv 绑定的环境变量，无法获取到通过 AutomaticEnv 绑定的环境变量
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>viper</span><span class=p>.</span><span class=nf>AllSettings</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>执行以上示例代码得到如下输出：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=err>$</span> <span class=nx>ENV_USERNAME</span><span class=p>=</span><span class=nx>arlettebrook</span> <span class=nx>ENV_SERVER_IP</span><span class=p>=</span><span class=mf>127.0.0.1</span> <span class=nx>ENV_PASSWORD</span><span class=p>=</span> <span class=k>go</span> <span class=nx>run</span> <span class=nx>main</span><span class=p>.</span><span class=k>go</span>
</span></span><span class=line><span class=cl><span class=nx>username</span><span class=p>:</span> <span class=nx>arlettebrook</span>
</span></span><span class=line><span class=cl><span class=nx>password</span><span class=p>:</span> 
</span></span><span class=line><span class=cl><span class=nx>server</span><span class=p>.</span><span class=nx>ip</span><span class=p>:</span> <span class=mf>127.0.0.1</span>
</span></span><span class=line><span class=cl><span class=kd>map</span><span class=p>[</span><span class=nx>password</span><span class=p>:</span> <span class=nx>username</span><span class=p>:</span><span class=nx>arlettebrook</span><span class=p>]</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=环境变量><a href=#%e7%8e%af%e5%a2%83%e5%8f%98%e9%87%8f class=header-anchor>#</a>
环境变量</h4><p>如果从命令行参数都没有获取到键值，将尝试从环境变量中读取。我们既可以一个个绑定，也可以自动全部绑定。</p><p>在<code>init</code>方法中调用<code>AutomaticEnv</code>方法绑定全部环境变量：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-golang data-lang=golang><span class=line><span class=cl><span class=kd>func</span> <span class=nf>init</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 绑定环境变量
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>viper</span><span class=p>.</span><span class=nf>AutomaticEnv</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>为了验证是否绑定成功，我们在<code>main</code>方法中将环境变量 GOPATH 打印出来：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=s>&#34;github.com/spf13/viper&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>init</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 绑定环境变量
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>viper</span><span class=p>.</span><span class=nf>AutomaticEnv</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;GOPATH:&#34;</span><span class=p>,</span> <span class=nx>viper</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=s>&#34;gopath&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;JAVA_HOME:&#34;</span><span class=p>,</span> <span class=nx>viper</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=s>&#34;java_home&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>其他环境变量也是一样的，上面输出：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ go run main.go
</span></span><span class=line><span class=cl>GOPATH: D:<span class=se>\G</span>oSettings<span class=se>\G</span>oPath
</span></span><span class=line><span class=cl>JAVA_HOME: E:<span class=se>\J</span>ava<span class=se>\j</span>dk-17.0.5
</span></span></code></pre></td></tr></table></div></div><p>也可以单独绑定环境变量：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=s>&#34;github.com/spf13/viper&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>init</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 绑定环境变量
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>_</span> <span class=p>=</span> <span class=nx>viper</span><span class=p>.</span><span class=nf>BindEnv</span><span class=p>(</span><span class=s>&#34;redis.port&#34;</span><span class=p>,</span> <span class=s>&#34;redis_port&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>_</span> <span class=p>=</span> <span class=nx>viper</span><span class=p>.</span><span class=nf>BindEnv</span><span class=p>(</span><span class=s>&#34;username&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;redis port:&#34;</span><span class=p>,</span> <span class=nx>viper</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=s>&#34;redis.port&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;username:&#34;</span><span class=p>,</span> <span class=nx>viper</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=s>&#34;username&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>调用<code>BindEnv</code>方法，如果只传入一个参数，则这个参数既表示键名，又表示环境变量名。 如果传入两个参数，则第一个参数表示键名，第二个参数表示环境变量名。</p><p>上面将运行将输出：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ <span class=nv>username</span><span class=o>=</span>arlettebrook <span class=nv>REDIS_PORT</span><span class=o>=</span><span class=m>10809</span> go run main.go 
</span></span><span class=line><span class=cl>redis port: <span class=m>10809</span>
</span></span><span class=line><span class=cl>username: arlettebrook
</span></span></code></pre></td></tr></table></div></div><p>如果对应的环境变量不存在，viper 会自动将键名全部大小写转换再查找一次。所以，使用键名<code>REDIS_PORT</code>也能读取环境变量<code>redis.port</code>的值。</p><p>另外，嵌套的配置键，绑定环境变量时必须指定环境变量名，因为 Viper 不会自动将点转换为下划线或其他分隔符。</p><p>但可以设置环境变量名的替换符，就可以不用知道第二个参数</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// 将键名中的 . 或 - 替换成 _
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>viper</span><span class=p>.</span><span class=nf>SetEnvKeyReplacer</span><span class=p>(</span><span class=nx>strings</span><span class=p>.</span><span class=nf>NewReplacer</span><span class=p>(</span><span class=s>&#34;.&#34;</span><span class=p>,</span> <span class=s>&#34;_&#34;</span><span class=p>,</span> <span class=s>&#34;-&#34;</span><span class=p>,</span> <span class=s>&#34;_&#34;</span><span class=p>))</span>
</span></span></code></pre></td></tr></table></div></div><p>完整代码如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;strings&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=s>&#34;github.com/spf13/viper&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>init</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 绑定环境变量
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>_</span> <span class=p>=</span> <span class=nx>viper</span><span class=p>.</span><span class=nf>BindEnv</span><span class=p>(</span><span class=s>&#34;redis.port&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>_</span> <span class=p>=</span> <span class=nx>viper</span><span class=p>.</span><span class=nf>BindEnv</span><span class=p>(</span><span class=s>&#34;username-a&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>viper</span><span class=p>.</span><span class=nf>SetEnvKeyReplacer</span><span class=p>(</span><span class=nx>strings</span><span class=p>.</span><span class=nf>NewReplacer</span><span class=p>(</span><span class=s>&#34;.&#34;</span><span class=p>,</span> <span class=s>&#34;_&#34;</span><span class=p>,</span> <span class=s>&#34;-&#34;</span><span class=p>,</span> <span class=s>&#34;_&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;redis port:&#34;</span><span class=p>,</span> <span class=nx>viper</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=s>&#34;redis.port&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;username-a:&#34;</span><span class=p>,</span> <span class=nx>viper</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=s>&#34;username-a&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>演示输出：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ <span class=nv>username_A</span><span class=o>=</span>arlettebrook <span class=nv>REDIS_PORT</span><span class=o>=</span><span class=m>10809</span> go run main.go 
</span></span><span class=line><span class=cl>redis port: <span class=m>10809</span>
</span></span><span class=line><span class=cl>username-a: arlettebrook
</span></span></code></pre></td></tr></table></div></div><h3 id=从命令行参数读取配置><a href=#%e4%bb%8e%e5%91%bd%e4%bb%a4%e8%a1%8c%e5%8f%82%e6%95%b0%e8%af%bb%e5%8f%96%e9%85%8d%e7%bd%ae class=header-anchor>#</a>
从命令行参数读取配置</h3><p>Viper 支持 <a class=link href=https://github.com/spf13/pflag target=_blank rel=noopener>pflag</a> 包（它们其实都在 <a class=link href=https://github.com/spf13 target=_blank rel=noopener>spf13</a> 仓库下），能够绑定命令行标志，从而读取命令行参数。</p><p>同 <code>BindEnv</code> 类似，在调用绑定方法时，不会设置值，而是在每次访问时设置。这意味着我们可以随时绑定它，例如可以在 <code>init()</code> 函数中。</p><ul><li><code>BindPFlag</code>：对于单个标志，可以调用此方法进行绑定。</li><li><code>BindPFlags</code>：可以绑定一组现有的标志集 <code>pflag.FlagSet</code>。</li></ul><p>示例程序如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=s>&#34;github.com/spf13/pflag&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;github.com/spf13/viper&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>_</span> <span class=p>=</span> <span class=nx>pflag</span><span class=p>.</span><span class=nf>StringP</span><span class=p>(</span><span class=s>&#34;username&#34;</span><span class=p>,</span> <span class=s>&#34;u&#34;</span><span class=p>,</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=s>&#34;help message for username&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>_</span> <span class=p>=</span> <span class=nx>pflag</span><span class=p>.</span><span class=nf>StringP</span><span class=p>(</span><span class=s>&#34;password&#34;</span><span class=p>,</span> <span class=s>&#34;p&#34;</span><span class=p>,</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=s>&#34;help message for password&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>pflag</span><span class=p>.</span><span class=nf>Parse</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>_</span> <span class=p>=</span> <span class=nx>viper</span><span class=p>.</span><span class=nf>BindPFlag</span><span class=p>(</span><span class=s>&#34;username&#34;</span><span class=p>,</span> <span class=nx>pflag</span><span class=p>.</span><span class=nf>Lookup</span><span class=p>(</span><span class=s>&#34;username&#34;</span><span class=p>))</span> <span class=c1>// 绑定单个标志
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>_</span> <span class=p>=</span> <span class=nx>viper</span><span class=p>.</span><span class=nf>BindPFlags</span><span class=p>(</span><span class=nx>pflag</span><span class=p>.</span><span class=nx>CommandLine</span><span class=p>)</span>                   <span class=c1>// 绑定标志集
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=c1>// 读取配置值
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;username: %s\n&#34;</span><span class=p>,</span> <span class=nx>viper</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=s>&#34;username&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;password: %s\n&#34;</span><span class=p>,</span> <span class=nx>viper</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=s>&#34;password&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>执行以上示例代码得到如下输出：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ go run main.go -u arlettebrook -p <span class=m>123456</span>
</span></span><span class=line><span class=cl>username: arlettebrook
</span></span><span class=line><span class=cl>password: <span class=m>123456</span>
</span></span></code></pre></td></tr></table></div></div><p>因为 pflag 能够兼容标准库的 flag 包，所以我们也可以变相的让 Viper 支持 flag。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>package main
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>import <span class=o>(</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;flag&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;github.com/spf13/pflag&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;github.com/spf13/viper&#34;</span>
</span></span><span class=line><span class=cl><span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>func main<span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=nv>_</span> <span class=o>=</span> flag.String<span class=o>(</span><span class=s2>&#34;username&#34;</span>, <span class=s2>&#34;&#34;</span>, <span class=s2>&#34;help message for username&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    pflag.CommandLine.AddGoFlagSet<span class=o>(</span>flag.CommandLine<span class=o>)</span> // 将 flag 命令行参数注册到 pflag
</span></span><span class=line><span class=cl>    pflag.Parse<span class=o>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nv>_</span> <span class=o>=</span> viper.BindPFlags<span class=o>(</span>pflag.CommandLine<span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    // 读取配置值
</span></span><span class=line><span class=cl>    fmt.Printf<span class=o>(</span><span class=s2>&#34;username: %s\n&#34;</span>, viper.Get<span class=o>(</span><span class=s2>&#34;username&#34;</span><span class=o>))</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>执行以上示例代码得到如下输出：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ go run main.go --username arlettebrook
</span></span><span class=line><span class=cl>username: arlettebrook
</span></span></code></pre></td></tr></table></div></div><p>如果你不使用 flag 或 pflag，则 Viper 还提供了 Go 接口的形式来支持其他 Flags，具体用法可以参考<a class=link href=https://github.com/spf13/viper#flag-interfaces target=_blank rel=noopener>官方文档</a>。</p><h4 id=命令行选项><a href=#%e5%91%bd%e4%bb%a4%e8%a1%8c%e9%80%89%e9%a1%b9 class=header-anchor>#</a>
命令行选项</h4><p>如果一个键没有通过<code>viper.Set</code>显示设置值，那么获取时将尝试从命令行选项中读取。 如果有，优先使用。viper 使用 pflag 库来解析选项。 我们首先在<code>init</code>方法中定义选项，并且调用<code>viper.BindPFlags</code>绑定选项到配置中：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=s>&#34;github.com/spf13/pflag&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;github.com/spf13/viper&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>init</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>pflag</span><span class=p>.</span><span class=nf>Int</span><span class=p>(</span><span class=s>&#34;redis.port&#34;</span><span class=p>,</span> <span class=mi>8381</span><span class=p>,</span> <span class=s>&#34;Redis port to connect&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 绑定命令行
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>_</span> <span class=p>=</span> <span class=nx>viper</span><span class=p>.</span><span class=nf>BindPFlags</span><span class=p>(</span><span class=nx>pflag</span><span class=p>.</span><span class=nx>CommandLine</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>pflag</span><span class=p>.</span><span class=nf>Parse</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>viper</span><span class=p>.</span><span class=nf>SetConfigFile</span><span class=p>(</span><span class=s>&#34;./config.toml&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>_</span> <span class=p>=</span> <span class=nx>viper</span><span class=p>.</span><span class=nf>ReadInConfig</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>viper</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=s>&#34;app_name&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>viper</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=s>&#34;log_level&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;mysql ip: &#34;</span><span class=p>,</span> <span class=nx>viper</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=s>&#34;mysql.ip&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;mysql port: &#34;</span><span class=p>,</span> <span class=nx>viper</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=s>&#34;mysql.port&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;mysql user: &#34;</span><span class=p>,</span> <span class=nx>viper</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=s>&#34;mysql.user&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;mysql password: &#34;</span><span class=p>,</span> <span class=nx>viper</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=s>&#34;mysql.password&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;mysql database: &#34;</span><span class=p>,</span> <span class=nx>viper</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=s>&#34;mysql.database&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;redis ip: &#34;</span><span class=p>,</span> <span class=nx>viper</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=s>&#34;redis.ip&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;redis port: &#34;</span><span class=p>,</span> <span class=nx>viper</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=s>&#34;redis.port&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>编译、运行程序：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ go run main.go --redis.port <span class=m>9381</span>
</span></span><span class=line><span class=cl>awesome web
</span></span><span class=line><span class=cl>DEBUG
</span></span><span class=line><span class=cl>mysql ip:  127.0.0.1
</span></span><span class=line><span class=cl>mysql port:  <span class=m>3306</span>
</span></span><span class=line><span class=cl>mysql user:  dj
</span></span><span class=line><span class=cl>mysql password:  <span class=m>123456</span>
</span></span><span class=line><span class=cl>mysql database:  awesome
</span></span><span class=line><span class=cl>redis ip:  127.0.0.1
</span></span><span class=line><span class=cl>redis port:  <span class=m>9381</span>
</span></span></code></pre></td></tr></table></div></div><p>如何不传入选项：</p><p>将使用环境变量的配置，没有，在使用配置文件的配置，没有，在使用默认，都没有，为对应类型的零值。</p><p><strong>将使用配置文件的配置</strong><code>redis port: 7381</code>，如果配置文件没有配置，才会使用默认值。这里没有默认值。</p><h3 id=从远程-keyvalue-存储读取配置><a href=#%e4%bb%8e%e8%bf%9c%e7%a8%8b-keyvalue-%e5%ad%98%e5%82%a8%e8%af%bb%e5%8f%96%e9%85%8d%e7%bd%ae class=header-anchor>#</a>
从远程 key/value 存储读取配置</h3><p>要在 Viper 中启用远程支持，需要匿名导入 <code>viper/remote</code> 包：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>import _ <span class=s2>&#34;github.com/spf13/viper/remote&#34;</span>
</span></span></code></pre></td></tr></table></div></div><p>Viper 支持 etcd、Consul 等远程 key/value 存储，这里以 Consul 为例进行讲解。</p><p>首先需要准备 Consul 环境，最方便快捷的方式就是启动一个 Docker 容器：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ docker run <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    -d <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    -p 8500:8500 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    -p 8600:8600/udp <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --name<span class=o>=</span>badger <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    consul agent -server -ui -node<span class=o>=</span>server-1 -bootstrap-expect<span class=o>=</span><span class=m>1</span> -client<span class=o>=</span>0.0.0.0
</span></span></code></pre></td></tr></table></div></div><p>Docker 容器启动好后，浏览器访问 <code>http://localhost:8500/</code>，即可进入 Consul 控制台，在 <code>user/config</code> 路径下编写 YAML 格式的配置。</p><p><img src=/p/go%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86%E4%B9%8B%E7%AC%AC%E4%B8%89%E6%96%B9%E5%BA%93viper/viper.assets/image-20240505001230221.png width=1107 height=693 srcset="/p/go%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86%E4%B9%8B%E7%AC%AC%E4%B8%89%E6%96%B9%E5%BA%93viper/viper.assets/image-20240505001230221_hu2fe08c5fd266909738116a9dadd6ba88_51547_480x0_resize_box_3.png 480w, /p/go%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86%E4%B9%8B%E7%AC%AC%E4%B8%89%E6%96%B9%E5%BA%93viper/viper.assets/image-20240505001230221_hu2fe08c5fd266909738116a9dadd6ba88_51547_1024x0_resize_box_3.png 1024w" loading=lazy alt="Consul Config" class=gallery-image data-flex-grow=159 data-flex-basis=383px></p><p>使用 Viper 从 Consul 读取配置示例代码如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=s>&#34;github.com/spf13/viper&#34;</span>
</span></span><span class=line><span class=cl>	<span class=nx>_</span> <span class=s>&#34;github.com/spf13/viper/remote&#34;</span> <span class=c1>// 必须导入，才能加载远程 key/value 配置
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>viper</span><span class=p>.</span><span class=nf>AddRemoteProvider</span><span class=p>(</span><span class=s>&#34;consul&#34;</span><span class=p>,</span> <span class=s>&#34;localhost:8500&#34;</span><span class=p>,</span> <span class=s>&#34;user/config&#34;</span><span class=p>)</span> <span class=c1>// 连接远程 consul 服务
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>viper</span><span class=p>.</span><span class=nf>SetConfigType</span><span class=p>(</span><span class=s>&#34;YAML&#34;</span><span class=p>)</span>                                        <span class=c1>// 显式设置文件格式文 YAML
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>viper</span><span class=p>.</span><span class=nf>ReadRemoteConfig</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 读取配置值
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;username: %s\n&#34;</span><span class=p>,</span> <span class=nx>viper</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=s>&#34;username&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;server.ip: %s\n&#34;</span><span class=p>,</span> <span class=nx>viper</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=s>&#34;server.ip&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>执行以上示例代码得到如下输出：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ go run main.go
</span></span><span class=line><span class=cl>username: jianghushinian
</span></span><span class=line><span class=cl>server.ip: 127.0.0.1
</span></span></code></pre></td></tr></table></div></div><blockquote><p>笔记：如果你想停止通过 Docker 安装的 Consul 容器，则可以执行 <code>docker stop badger</code> 命令。如果需要删除，则可以执行 <code>docker rm badger</code> 命令。</p></blockquote><hr><h2 id=从-viper-中读取配置值><a href=#%e4%bb%8e-viper-%e4%b8%ad%e8%af%bb%e5%8f%96%e9%85%8d%e7%bd%ae%e5%80%bc class=header-anchor>#</a>
从 Viper 中读取配置值</h2><p>前文中我们介绍了各种将配置读入 Viper 的技巧，现在该学习如何使用这些配置了。</p><p>在 Viper 中，有如下几种方法可以获取配置值：</p><ul><li><code>Get(key string) interface{}</code>：获取配置项 <code>key</code> 所对应的值，<code>key</code> 不区分大小写，返回接口类型。</li><li><code>Get&lt;Type>(key string) &lt;Type></code>：获取指定类型的配置值， 可以是 Viper 支持的类型：<code>GetBool</code>、<code>GetFloat64</code>、<code>GetInt</code>、<code>GetIntSlice</code>、<code>GetString</code>、<code>GetStringMap</code>、<code>GetStringMapString</code>、<code>GetStringSlice</code>、<code>GetTime</code>、<code>GetDuration</code>。</li><li><code>AllSettings() map[string]interface{}</code>：返回所有配置。根据我的经验，如果使用环境变量指定配置，则只能获取到通过 <code>BindEnv</code> 绑定的环境变量，无法获取到通过 <code>AutomaticEnv</code> 绑定的环境变量。</li><li><code>IsSet(key string) bool</code>：值得注意的是，在使用 <code>Get</code> 或 <code>Get&lt;Type></code> 获取配置值，如果找不到，则每个 <code>Get</code> 函数都会返回一个零值。为了检查给定的键是否存在，可以使用 <code>IsSet</code> 方法，存在返回 <code>true</code>，不存在返回 <code>false</code>。</li></ul><h3 id=访问嵌套的键><a href=#%e8%ae%bf%e9%97%ae%e5%b5%8c%e5%a5%97%e7%9a%84%e9%94%ae class=header-anchor>#</a>
访问嵌套的键</h3><p>有如下配置文件 <code>config.yaml</code>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>username</span><span class=p>:</span><span class=w> </span><span class=l>arlettebrook</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>password</span><span class=p>:</span><span class=w> </span><span class=m>123456</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>server</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ip</span><span class=p>:</span><span class=w> </span><span class=m>127.0.0.1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>8080</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>可以通过 <code>.</code> 分隔符来访问嵌套字段。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>viper</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=s>&#34;server.ip&#34;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>示例如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;log&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=s>&#34;github.com/spf13/viper&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>viper</span><span class=p>.</span><span class=nf>SetConfigFile</span><span class=p>(</span><span class=s>&#34;./config.yaml&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>err</span> <span class=o>:=</span> <span class=nx>viper</span><span class=p>.</span><span class=nf>ReadInConfig</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>       <span class=nx>log</span><span class=p>.</span><span class=nf>Fatalln</span><span class=p>(</span><span class=s>&#34;加载配置文件失败：&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 读取配置值
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;username: %v\n&#34;</span><span class=p>,</span> <span class=nx>viper</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=s>&#34;username&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;server: %v\n&#34;</span><span class=p>,</span> <span class=nx>viper</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=s>&#34;server&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;server.ip: %v\n&#34;</span><span class=p>,</span> <span class=nx>viper</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=s>&#34;server.ip&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;server.port: %v\n&#34;</span><span class=p>,</span> <span class=nx>viper</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=s>&#34;server.port&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>执行以上示例代码得到如下输出：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ go run main.go 
</span></span><span class=line><span class=cl>username: arlettebrook
</span></span><span class=line><span class=cl>server: map<span class=o>[</span>ip:127.0.0.1 port:8080<span class=o>]</span>
</span></span><span class=line><span class=cl>server.ip: 127.0.0.1
</span></span><span class=line><span class=cl>server.port: <span class=m>8080</span>
</span></span></code></pre></td></tr></table></div></div><p>有一种情况是，配置中本就存在着叫 <code>server.ip</code> 的键，那么它会遮蔽 <code>server</code> 对象下的 <code>ip</code> 配置项。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>username</span><span class=p>:</span><span class=w> </span><span class=l>arlettebrook</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>password</span><span class=p>:</span><span class=w> </span><span class=m>123456</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>server</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ip</span><span class=p>:</span><span class=w> </span><span class=m>127.0.0.1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>8080</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>server.ip</span><span class=p>:</span><span class=w> </span><span class=m>10.0.0.1</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>示例程序如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;log&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=s>&#34;github.com/spf13/viper&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>viper</span><span class=p>.</span><span class=nf>SetConfigFile</span><span class=p>(</span><span class=s>&#34;./config.yaml&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>err</span> <span class=o>:=</span> <span class=nx>viper</span><span class=p>.</span><span class=nf>ReadInConfig</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>       <span class=nx>log</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;加载配置文件出错：&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 读取配置值
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;username: %v\n&#34;</span><span class=p>,</span> <span class=nx>viper</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=s>&#34;username&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;server: %v\n&#34;</span><span class=p>,</span> <span class=nx>viper</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=s>&#34;server&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;server.ip: %v\n&#34;</span><span class=p>,</span> <span class=nx>viper</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=s>&#34;server.ip&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;server.port: %v\n&#34;</span><span class=p>,</span> <span class=nx>viper</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=s>&#34;server.port&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>执行以上示例代码得到如下输出：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ go run main.go 
</span></span><span class=line><span class=cl>username: arlettebrook
</span></span><span class=line><span class=cl>server: map<span class=o>[</span>ip:127.0.0.1 port:8080<span class=o>]</span>
</span></span><span class=line><span class=cl>server.ip: 10.0.0.1
</span></span><span class=line><span class=cl>server.port: <span class=m>8080</span>
</span></span></code></pre></td></tr></table></div></div><p><code>server.ip</code> 打印结果为 <code>10.0.0.1</code>，而不再是 <code>server</code> map 中所对应的值 <code>127.0.0.1</code>。</p><h3 id=提取子树><a href=#%e6%8f%90%e5%8f%96%e5%ad%90%e6%a0%91 class=header-anchor>#</a>
提取子树</h3><p>当使用 Viper 读取 <code>config.yaml</code> 配置文件后，<code>viper</code> 对象就包含了所有配置，并能通过 <code>viper.Get("server.ip")</code> 获取子配置。</p><p>我们可以将这份配置理解为一颗树形结构，<code>viper</code> 对象就包含了这个完整的树，可以使用如下方法获取 <code>server</code> 子树。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>srvCfg :<span class=o>=</span> viper.Sub<span class=o>(</span><span class=s2>&#34;server&#34;</span><span class=o>)</span>
</span></span></code></pre></td></tr></table></div></div><p>使用示例如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=s>&#34;github.com/spf13/viper&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>viper</span><span class=p>.</span><span class=nf>SetConfigFile</span><span class=p>(</span><span class=s>&#34;./config.yaml&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>_</span> <span class=p>=</span> <span class=nx>viper</span><span class=p>.</span><span class=nf>ReadInConfig</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 获取 server 子树
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>srvCfg</span> <span class=o>:=</span> <span class=nx>viper</span><span class=p>.</span><span class=nf>Sub</span><span class=p>(</span><span class=s>&#34;server&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 读取配置值
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;ip: %v\n&#34;</span><span class=p>,</span> <span class=nx>srvCfg</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=s>&#34;ip&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;port: %v\n&#34;</span><span class=p>,</span> <span class=nx>srvCfg</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=s>&#34;port&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;server.ip: %v\n&#34;</span><span class=p>,</span> <span class=nx>viper</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=s>&#34;server.ip&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>执行以上示例代码得到如下输出：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ go run main.go 
</span></span><span class=line><span class=cl>ip: 127.0.0.1
</span></span><span class=line><span class=cl>port: <span class=m>8080</span>
</span></span><span class=line><span class=cl>server.ip: 10.0.0.1
</span></span></code></pre></td></tr></table></div></div><p>这里键没有出现覆盖的情况</p><h3 id=反序列化><a href=#%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96 class=header-anchor>#</a>
反序列化</h3><p>Viper 提供了 2 个方法进行反序列化操作，以此来实现将所有或特定的值解析到结构体、map 等。</p><ul><li><code>Unmarshal(rawVal interface{}) : error</code>：反序列化所有配置项。</li><li><code>UnmarshalKey(key string, rawVal interface{}) : error</code>：反序列化指定配置项。</li></ul><p>使用示例如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;log&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=s>&#34;github.com/spf13/viper&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Config</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>Username</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>	<span class=nx>Password</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>	<span class=c1>// Viper 支持嵌套结构体
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>Server</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>IP</span>   <span class=kt>string</span>
</span></span><span class=line><span class=cl>		<span class=nx>Port</span> <span class=kt>int</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>viper</span><span class=p>.</span><span class=nf>SetConfigFile</span><span class=p>(</span><span class=s>&#34;./config.yaml&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>_</span> <span class=p>=</span> <span class=nx>viper</span><span class=p>.</span><span class=nf>ReadInConfig</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=kd>var</span> <span class=nx>cfg</span> <span class=nx>Config</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>viper</span><span class=p>.</span><span class=nf>Unmarshal</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>cfg</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>log</span><span class=p>.</span><span class=nf>Fatalln</span><span class=p>(</span><span class=s>&#34;反序列化错误：&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=kd>var</span> <span class=nx>Password</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>viper</span><span class=p>.</span><span class=nf>UnmarshalKey</span><span class=p>(</span><span class=s>&#34;Password&#34;</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>Password</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>log</span><span class=p>.</span><span class=nf>Fatalln</span><span class=p>(</span><span class=s>&#34;反序列化错误：&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;cfg: %+v\n&#34;</span><span class=p>,</span> <span class=nx>cfg</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Password: %s\n&#34;</span><span class=p>,</span> <span class=nx>Password</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>执行以上示例代码得到如下输出：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ go run main.go 
</span></span><span class=line><span class=cl>cfg: <span class=o>{</span>Username:arlettebrook Password:123456 Server:<span class=o>{</span>IP:10.0.0.1 Port:8080<span class=o>}}</span>
</span></span><span class=line><span class=cl>Password: <span class=m>123456</span>
</span></span></code></pre></td></tr></table></div></div><p>如果配置项的 <code>key</code> 本身就包含 <code>.</code>，则需要修改分隔符。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=s>&#34;github.com/spf13/viper&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Config</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>Chart</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>       <span class=nx>Values</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kd>interface</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 默认的键分隔符为 `.`，这里将其修改为 `::`
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>v</span> <span class=o>:=</span> <span class=nx>viper</span><span class=p>.</span><span class=nf>NewWithOptions</span><span class=p>(</span><span class=nx>viper</span><span class=p>.</span><span class=nf>KeyDelimiter</span><span class=p>(</span><span class=s>&#34;::&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>v</span><span class=p>.</span><span class=nf>SetDefault</span><span class=p>(</span><span class=s>&#34;chart::values&#34;</span><span class=p>,</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kd>interface</span><span class=p>{}{</span>
</span></span><span class=line><span class=cl>       <span class=s>&#34;ingress&#34;</span><span class=p>:</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kd>interface</span><span class=p>{}{</span>
</span></span><span class=line><span class=cl>          <span class=s>&#34;annotations&#34;</span><span class=p>:</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kd>interface</span><span class=p>{}{</span>
</span></span><span class=line><span class=cl>             <span class=s>&#34;traefik.frontend.rule.type&#34;</span><span class=p>:</span>                 <span class=s>&#34;PathPrefix&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>             <span class=s>&#34;traefik.ingress.kubernetes.io/ssl-redirect&#34;</span><span class=p>:</span> <span class=s>&#34;true&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=p>},</span>
</span></span><span class=line><span class=cl>       <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>cfg</span> <span class=nx>Config</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>v</span><span class=p>.</span><span class=nf>Unmarshal</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>cfg</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>       <span class=nb>panic</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;cfg: %+v\n&#34;</span><span class=p>,</span> <span class=nx>cfg</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>执行以上示例代码得到如下输出：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ go run main.go 
</span></span><span class=line><span class=cl>cfg: <span class=o>{</span>Chart:<span class=o>{</span>Values:map<span class=o>[</span>ingress:map<span class=o>[</span>annotations:map<span class=o>[</span>traefik.frontend.rule.type:PathPrefix traefik.
</span></span><span class=line><span class=cl>ingress.kubernetes.io/ssl-redirect:true<span class=o>]]]}}</span>
</span></span></code></pre></td></tr></table></div></div><blockquote><p>注意⚠️：Viper 在后台使用 <a class=link href=https://github.com/mitchellh/mapstructure target=_blank rel=noopener>mapstructure</a> 来解析值，其默认情况下使用 <code>mapstructure</code> tags。当我们需要将 Viper 读取的配置反序列到结构体中时，如果出现结构体字段跟配置项不匹配，则可以设置 <code>mapstructure</code> tags 来解决。</p></blockquote><h4 id=unmarshal><a href=#unmarshal class=header-anchor>#</a>
<code>Unmarshal</code></h4><p>viper 支持将配置<code>Unmarshal</code>到一个结构体中，为结构体中的对应字段赋值。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-golang data-lang=golang><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;log&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=s>&#34;github.com/spf13/viper&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Config</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>AppName</span>  <span class=kt>string</span>
</span></span><span class=line><span class=cl>	<span class=nx>LogLevel</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>MySQL</span> <span class=nx>MySQLConfig</span>
</span></span><span class=line><span class=cl>	<span class=nx>Redis</span> <span class=nx>RedisConfig</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>MySQLConfig</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>IP</span>       <span class=kt>string</span>
</span></span><span class=line><span class=cl>	<span class=nx>Port</span>     <span class=kt>int</span>
</span></span><span class=line><span class=cl>	<span class=nx>User</span>     <span class=kt>string</span>
</span></span><span class=line><span class=cl>	<span class=nx>Password</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>	<span class=nx>Database</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>RedisConfig</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>IP</span>   <span class=kt>string</span>
</span></span><span class=line><span class=cl>	<span class=nx>Port</span> <span class=kt>int</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>viper</span><span class=p>.</span><span class=nf>SetConfigName</span><span class=p>(</span><span class=s>&#34;config&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>viper</span><span class=p>.</span><span class=nf>SetConfigType</span><span class=p>(</span><span class=s>&#34;toml&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>viper</span><span class=p>.</span><span class=nf>AddConfigPath</span><span class=p>(</span><span class=s>&#34;.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>err</span> <span class=o>:=</span> <span class=nx>viper</span><span class=p>.</span><span class=nf>ReadInConfig</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>log</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;read config failed: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=kd>var</span> <span class=nx>c</span> <span class=nx>Config</span>
</span></span><span class=line><span class=cl>	<span class=nx>err</span> <span class=p>=</span> <span class=nx>viper</span><span class=p>.</span><span class=nf>Unmarshal</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>c</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>log</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;反序列化失败：%v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>MySQL</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>编译，运行程序，输出：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ go run main.go 
</span></span><span class=line><span class=cl><span class=o>{</span>127.0.0.1 <span class=m>3306</span> dj <span class=m>123456</span> awesome<span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=序列化><a href=#%e5%ba%8f%e5%88%97%e5%8c%96 class=header-anchor>#</a>
序列化</h3><p>一个好用的配置包不仅能够支持反序列化操作，还要支持序列化操作。Viper 支持将配置序列化成字符串，或直接序列化到文件中。</p><h4 id=序列化成字符串><a href=#%e5%ba%8f%e5%88%97%e5%8c%96%e6%88%90%e5%ad%97%e7%ac%a6%e4%b8%b2 class=header-anchor>#</a>
序列化成字符串</h4><p>我们可以将全部配置序列化配置为 YAML 格式字符串。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-golang data-lang=golang><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=s>&#34;github.com/spf13/viper&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;gopkg.in/yaml.v3&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 序列化配置为 YAML 格式字符串
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>yamlStringSettings</span><span class=p>()</span> <span class=kt>string</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>c</span> <span class=o>:=</span> <span class=nx>viper</span><span class=p>.</span><span class=nf>AllSettings</span><span class=p>()</span> <span class=c1>// 获取全部配置
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>bs</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>yaml</span><span class=p>.</span><span class=nf>Marshal</span><span class=p>(</span><span class=nx>c</span><span class=p>)</span> <span class=c1>// 根据需求序列化成不同格式
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span> <span class=nb>string</span><span class=p>(</span><span class=nx>bs</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>viper</span><span class=p>.</span><span class=nf>SetConfigFile</span><span class=p>(</span><span class=s>&#34;./config.yaml&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>_</span> <span class=p>=</span> <span class=nx>viper</span><span class=p>.</span><span class=nf>ReadInConfig</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=nf>yamlStringSettings</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>执行以上示例代码得到如下输出：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ go run main.go 
</span></span><span class=line><span class=cl>password: <span class=m>123456</span>
</span></span><span class=line><span class=cl>server:
</span></span><span class=line><span class=cl>    ip: 10.0.0.1
</span></span><span class=line><span class=cl>    port: <span class=m>8080</span>
</span></span><span class=line><span class=cl>username: arlettebrook
</span></span></code></pre></td></tr></table></div></div><h4 id=写入配置文件><a href=#%e5%86%99%e5%85%a5%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6 class=header-anchor>#</a>
写入配置文件</h4><p>Viper 还支持直接将配置序列化到文件中，提供了如下几个方法：</p><ul><li><code>WriteConfig</code>：将当前的 <code>viper</code> 配置写入预定义路径。如果没有预定义路径，则会报错。如果预定义路径已经存在配置文件，将会被覆盖。</li><li><code>SafeWriteConfig</code>：将当前的 <code>viper</code> 配置写入预定义路径。如果没有预定义路径，则会报错。如果预定义路径已经存在配置文件，不会覆盖，会报错。</li><li><code>WriteConfigAs</code>： 将当前的 <code>viper</code> 配置写入给定的文件路径。如果给定的文件路径已经存在配置文件，将会被覆盖。</li><li><code>SafeWriteConfigAs</code>：将当前的 <code>viper</code> 配置写入给定的文件路径。如果给定的文件路径已经存在配置文件，不会覆盖，会报错。</li><li>注意保存的文件类型要与配置类型一直，否则会报错<code>config type could not be determined for XXX</code>。</li></ul><p>使用示例：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>viper</span><span class=p>.</span><span class=nf>WriteConfig</span><span class=p>()</span> <span class=c1>// 将当前配置写入由 `viper.AddConfigPath()` 和 `viper.SetConfigFile()` 设置的预定义路径。类型就为配置类型。
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>viper</span><span class=p>.</span><span class=nf>SafeWriteConfig</span><span class=p>()</span> <span class=c1>// 将会报错，因为它已经被写入了。
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=nx>viper</span><span class=p>.</span><span class=nf>WriteConfigAs</span><span class=p>(</span><span class=s>&#34;./cfg.yaml&#34;</span><span class=p>)</span> <span class=c1>// 文件类型要与配置类型一直，否则报错
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>viper</span><span class=p>.</span><span class=nf>SafeWriteConfigAs</span><span class=p>(</span><span class=s>&#34;./cfg.yaml&#34;</span><span class=p>)</span> <span class=c1>// 将会报错，因为它已经被写入了。
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>viper</span><span class=p>.</span><span class=nf>SafeWriteConfigAs</span><span class=p>(</span><span class=s>&#34;./cfg/cfg.yaml&#34;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=s>&#34;github.com/spf13/viper&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;gopkg.in/yaml.v3&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 序列化配置为 YAML 格式字符串
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>yamlStringSettings</span><span class=p>()</span> <span class=kt>string</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>c</span> <span class=o>:=</span> <span class=nx>viper</span><span class=p>.</span><span class=nf>AllSettings</span><span class=p>()</span> <span class=c1>// 获取全部配置
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>bs</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>yaml</span><span class=p>.</span><span class=nf>Marshal</span><span class=p>(</span><span class=nx>c</span><span class=p>)</span> <span class=c1>// 根据需求序列化成不同格式
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span> <span class=nb>string</span><span class=p>(</span><span class=nx>bs</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>viper</span><span class=p>.</span><span class=nf>SetConfigFile</span><span class=p>(</span><span class=s>&#34;./config.yaml&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>_</span> <span class=p>=</span> <span class=nx>viper</span><span class=p>.</span><span class=nf>ReadInConfig</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=nf>yamlStringSettings</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=nx>viper</span><span class=p>.</span><span class=nf>Set</span><span class=p>(</span><span class=s>&#34;username&#34;</span><span class=p>,</span> <span class=s>&#34;哈哈哈&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>err</span> <span class=o>:=</span> <span class=nx>viper</span><span class=p>.</span><span class=nf>WriteConfigAs</span><span class=p>(</span><span class=s>&#34;./cfg.yaml&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>       <span class=nb>panic</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;修改后的username:&#34;</span><span class=p>,</span> <span class=nx>viper</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=s>&#34;username&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>输出：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ go run main.go 
</span></span><span class=line><span class=cl>password: <span class=m>123456</span>
</span></span><span class=line><span class=cl>server:
</span></span><span class=line><span class=cl>    ip: 10.0.0.1
</span></span><span class=line><span class=cl>    port: <span class=m>8080</span>
</span></span><span class=line><span class=cl>username: arlettebrook
</span></span><span class=line><span class=cl>修改后的username: 哈哈哈
</span></span></code></pre></td></tr></table></div></div><h5 id=保存配置><a href=#%e4%bf%9d%e5%ad%98%e9%85%8d%e7%bd%ae class=header-anchor>#</a>
保存配置</h5><p>有时候，我们想要将程序中生成的配置，或者所做的修改保存下来。viper 提供了接口！</p><ul><li><code>WriteConfig</code>：将当前的 viper 配置写到预定义路径，如果没有预定义路径，返回错误。将会覆盖当前配置；</li><li><code>SafeWriteConfig</code>：与上面功能一样，但是如果配置文件存在，则不覆盖；</li><li><code>WriteConfigAs</code>：保存配置到指定路径，如果文件存在，则覆盖；</li><li><code>SafeWriteConfig</code>：与上面功能一样，但是入股配置文件存在，则不覆盖。</li></ul><p>下面我们通过程序生成一个<code>config.toml</code>配置：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;log&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=s>&#34;github.com/spf13/viper&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>viper</span><span class=p>.</span><span class=nf>SetConfigName</span><span class=p>(</span><span class=s>&#34;config&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>viper</span><span class=p>.</span><span class=nf>SetConfigType</span><span class=p>(</span><span class=s>&#34;toml&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>viper</span><span class=p>.</span><span class=nf>AddConfigPath</span><span class=p>(</span><span class=s>&#34;.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>viper</span><span class=p>.</span><span class=nf>Set</span><span class=p>(</span><span class=s>&#34;app_name&#34;</span><span class=p>,</span> <span class=s>&#34;awesome web&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>viper</span><span class=p>.</span><span class=nf>Set</span><span class=p>(</span><span class=s>&#34;log_level&#34;</span><span class=p>,</span> <span class=s>&#34;DEBUG&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>viper</span><span class=p>.</span><span class=nf>Set</span><span class=p>(</span><span class=s>&#34;mysql.ip&#34;</span><span class=p>,</span> <span class=s>&#34;127.0.0.1&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>viper</span><span class=p>.</span><span class=nf>Set</span><span class=p>(</span><span class=s>&#34;mysql.port&#34;</span><span class=p>,</span> <span class=mi>3306</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>viper</span><span class=p>.</span><span class=nf>Set</span><span class=p>(</span><span class=s>&#34;mysql.user&#34;</span><span class=p>,</span> <span class=s>&#34;root&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>viper</span><span class=p>.</span><span class=nf>Set</span><span class=p>(</span><span class=s>&#34;mysql.password&#34;</span><span class=p>,</span> <span class=s>&#34;123456&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>viper</span><span class=p>.</span><span class=nf>Set</span><span class=p>(</span><span class=s>&#34;mysql.database&#34;</span><span class=p>,</span> <span class=s>&#34;awesome&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>viper</span><span class=p>.</span><span class=nf>Set</span><span class=p>(</span><span class=s>&#34;redis.ip&#34;</span><span class=p>,</span> <span class=s>&#34;127.0.0.1&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>viper</span><span class=p>.</span><span class=nf>Set</span><span class=p>(</span><span class=s>&#34;redis.port&#34;</span><span class=p>,</span> <span class=mi>6381</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>err</span> <span class=o>:=</span> <span class=nx>viper</span><span class=p>.</span><span class=nf>SafeWriteConfig</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>       <span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=s>&#34;write config failed: &#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><hr><h2 id=多实例对象><a href=#%e5%a4%9a%e5%ae%9e%e4%be%8b%e5%af%b9%e8%b1%a1 class=header-anchor>#</a>
多实例对象</h2><p>由于大多数应用程序都希望使用单个配置实例对象来管理配置，因此 viper 包默认提供了这一功能，它类似于一个单例。当我们使用 Viper 时不需要配置或初始化，Viper 实现了开箱即用的效果。</p><p>在上面的所有示例中，演示了如何以单例方式使用 Viper。我们还可以创建多个不同的 Viper 实例以供应用程序中使用，每个实例都有自己单独的一组配置和值，并且它们可以从不同的配置文件、key/value 存储等位置读取配置信息。</p><p>Viper 包支持的所有功能都被镜像为 <code>viper</code> 对象上的方法，这种设计思路在 Go 语言中非常常见，如标准库中的 log 包。</p><p>多实例使用示例：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=s>&#34;github.com/spf13/viper&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>x</span> <span class=o>:=</span> <span class=nx>viper</span><span class=p>.</span><span class=nf>New</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nx>y</span> <span class=o>:=</span> <span class=nx>viper</span><span class=p>.</span><span class=nf>New</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>x</span><span class=p>.</span><span class=nf>SetConfigFile</span><span class=p>(</span><span class=s>&#34;./config.yaml&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>_</span> <span class=p>=</span> <span class=nx>x</span><span class=p>.</span><span class=nf>ReadInConfig</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;x.username: %v\n&#34;</span><span class=p>,</span> <span class=nx>x</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=s>&#34;username&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>y</span><span class=p>.</span><span class=nf>SetDefault</span><span class=p>(</span><span class=s>&#34;username&#34;</span><span class=p>,</span> <span class=s>&#34;多实例对象&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;y.username: %v\n&#34;</span><span class=p>,</span> <span class=nx>y</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=s>&#34;username&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>viper</span><span class=p>.</span><span class=nf>SetDefault</span><span class=p>(</span><span class=s>&#34;username&#34;</span><span class=p>,</span> <span class=s>&#34;默认单实例对象&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;viper.username: %v\n&#34;</span><span class=p>,</span> <span class=nx>viper</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=s>&#34;username&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>在这里，我创建了两个 Viper 实例 <code>x</code> 和 <code>y</code>，它们分别从配置文件读取配置和通过默认值的方式设置配置，使用时互不影响，使用者可以自行管理它们的生命周期。</p><p>执行以上示例代码得到如下输出：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ go run main.go 
</span></span><span class=line><span class=cl>x.username: arlettebrook
</span></span><span class=line><span class=cl>y.username: 多实例对象
</span></span><span class=line><span class=cl>viper.username: 默认单实例对象
</span></span></code></pre></td></tr></table></div></div><h2 id=使用建议><a href=#%e4%bd%bf%e7%94%a8%e5%bb%ba%e8%ae%ae class=header-anchor>#</a>
使用建议</h2><p>Viper 提供了众多方法可以管理配置，在实际项目开发中我们可以根据需要进行使用。如果是小型项目，推荐直接使用 <code>viper</code> 实例管理配置。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=s>&#34;github.com/spf13/viper&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>viper</span><span class=p>.</span><span class=nf>SetConfigFile</span><span class=p>(</span><span class=s>&#34;./config.yaml&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>viper</span><span class=p>.</span><span class=nf>ReadInConfig</span><span class=p>();</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>       <span class=nb>panic</span><span class=p>(</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;read config file error: %s \n&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>()))</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 监控配置文件变化
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>viper</span><span class=p>.</span><span class=nf>WatchConfig</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// use config...
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>viper</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=s>&#34;username&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>如果是中大型项目，一般都会有一个用来记录配置的结构体，可以使用 Viper 将配置反序列化到结构体中。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=s>&#34;github.com/fsnotify/fsnotify&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;github.com/spf13/viper&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Config</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>Username</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>    <span class=nx>Password</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Viper 支持嵌套结构体
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>Server</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>       <span class=nx>IP</span>   <span class=kt>string</span>
</span></span><span class=line><span class=cl>       <span class=nx>Port</span> <span class=kt>int</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>viper</span><span class=p>.</span><span class=nf>SetConfigFile</span><span class=p>(</span><span class=s>&#34;./config.yaml&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>viper</span><span class=p>.</span><span class=nf>ReadInConfig</span><span class=p>();</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>       <span class=nb>panic</span><span class=p>(</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;read config file error: %s \n&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>()))</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 将配置信息反序列化到结构体中
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>var</span> <span class=nx>cfg</span> <span class=nx>Config</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>viper</span><span class=p>.</span><span class=nf>Unmarshal</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>cfg</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>       <span class=nb>panic</span><span class=p>(</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;unmarshal config error: %s \n&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>()))</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 注册每次配置文件发生变更后都会调用的回调函数
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>viper</span><span class=p>.</span><span class=nf>OnConfigChange</span><span class=p>(</span><span class=kd>func</span><span class=p>(</span><span class=nx>e</span> <span class=nx>fsnotify</span><span class=p>.</span><span class=nx>Event</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>       <span class=c1>// 每次配置文件发生变化，需要重新将其反序列化到结构体中
</span></span></span><span class=line><span class=cl><span class=c1></span>       <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>viper</span><span class=p>.</span><span class=nf>Unmarshal</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>cfg</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nb>panic</span><span class=p>(</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;unmarshal config error: %s \n&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>()))</span>
</span></span><span class=line><span class=cl>       <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 监控配置文件变化
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>viper</span><span class=p>.</span><span class=nf>WatchConfig</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// use config...
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>cfg</span><span class=p>.</span><span class=nx>Username</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>需要注意的是，直接使用 <code>viper</code> 实例管理配置的情况下，当我们通过 <code>viper.WatchConfig()</code> 监听了配置文件变化，如果配置变化，则变化会立刻体现在 <code>viper</code> 实例对象上，下次通过 <code>viper.Get()</code> 获取的配置即为最新配置。但是在使用结构体管理配置时，<code>viper</code> 实例对象变化了，记录配置的结构体 <code>Config</code> 是不会自动更新的，所以需要使用 <code>viper.OnConfigChange</code> 在回调函数中重新将变更后的配置反序列化到 <code>Config</code> 中。</p><hr><h2 id=总结><a href=#%e6%80%bb%e7%bb%93 class=header-anchor>#</a>
总结</h2><p>本文探讨 Viper 的各种用法和使用场景，首先说明了为什么使用 Viper，它的优势是什么。</p><p>接着讲解了 Viper 包中最核心的两个功能：如何把配置值读入 Viper 和从 Viper 中读取配置值。Viper 对着两个功能都提供了非常多的方法来支持。</p><p>然后又介绍了如何用 Viper 来管理多份配置，即使用多实例。</p><p>对于 Viper 的使用我也给出了自己的建议，针对小型项目，推荐直接使用 <code>viper</code> 实例管理配置，如果是中大型项目，则推荐使用结构体来管理配置。</p><p>最后，Viper 正在向着 v2 版本迈进，欢迎读者在<a class=link href=https://docs.google.com/forms/d/e/1FAIpQLSeesGIS8Rya-iOXmXjUst8sT3NMSmdclBPa-aJT3HkPjDWnng/viewform target=_blank rel=noopener>这里</a>分享想法，也期待下次来写一篇 v2 版本的文章与读者一起学习进步。</p><hr><h2 id=参考><a href=#%e5%8f%82%e8%80%83 class=header-anchor>#</a>
参考</h2><blockquote><ol><li>Viper 源码仓库： <a class=link href=https://github.com/spf13/viper target=_blank rel=noopener>https://github.com/spf13/viper</a></li><li>搬运：<a class=link href=https://jianghushinian.cn/2023/04/25/how-to-use-viper-for-configuration-management-in-go/ target=_blank rel=noopener>在 Go 中如何使用 Viper 来管理配置</a></li><li><a class=link href=https://darjun.github.io/2020/01/18/godailylib/viper/ target=_blank rel=noopener>Go 每日一库之 viper</a></li></ol></blockquote></section><footer class=article-footer><section class=article-tags><a href=/tags/go%E7%AC%AC%E4%B8%89%E6%96%B9%E5%BA%93/>Go第三方库</a></section><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>相关文章</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/p/gin-introduction/><div class=article-details><h2 class=article-title>Gin Introduction</h2></div></a></article><article><a href=/p/go-ini-introduction/><div class=article-details><h2 class=article-title>Go-ini Introduction</h2></div></a></article><article><a href=/p/carbon-introduction/><div class=article-details><h2 class=article-title>Carbon Introduction</h2></div></a></article><article><a href=/p/godotenv-introduction/><div class=article-details><h2 class=article-title>Godotenv Introduction</h2></div></a></article><article><a href=/p/cast-introduction/><div class=article-details><h2 class=article-title>Cast Introduction</h2></div></a></article></div></div></aside><script src=//unpkg.com/@waline/client@v2/dist/waline.js></script><link href=//unpkg.com/@waline/client@v2/dist/waline.css rel=stylesheet><div id=waline class=waline-container></div><style>.waline-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding);--waline-font-size:var(--article-font-size)}.waline-container .wl-count{color:var(--card-text-color-main)}</style><script>Waline.init({copyright:!1,dark:'html[data-scheme="dark"]',el:"#waline",emoji:["https://unpkg.com/@waline/emojis@1.0.1/weibo"],lang:"zh-cn",locale:{admin:"👻Hi!",placeholder:"🎉留下你的脚印..."},pageview:!0,requiredMeta:["name","email"],serverURL:"https://waline-comment-omega-ten.vercel.app/"})</script><footer class=site-footer><section class=copyright>Copyright &copy;
2020 -
2024 <b><a href=https://github.com/arlettebrook target=_blank rel=noopener>@Arlettebrook</a></b></section><section class=powerby>博客内容遵循<b><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/legalcode.zh-hans target=_blank rel=noopener> 知识共享 署名-非商业性-相同方式共享4.0国际协议</a></b><br>使用 <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> 构建<br>主题 <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.25.0>Stack</a></b> 由 <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> 设计</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>